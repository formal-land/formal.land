<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>Formal Land Blog</title>
        <link>https://formal.land/blog</link>
        <description>Formal Land Blog</description>
        <lastBuildDate>Tue, 20 Jan 2026 00:00:00 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <item>
            <title><![CDATA[ðŸ¦„ Formal verification is translation and verification]]></title>
            <link>https://formal.land/blog/2026/01/20/translation-and-verification</link>
            <guid>https://formal.land/blog/2026/01/20/translation-and-verification</guid>
            <pubDate>Tue, 20 Jan 2026 00:00:00 GMT</pubDate>
            <description><![CDATA[In this post, we propose a general overview of what formal verification is by decomposing it into two main steps:]]></description>
            <content:encoded><![CDATA[<p>In this post, we propose a general overview of what formal verification is by decomposing it into two main steps:</p>
<ul>
<li><strong>Translation</strong> of the source code to a formal language;</li>
<li><strong>Verification</strong> of the formal specification in the formal language.</li>
</ul>
<p>We will cover the main techniques used at each step, knowing that in most cases it is possible to combine the approaches.</p>
<figure><p><img decoding="async" loading="lazy" alt="White forest" src="https://formal.land/assets/images/white-forest-4935d524d0043daf676bd04662ad429e.png" width="951" height="948" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="translation">Translation<a href="https://formal.land/blog/2026/01/20/translation-and-verification#translation" class="hash-link" aria-label="Direct link to Translation" title="Direct link to Translation">â€‹</a></h2>
<p>The translation part handles all the programming details, such as manipulating data structures from the standard library, or handling how pointers, states, and i/o are done.</p>
<p>The end goal of the translation is to generate a purely functional representation of the code, as formal systems are purely mathematical representations of the code (think languages like <a href="https://www.haskell.org/" target="_blank" rel="noopener noreferrer">Haskell</a>/<a href="https://ocaml.org/" target="_blank" rel="noopener noreferrer">OCaml</a>, or mathematical propositions). The end result can be extremely verbose.</p>
<p>There are a few approaches to make it manageable:</p>
<ol>
<li>Use fully automated formal verification, where the computer will have to read the translation, but not the human. This is the approach of SMT/model checking. The downside is that verification can timeout.</li>
<li>Use a manual/AI translation to an idiomatic representation in the formal language, with a manual review or tests to make sure it captures all the details. The drawback is that it can introduce mistakes, and it is hard to maintain when code changes.</li>
<li>Use a compiler, which can work very well with enough automation or by restricting the source programming language to a specific and "safe" subset. It can be combined with proof-by-refinements, so the user can provide and prove correct custom "cleaning" of the translation.</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="verification">Verification<a href="https://formal.land/blog/2026/01/20/translation-and-verification#verification" class="hash-link" aria-label="Direct link to Verification" title="Direct link to Verification">â€‹</a></h2>
<p>Then comes the time of specifications and proofs.</p>
<p>The specification language can be the programming language itself, with some "assert", some specific language embedded as comments, or the formal language itself. Depending on the language you use, you will have different expressiveness. With more expressive languages, you can write more general properties like "this program never lets non-admins read admin data", leading to cleaner and hence potentially safer specifications. Theorem provers (<a href="https://rocq-prover.org/" target="_blank" rel="noopener noreferrer">Rocq</a>, <a href="https://leanprover.github.io/" target="_blank" rel="noopener noreferrer">Lean</a>, <a href="https://isabelle.in.tum.de/" target="_blank" rel="noopener noreferrer">Isabelle</a>) are the most expressive.</p>
<p>For the proof, the system either handles it automatically (SMT/model checking), at the cost of loop approximations sometimes, or timeouts when it is too complicated. Or you can help the system manually (theorem prover). It gives more control and removes the "magic" part of the system. It enables the verification of the most complex properties like cryptographic maths. The drawback is that you need to learn and use those languages.</p>
<p>At the end, you are 100% sure your code is correct for what you stated: you get a mathematical proof covering all possible entries. The correctness of what you state is up to the scope you consider (the more you verify, the better!) and the exhaustiveness of your specifications.</p>
<figure><p><img decoding="async" loading="lazy" alt="Diagram" src="https://formal.land/assets/images/diagram-e2a10ba370dad0d0ee01743418183acf.jpeg" width="1320" height="625" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://formal.land/blog/2026/01/20/translation-and-verification#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">â€‹</a></h2>
<p>Formal verification is often the combination of the two phases above, with quite different focuses but often similar complexity.</p>
<p>We hope this helps you get a better understanding of what formal methods are and which techniques are best suited to your project.</p>
<p>Do you want to improve your processes by verifying your code? Discuss with us to know what is possible at <a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a>.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Socials</div><div class="admonitionContent_BuS1"><p>Do not forget to follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> and <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more.</p></div></div>]]></content:encoded>
            <category>formal verification</category>
            <category>translation</category>
            <category>verification</category>
        </item>
        <item>
            <title><![CDATA[ðŸ¦€ Functional correctness of STATIC_CALL in Revm]]></title>
            <link>https://formal.land/blog/2026/01/16/functional-correctness-static-call-revm</link>
            <guid>https://formal.land/blog/2026/01/16/functional-correctness-static-call-revm</guid>
            <pubDate>Fri, 16 Jan 2026 00:00:00 GMT</pubDate>
            <description><![CDATA[In this blog post, we show how we state the functional correctness of the implementation of the STATIC_CALL instruction in Revm, an implementation of the Ethereum's virtual machine EVM in Rust. This involves running rocq-of-rust to translate the Rust code to the theorem prover Rocq, and then making a proof by refinements until obtaining a specification of the code written in purely functional style, optimized for formal verification. This also proves the code cannot panic, as our specifications are free of panics.]]></description>
            <content:encoded><![CDATA[<p>In this blog post, we show how we state the functional correctness of the implementation of the <code>STATIC_CALL</code> instruction in <a href="https://github.com/bluealloy/revm" target="_blank" rel="noopener noreferrer">Revm</a>, an implementation of the Ethereum's virtual machine EVM in Rust. This involves running <a href="https://github.com/formal-land/rocq-of-rust" target="_blank" rel="noopener noreferrer">rocq-of-rust</a> to translate the Rust code to the theorem prover <a href="https://rocq-prover.org/" target="_blank" rel="noopener noreferrer">Rocq</a>, and then making a proof by refinements until obtaining a specification of the code written in purely functional style, optimized for formal verification. This also proves the code cannot panic, as our specifications are free of panics.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>This work was funded by a grant from the <a href="https://ethereum.foundation/" target="_blank" rel="noopener noreferrer">Ethereum Foundation</a>, to whom we are thankful, related to the <a href="https://verified-zkevm.org/" target="_blank" rel="noopener noreferrer">zkEVM Formal Verification Project</a>, to bring more security to the Ethereum ecosystem in general.</p><p>Completing this work on Revm and the other main implementations of the EVM, together with a proof of equivalence between them, will enable proving that there cannot be network splits due to nodes disagreeing on the EVM semantics.</p></div></div>
<figure><p><img decoding="async" loading="lazy" alt="Snow forest" src="https://formal.land/assets/images/snow-forest-303a602e7f98ea125e6997305a3ba831.png" width="1024" height="1024" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="general-overview">General overview<a href="https://formal.land/blog/2026/01/16/functional-correctness-static-call-revm#general-overview" class="hash-link" aria-label="Direct link to General overview" title="Direct link to General overview">â€‹</a></h2>
<p>We will step through the three main phases of the translation of Rust to Rocq:</p>
<ol>
<li><strong>Translation:</strong> from the source Rust code to the THIR intermediate representation in Rocq;</li>
<li><strong>Link:</strong> typechecking and naming resolution of the THIR intermediate representation in Rocq;</li>
<li><strong>Simulation:</strong> handling of the control flow and memory mutations to get a purely functional representation in Rocq.</li>
</ol>
<figure><p><img decoding="async" loading="lazy" alt="Diagram" src="https://formal.land/assets/images/diagram-a2fa1be1328bb0156091cb0fe05d79ec.png" width="1600" height="405" class="img_ev3q"></p><figcaption><p><strong>Figure:</strong> High-level overview of the translation phases from the source Rust code to a purely functional representation in Rocq.</p></figcaption></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="source-code">Source code<a href="https://formal.land/blog/2026/01/16/functional-correctness-static-call-revm#source-code" class="hash-link" aria-label="Direct link to Source code" title="Direct link to Source code">â€‹</a></h2>
<p>Here is the body of the function implementing the <code>STATIC_CALL</code> instruction in Revm, from the file <a href="https://github.com/formal-land/revm/blob/80099a7702084332b8de4a99dabe0095b5cde705/crates/interpreter/src/instructions/contract.rs" target="_blank" rel="noopener noreferrer">interpreter/src/instructions/contract.rs</a>:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">static_call</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">WIRE</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">InterpreterTypes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">H</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Host</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token class-name">Sized</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    interpreter</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token class-name">Interpreter</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">WIRE</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token class-name">H</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property" style="color:#36acaa">check!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">interpreter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">BYZANTIUM</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property" style="color:#36acaa">popn!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">local_gas_limit</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> to</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> interpreter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> to </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Address</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">from_word</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">B256</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">from</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">to</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Max gas limit is not possible in real ethereum situation.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> local_gas_limit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">try_from</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">local_gas_limit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">unwrap_or</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">::</span><span class="token constant" style="color:#36acaa">MAX</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token class-name">Some</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> return_memory_offset</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_memory_input_and_out_ranges</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">interpreter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token class-name">Some</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> load</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> host</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">load_account_delegated</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">to</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        interpreter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">control</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">set_instruction_result</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">InstructionResult</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">FatalExternalError</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Set `is_empty` to false as we are not creating this account.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    load</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_empty </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token class-name">Some</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gas_limit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">calc_call_gas</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">interpreter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> load</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> local_gas_limit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property" style="color:#36acaa">gas!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">interpreter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gas_limit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Call host to interact with target contract</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">control</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">set_next_action</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">InterpreterAction</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">NewFrame</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">FrameInput</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Call</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Box</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">CallInputs</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            input</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            gas_limit</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            target_address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> to</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            caller</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">input</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">target_address</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            bytecode_address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> to</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">CallValue</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Transfer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">U256</span><span class="token punctuation" style="color:#393A34">::</span><span class="token constant" style="color:#36acaa">ZERO</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            scheme</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">CallScheme</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">StaticCall</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            is_static</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            is_eof</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return_memory_offset</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">InstructionResult</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">CallOrCreate</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This code contains many difficult parts, including:</p>
<ul>
<li>The use of complex traits, such as <code>InterpreterTypes</code>, relying on associated types and sub-traits;</li>
<li>The use of macros such as <code>gas!</code>, hiding more code than it appears;</li>
<li>Conversions with inference of the target type, through the use of the <code>from</code> and <code>try_from</code> functions;</li>
<li>A bit of control flow with pattern-matching and early returns.</li>
</ul>
<p>Here is our specification in Rocq, from the file <a href="https://github.com/formal-land/rocq-of-rust/blob/main/RocqOfRust/revm/revm_interpreter/instructions/simulate/contract/static_call.v" target="_blank" rel="noopener noreferrer">revm_interpreter/instructions/simulate/contract/static_call.v</a>:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> static_call</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">WIRE H </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Link WIRE</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Link H</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">WIRE_types </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> InterpreterTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">InterpreterTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AreLinks WIRE_types</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">IInterpreterTypes </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> InterpreterTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">C WIRE_types</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">IHost </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Host</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">C H</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">interpreter </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t WIRE WIRE_types</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">host </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> H</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t WIRE WIRE_types </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> H </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  check_macro interpreter SpecId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BYZANTIUM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> interpreter </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">interpreter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> host</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> interpreter </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  popn_macro interpreter </span><span class="token punct punctuation" style="color:#393A34">{|</span><span class="token plain"> Integer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> interpreter </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">interpreter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> host</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> arr interpreter </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> to</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> local_gas_limit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> ArrayPairs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_tuple_rev </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arr</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> to </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Impl_Address</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_word </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Impl_From_U256_for_FixedBytes_32</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from to</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> local_gas_limit </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Impl_Result_T_E</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">unwrap_or</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TryFrom_Uint_for_u64</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">try_from local_gas_limit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Impl_u64</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MAX </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> call_helpers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_memory_input_and_out_ranges interpreter </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">None</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> interpreter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">interpreter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> host</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Some </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> return_memory_offset</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> interpreter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> IHost</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Host</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load_account_delegated</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> host to </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">None</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> host</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> control </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      IInterpreterTypes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">InterpreterTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Loop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Loop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_instruction_result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        interpreter</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">control</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        instruction_result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">InstructionResult</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FatalExternalError </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> interpreter </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      interpreter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">control </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> control </span><span class="token operator" style="color:#393A34">|</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">interpreter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> host</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Some load</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> host</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> load </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> load </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> AccountLoad</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_empty </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> false </span><span class="token operator" style="color:#393A34">|</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> call_helpers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">calc_call_gas interpreter load false local_gas_limit </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">None</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> interpreter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">interpreter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> host</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Some gas_limit</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> interpreter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  gas_macro interpreter gas_limit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> interpreter </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">interpreter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> host</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> interpreter </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> control </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IInterpreterTypes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">InterpreterTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Loop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Loop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_next_action</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      interpreter</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">control</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">interpreter_action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">InterpreterAction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NewFrame</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">interpreter_action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FrameInput</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Call</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Impl_Box</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">new</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punct punctuation" style="color:#393A34">{|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              call_inputs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallInputs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bytecode_address </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> to</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              call_inputs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallInputs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">caller </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                InputTraits</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">target_address interpreter</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">input</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              call_inputs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallInputs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gas_limit </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> gas_limit</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              call_inputs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallInputs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">input </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> input</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              call_inputs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallInputs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_eof </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              call_inputs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallInputs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_static </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              call_inputs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallInputs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">return_memory_offset </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> return_memory_offset</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              call_inputs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallInputs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">scheme </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> call_inputs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallScheme</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StaticCall</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              call_inputs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallInputs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">target_address </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> to</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              call_inputs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallInputs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> call_inputs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallValue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Transfer Impl_Uint</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZERO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      instruction_result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">InstructionResult</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallOrCreate </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> interpreter </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    interpreter </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">control </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> control </span><span class="token operator" style="color:#393A34">|</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">interpreter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> host</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">end</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">end</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We aim to keep the structure of the Rust code, using the <code>check_macro</code> and <code>popn_macro</code> functions to also reproduce the Rust macros. The added verbosity is essentially due to Rocq notations being heavier, in particular to manipulate structures or to call trait methods, as well as making the state manipulation explicit.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="translation-of-the-thir">Translation of the THIR<a href="https://formal.land/blog/2026/01/16/functional-correctness-static-call-revm#translation-of-the-thir" class="hash-link" aria-label="Direct link to Translation of the THIR" title="Direct link to Translation of the THIR">â€‹</a></h2>
<p>Running the command <code>cargo rocq-of-rust</code>, after installing the tool, automatically extracts the THIR intermediate representation of the Rust code of Revm to Rocq. The representation is typically very verbose, with around 1,000 lines, for example, for the <code>STATIC_CALL</code> function. You can look at the extracted code in <a href="https://github.com/formal-land/rocq-of-rust/blob/main/RocqOfRust/revm/revm_interpreter/instructions/contract.v" target="_blank" rel="noopener noreferrer">revm_interpreter/instructions/contract.v</a>. This is mostly a deep-embedding; it starts like this:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> static_call </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Îµ </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ï„ </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Î± </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> Îµ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Ï„</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Î± </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> WIRE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> H </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> interpreter</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> host </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">monadic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> interpreter </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path </span><span class="token string" style="color:#e3116c">"&amp;mut"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path </span><span class="token string" style="color:#e3116c">"revm_interpreter::interpreter::Interpreter"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> WIRE </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              interpreter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> host </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path </span><span class="token string" style="color:#e3116c">"&amp;mut"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> H </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> host </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">catch_return </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tuple </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">monadic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tuple </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">match_operator </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tuple </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tuple </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tuple </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> Î³ </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">monadic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> Î³ </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">use</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path </span><span class="token string" style="color:#e3116c">"bool"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">call_closure </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path </span><span class="token string" style="color:#e3116c">"bool"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  </span><span class="token keyword" style="color:#00009f">UnOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">not</span><span class="token punctuation" style="color:#393A34">,</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To make it understandable, we make a proof by refinement, where we prove in a few steps that the code is equivalent to a simpler version, until arriving at the functional specification.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="typing">Typing<a href="https://formal.land/blog/2026/01/16/functional-correctness-static-call-revm#typing" class="hash-link" aria-label="Direct link to Typing" title="Direct link to Typing">â€‹</a></h2>
<p>Even if the extracted code contains the type annotations from the Rust compiler (the letter T of THIR stands for Type), the extracted code is, for now, untyped, and all the values are in the special type <code>Value.t</code> representing all possible Rust values. We do a first pass where we type all the code using user-provided Rocq types representing the Rust values of interest.</p>
<p>For example, for the Rust type:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">enum</span><span class="token plain"> </span><span class="token type-definition class-name">Ordering</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Less</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Equal</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Greater</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>we will provide the Rocq type:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Ordering</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Less</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Equal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Greater</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>with an injection&nbsp;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Ï†</mi></mrow><annotation encoding="application/x-tex">\varphi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">Ï†</span></span></span></span> to go to the type of Rust values:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Ï† x </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> x </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Less </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StructTuple </span><span class="token string" style="color:#e3116c">"core::cmp::Ordering::Less"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Equal </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StructTuple </span><span class="token string" style="color:#e3116c">"core::cmp::Ordering::Equal"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Greater </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StructTuple </span><span class="token string" style="color:#e3116c">"core::cmp::Ordering::Greater"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The bulk of the type-checking phase is about showing that we can view all the untyped values as images of typed values, both for the inputs and outputs of functions, through the canonical injection&nbsp;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Ï†</mi></mrow><annotation encoding="application/x-tex">\varphi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">Ï†</span></span></span></span> defined for each type.</p>
<p>Here is the typing statement for the <code>STATIC_CALL</code> function, from the file <a href="https://github.com/formal-land/rocq-of-rust/blob/main/RocqOfRust/revm/revm_interpreter/instructions/links/contract/static_call.v" target="_blank" rel="noopener noreferrer">revm_interpreter/instructions/links/contract/static_call.v</a>:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Instance</span><span class="token plain"> run_static_call</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">WIRE H </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Link WIRE</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Link H</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">WIRE_types </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> InterpreterTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">InterpreterTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AreLinks WIRE_types</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">H_types </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Host</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Host</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AreLinks H_types</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">run_InterpreterTypes_for_WIRE </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> InterpreterTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Run WIRE WIRE_types</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">run_Host_for_H </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Host</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Run H H_types</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">interpreter </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">'</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">mut </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t WIRE WIRE_types</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">host </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">'</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">mut H</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instructions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">contract</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">static_call </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> Î¦ WIRE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> Î¦ H </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> Ï† interpreter</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> Ï† host </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    unit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Proof</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  constructor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  destruct </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TryFrom_Uint_for_u64</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">method_try_from</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BITS </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punct punctuation" style="color:#393A34">{|</span><span class="token plain"> Integer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">256</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">LIMBS </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punct punctuation" style="color:#393A34">{|</span><span class="token plain"> Integer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  run_symbolic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Defined</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token attribute attr-name" style="color:#00a4db">Global</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Opaque</span><span class="token plain"> run_static_call</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Most of the proof is automated in the <code>run_symbolic</code> tactic, once we have properly declared the corresponding Rocq types and expressed the Rust traits as Rocq typeclasses.</p>
<p>Essentially, for a function <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span></span></span></span> from <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal">A</span></span></span></span> to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.05017em">B</span></span></span></span>, we show that:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">âˆ€</mi><mtext>â€‰</mtext><mo stretchy="false">(</mo><mi>x</mi><mo>:</mo><mi>A</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mtext>&nbsp;</mtext><mi mathvariant="normal">âˆƒ</mi><mtext>â€‰</mtext><mo stretchy="false">(</mo><mi>y</mi><mo>:</mo><mi>B</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace width="1em"></mspace><mi>f</mi><mo stretchy="false">(</mo><msub><mi>Ï†</mi><mi>A</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>=</mo><msub><mi>Ï†</mi><mi>B</mi></msub><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">  \forall\,(x : A),\ \exists\,(y : B), \quad f (Ï†_A(x)) = Ï†_B(y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">âˆ€</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">A</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace">&nbsp;</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">âˆƒ</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.05017em">B</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em"></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">Ï†</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">))</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal">Ï†</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em">B</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="mclose">)</span></span></span></span></span>
<p>with a constructive proof enabling the computation of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.03588em">y</span></span></span></span> from <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">x</span></span></span></span>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="memory">Memory<a href="https://formal.land/blog/2026/01/16/functional-correctness-static-call-revm#memory" class="hash-link" aria-label="Direct link to Memory" title="Direct link to Memory">â€‹</a></h2>
<p>We do not print the code of the typed version of <code>static_call</code>, as this code can be extremely verbose! But we will step through it, using a semantics where we allocate local values on the stack, to show that the typed code is equivalent to the functional specification above. In this phase, we:</p>
<ul>
<li>Convert the control flow of Rust, with its <code>match</code>, <code>return</code>, ... operators to Rocq ones;</li>
<li>Convert the use of stack-allocated (and sometimes heap-allocated) values to Rocq values, which are implicitly allocated, as this is a functional language.</li>
</ul>
<p>Depending on the code, we will structure it using a state and/or error monad. The statement for the equivalence, from the file <a href="https://github.com/formal-land/rocq-of-rust/blob/main/RocqOfRust/revm/revm_interpreter/instructions/simulate/contract/static_call.v" target="_blank" rel="noopener noreferrer">revm_interpreter/instructions/simulate/contract/static_call.v</a>, is:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Lemma</span><span class="token plain"> static_call_eq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">WIRE H </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Link WIRE</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Link H</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">WIRE_types </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> InterpreterTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">InterpreterTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AreLinks WIRE_types</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">H_types </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Host</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Host</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AreLinks H_types</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">run_InterpreterTypes_for_WIRE </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> InterpreterTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Run WIRE WIRE_types</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">run_Host_for_H </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Host</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Run H H_types</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">IInterpreterTypes </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> InterpreterTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">C WIRE_types</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">InterpreterTypesEq </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      InterpreterTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Eq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t WIRE WIRE_types run_InterpreterTypes_for_WIRE IInterpreterTypes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">IHost </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Host</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">C H</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HostEq </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Host</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Eq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t IHost</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">interpreter </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t WIRE WIRE_types</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">host </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> H</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> ref_interpreter </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> make_ref </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> ref_host </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> make_ref </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SimulateM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">eval_f </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      run_static_call</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        run_InterpreterTypes_for_WIRE run_Host_for_H ref_interpreter ref_host</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">interpreter</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> host</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">stack ðŸŒ²</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Output</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Success tt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">interpreter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> host</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> static_call interpreter host </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">interpreter</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> host</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">stack</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>where the function <code>run_static_call</code> is the typed version of the code extracted by <code>rocq-of-rust</code>, and <code>static_all</code> is our functional specification.</p>
<p>The notation:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> e ðŸŒ² v </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>means that the monadic expression <code>e</code> evaluates to the purely functional value <code>v</code>.</p>
<p>The proof is done by stepping through each functional call or branching of the code of <code>static_call</code>. We could automate the proof further, but for now, we still step manually through the code for better control. Here is an extract from the proof:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">eapply Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Call</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> Impl_From_U256_for_FixedBytes_32</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_eq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eapply Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Call</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> Impl_Address</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_word_eq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eapply Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Call</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> TryFrom_Uint_for_u64</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">try_from_eq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>stepping through the function calls for:</p>
<ul>
<li><code>B256::from(...)</code></li>
<li><code>Address::from_word(...)</code></li>
<li><code>u64::try_from(...)</code></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ï¸-conclusion">âœ’ï¸ Conclusion<a href="https://formal.land/blog/2026/01/16/functional-correctness-static-call-revm#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to âœ’ï¸ Conclusion" title="Direct link to âœ’ï¸ Conclusion">â€‹</a></h2>
<p>We have seen how to formally verify the functional correctness of the Rust implementation for the <code>STATIC_CALL</code> instruction of the EVM using <code>rocq-of-rust</code>. These techniques are general, and enable the formal verification at scale of programs for a large subset of Rust, for arbitrary security properties using the theorem prover Rocq.</p>
<blockquote>
<p>You want to secure critical applications? Discuss with us to know what is possible at <a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a>.</p>
</blockquote>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Socials</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more!</em></p></div></div>]]></content:encoded>
            <category>Rust</category>
            <category>EVM</category>
            <category>rocq-of-rust</category>
            <category>functional correctness</category>
        </item>
        <item>
            <title><![CDATA[ðŸ¥· Formal verification of the Keccak precompile from Plonky3]]></title>
            <link>https://formal.land/blog/2026/01/14/formal-verification-keccak-plonky3</link>
            <guid>https://formal.land/blog/2026/01/14/formal-verification-keccak-plonky3</guid>
            <pubDate>Wed, 14 Jan 2026 00:00:00 GMT</pubDate>
            <description><![CDATA[In this blog post, we present our work to formally verify the determinism of the Keccak precompile ZK circuits in Plonky3 using our ðŸ€&nbsp;Garden framework.]]></description>
            <content:encoded><![CDATA[<p>In this blog post, we present our work to formally verify the determinism of the Keccak precompile ZK circuits in <a href="https://github.com/Plonky3/Plonky3" target="_blank" rel="noopener noreferrer">Plonky3</a> using our <a href="https://github.com/formal-land/garden" target="_blank" rel="noopener noreferrer">ðŸ€&nbsp;Garden</a> framework.</p>
<p>Concretely, this means that:</p>
<ul>
<li>This complex circuit is safe for use with all the zkVMs based on Plonky3.</li>
<li>The ðŸ€&nbsp;Garden framework is very expressive and can verify arbitrary circuits, as optimized precompiles are one of the most complex ZK circuits.</li>
</ul>
<p>The formal verification of the determinism of ZK circuits is important, as this is one of the main sources of critical bugs in zkVMs, and these bugs cannot be found by other means, like testing, while most of the unverified zkVMs have at least one such bug.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>This work was funded by a grant from the <a href="https://ethereum.foundation/" target="_blank" rel="noopener noreferrer">Ethereum Foundation</a> to whom we are thankful, as part of the <a href="https://verified-zkevm.org/" target="_blank" rel="noopener noreferrer">zkEVM Formal Verification Project</a>, to "accelerate the application of formal verification methods to zkEVMs".</p></div></div>
<figure><p><img decoding="async" loading="lazy" alt="Snow forest" src="https://formal.land/assets/images/snow-forest-fa8700350aa2ddfe8b2fa792e6793b89.png" width="1024" height="1024" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="source-code">Source code<a href="https://formal.land/blog/2026/01/14/formal-verification-keccak-plonky3#source-code" class="hash-link" aria-label="Direct link to Source code" title="Direct link to Source code">â€‹</a></h2>
<p>The code of the Keccak circuit in Plonky3 is in <a href="https://github.com/Plonky3/Plonky3/blob/main/keccak-air/src/air.rs" target="_blank" rel="noopener noreferrer">keccak-air/src/air.rs</a>. This is a Rust code generating a list of polynomial constraints whose unique solution is the Keccak hash of the input. Here is an extract for one of the loops:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> x </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">..</span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    builder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">assert_bools</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">local</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    builder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">assert_zeros</span><span class="token punctuation" style="color:#393A34">::</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token namespace" style="opacity:0.7">array</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token function" style="color:#d73a49">from_fn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token closure-params">z</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> xor </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> local</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">into</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">xor3</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">local</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">into</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">local</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">z </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">63</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">into</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        local</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c_prime</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> xor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here is our translation in the formal language <a href="https://rocq-prover.org/" target="_blank" rel="noopener noreferrer">Rocq</a> that we use for Garden, from the file <a href="https://github.com/formal-land/garden/blob/main/Garden/Plonky3/keccak/air.v" target="_blank" rel="noopener noreferrer">Garden/Plonky3/keccak/air.v</a>:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> eval </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">local </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> KeccakCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t unit </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">for_in_zero_to_n </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> x </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">assert_bools </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">KeccakCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">assert_zeros </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">N </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punct punctuation" style="color:#393A34">{|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get z </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> xor </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          xor3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">KeccakCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">KeccakCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> mod </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">KeccakCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> mod </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">z </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">63</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> mod </span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">KeccakCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c_prime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">F xor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Note that the style is very similar to the Rust code. The variables, or columns since they are in a matrix, are described in <a href="https://github.com/Plonky3/Plonky3/blob/main/keccak-air/src/columns.rs" target="_blank" rel="noopener noreferrer">keccak-air/src/columns.rs</a>. For example, there is:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">KeccakCols</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> step_flags</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NUM_ROUNDS</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> export</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> preimage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">U64_LIMBS</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">U64_LIMBS</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> c_prime</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> a_prime</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> a_prime_prime</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">U64_LIMBS</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> a_prime_prime_0_0_bits</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> a_prime_prime_prime_0_0_limbs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">U64_LIMBS</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>that we translate in <a href="https://github.com/formal-land/garden/blob/main/Garden/Plonky3/keccak/columns.v" target="_blank" rel="noopener noreferrer">Garden/Plonky3/keccak/columns.v</a> to:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> KeccakCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Record</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    step_flags </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Z NUM_ROUNDS</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    export </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    preimage </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Z U64_LIMBS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    a </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Z U64_LIMBS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    c </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Z </span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    c_prime </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Z </span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    a_prime </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Z </span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    a_prime_prime </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Z U64_LIMBS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    a_prime_prime_0_0_bits </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Z </span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    a_prime_prime_prime_0_0_limbs </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Z U64_LIMBS</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="correction-of-the-translation">Correction of the translation<a href="https://formal.land/blog/2026/01/14/formal-verification-keccak-plonky3#correction-of-the-translation" class="hash-link" aria-label="Direct link to Correction of the translation" title="Direct link to Correction of the translation">â€‹</a></h2>
<p>How do we know that our formal representation of the Keccak circuit in Rocq is the same as in Rust? To make sure they are the same, without resorting to a complex formalization of the Rust code of Plonky3, we rely on the fact that circuits are lists of polynomial equations, which can be compared once we extend all the definitions.</p>
<p>To that end, we implement both in Plonky3 and Rocq a pretty-printing function for circuits as polynomials, using the same format to make sure both definitions are the same. We found a few mistakes in our manual translation, but they were quick to fix (less than one hour of work). You can get more information about the pretty-printing in Rust in our previous blog post <a href="https://formal.land/blog/2025/08/26/pretty-printing-rust-constraints">ðŸ¥· Pretty-printing of Rust ZK constraints</a>. For Rocq, there is an extra step to go from our shallow representation of the circuits to a deep embedding using a tactic. You can look at the file <a href="https://github.com/formal-land/garden/blob/main/Garden/Plonky3/keccak/pretty_print.v" target="_blank" rel="noopener noreferrer">Garden/Plonky3/keccak/pretty_print.v</a> for the details.</p>
<p>The file with all the pretty-printed polynomials is <a href="https://github.com/formal-land/garden/blob/main/Garden/Plonky3/keccak/air.snapshot" target="_blank" rel="noopener noreferrer">Garden/Plonky3/keccak/air.snapshot</a>, containing about 100,000 lines.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="giving-a-semantics-to-the-circuit">Giving a semantics to the circuit<a href="https://formal.land/blog/2026/01/14/formal-verification-keccak-plonky3#giving-a-semantics-to-the-circuit" class="hash-link" aria-label="Direct link to Giving a semantics to the circuit" title="Direct link to Giving a semantics to the circuit">â€‹</a></h2>
<p>We use the semantics rules defined on the Garden monad in <a href="https://github.com/formal-land/garden/blob/main/Garden/Plonky3/M.v" target="_blank" rel="noopener noreferrer">Garden/Plonky3/M.v</a> to give a semantics to the circuit. This part is mostly automated, and reformulates the imperative code of the circuit in propositional formulas on the variables of the circuit.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="core-verification">Core verification<a href="https://formal.land/blog/2026/01/14/formal-verification-keccak-plonky3#core-verification" class="hash-link" aria-label="Direct link to Core verification" title="Direct link to Core verification">â€‹</a></h2>
<p>In order to represent bitwise operations of the hash function Keccak in a very optimized way, the Plonky3 implementation uses a lot of tricks, like representing XOR operations as a succession of multiplications and substractions. Some of the constraints are also not appearing in the natural order of definition for the Keccak steps, and only make sense when we assemble all of them together.</p>
<p>The core property, given in <a href="https://github.com/formal-land/garden/blob/main/Garden/Plonky3/keccak/proofs/air.v" target="_blank" rel="noopener noreferrer">Garden/Plonky3/keccak/proofs/air.v</a>, is as follows:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Lemma</span><span class="token plain"> from_implies_to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">local </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> KeccakCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t bool </span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">From</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t local a </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">To</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t local a</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here <code>From.t</code> and <code>To.t</code> are two propositions expressing the constraints in the order in which they appear in the circuit, and in the expected order for the canonical Keccak definition, respectively. We also check the formula for the XORs as substractions:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Lemma</span><span class="token plain"> xor_sum_diff_eq </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">H_p </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">local </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> KeccakCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x z </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">H_a_prime_bools </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> IsBool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">KeccakCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">a_prime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">H_c_prime_bools </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> IsBool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">KeccakCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c_prime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">H_sum_diff </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> diff </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> sum </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          a_prime_c_prime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_sum </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">KeccakCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">a_prime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">KeccakCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">a_prime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">KeccakCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">a_prime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">KeccakCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">a_prime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">KeccakCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">a_prime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sum </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">F </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">KeccakCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c_prime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      diff </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">F </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">diff </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">F </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">F </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">diff </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">F </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> x </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> z </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">KeccakCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c_prime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">b2z </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">xorbs </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">odd </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">KeccakCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">a_prime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">odd </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">KeccakCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">a_prime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">odd </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">KeccakCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">a_prime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">odd </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">KeccakCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">a_prime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">odd </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">KeccakCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">a_prime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We make a general proof, only requiring that the prime order <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span> of the field is greater than <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>6</mn></mrow><annotation encoding="application/x-tex">6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">6</span></span></span></span>, but there is also a simpler proof that takes the specific prime of a circuit like Goldilocks, and tests all possible combinations of boolean inputs. This is pretty efficient as there are only six boolean values as parameters of this formula.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="one-round">One round<a href="https://formal.land/blog/2026/01/14/formal-verification-keccak-plonky3#one-round" class="hash-link" aria-label="Direct link to One round" title="Direct link to One round">â€‹</a></h2>
<p>We make a reference definition of Keccak using boolean values and straightforward definitions. Here is an example of a sub-step:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> compute_a_prime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t bool </span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t bool </span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t bool </span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punct punctuation" style="color:#393A34">{|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get y </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punct punctuation" style="color:#393A34">{|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get x </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punct punctuation" style="color:#393A34">{|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get z </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          xorbs </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> mod </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> mod </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">z </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">63</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> mod </span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Then we show that combining all the equations of the circuit, the only possible solution, if it exists, is the same as one round of the canonical Keccak definition. The whole lemma is:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Lemma</span><span class="token plain"> post_implies_round_computation </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">local</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> next</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> KeccakCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">is_first_row is_transition </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t bool </span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">round </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> local </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">map_mod local</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> next </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">map_mod next</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Post</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t local next is_first_row is_transition </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Valid</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t local a </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> round </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> NUM_ROUNDS </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  step_flags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Valid</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t local round </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> c </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> ComputeKeccak</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compute_c a </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> c_prime </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> ComputeKeccak</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compute_c_prime c </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> a_prime </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> ComputeKeccak</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compute_a_prime a c </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> b </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> ComputeKeccak</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compute_b a_prime </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> a_prime_prime </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> ComputeKeccak</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compute_a_prime_prime b </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> a_prime_prime_prime_0_0 </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> ComputeKeccak</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compute_a_prime_prime_prime_0_0 a_prime_prime round </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">forall</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> x </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">forall</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> y </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">forall</span><span class="token plain"> limb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> limb </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> U64_LIMBS </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Impl_KeccakCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">a_prime_prime_prime local y x limb </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Limbs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">of_bools BITS_PER_LIMB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ComputeKeccak</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compute_a_prime_prime_prime a_prime_prime a_prime_prime_prime_0_0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      limb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It uses the core verification lemmas made just before to handle all the tricks of the Keccak circuit.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="all-the-rounds">All the rounds<a href="https://formal.land/blog/2026/01/14/formal-verification-keccak-plonky3#all-the-rounds" class="hash-link" aria-label="Direct link to All the rounds" title="Direct link to All the rounds">â€‹</a></h2>
<p>The Keccak hash function runs by applying the same round several times. There are some polynomial constraints to handle these iterations, by counting the number of steps and making sure we start each new round from the result of the previous round.</p>
<p>Here is the final statement, ensuring the safety of the circuit:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">(** We are computing a full round of Keccak every [NUM_ROUNDS] rows. *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Lemma</span><span class="token plain"> posts_imply </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rows</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> KeccakCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">preimages </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t bool </span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> rows i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">map_mod </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rows</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">(* We assume we validated the circuit on all the rows. Note that we assume here that we are</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">       always transitioning. *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">forall</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Post</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rows i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rows </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">(* We assume the preimages are given by the [preimages] function at the beginning of</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">       each round. *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">forall</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    i mod NUM_ROUNDS </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">forall</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> x </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">forall</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> y </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">forall</span><span class="token plain"> limb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> limb </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> U64_LIMBS </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rows i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">KeccakCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">preimage</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">limb</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Limbs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">of_bools BITS_PER_LIMB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">preimages </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> NUM_ROUNDS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      limb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">(* We prove that we get the Keccak output in the [a_prime_prime_prime] array of the</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">       last round. *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">forall</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">forall</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> x </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">forall</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> y </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">forall</span><span class="token plain"> limb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> limb </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> U64_LIMBS </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> final_index </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> NUM_ROUNDS </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> NUM_ROUNDS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">23</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Impl_KeccakCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">a_prime_prime_prime </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rows final_index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> y x limb </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Limbs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">of_bools BITS_PER_LIMB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ComputeKeccak</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compute_keccak </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">preimages </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> NUM_ROUNDS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      limb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We represent the matrix of field variables with indexed columns, in the variable <code>rows : Z -&gt; KeccakCols.t</code>.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Remark</div><div class="admonitionContent_BuS1"><p>In addition to having verified the determinism of the circuit, we have also proven functional correctness. Indeed, we state that if there is a solution, then it must be the same as the canonical definition of Keccak.</p></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Remark</div><div class="admonitionContent_BuS1"><p>We also show that we can optimize the circuit a bit, as we do not rely on all the constraints, in particular the ones related to the <code>preimage</code> column.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ï¸-conclusion">âœ’ï¸ Conclusion<a href="https://formal.land/blog/2026/01/14/formal-verification-keccak-plonky3#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to âœ’ï¸ Conclusion" title="Direct link to âœ’ï¸ Conclusion">â€‹</a></h2>
<p>Verifying the determinism of ZK circuits is mandatory, as this is a major source of vulnerabilities in zkVMs. We have seen here the summary of how to verify a very complex example, with the Keccak circuit of Plonky3 using the Garden framework and theorem proving.</p>
<p>The same principles extend to arbitrary circuits, including RISC-V circuits, other precompiles, and recursion circuits, or circuits containing other primitive operations such as lookups.</p>
<blockquote>
<p>You want to secure your zkVM? Discuss with us to know what is possible! â‡¨ <a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a></p>
</blockquote>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions!</em></p></div></div>]]></content:encoded>
            <category>zkVM</category>
            <category>zero-knowledge</category>
            <category>Plonky3</category>
            <category>Keccak</category>
        </item>
        <item>
            <title><![CDATA[ðŸ¥· Verification of the completeness of an OpenVM chip]]></title>
            <link>https://formal.land/blog/2025/09/02/verification-completeness-open-vm-chip</link>
            <guid>https://formal.land/blog/2025/09/02/verification-completeness-open-vm-chip</guid>
            <pubDate>Tue, 02 Sep 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[In our previous blog post ðŸ¥· Formal verification of an OpenVM chip, we have seen how to verify the determinism of the branch_eq chip of OpenVM. Now, we will see how to verify its completeness, meaning that it always accepts a valid witness for any possible input.]]></description>
            <content:encoded><![CDATA[<p>In our previous blog post <a href="https://formal.land/blog/2025/08/13/verification-of-openvm-branch-eq">ðŸ¥· Formal verification of an OpenVM chip</a>, we have seen how to verify the determinism of the <code>branch_eq</code> chip of OpenVM. Now, we will see how to verify its completeness, meaning that it always accepts a valid witness for any possible input.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>This work was funded by a grant from the <a href="https://ethereum.foundation/" target="_blank" rel="noopener noreferrer">Ethereum Foundation</a> to whom we are thankful, as part of the <a href="https://verified-zkevm.org/" target="_blank" rel="noopener noreferrer">zkEVM Formal Verification Project</a>, to "accelerate the application of formal verification methods to zkEVMs".</p></div></div>
<figure><p><img decoding="async" loading="lazy" alt="Green forest" src="https://formal.land/assets/images/green-forest-c992f0c865d139086d04806ed3dd6de3.png" width="1024" height="1024" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-completeness-for-circuits">ðŸŽ„ Completeness for circuits<a href="https://formal.land/blog/2025/09/02/verification-completeness-open-vm-chip#-completeness-for-circuits" class="hash-link" aria-label="Direct link to ðŸŽ„ Completeness for circuits" title="Direct link to ðŸŽ„ Completeness for circuits">â€‹</a></h2>
<p>The completeness property for a circuit says that for any given set of well-formed input variables, there exists a set of output variables that satisfies the circuit.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Security implications</div><div class="admonitionContent_BuS1"><p>It means that the circuit, generally representing a VM, will never reach a state where it is blocked, which would be a denial of service attack.</p></div></div>
<p>To state this property with quantifiers, let us consider a circuit <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">C</mi></mrow><annotation encoding="application/x-tex">\mathcal{C}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathcal" style="margin-right:0.05834em">C</span></span></span></span> parametrized by some variables that we group into the categories of input, output, and oracle variables (values given by the prover and verified by the circuit to speed up some computations). We say that the circuit is complete if:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">âˆ€</mi><mtext>&nbsp;input</mtext><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mi mathvariant="normal">âˆƒ</mi><mtext>&nbsp;output</mtext><mo separator="true">,</mo><mtext>oracle</mtext><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mi mathvariant="script">C</mi><mo stretchy="false">(</mo><mtext>input</mtext><mo separator="true">,</mo><mtext>output</mtext><mo separator="true">,</mo><mtext>oracle</mtext><mo stretchy="false">)</mo><mtext>&nbsp;holds</mtext></mrow><annotation encoding="application/x-tex">  \forall\ \text{input},\\
  \exists\ \text{output}, \text{oracle},\\
  \mathcal{C}(\text{input}, \text{output}, \text{oracle}) \text{ holds}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord">âˆ€</span><span class="mspace">&nbsp;</span><span class="mord text"><span class="mord">input</span></span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord">âˆƒ</span><span class="mspace">&nbsp;</span><span class="mord text"><span class="mord">output</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord text"><span class="mord">oracle</span></span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathcal" style="margin-right:0.05834em">C</span><span class="mopen">(</span><span class="mord text"><span class="mord">input</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord text"><span class="mord">output</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord text"><span class="mord">oracle</span></span><span class="mclose">)</span><span class="mord text"><span class="mord">&nbsp;holds</span></span></span></span></span></span>
<blockquote>
<p>Now, in our <a href="https://github.com/formal-land/garden" target="_blank" rel="noopener noreferrer">Garden</a> framework for circuits' formal verification, how do we define reasoning rules to show completeness? ðŸ¤”</p>
</blockquote>
<p>In practice, we have an explicit function representing the output variables that we want, as circuits are supposed to be deterministic for security reasons. So showing completeness amounts to verifying that for the expected output of the circuit, all constraints are satisfied.</p>
<p>We define this predicate as follows:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> e âœ… value </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>where <code>e</code> is of type <code>M.t A</code> and <code>value</code> is of type <code>A</code>. It says that a circuit <code>e</code> in closed form, so applied to all its input and output variables, will evaluate to <code>value</code> satisfying all the constraints.</p>
<p>Generally the result value <code>value</code> will be the unit value as circuits do not return anything, but for intermediate circuits it can be a structure of polynomial expressions, composed with other sub-circuits to build the final zkVM circuit.</p>
<p>We define the completeness predicate following the constructors of the monad <code>M.t</code>, with one rule per constructor:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Prop</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Pure </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pure value âœ… value </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> AssertZero </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  x </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AssertZero x value âœ… value </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Call </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> e âœ… value </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Call e âœ… value </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Let</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">B </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t B</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> B</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> B </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value_k </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> e âœ… value </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> k value âœ… value_k </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Let</span><span class="token plain"> e k âœ… value_k </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> When </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">condition </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">condition </span><span class="token operator" style="color:#393A34">&lt;&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> e âœ… value </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">When condition e âœ… value </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here are some comments about the rules:</p>
<ul>
<li><code>Pure</code>: we directly return the value <code>value</code> that we are supposed to return. This is the case for purely functional circuits.</li>
<li><code>AssertZero</code>: we assert that the parameter <code>x</code> is equal to <code>0</code>. This is the main primitive to assert the constraints. We check the equality between the polynomial expression <code>x</code> and <code>0</code> in <code>Z</code> as we compute the modulo after each primitive polynomial operation, and we compare that all operations are correctly applied by comparison with the Rust implementation.</li>
<li><code>Call</code>: this is a utility wrapper to simplify the composition of sub-circuits by giving an explicit way to mark limits. It does nothing except unwrap the <code>M.Call</code> constructor.</li>
<li><code>Let</code>: for the binding constructor, the most important constructor in a monad, we state that a circuit is complete if both the circuits <code>e</code> and <code>k</code> applied to the result of <code>e</code> are complete.</li>
<li><code>When</code>: we conditionally evaluate a sub-circuit <code>e</code> and we assert that it evaluates to <code>value</code>. We show the completeness of <code>e</code> under the condition that <code>condition</code> is not zero. In practice, <code>value</code> will always by the unit value (this is the case on Plonky3 circuits).</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ï¸-for-branch_eq">ðŸ›¡ï¸ For <code>branch_eq</code><a href="https://formal.land/blog/2025/09/02/verification-completeness-open-vm-chip#%EF%B8%8F-for-branch_eq" class="hash-link" aria-label="Direct link to ï¸-for-branch_eq" title="Direct link to ï¸-for-branch_eq">â€‹</a></h2>
<p>If we take again the <code>branch_eq</code> chip of <a href="https://openvm.dev/" target="_blank" rel="noopener noreferrer">OpenVM</a>, located in <a href="https://github.com/openvm-org/openvm/blob/main/extensions/rv32im/circuit/src/branch_eq/core.rs" target="_blank" rel="noopener noreferrer">github.com/openvm-org/openvm/extensions/rv32im/circuit/src/branch_eq/core.rs</a>, we state its completeness as follows:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Lemma</span><span class="token plain"> eval_complete </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime goldilocks_prime</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">NUM_LIMBS </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> BranchEqualCoreAir</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t NUM_LIMBS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Z NUM_LIMBS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Z NUM_LIMBS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">imm</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">diff_inv_marker</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Z NUM_LIMBS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">from_pc</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">branch_equal_opcode </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> BranchEqualOpcode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">H_NUM_LIMBS </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> NUM_LIMBS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> a </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">map_mod a</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> b </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">map_mod b</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> imm </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">map_mod imm</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> diff_inv_marker </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">map_mod diff_inv_marker</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> from_pc </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">map_mod from_pc</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> expected_cmp_result </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> get_expected_cmp_result branch_equal_opcode a b </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> local </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punct punctuation" style="color:#393A34">{|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      BranchEqualCoreCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">a </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      BranchEqualCoreCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">b </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      BranchEqualCoreCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cmp_result </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">b2z expected_cmp_result</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      BranchEqualCoreCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">imm </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> imm</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      BranchEqualCoreCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">opcode_beq_flag </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> branch_equal_opcode </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> BranchEqualOpcode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BEQ </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> BranchEqualOpcode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BNE </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      BranchEqualCoreCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">opcode_bne_flag </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> branch_equal_opcode </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> BranchEqualOpcode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BEQ </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> BranchEqualOpcode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BNE </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      BranchEqualCoreCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">diff_inv_marker </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> diff_inv_marker</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">forall</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">(* We assume a [diff_inv_marker] oracle with the following property *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">H_diff_inv_marker </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Eq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dec a b </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">(* It can be anything in case of equality *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">(* Otherwise it is the inverse of the difference in exactly one case, zero elsewhere *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">exists</span><span class="token plain"> k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> k </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> NUM_LIMBS </span><span class="token operator" style="color:#393A34">/\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">forall</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> NUM_LIMBS </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> k </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">BinOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mul </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">BinOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sub </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> diff_inv_marker</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          diff_inv_marker</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> eval self local from_pc âœ…</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    get_expected_result self local from_pc expected_cmp_result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is a long statement, but here is the gist of it:</p>
<ul>
<li>We expect the final result to be the result of the function <code>get_expected_result</code> applied to its parameters. This represents a structure containing various polynomial expressions, which will be useful later to combine this sub-circuit with others.</li>
<li>The columns <code>a</code>, <code>b</code>, and <code>imm</code> can be anything. They are input variables.</li>
<li>The columns <code>opcode_beq_flag</code> and <code>opcode_bne_flag</code> are also input variables, but must be consistent: only one of them can be equal to <code>1</code>; the other one must be equal to <code>0</code>.</li>
<li>The column <code>diff_inv_marker</code> is an oracle variable. We assume that it has the expected property described by the predicate <code>H_diff_inv_marker</code>. Note that with this statement we do not assume that an oracle value exists, and assume that this is obvious. It could be verified in a second step.</li>
<li>The column <code>cmp_result</code> is the only output variable. We compute it with <code>get_expected_cmp_result</code>, and it must be a boolean (<code>0</code> or <code>1</code> in the field modulo <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span>).</li>
</ul>
<p>This is thanks to the setting of the output value to <code>get_expected_cmp_result</code>, which allows us to execute the circuit and validate all the constraints. The definition of this function is:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> get_expected_cmp_result </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">NUM_LIMBS </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">branch_equal_opcode </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> BranchEqualOpcode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a b </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Z NUM_LIMBS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bool </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> branch_equal_opcode </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> BranchEqualOpcode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BEQ </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Eq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dec a b </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> BranchEqualOpcode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BNE </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Eq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dec a b </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When we have shown the determinism, we also used this function but in the other direction: to show that the constraints of the circuit imply that the output column must be equal to it.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-proof">ðŸ” Proof<a href="https://formal.land/blog/2025/09/02/verification-completeness-open-vm-chip#-proof" class="hash-link" aria-label="Direct link to ðŸ” Proof" title="Direct link to ðŸ” Proof">â€‹</a></h2>
<p>The Rocq proof of the statement above is in <a href="https://github.com/formal-land/garden/blob/main/Garden/OpenVM/BranchEq/core_with_monad.v" target="_blank" rel="noopener noreferrer">Garden/OpenVM/BranchEq/core_with_monad.v</a>. We apply the reasoning rules presented above to step through the definition of the <code>branch_eq</code> circuit. For the main loop, which is parameterized by an arbitrary number of <code>NUM_LIMBS</code>, we make a reasoning by induction to ensure that the constraints <code>M.AssertZero</code> are always satisfied.</p>
<p>Here is an extract of the proof:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">eapply Complete</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> tt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  repeat econstructor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unfold local</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> destruct expected_cmp_result</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> reflexivity</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>to verify the completeness of the line:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">assert_bool local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">BranchEqualCoreCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cmp_result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>by case reasoning over the boolean variable <code>cmp_result</code>.This works as we force the value of this output variable to be a boolean, as the result of the <code>get_expected_cmp_result</code> function lifted to a field element.</p>
<p>There are no automations for now to verify the completeness, but we plan on adding some as we verify more circuits.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ï¸-conclusion">âœ’ï¸ Conclusion<a href="https://formal.land/blog/2025/09/02/verification-completeness-open-vm-chip#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to âœ’ï¸ Conclusion" title="Direct link to âœ’ï¸ Conclusion">â€‹</a></h2>
<p>We have seen here what the definition of completeness is for a circuit, how we define it in our framework Garden through reasoning rules, and how we can verify it for the <code>branch_eq</code> chip of OpenVM.</p>
<blockquote>
<p>You want to secure your zkVM? Discuss with us to check what is possible! â‡¨ <a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a></p>
</blockquote>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions!</em></p></div></div>]]></content:encoded>
            <category>zkVM</category>
            <category>zero-knowledge</category>
            <category>completeness</category>
        </item>
        <item>
            <title><![CDATA[ðŸ¥· Pretty-printing of Rust ZK constraints]]></title>
            <link>https://formal.land/blog/2025/08/26/pretty-printing-rust-constraints</link>
            <guid>https://formal.land/blog/2025/08/26/pretty-printing-rust-constraints</guid>
            <pubDate>Tue, 26 Aug 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Many zkVMs are implemented in Rust, using the Plonky3 library to describe their circuits. While Rust is efficient and expressive for describing complex circuits, it is a complex language when it comes to formal verification. We present here a way to pretty-print the list of constraints generated by a Plonky3 program. That way, we will be able to import the constraints in a formal verification system like Rocq to make sure they are safe and correct.]]></description>
            <content:encoded><![CDATA[<p>Many zkVMs are implemented in Rust, using the <a href="https://github.com/Plonky3/Plonky3" target="_blank" rel="noopener noreferrer">Plonky3</a> library to describe their circuits. While Rust is efficient and expressive for describing complex circuits, it is a complex language when it comes to formal verification. We present here a way to pretty-print the list of constraints generated by a Plonky3 program. That way, we will be able to import the constraints in a formal verification system like <a href="https://rocq-prover.org/" target="_blank" rel="noopener noreferrer">Rocq</a> to make sure they are safe and correct.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>This work was funded by a grant from the <a href="https://ethereum.foundation/" target="_blank" rel="noopener noreferrer">Ethereum Foundation</a> to whom we are thankful, as part of the <a href="https://verified-zkevm.org/" target="_blank" rel="noopener noreferrer">zkEVM Formal Verification Project</a>, to "accelerate the application of formal verification methods to zkEVMs".</p></div></div>
<figure><p><img decoding="async" loading="lazy" alt="Green forest" src="https://formal.land/assets/images/green-forest-64cf93c699ac9003123bf64a9ce3f9e7.png" width="1024" height="1024" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ï¸-plonky3">ðŸ› ï¸ Plonky3<a href="https://formal.land/blog/2025/08/26/pretty-printing-rust-constraints#%EF%B8%8F-plonky3" class="hash-link" aria-label="Direct link to ðŸ› ï¸ Plonky3" title="Direct link to ðŸ› ï¸ Plonky3">â€‹</a></h2>
<p>This is one of the most popular libraries in use to describe circuits for zkVMs, with something like half of the projects using it. The main API to describe circuits is the trait <code>AirBuilder</code> in <a href="https://github.com/Plonky3/Plonky3/blob/main/air/src/air.rs" target="_blank" rel="noopener noreferrer">air/src/air.rs</a>, which we summarize and simplify here:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">trait</span><span class="token plain"> </span><span class="token type-definition class-name">AirBuilder</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Sized</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// Field element</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token type-definition class-name">F</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// Variable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token type-definition class-name">Var</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// Polynomial expression</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token type-definition class-name">Expr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// Matrix of the trace</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token type-definition class-name">M</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Matrix</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Var</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// Return the matrix representing the main (primary) trace registers.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">M</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// Expression evaluating to 1 on the first row, 0 elsewhere.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">is_first_row</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Expr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// Expression evaluating to 1 on the last row, 0 elsewhere.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">is_last_row</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Expr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// Expression evaluating to 1 on all transition rows (not last row), 0 on last row.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">is_transition</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Expr</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// Returns a sub-builder whose constraints are enforced only when `condition` is nonzero.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">when</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">I</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Into</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Expr</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> condition</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">I</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">FilteredAirBuilder</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token lifetime-annotation symbol" style="color:#36acaa">'_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Self</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// Assert that the given element is zero.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">///</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// Where possible, batching multiple assert_zero calls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// into a single assert_zeros call will improve performance.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">assert_zero</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">I</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Into</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Expr</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">I</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>From the <code>assert_zero</code> function, we can build all the other assertion operators, like <code>assert_bool</code> or <code>assert_eq</code>. These assertions, creating polynomial equations, will be applied to expressions built from the variables of the trace returned by the <code>main</code> function. Some special expressions <code>is_first_row</code>, <code>is_last_row</code>, and <code>is_transition</code> help state how to initialize the trace and transition between rows. Finally, the <code>when</code> function can be seen as a convenient helper with:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">air_builder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">when</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">condition</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">assert_zero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">expr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>behaving like:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">air_builder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">assert_zero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">condition </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> expr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>since:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mtext>condition</mtext><mo>â‹…</mo><mtext>expr</mtext></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mn>0</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mo>â‡”</mo><mtext>condition</mtext><mo mathvariant="normal">â‰ </mo><mn>0</mn><mo>â‡’</mo><mtext>expr</mtext></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mn>0</mn></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">  \begin{align*}
    \text{condition} \cdot \text{expr} &amp;= 0 \\
    \Leftrightarrow \text{condition} \neq 0 \Rightarrow \text{expr} &amp;= 0
  \end{align*}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.75em"><span style="top:-3.91em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord text"><span class="mord">condition</span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord text"><span class="mord">expr</span></span></span></span><span style="top:-2.41em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mrel">â‡”</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mord text"><span class="mord">condition</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel"><span class="mrel"><span class="mord vbox"><span class="thinbox"><span class="rlap"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="inner"><span class="mord"><span class="mrel">î€ </span></span></span><span class="fix"></span></span></span></span></span><span class="mrel">=</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">â‡’</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mord text"><span class="mord">expr</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.25em"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.75em"><span style="top:-3.91em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mord">0</span></span></span><span style="top:-2.41em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mord">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.25em"><span></span></span></span></span></span></span></span></span></span></span></span>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-storing-the-constraints">ðŸ“š Storing the constraints<a href="https://formal.land/blog/2025/08/26/pretty-printing-rust-constraints#-storing-the-constraints" class="hash-link" aria-label="Direct link to ðŸ“š Storing the constraints" title="Direct link to ðŸ“š Storing the constraints">â€‹</a></h2>
<p>Thanks to this modular architecture in Plonky3, we can provide a mock implementation of the <code>AirBuilder</code> trait, which will be used to pretty-print the constraints. We implement each primitive operation by saving the parameters in a list, so that at the end of the construction of a circuit, we obtain a list of constraints. For the representation of expressions, we use the existing <code>SymbolicExpression</code> implementation. Here is our current implementation of <code>AirBuilder</code>:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">RocqAirBuilder</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// A matrix of variables, to be built with variables with an</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// id numbering from 0 to width * height - 1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    main</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">RowMajorMatrix</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">SymbolicVariable</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Goldilocks</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// A list of constraints, each one being a polynomial equation of</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// an expression equal to zero</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    constraints</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Constraint</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">SymbolicExpression</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Goldilocks</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">impl</span><span class="token plain"> </span><span class="token class-name">AirBuilder</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token class-name">RocqAirBuilder</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token type-definition class-name">F</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Goldilocks</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token type-definition class-name">Expr</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">SymbolicExpression</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">F</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token type-definition class-name">Var</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">SymbolicVariable</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">F</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token type-definition class-name">M</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">RowMajorMatrix</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Var</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">Self</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token class-name">AirBuilder</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">M</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">main</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">is_first_row</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">Self</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token class-name">AirBuilder</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Expr</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">SymbolicExpression</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">IsFirstRow</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">is_last_row</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">Self</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token class-name">AirBuilder</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Expr</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">SymbolicExpression</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">IsLastRow</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">is_transition_window</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">Self</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token class-name">AirBuilder</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Expr</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">SymbolicExpression</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">IsTransition</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">assert_zero</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">I</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> expr</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">I</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">I</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Into</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Expr</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// We store the constraint in a list, to be printed at the end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">constraints</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Constraint</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">AssertZero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">expr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">into</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As this is convenient when the list of constraints is long (in the tens of thousands for a typical precompile), we also add a logging function:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">impl</span><span class="token plain"> </span><span class="token class-name">LoggingAirBuilder</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token class-name">RocqAirBuilder</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">log_in_constraints</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">constraints</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Constraint</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Message</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">to_string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>to display a string marker at any point in the code.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-pretty-printing">ðŸŽ¨ Pretty-printing<a href="https://formal.land/blog/2025/08/26/pretty-printing-rust-constraints#-pretty-printing" class="hash-link" aria-label="Direct link to ðŸŽ¨ Pretty-printing" title="Direct link to ðŸŽ¨ Pretty-printing">â€‹</a></h2>
<p>We display the list of constraints on the standard output, so that they can be saved in a snapshot file. We take care of having an output that is regular and readable. The transformation we make is that we flatten the application of the associative binary operators <code>+</code> and <code>*</code> so that they get applied to a list of operands instead of two. This tends to flatten the output and increase the readability in our experience.</p>
<p>Here is a typical output:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Trace ðŸ¾</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Message ðŸ¦œ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    eval_row</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Message ðŸ¦œ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    eval_row::flags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AssertZero:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mul:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Variable: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Sub:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Variable: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Constant: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AssertZero:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mul:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Variable: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Sub:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Variable: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Constant: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AssertZero:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mul:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Variable: 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Sub:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Variable: 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Constant: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AssertZero:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mul:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Add:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Variable: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Variable: 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Sub:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Add:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Variable: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Variable: 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Constant: 1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We annotate the user messages with a ðŸ¦œ to make them easier to find in the list of constraints. The variables are all identified by their <em>id</em> in the trace, which is a number from <code>0</code> to <code>width * height - 1</code>. We flatten the consecutive applications of binary operators, like in:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">AssertZero:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Mul:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Variable: 459</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Constant: 18446462594437939201</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Sub:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Add:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Variable: 808</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Constant: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mul:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Variable: 11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Constant: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mul:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Variable: 12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Constant: 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mul:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Variable: 13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Constant: 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mul:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Variable: 14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Constant: 8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mul:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Variable: 15</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Constant: 16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mul:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Variable: 16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Constant: 32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mul:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Variable: 17</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Constant: 64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mul:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Variable: 18</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Constant: 128</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mul:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Variable: 19</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Constant: 256</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mul:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Variable: 20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Constant: 512</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mul:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Variable: 21</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Constant: 1024</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mul:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Variable: 22</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Constant: 2048</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mul:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Variable: 23</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Constant: 4096</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mul:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Variable: 24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Constant: 8192</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mul:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Variable: 25</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Constant: 16384</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mul:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Variable: 26</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Constant: 32768</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Constant: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Add:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Constant: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mul:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Variable: 782</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Constant: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Mul:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Variable: 783</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Constant: 256</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Note that the large constant <code>18446462594437939201</code> is the inverse of <code>2</code> for the Goldilocks prime.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>There are other kinds of constraints, like lookups, which we do not show here.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ï¸-conclusion">âœ’ï¸ Conclusion<a href="https://formal.land/blog/2025/08/26/pretty-printing-rust-constraints#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to âœ’ï¸ Conclusion" title="Direct link to âœ’ï¸ Conclusion">â€‹</a></h2>
<p>We have seen here how to output the definition of a Plonky3 circuit in a readable, and sometimes verbose, text format.</p>
<p>Next, we will see how to connect this representation to the Rocq formalization of a circuit, to make sure we are verifying the right implementation.</p>
<blockquote>
<p>You want to secure your zkVM? Discuss to check what is possible! â‡¨ <a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a></p>
</blockquote>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions!</em></p></div></div>]]></content:encoded>
            <category>zkVM</category>
            <category>zero-knowledge</category>
            <category>contraints</category>
        </item>
        <item>
            <title><![CDATA[ðŸ¥· Formal verification of an OpenVM chip]]></title>
            <link>https://formal.land/blog/2025/08/13/verification-of-openvm-branch-eq</link>
            <guid>https://formal.land/blog/2025/08/13/verification-of-openvm-branch-eq</guid>
            <pubDate>Wed, 13 Aug 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[In this blog post, we present the formal verification of the determinism of the BranchEq circuit of the OpenVM zkVM. This zkVM provides an implementation of RISC-V with Plonky3, and appears to be very fast even on a CPU.]]></description>
            <content:encoded><![CDATA[<p>In this blog post, we present the formal verification of the determinism of the <a href="https://github.com/openvm-org/openvm/blob/main/extensions/rv32im/circuit/src/branch_eq/core.rs" target="_blank" rel="noopener noreferrer">BranchEq</a> circuit of the <a href="https://openvm.dev/" target="_blank" rel="noopener noreferrer">OpenVM</a> zkVM. This zkVM provides an implementation of RISC-V with <a href="https://github.com/Plonky3/Plonky3" target="_blank" rel="noopener noreferrer">Plonky3</a>, and appears to be very fast even on a CPU.</p>
<p>We do our verification work using the formal verification system <a href="https://rocq-prover.org/" target="_blank" rel="noopener noreferrer">Rocq</a>, showing the determinism on a model of the code. To see the other properties that can be verified, you can refer to our previous blog post <a href="https://formal.land/blog/2025/08/12/verification-of-zkvm">ðŸ¦„ What to verify in a zkVM</a>. We will see later how to make sure that the Rocq model corresponds to the actual Rust implementation of the circuit.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>This work was funded by a grant from the <a href="https://ethereum.foundation/" target="_blank" rel="noopener noreferrer">Ethereum Foundation</a> to whom we are thankful, as part of the <a href="https://verified-zkevm.org/" target="_blank" rel="noopener noreferrer">zkEVM Formal Verification Project</a>, to "accelerate the application of formal verification methods to zkEVMs".</p></div></div>
<figure><p><img decoding="async" loading="lazy" alt="Green forest" src="https://formal.land/assets/images/forest-7277f0aa94d535a998bc0f66da212999.png" width="1024" height="1024" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-rust-source-code">ðŸ¦€ Rust source code<a href="https://formal.land/blog/2025/08/13/verification-of-openvm-branch-eq#-rust-source-code" class="hash-link" aria-label="Direct link to ðŸ¦€ Rust source code" title="Direct link to ðŸ¦€ Rust source code">â€‹</a></h2>
<p>The role of the <code>branch_eq</code> chip is to compare two integers decomposed into limbs, and to make a code jump depending on the result of the comparison. To check the determinism, we only need to verify the code of the circuit itself, which is:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">eval</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    builder</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Var</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    from_pc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Var</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">AdapterAirContext</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Expr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">I</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> cols</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token class-name">BranchEqualCoreCols</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NUM_LIMBS</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> local</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">borrow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> flags </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">opcode_beq_flag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">opcode_bne_flag</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> is_valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">iter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fold</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Expr</span><span class="token punctuation" style="color:#393A34">::</span><span class="token constant" style="color:#36acaa">ZERO</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token closure-params">acc</span><span class="token closure-params punctuation" style="color:#393A34">,</span><span class="token closure-params"> </span><span class="token closure-params operator" style="color:#393A34">&amp;</span><span class="token closure-params">flag</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        builder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">assert_bool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">flag</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        acc </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> flag</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">into</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    builder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">assert_bool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">is_valid</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    builder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">assert_bool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cmp_result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> a </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> b </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> inv_marker </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">diff_inv_marker</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 1 if cmp_result indicates a and b are equal, 0 otherwise</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> cmp_eq </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cmp_result </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">opcode_beq_flag </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">not</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cmp_result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">opcode_bne_flag</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> sum </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cmp_eq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">..</span><span class="token constant" style="color:#36acaa">NUM_LIMBS</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sum </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> inv_marker</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        builder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">assert_zero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cmp_eq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    builder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">when</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">is_valid</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">assert_one</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sum</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> expected_opcode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">iter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">zip</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">BranchEqualOpcode</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">iter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fold</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Expr</span><span class="token punctuation" style="color:#393A34">::</span><span class="token constant" style="color:#36acaa">ZERO</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token closure-params">acc</span><span class="token closure-params punctuation" style="color:#393A34">,</span><span class="token closure-params"> </span><span class="token closure-params punctuation" style="color:#393A34">(</span><span class="token closure-params">flag</span><span class="token closure-params punctuation" style="color:#393A34">,</span><span class="token closure-params"> opcode</span><span class="token closure-params punctuation" style="color:#393A34">)</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            acc </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">flag</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">into</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Expr</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">from_canonical_u8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">opcode </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Expr</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">from_canonical_usize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">offset</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> to_pc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> from_pc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cmp_result </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">imm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">not</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cmp_result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Expr</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">from_canonical_u32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pc_step</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">AdapterAirContext</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        to_pc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Some</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">to_pc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reads</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Into</span><span class="token punctuation" style="color:#393A34">::</span><span class="token plain">into</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Into</span><span class="token punctuation" style="color:#393A34">::</span><span class="token plain">into</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">into</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        writes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Default</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">default</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        instruction</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">ImmInstruction</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            is_valid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            opcode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> expected_opcode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            immediate</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">imm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">into</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">into</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you are used to Plonky3 circuits, you should be able to read most of the code. The most clever part is this loop:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> sum </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cmp_eq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">..</span><span class="token constant" style="color:#36acaa">NUM_LIMBS</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sum </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> inv_marker</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    builder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">assert_zero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cmp_eq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">builder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">when</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">is_valid</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">assert_one</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sum</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>to compute whether the two integers are equal. For two different values of <code>a</code> and <code>b</code>, it relies on the oracle <code>inv_marker</code>, which will be equal to the inverse of <code>(a[i] - b[i])</code> for one of the <code>i</code> such that <code>a</code> and <code>b</code> differ, and to 0 otherwise. In contrast to the AIR examples provided in the Plonky3 repository, we return field expressions in addition to asserting equations with the <code>builder</code>. This will enable more advanced compositions with other chips.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-rocq-model">ðŸ“ Rocq model<a href="https://formal.land/blog/2025/08/13/verification-of-openvm-branch-eq#-rocq-model" class="hash-link" aria-label="Direct link to ðŸ“ Rocq model" title="Direct link to ðŸ“ Rocq model">â€‹</a></h2>
<p>We translate this code <em>manually</em> to the formal language Rocq using our zero-knowledge framework <a href="https://github.com/formal-land/garden" target="_blank" rel="noopener noreferrer">Garden</a>. We will see later how to check that this translation is faithful to the original code. Here is our translation:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> eval </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">NUM_LIMBS </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> BranchEqualCoreAir</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t NUM_LIMBS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">local </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> BranchEqualCoreCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t NUM_LIMBS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">from_pc </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">AdapterAirContext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t NUM_LIMBS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> flags </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list Z </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">BranchEqualCoreCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">opcode_beq_flag</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">BranchEqualCoreCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">opcode_bne_flag</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> is_valid </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    List</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fold_left</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> acc flag </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">assert_bool flag </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pure </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">BinOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add acc flag</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">zero</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      flags </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">assert_bool is_valid </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">assert_bool local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">BranchEqualCoreCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cmp_result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> a </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Z NUM_LIMBS </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">BranchEqualCoreCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> b </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Z NUM_LIMBS </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">BranchEqualCoreCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> inv_marker </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Z NUM_LIMBS </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">BranchEqualCoreCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">diff_inv_marker</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> cmp_eq </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pure </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">BinOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">BinOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mul local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">BranchEqualCoreCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cmp_result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">BranchEqualCoreCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">opcode_beq_flag</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">BinOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mul </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">not local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">BranchEqualCoreCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cmp_result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">BranchEqualCoreCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">opcode_bne_flag</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">for_in_zero_to_n NUM_LIMBS </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">assert_zero </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">BinOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mul cmp_eq </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">BinOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sub </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get a i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get b i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> sum </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sum_for_in_zero_to_n NUM_LIMBS </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">BinOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mul </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get inv_marker i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">BinOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sub </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get a i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get b i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> sum </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BinOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add sum cmp_eq </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">when is_valid </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">assert_one sum</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> flags_with_opcode_integer </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Z </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">BranchEqualCoreCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">opcode_beq_flag</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">BranchEqualCoreCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">opcode_bne_flag</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> expected_opcode </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Lists</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">List</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fold_left</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> acc </span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">flag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opcode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">BinOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add acc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">BinOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mul flag opcode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      flags_with_opcode_integer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> expected_opcode </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">BinOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add expected_opcode self</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">BranchEqualCoreAir</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">offset</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> to_pc </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">BinOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">BinOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        from_pc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">BinOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mul local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">BranchEqualCoreCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cmp_result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">BranchEqualCoreCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">imm</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">BinOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mul </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">not local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">BranchEqualCoreCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cmp_result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">BranchEqualCoreAir</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pc_step</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pure </span><span class="token punct punctuation" style="color:#393A34">{|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AdapterAirContext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_pc </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Some to_pc</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AdapterAirContext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reads </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AdapterAirContext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">writes </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> tt</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AdapterAirContext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">instruction </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punct punctuation" style="color:#393A34">{|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ImmInstruction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_valid </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> is_valid</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ImmInstruction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">opcode </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> expected_opcode</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ImmInstruction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">immediate </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">BranchEqualCoreCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">imm</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It should be similar to the Rust code above, with the use of the monadic notation <code>let*</code> as asserting equations makes a side-effect. We do not need an explicit <code>builder</code> variable, as it is part of the monad <code>M.t</code>. We should use binary notations <code>+</code> and <code>*</code> for <code>BinOp.add</code> and <code>BinOp.mul</code> to make it even more similar to the original code. We do not distinguish between field elements, variables, and polynomial expressions, as we can do symbolic reasoning in Rocq, and we do not need to translate the constraints to a list of polynomial equations.</p>
<p>We parametrize all the code by an ambient prime number <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span>, which is used for all the field operations, in order to know modulo which&nbsp;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span> we should make the computations. We represent all the field elements in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="double-struck">Z</mi></mrow><annotation encoding="application/x-tex">\mathbb{Z}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6889em"></span><span class="mord mathbb">Z</span></span></span></span>, and we apply the modulo operation on the result of each operation.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-reasoning-rules">ðŸ§  Reasoning rules<a href="https://formal.land/blog/2025/08/13/verification-of-openvm-branch-eq#-reasoning-rules" class="hash-link" aria-label="Direct link to ðŸ§  Reasoning rules" title="Direct link to ðŸ§  Reasoning rules">â€‹</a></h2>
<p>We use similar reasoning rules as in the previous blog post <a href="https://formal.land/blog/2025/07/31/llzk-to-rocq-verification">ðŸ¥· Formal verification of LLZK circuits in Rocq</a>. These rules execute the code as one would expect for a purely functional program, and additionally accumulate the equational constraints in a resulting proposition. Here is the rule for the monadic bind:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Let</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A B </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t B</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">output </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> B</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">P1 P2 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Prop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> e ðŸ”½ value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> P1 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">P1 </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> k value ðŸ”½ output</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> P2 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Let</span><span class="token plain"> e k ðŸ”½ output</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> P1 </span><span class="token operator" style="color:#393A34">/\</span><span class="token plain"> P2 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When we execute two computations in sequence <code>e</code> and <code>k</code>, the final constraint is the conjunction of the constraints for <code>e</code> and <code>k</code>. The basic rule to add a constraint is:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Equal </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x1 x2 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Equal x1 x2 ðŸ”½ tt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> x1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> x2 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We can also simplify the proposition by a potentially weaker one, as we are only interested in what the constraints imply to verify determinism:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Implies </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">P1 P2 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Prop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> e ðŸ”½ value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> P1 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">P1 </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> P2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> e ðŸ”½ value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> P2 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You can find the full list of rules in the file <a href="https://github.com/formal-land/garden/blob/main/Garden/Plonky3/M.v" target="_blank" rel="noopener noreferrer">Garden/Plonky3/M.v</a> in the <a href="https://github.com/formal-land/garden" target="_blank" rel="noopener noreferrer">Garden repository</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-specification">ðŸ“ Specification<a href="https://formal.land/blog/2025/08/13/verification-of-openvm-branch-eq#-specification" class="hash-link" aria-label="Direct link to ðŸ“ Specification" title="Direct link to ðŸ“ Specification">â€‹</a></h2>
<p>We can now specify the code. You can read the full specification in the lemma <code>eval_implies</code> in the file <a href="https://github.com/formal-land/garden/blob/main/Garden/OpenVM/BranchEq/core_with_monad.v" target="_blank" rel="noopener noreferrer">Garden/OpenVM/BranchEq/core_with_monad.v</a>. We state:</p>
<ul>
<li>What is the expected output in a purely functional form for the output of the function in <code>AdapterAirContext.t NUM_LIMBS</code>?</li>
<li>What are the constraints on the columns in <code>local</code>?</li>
</ul>
<p>Here is the type of the <code>local</code> parameter:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Record</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">NUM_LIMBS </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  a </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Z NUM_LIMBS</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  b </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Z NUM_LIMBS</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cmp_result </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  imm </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  opcode_beq_flag </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  opcode_bne_flag </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  diff_inv_marker </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Z NUM_LIMBS</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Arguments</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> clear implicits</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We assume that either <code>opcode_beq_flag</code> or <code>opcode_bne_flag</code> is equal to <code>1</code>, and that the other one is equal to <code>0</code>. This flag controls whether we are checking the equality or the inequality of the two integers <code>a</code> and <code>b</code>. For the constraints, our specification says that:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">BranchEqualCoreCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cmp_result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">b2z expected_cmp_result</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>meaning that the column <code>cmp_result</code> must represent a boolean with value:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> expected_cmp_result </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bool </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> branch_equal_opcode </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> BranchEqualOpcode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BEQ </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Eq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dec local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">BranchEqualCoreCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">BranchEqualCoreCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> BranchEqualOpcode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BNE </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Eq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dec local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">BranchEqualCoreCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">BranchEqualCoreCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>which is the result of the comparison check, depending on the opcode flag.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-proof">ðŸ” Proof<a href="https://formal.land/blog/2025/08/13/verification-of-openvm-branch-eq#-proof" class="hash-link" aria-label="Direct link to ðŸ” Proof" title="Direct link to ðŸ” Proof">â€‹</a></h2>
<p>We verify the specification by applying the reasoning rules to accumulate the constraints on each monadic bind <code>let*</code>. For example, for:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">assert_bool local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">BranchEqualCoreCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cmp_result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>we do:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">eapply Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">LetAccumulate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  constructor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">intros H_cmp_result</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This gives us, in the proof context, the additional hypothesis:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">H_cmp_result</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> IsBool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">BranchEqualCoreCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cmp_result</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It states that the column <code>cmp_result</code> is either <code>0</code> or <code>1</code>. For most of the rest of the reasoning, we apply similar rules and reason exhaustively for all the possible cases over the boolean variables and the equality of <code>a</code> and <code>b</code>, eliminating impossible cases and showing that the column <code>cmp_result</code> always contains the expected value.</p>
<p>To verify this circuit, we also made the choice to use a specific value for the prime number&nbsp;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span> with the Goldilocks prime. This is making the proof simpler in some cases, as we can explicitly compute the result of modulo operations on boolean values, without relying on field reasoning. We think it is safe to assume a specific prime, as circuits generally use a single fixed prime value.</p>
<p>For the expected output, for example, for the <code>pc</code> variable, which is modified if we decide to jump, we state that we must have the expected value:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">AdapterAirContext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_pc </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Some </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">BinOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add from_pc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> expected_cmp_result </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      local</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">BranchEqualCoreCols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">imm</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      self</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">BranchEqualCoreAir</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pc_step</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once we have specified the <code>cmp_result</code> column, this amounts to showing the equality of two expressions using field elements, which is done through automation procedures.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Note</div><div class="admonitionContent_BuS1"><p>For this circuit, the completeness is not obvious, as there is an oracle variable <code>diff_inv_marker</code> which must have a correct value provided by the prover. We should also verify the completeness of the circuit with appropriate reasoning rules.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ï¸-conclusion">âœ’ï¸ Conclusion<a href="https://formal.land/blog/2025/08/13/verification-of-openvm-branch-eq#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to âœ’ï¸ Conclusion" title="Direct link to âœ’ï¸ Conclusion">â€‹</a></h2>
<p>We have seen how to specify the determinism of the <code>branch_eq</code> chip of OpenVM, and to formally verify that this is the case for any possible parameters and column values.</p>
<p>Next, we will see how to make sure that our Rocq formalization corresponds to the Rust implementation of the chip.</p>
<blockquote>
<p>You want to discuss security? Contact us! â‡¨ <a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a></p>
</blockquote>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions!</em></p></div></div>]]></content:encoded>
            <category>zkVM</category>
            <category>zero-knowledge</category>
            <category>determinism</category>
        </item>
        <item>
            <title><![CDATA[ðŸ¦„ What to verify in a zkVM]]></title>
            <link>https://formal.land/blog/2025/08/12/verification-of-zkvm</link>
            <guid>https://formal.land/blog/2025/08/12/verification-of-zkvm</guid>
            <pubDate>Tue, 12 Aug 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[We present in this blog post the main properties that need to be formally verified in the circuits of a zkVM to consider it as secure.]]></description>
            <content:encoded><![CDATA[<p>We present in this blog post the main properties that need to be formally verified in the circuits of a zkVM to consider it as secure.</p>
<p>The formal verification of zero-knowledge applications is considered a priority by <a href="https://x.com/VitalikButerin" target="_blank" rel="noopener noreferrer">Vitalik Buterin</a>, the founder of <a href="https://ethereum.org/" target="_blank" rel="noopener noreferrer">Ethereum</a>, among others. The website <a href="https://ethproofs.org/" target="_blank" rel="noopener noreferrer">ethproofs.org</a> lists zkVMs ready to run Ethereum, with formal verification of the code being one of the criteria to appear as ðŸŸ© green.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>YouTube video</div><div class="admonitionContent_BuS1"><p>Here is the link to our YouTube video explaining the content of this blog post: <a href="https://www.youtube.com/watch?v=WFwXSR66pss" target="_blank" rel="noopener noreferrer">ðŸ“½ï¸&nbsp;Properties to formally verify in zkVM circuits</a></p></div></div>
<figure><p><img decoding="async" loading="lazy" alt="Green forest" src="https://formal.land/assets/images/forest-40dfde6613dc1c8860d8a20cd9bd3a37.jpeg" width="832" height="1248" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-determinism">ðŸ§­ Determinism<a href="https://formal.land/blog/2025/08/12/verification-of-zkvm#-determinism" class="hash-link" aria-label="Direct link to ðŸ§­ Determinism" title="Direct link to ðŸ§­ Determinism">â€‹</a></h2>
<p>Zero-knowledge circuits are a set of equations whose solutions are the execution trace of a certain VM, for example, a RISC-V implementation or directly an EVM. A zero-knowledge proof shows that a user knows a solution to those equations.</p>
<p>Given the initial state of the virtual machine, there must be at most one solution, as most VMs are deterministic. If someone submits another solution that is still validated by the equations, it will correspond to an execution trace that is not supposed to be possible. This can represent an attack, if someone is able to forge a solution corresponding to an execution by-passing the check of signatures in transactions, essentially allowing them to steal the funds of other users.</p>
<p>A simple equation is this one:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>x</mi><mo stretchy="false">(</mo><mi>x</mi><mo>âˆ’</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mn>0</mn></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">  \begin{aligned}
    x(x - 1) &amp;= 0 \\
  \end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.5em;vertical-align:-0.5em"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1em"><span style="top:-3.16em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.5em"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1em"><span style="top:-3.16em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mord">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.5em"><span></span></span></span></span></span></span></span></span></span></span></span>
<p>enforcing that <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">x</span></span></span></span> is either <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">0</span></span></span></span> or <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">1</span></span></span></span>, that is to say, a boolean value, generally a requirement for all the variables of a zkVM.</p>
<p>As the set of equations is generally very long (typically thousands of cases), with a code implementation evolving over time, it is not possible to verify all the cases manually, and it is very easy to make at least one mistake. This is where <em>formal verification</em> comes in, with the capability to verify the correctness of the equations for all possible initial values using a proof assistant such as <a href="https://rocq-prover.org/" target="_blank" rel="noopener noreferrer">Rocq</a>.</p>
<p>In a circuit <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">C</mi></mrow><annotation encoding="application/x-tex">\mathcal{C}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathcal" style="margin-right:0.05834em">C</span></span></span></span>, we will separate the variables into a few categories:</p>
<ul>
<li>The <strong>input</strong> variables, which are the variables that are initially known, typically represent the initial state of the VM at each execution step.</li>
<li>The <strong>output</strong> variables represent what is computed by the VM at each iteration.</li>
<li>The <strong>internal</strong> variables represent intermediate values computed by the VM to compute the output. We can also consider these variables as part of the output.</li>
<li>The <strong>oracle</strong> variables, which are variables with potentially many right answers, are used to help in intermediate steps of computations. This part is rarely present.</li>
</ul>
<p>We will say that a circuit holds if and only if all its equations are satisfied, what we note:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="script">C</mi><mo stretchy="false">(</mo><mtext>input</mtext><mo separator="true">,</mo><mtext>output</mtext><mo separator="true">,</mo><mtext>oracle</mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">  \mathcal{C}(\text{input}, \text{output}, \text{oracle})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathcal" style="margin-right:0.05834em">C</span><span class="mopen">(</span><span class="mord text"><span class="mord">input</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord text"><span class="mord">output</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord text"><span class="mord">oracle</span></span><span class="mclose">)</span></span></span></span></span>
<p>We will say that the circuit <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">C</mi></mrow><annotation encoding="application/x-tex">\mathcal{C}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathcal" style="margin-right:0.05834em">C</span></span></span></span> is deterministic if there exists a function <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span></span></span></span> such that:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">âˆ€</mi><mtext>&nbsp;input</mtext><mo separator="true">,</mo><mtext>output</mtext><mo separator="true">,</mo><mtext>oracle</mtext><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mi mathvariant="script">C</mi><mo stretchy="false">(</mo><mtext>input</mtext><mo separator="true">,</mo><mtext>output</mtext><mo separator="true">,</mo><mtext>oracle</mtext><mo stretchy="false">)</mo><mtext>â€…â€Š</mtext><mo>âŸ¹</mo><mtext>â€…â€Š</mtext><mtext>output</mtext><mo>=</mo><mi>f</mi><mo stretchy="false">(</mo><mtext>input</mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">  \forall\ \text{input}, \text{output}, \text{oracle},\\
  \mathcal{C}(\text{input}, \text{output}, \text{oracle}) \implies \text{output} = f(\text{input})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord">âˆ€</span><span class="mspace">&nbsp;</span><span class="mord text"><span class="mord">input</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord text"><span class="mord">output</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord text"><span class="mord">oracle</span></span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathcal" style="margin-right:0.05834em">C</span><span class="mopen">(</span><span class="mord text"><span class="mord">input</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord text"><span class="mord">output</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord text"><span class="mord">oracle</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">âŸ¹</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.8095em;vertical-align:-0.1944em"></span><span class="mord text"><span class="mord">output</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="mopen">(</span><span class="mord text"><span class="mord">input</span></span><span class="mclose">)</span></span></span></span></span>
<p>This is often what people mean when they say that they are "formally verifying a zkVM". Note that it does not mean there exists a solution; a circuit with no solution is also deterministic. It does not mean that the solution is the expected behavior for the VM a circuit is representing. We will see how to state those properties next.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>Security</div><div class="admonitionContent_BuS1"><ul>
<li><strong>Severity: CRITICAL</strong> Someone can steal all the funds if it is possible to forge an incorrect transaction.</li>
<li><strong>Discoverability: Formal verification only</strong> Testing cannot find if there are other solutions to the equations, as the space of possible solutions is too large.</li>
</ul></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-functional-correctness">ðŸ§® Functional correctness<a href="https://formal.land/blog/2025/08/12/verification-of-zkvm#-functional-correctness" class="hash-link" aria-label="Direct link to ðŸ§® Functional correctness" title="Direct link to ðŸ§® Functional correctness">â€‹</a></h2>
<p>The functional correctness of a zkVM is the property that the output of the VM is the expected behavior for the VM that a circuit represents. Assuming we have a VM represented by a state transition function:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="script">M</mi><mo>:</mo><mtext>State</mtext><mo>â†’</mo><mtext>State</mtext></mrow><annotation encoding="application/x-tex">  \mathcal{M} : \text{State} \to \text{State}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathcal">M</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord text"><span class="mord">State</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">â†’</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord text"><span class="mord">State</span></span></span></span></span></span>
<p>with a deterministic circuit <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">C</mi></mrow><annotation encoding="application/x-tex">\mathcal{C}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathcal" style="margin-right:0.05834em">C</span></span></span></span> for the function:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>f</mi><mo>:</mo><mtext>Input</mtext><mo>â†’</mo><mtext>Output</mtext></mrow><annotation encoding="application/x-tex">  f : \text{Input} \to \text{Output}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em"></span><span class="mord text"><span class="mord">Input</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">â†’</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em"></span><span class="mord text"><span class="mord">Output</span></span></span></span></span></span>
<p>and conversion functions:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>Ï†</mi><mtext>Input</mtext></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>:</mo><mtext>State</mtext><mo>â†’</mo><mtext>Input</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>Ï†</mi><mtext>Output</mtext></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>:</mo><mtext>State</mtext><mo>â†’</mo><mtext>Output</mtext></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">  \begin{aligned}
    \varphi_{\text{Input}} &amp;: \text{State} \to \text{Input} \\
    \varphi_{\text{Output}} &amp;: \text{State} \to \text{Output} \\
  \end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.75em"><span style="top:-3.91em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord mathnormal">Ï†</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Input</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span></span></span><span style="top:-2.41em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord mathnormal">Ï†</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Output</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.25em"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.75em"><span style="top:-3.91em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mord text"><span class="mord">State</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">â†’</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mord text"><span class="mord">Input</span></span></span></span><span style="top:-2.41em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mord text"><span class="mord">State</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">â†’</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mord text"><span class="mord">Output</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.25em"><span></span></span></span></span></span></span></span></span></span></span></span>
<p>We say that the circuit <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">C</mi></mrow><annotation encoding="application/x-tex">\mathcal{C}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathcal" style="margin-right:0.05834em">C</span></span></span></span> is functionally correct if:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">âˆ€</mi><mtext>&nbsp;state</mtext><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mi>f</mi><mo stretchy="false">(</mo><msub><mi>Ï†</mi><mtext>Input</mtext></msub><mo stretchy="false">(</mo><mtext>state</mtext><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>=</mo><msub><mi>Ï†</mi><mtext>Output</mtext></msub><mo stretchy="false">(</mo><mi mathvariant="script">M</mi><mo stretchy="false">(</mo><mtext>state</mtext><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">  \forall\ \text{state}, \\
  f(\varphi_{\text{Input}}(\text{state})) = \varphi_{\text{Output}}(\mathcal{M}(\text{state}))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord">âˆ€</span><span class="mspace">&nbsp;</span><span class="mord text"><span class="mord">state</span></span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">Ï†</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Input</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord text"><span class="mord">state</span></span><span class="mclose">))</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal">Ï†</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Output</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathcal">M</span><span class="mopen">(</span><span class="mord text"><span class="mord">state</span></span><span class="mclose">))</span></span></span></span></span>
<p>that is to say that the functions <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">M</mi></mrow><annotation encoding="application/x-tex">\mathcal{M}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathcal">M</span></span></span></span> are the same, up to the conversion functions <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Ï†</mi><mtext>Input</mtext></msub></mrow><annotation encoding="application/x-tex">\varphi_{\text{Input}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal">Ï†</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Input</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Ï†</mi><mtext>Output</mtext></msub></mrow><annotation encoding="application/x-tex">\varphi_{\text{Output}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal">Ï†</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Output</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span></span></span></span>.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>Security</div><div class="admonitionContent_BuS1"><ul>
<li><strong>Severity: CRITICAL</strong> If the functional correctness is not verified, it means that the VM is not behaving as expected, creating bugs in user applications expecting a certain behavior of the VM, like full EVM compatibility for example.</li>
<li><strong>Discoverability: Testing can help</strong> but formal verification is <strong>necessary to cover all corner cases</strong>, as people do when designing physical chips.</li>
</ul></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-completeness">ðŸŽ„ Completeness<a href="https://formal.land/blog/2025/08/12/verification-of-zkvm#-completeness" class="hash-link" aria-label="Direct link to ðŸŽ„ Completeness" title="Direct link to ðŸŽ„ Completeness">â€‹</a></h2>
<p>The completeness property says that for every input, there must exist an output solution.</p>
<p>Indeed, up to this point, we have said nothing about the existence of a solution, and a circuit without a solution is considered deterministic and functionally correct for any VM. We state this property as follows:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">âˆ€</mi><mtext>&nbsp;input</mtext><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mi mathvariant="normal">âˆƒ</mi><mtext>&nbsp;output</mtext><mo separator="true">,</mo><mtext>oracle</mtext><mo separator="true">,</mo><mspace linebreak="newline"></mspace><mi mathvariant="script">C</mi><mo stretchy="false">(</mo><mtext>input</mtext><mo separator="true">,</mo><mtext>output</mtext><mo separator="true">,</mo><mtext>oracle</mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">  \forall\ \text{input}, \\
  \exists\ \text{output}, \text{oracle},\\
  \mathcal{C}(\text{input}, \text{output}, \text{oracle})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord">âˆ€</span><span class="mspace">&nbsp;</span><span class="mord text"><span class="mord">input</span></span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord">âˆƒ</span><span class="mspace">&nbsp;</span><span class="mord text"><span class="mord">output</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord text"><span class="mord">oracle</span></span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathcal" style="margin-right:0.05834em">C</span><span class="mopen">(</span><span class="mord text"><span class="mord">input</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord text"><span class="mord">output</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord text"><span class="mord">oracle</span></span><span class="mclose">)</span></span></span></span></span>
<p>This is generally the simplest property to verify, as it amounts to writing a function expressing a valid oracle value from the input, and to check that the function&nbsp;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span></span></span></span> representing the output is indeed accepted by the set of equations of the circuit.</p>
<p>Another related security property is verifying that the code generating the execution trace for a circuit, that is to say, the solutions for the equations for a given VM execution, does succeed for any possible initial state of the VM. This is not critical as this code is not part of the circuit, so it can be updated and fixed if, for a given input, the generated trace does not fulfill the equations, although some transactions will be blocked in the meantime.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>Security</div><div class="admonitionContent_BuS1"><ul>
<li><strong>Severity: HIGH</strong> If the circuit is not complete, some transactions will be wrongly rejected, potentially blocking some smart contracts until a circuit upgrade, but no invalid transactions will be accepted.</li>
<li><strong>Discoverability: Formal verification is efficient</strong> so it is recommended, as here we are already starting from a solution and checking that it is valid.</li>
</ul></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ï¸-conclusion">âœ’ï¸ Conclusion<a href="https://formal.land/blog/2025/08/12/verification-of-zkvm#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to âœ’ï¸ Conclusion" title="Direct link to âœ’ï¸ Conclusion">â€‹</a></h2>
<p>We have seen what we consider to be the three main properties to formally verify in a zkVM and ensure it is secure enough to hold user funds at scale. We recommend first starting with determinism, and then verifying the functional correctness and completeness.</p>
<p>Verifying a zkVM is necessary to appear as fully validated on <a href="https://ethproofs.org/" target="_blank" rel="noopener noreferrer">Ethproofs</a>, and we work hard to make sure it can be the case for everyone!</p>
<blockquote>
<p>You want to discuss security? Contact us! â‡¨ <a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a></p>
</blockquote>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions!</em></p></div></div>]]></content:encoded>
            <category>zkVM</category>
            <category>zero-knowledge</category>
            <category>specification</category>
        </item>
        <item>
            <title><![CDATA[ðŸ¦„ Short introduction to Rocq]]></title>
            <link>https://formal.land/blog/2025/08/11/quick-rocq-in-a-hurry</link>
            <guid>https://formal.land/blog/2025/08/11/quick-rocq-in-a-hurry</guid>
            <pubDate>Mon, 11 Aug 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[In this blog post, we present a short introduction to Rocq, a formal verification system, as a summary of the guide Rocq in a Hurry from Yves Bertot of the Rocq team.]]></description>
            <content:encoded><![CDATA[<p>In this blog post, we present a short introduction to <a href="https://rocq-prover.org/" target="_blank" rel="noopener noreferrer">Rocq</a>, a formal verification system, as a summary of the guide <a href="https://cel.hal.science/inria-00001173v6/document" target="_blank" rel="noopener noreferrer">Rocq in a Hurry</a> from <a href="https://www-sop.inria.fr/members/Yves.Bertot/research.html" target="_blank" rel="noopener noreferrer">Yves Bertot</a> of the Rocq team.</p>
<p>Rocq is the formal system that we use exclusively, but other interactive theorem provers work the same way. From this introduction, you can get a sense of how the verification of mathematical statements or security properties of programs works.</p>
<figure><p><img decoding="async" loading="lazy" alt="Green forest" src="https://formal.land/assets/images/forest-4f0bdc03b8188e8b1d6e2410c466cff6.png" width="1024" height="1024" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-definitions">ðŸ§© Definitions<a href="https://formal.land/blog/2025/08/11/quick-rocq-in-a-hurry#-definitions" class="hash-link" aria-label="Direct link to ðŸ§© Definitions" title="Direct link to ðŸ§© Definitions">â€‹</a></h2>
<p>There are propositions for logical formulas, which can be <code>True</code>, <code>False</code>, <code>/\</code> (and), <code>\/</code> (or), <code>-&gt;</code> (implies), <code>~</code> (not), using quantifiers <code>forall</code> and <code>exists</code>, and operators like <code>=</code> for equality. These can be proven to be correct. There are expressions like <code>3 * x</code> that can be computed. We can define these as in a purely functional programming language.</p>
<p>Basic data types for computations are booleans (not to be confused with propositions, on which you cannot compute), natural numbers defined as being either <code>0</code> or <code>n + 1</code> for some other <code>n</code> a natural number, and lists which are either <code>[]</code> or <code>x :: l</code> like in many functional languages. You can define functions on those data types by pattern-matching (<code>match</code> operator) with recursive calls restricted to sub-elements of the patterns, to make sure all functions terminate.</p>
<p>Here is an example of a recursive function combining booleans, natural numbers, and lists:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Fixpoint</span><span class="token plain"> insert n l </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> l </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> n </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> a </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tl </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> n </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> a </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      n </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> l</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      a </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> insert n tl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-proofs">ðŸ“ Proofs<a href="https://formal.land/blog/2025/08/11/quick-rocq-in-a-hurry#-proofs" class="hash-link" aria-label="Direct link to ðŸ“ Proofs" title="Direct link to ðŸ“ Proofs">â€‹</a></h2>
<p>For propositions, like <code>forall (n : nat), n &lt; n + 1</code>, the goal is to find a proof of it, as we cannot simply evaluate a proposition to know if it is true or false. To write the proof, we use the interactive mode of Rocq, where we will step through the proof to construct it while being checked as correct. There are also automation primitives to go faster, but we will not see them here.</p>
<p>An example of proposition to verify is the commutativity of the "and" operator <code>/\</code>:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">forall</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">A B </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Prop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">/\</span><span class="token plain"> B </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> B </span><span class="token operator" style="color:#393A34">/\</span><span class="token plain"> A</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In proof mode, we see what the hypotheses are and what the goal is, separated by a horizontal bar. Originally, the whole proposition is the goal, and there are no hypotheses. Then with <code>intros</code> command, we move everything we can (in the <code>forall</code> or before the <code>-&gt;</code>) to the hypotheses:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">A</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> B </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Prop</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">H </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">/\</span><span class="token plain"> B</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">B </span><span class="token operator" style="color:#393A34">/\</span><span class="token plain"> A</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now the goal is <code>B /\ A</code>. We can use <code>split</code> to split the goal into two, first <code>B</code> and then <code>A</code>:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">A</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> B </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Prop</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">H </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">/\</span><span class="token plain"> B</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">B</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To solve the first goal, we can use <code>destruct H</code> to split <code>H</code> it into two hypotheses <code>H1</code> and <code>H2</code>. We obtain:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">A</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> B </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Prop</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">H1 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">H2 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> B</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">B</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now we have in the hypotheses exactly what we want to prove, that is to say, <code>B</code>. We can now conclude the proof with <code>apply H2</code>, and do similarly for the other goal <code>A</code>. We have completed our first formal proof!</p>
<p>For all the propositional operators, there is a command to use them when they are in a hypothesis, and a command to build them when they are in the goal. The most frequent commands, also named tactics, are: <code>intros</code>, <code>apply</code>, <code>split</code>, <code>destruct</code>, <code>rewrite</code>, <code>exists</code>, <code>reflexivity</code>, <code>unfold</code>. As an exercise, you can try to prove the commutativity of the "or" operator <code>\/</code>.</p>
<p>Proofs are generally organized into a lot of sub-steps called lemmas. These are intermediate properties used to prove the main goal. This is similar to how we would split a large function into smaller ones to better organize a program. The standard library or other packages provide a lot of lemmas. You can find them using the <code>Search</code> command.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-reasoning-on-expressions">ðŸ§® Reasoning on expressions<a href="https://formal.land/blog/2025/08/11/quick-rocq-in-a-hurry#-reasoning-on-expressions" class="hash-link" aria-label="Direct link to ðŸ§® Reasoning on expressions" title="Direct link to ðŸ§® Reasoning on expressions">â€‹</a></h2>
<p>To reason on propositions over expressions, and in particular programs, we can use the same tactics. The <code>destruct</code> tactic enables reasoning by cases. For example, on booleans this means reasoning on the two cases <code>false</code> and <code>true</code> to verify that a property is correct for any boolean. On infinite data structures, like natural numbers, we reason by induction using the tactic <code>induction</code>. For a given <code>n</code>, a natural number in the hypotheses, it will generate two sub-goals, one with <code>n</code> replaced by <code>0</code>, and one with <code>n</code> replaced by <code>n + 1</code>, assuming an additional hypothesis which is the goal assumed correct for <code>n</code>. An example of property is that the length of the concatenation of two lists is the sum of the lengths of the two lists, for any possible lists.</p>
<p>We can compose the reasoning by cases, yielding an arbitrary number of sub-goals. In practice, we will often get stuck in the wrong direction, like we would be stuck on paper, probably even more so than on paper.</p>
<p>The reasoning by induction works on arbitrary infinite data structures. For example, on lists it generates a sub-goal for the empty list, and one for the list <code>x :: l</code>, assuming an additional hypothesis which is the goal assumed correct for <code>l</code>.</p>
<p>We can define new data types with several constructors together with potential parameters, and the possibility to reference itself in the parameters of the constructors. This is similar to the definition of <code>enum</code> in Rust. For example, for binary trees with empty leaves:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> bin </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Leaf </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Node </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bin </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> bin </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> bin</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It is then possible to define functions by pattern-matching and recursing on this new data type, like we were doing on natural numbers or lists, as well as prove properties by induction.</p>
<p>There are additional common data types. An important one is <code>Z</code> which represents unbounded integers in binary encoding. It is more efficient than <code>nat</code> for computations that use an unary encoding, but sometimes less convenient for proofs.</p>
<p>Finally, we can also define new propositions using the <code>Inductive</code> keyword to define complex and recursive propositions. This is, for example, useful when defining the execution rules of programming languages.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ï¸-conclusion">âœ’ï¸ Conclusion<a href="https://formal.land/blog/2025/08/11/quick-rocq-in-a-hurry#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to âœ’ï¸ Conclusion" title="Direct link to âœ’ï¸ Conclusion">â€‹</a></h2>
<p>We have seen a quick introduction to understand to state and formally verify properties in a system like Rocq. In practice, to formally verify the security of a program, we will wrap these primitives in automation layers, and connect the definitions to the actual source code with translation tools such as <a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">coq-of-rust</a>.</p>
<blockquote>
<p>You want to secure your code? Contact us! â‡¨ <a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a></p>
</blockquote>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions!</em></p></div></div>]]></content:encoded>
            <category>Rocq</category>
            <category>formal verification</category>
            <category>introduction</category>
        </item>
        <item>
            <title><![CDATA[ðŸ¥· Formal verification of LLZK circuits in Rocq]]></title>
            <link>https://formal.land/blog/2025/07/31/llzk-to-rocq-verification</link>
            <guid>https://formal.land/blog/2025/07/31/llzk-to-rocq-verification</guid>
            <pubDate>Thu, 31 Jul 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[In this blog post, we present a short example about how we define reasoning rules in Rocq to formally verify the safety of zero-knowledge circuits written in LLZK.]]></description>
            <content:encoded><![CDATA[<p>In this blog post, we present a short example about how we define reasoning rules in <a href="https://rocq-prover.org/" target="_blank" rel="noopener noreferrer">Rocq</a> to formally verify the safety of zero-knowledge circuits written in <a href="https://github.com/Veridise/llzk-lib" target="_blank" rel="noopener noreferrer">LLZK</a>.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Follow-up</div><div class="admonitionContent_BuS1"><p>This blog post is a follow-up to:</p><ul>
<li><a href="https://formal.land/blog/2025/07/30/llzk-to-rocq-semantics">ðŸ¥· Semantics for LLZK in Rocq</a></li>
</ul><p>The code we are referring to in this post is available in <a href="https://github.com/formal-land/garden/tree/main/Garden/LLZK" target="_blank" rel="noopener noreferrer">github.com/formal-land/garden/Garden/LLZK</a>.</p></div></div>
<figure><p><img decoding="async" loading="lazy" alt="Green forest" src="https://formal.land/assets/images/green_forest-67a5dfcc71e922dadfd45e6929435a0d.png" width="1024" height="1024" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-reasoning-rules">ðŸ§® Reasoning rules<a href="https://formal.land/blog/2025/07/31/llzk-to-rocq-verification#-reasoning-rules" class="hash-link" aria-label="Direct link to ðŸ§® Reasoning rules" title="Direct link to ðŸ§® Reasoning rules">â€‹</a></h2>
<p>As we use a free monad to represent the effectful operations of LLZK, we need to define reasoning rules to evaluate each operator.</p>
<p>In order to optimize the proofs for the verification of safety properties (no under-constraints), we will assume that the execution of LLZK terms is always complete. By complete, we mean that there are no out-of-bound accesses in arrays. We also mean that we initialize each value exactly once, for the pattern where we declare an array and then set its elements in a second step, for example.</p>
<p>For the circuits, this is a reasonable assumption, as they are executed only once, unrolling all the loops and function calls in a large set of polynomial equations. For the <code>compute</code> functions that generate the witnesses, since they are stored off-chain, we can always upgrade them if we realize they are not complete. A proof of completeness for the <code>compute</code> functions could be done independently using a dedicated semantics.</p>
<p>We define a predicate:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> e ðŸ”½ result </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> P </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>saying that a monadic computation <code>e</code> can reduce to the value <code>output</code>, and that its successful execution implies that the predicate <code>P</code> holds. The predicate <code>P</code> typically applies to the input and output field variables of the circuit. A typical predicate is:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>output</mtext><mo>=</mo><mtext>expected_output(input)</mtext></mrow><annotation encoding="application/x-tex">\text{output} = \text{expected\_output(\text{input})}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8095em;vertical-align:-0.1944em"></span><span class="mord text"><span class="mord">output</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em"></span><span class="mord text"><span class="mord">expected_output(</span><span class="mord text"><span class="mord">input</span></span><span class="mord">)</span></span></span></span></span></span>
<p>stating that the circuit is deterministic.</p>
<p>The main reasoning rules are, in Rocq code:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">forall</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Prop</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Prop</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Pure </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pure value ðŸ”½ value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> True </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> AssertEqual </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x1 x2 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AssertEqual x1 x2 ðŸ”½ tt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> x1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> x2 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CreateStruct </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CreateStruct ðŸ”½ value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> True </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> FieldWrite </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">field </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FieldWrite field field ðŸ”½ tt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> True </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Let</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A B </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t B</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">output </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> B</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">P1 P2 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Prop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> e ðŸ”½ value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> P1 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">P1 </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> k value ðŸ”½ output</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> P2 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Let</span><span class="token plain"> e k ðŸ”½ output</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> P1 </span><span class="token operator" style="color:#393A34">/\</span><span class="token plain"> P2 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Implies </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">P1 P2 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Prop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> e ðŸ”½ value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> P1 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">P1 </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> P2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> e ðŸ”½ value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> P2 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"{{ e ðŸ”½ output , P }}"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t e output P</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="pure"><code>Pure</code><a href="https://formal.land/blog/2025/07/31/llzk-to-rocq-verification#pure" class="hash-link" aria-label="Direct link to pure" title="Direct link to pure">â€‹</a></h3>
<p>There is nothing special to say about the rule of the <code>M.Pure</code> operator of the monad. We return the <code>value</code> that we are supposed to return, whether it is in a fully evaluated form or still as an expression with some free variables. The predicate is <code>True</code> as we do not assert any constraints.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="assertequal"><code>AssertEqual</code><a href="https://formal.land/blog/2025/07/31/llzk-to-rocq-verification#assertequal" class="hash-link" aria-label="Direct link to assertequal" title="Direct link to assertequal">â€‹</a></h3>
<p>For the <code>M.AssertEqual</code> operator, we always return the unit value <code>tt</code>, and we assert that the two parameters are equal. The predicate is the equality between the two parameters, as this is the condition to successfully execute the operator.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="createstruct"><code>CreateStruct</code><a href="https://formal.land/blog/2025/07/31/llzk-to-rocq-verification#createstruct" class="hash-link" aria-label="Direct link to createstruct" title="Direct link to createstruct">â€‹</a></h3>
<p>With this operator, we can declare a new structure element, whose fields are to be set later. This is a non-deterministic operation, and we let the user choose the value of the structure when verifying the circuit. However, in practice, there is only one possible choice as the value of the structure must be compatible with the write operations that will follow.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="fieldwrite"><code>FieldWrite</code><a href="https://formal.land/blog/2025/07/31/llzk-to-rocq-verification#fieldwrite" class="hash-link" aria-label="Direct link to fieldwrite" title="Direct link to fieldwrite">â€‹</a></h3>
<p>This operator is used to write a value in a field of a structure. We can apply this rule only if we have chosen the right value for the structure. We assume that all LLZK functions are complete, which can be checked at runtime, so that each declared structure has exactly one write operation, and we cannot make a read before the write.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="let"><code>Let</code><a href="https://formal.land/blog/2025/07/31/llzk-to-rocq-verification#let" class="hash-link" aria-label="Direct link to let" title="Direct link to let">â€‹</a></h3>
<p>The <code>Let</code> rule is for the binding operator of the monad. It combines the conditions <code>P1</code> and <code>P2</code> to form a new predicate <code>P1 /\ P2</code> for the execution of <code>e</code> and <code>k</code>. We can also use the knowledge of <code>P1</code> to reason about the execution of <code>k</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="implies"><code>Implies</code><a href="https://formal.land/blog/2025/07/31/llzk-to-rocq-verification#implies" class="hash-link" aria-label="Direct link to implies" title="Direct link to implies">â€‹</a></h3>
<p>Finally, the <code>Implies</code> rule is used to simplify the expression of the predicate <code>P</code>. We generally wrap our proofs in an <code>Implies</code> call to have a clean predicate at the end. Otherwise, the final expression would contain a lot of clutter, like <code>True /\ ...</code> operations.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-example">ðŸ“ Example<a href="https://formal.land/blog/2025/07/31/llzk-to-rocq-verification#-example" class="hash-link" aria-label="Direct link to ðŸ“ Example" title="Direct link to ðŸ“ Example">â€‹</a></h2>
<p>We now look at the specification and verification of the LLZK example we took at the beginning of this blog post series:</p>
<div class="language-mlir codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-mlir codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">function.def @global_add(%a: !felt.type, %b: !felt.type) -&gt; !felt.type {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  %c = felt.add %a, %b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  function.return %c : !felt.type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">struct.def @Adder {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  struct.field @sum : !felt.type {llzk.pub}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  function.def @compute(%a: !felt.type, %b: !felt.type) -&gt; !struct.type&lt;@Adder&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    %self = struct.new : !struct.type&lt;@Adder&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    %sum = function.call @global_add(%a, %b) : (!felt.type, !felt.type) -&gt; (!felt.type)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct.writef %self[@sum] = %sum : !struct.type&lt;@Adder&gt;, !felt.type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function.return %self : !struct.type&lt;@Adder&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  function.def @constrain(%self: !struct.type&lt;@Adder&gt;, %a: !felt.type, %b: !felt.type) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    %sum = struct.readf %self[@sum] : !struct.type&lt;@Adder&gt;, !felt.type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    %c = function.call @global_add(%a, %b) : (!felt.type, !felt.type) -&gt; (!felt.type)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    constrain.eq %sum, %c : !felt.type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function.return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="global_add"><code>global_add</code><a href="https://formal.land/blog/2025/07/31/llzk-to-rocq-verification#global_add" class="hash-link" aria-label="Direct link to global_add" title="Direct link to global_add">â€‹</a></h3>
<p>For the <code>global_add</code> function, we write the following specification in the file <a href="https://github.com/formal-land/garden/blob/main/Garden/LLZK/verification.v" target="_blank" rel="noopener noreferrer">Garden/LLZK/verification.v</a>:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Lemma</span><span class="token plain"> global_add_eq </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x y </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> global_add x y ðŸ”½ </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> mod p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> True </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The generated Rocq translation of the <code>global_add</code> function is:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> global_add </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg_fun_0 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg_fun_1 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> var_0 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BinOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add arg_fun_0 arg_fun_1 </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pure var_0</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We can now prove the specification with the application of the single rule <code>Run.Pure</code>, as the code is purely functional:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Proof</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Qed</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Most of the auxiliary functions or the <code>compute</code> functions will have a specification of a similar form, where the predicate is <code>True</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="compute"><code>compute</code><a href="https://formal.land/blog/2025/07/31/llzk-to-rocq-verification#compute" class="hash-link" aria-label="Direct link to compute" title="Direct link to compute">â€‹</a></h3>
<p>The translation of the <code>compute</code> function is:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> compute </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg_fun_0 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg_fun_1 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> var_self </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CreateStruct </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> var_0 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> global_add arg_fun_0 arg_fun_1 </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> unit </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FieldWrite var_self</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sum</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> var_0 </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pure var_self</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here, there are some side-effects composed with the <code>M.Let</code> operator, noted <code>let*</code>. We can apply the <code>Run.Let</code> rule to prove the specification:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> spec </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x y </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punct punctuation" style="color:#393A34">{|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sum </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> mod p</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Lemma</span><span class="token plain"> compute_eq </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x y </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compute x y ðŸ”½</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec x y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Proof</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unfold Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compute</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  eapply Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Implies</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    eapply Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Let</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      eapply Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CreateStruct </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Build_t </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    intros </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    eapply Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Let</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> global_add_eq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    intros </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    eapply Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Let</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      eapply Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FieldWrite</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    intros </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  easy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Qed</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The specification states that we are creating a structure with the addition modulo <code>p</code> of the two input parameters. We make the proof with a succession of <code>Run.Let</code> rules. For the line:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> var_self </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CreateStruct </span><span class="token keyword" style="color:#00009f">in</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>we apply the <code>Run.CreateStruct</code> rule, with an existential variable <code>_</code> for the field of the structure. This existential variable is later unified with the right value when we evaluate the line:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> unit </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FieldWrite var_self</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sum</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> var_0 </span><span class="token keyword" style="color:#00009f">in</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>which forces its value to be <code>var_0</code>.</p>
<p>The last tactic:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">easy</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>at the end of the proof is there to aggregate the predicate <code>True /\ ... /\ True</code> that we obtain from the <code>Run.Let</code> rules into a single <code>True</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="constrain"><code>constrain</code><a href="https://formal.land/blog/2025/07/31/llzk-to-rocq-verification#constrain" class="hash-link" aria-label="Direct link to constrain" title="Direct link to constrain">â€‹</a></h3>
<p>The translation of the <code>constrain</code> function is:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> constrain </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg_fun_0 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg_fun_1 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg_fun_2 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t unit </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> var_0 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> arg_fun_0</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sum</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> var_1 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> global_add arg_fun_1 arg_fun_2 </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> unit </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AssertEqual var_0 var_1 </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pure tt</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We specify it as follows:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Lemma</span><span class="token plain"> contrain_implies </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x y </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> self </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> map_mod self </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">constrain self x y ðŸ”½</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> spec x y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here, we always return the unit value <code>tt</code>, and we assert that the <code>self</code> parameter must be equal to the expected structure containing the sum of the two input parameters. Note that we use the <code>map_mod</code> function to make sure to apply the modulo operation to the fields of the structure, as otherwise they could be arbitrary <code>Z</code> values. This is a way to express that we consider equality to be modulo <code>p</code>.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>No under-constraints</div><div class="admonitionContent_BuS1"><p>This specification states that there are no under-constraints in the <code>constrain</code> function. Indeed, the <code>self</code> parameter is only allowed to be equal to a single value <code>spec x y</code>. However, we do not show that the circuit is not over-constrained: we show that all solutions must be equal to <code>spec x y</code>, but there might be no solutions, and this statement would hold.</p><p>The no over-constraints property is generally considered less critical than the no under-constraints property, and easier to formally verify: it amounts to verifying that the expected output validates all the assertions of the circuit.</p></div></div>
<p>For the proof, we again apply the <code>Run.t</code> rules in a straightforward way:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Proof</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unfold Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">constrain</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  eapply Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Implies</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    eapply Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Let</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> global_add_eq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    intros </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    eapply Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Let</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AssertEqual</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    intros </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unfold spec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hauto lq</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> on</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Qed</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ï¸-conclusion">âœ’ï¸ Conclusion<a href="https://formal.land/blog/2025/07/31/llzk-to-rocq-verification#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to âœ’ï¸ Conclusion" title="Direct link to âœ’ï¸ Conclusion">â€‹</a></h2>
<p>We have seen how to formally specify and verify the safety of an LLZK circuit in Rocq. There are a few things that need to be improved now:</p>
<ul>
<li>Adding more automation to the proofs: as you can see, they are rather verbose, even if LLM auto-complete catches repetitive patterns.</li>
<li>Adding more support for the LLZK language, translating bigger examples (in the thousands of lines, the one above is 500 lines long). Indeed, other <code>.llzk</code> files use features that we do not support yet, like arrays whose size is dynamic with respect to a <code>for</code> loop counter. Our plan is to add dynamic typing rules capabilities in a refined version of our reasoning rules.</li>
</ul>
<blockquote>
<p>You want to secure your code? Contact us! â‡¨ <a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a></p>
</blockquote>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions!</em></p></div></div>]]></content:encoded>
            <category>LLZK</category>
            <category>formal verification</category>
            <category>zero-knowledge</category>
        </item>
        <item>
            <title><![CDATA[ðŸ¥· Semantics for LLZK in Rocq]]></title>
            <link>https://formal.land/blog/2025/07/30/llzk-to-rocq-semantics</link>
            <guid>https://formal.land/blog/2025/07/30/llzk-to-rocq-semantics</guid>
            <pubDate>Wed, 30 Jul 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[LLZK is a language designed to implement zero-knowledge circuits. We wrote a translation tool from this language to a representation in the formal language Rocq.]]></description>
            <content:encoded><![CDATA[<p><a href="https://github.com/Veridise/llzk-lib" target="_blank" rel="noopener noreferrer">LLZK</a> is a language designed to implement <a href="https://en.wikipedia.org/wiki/Zero-knowledge_proof" target="_blank" rel="noopener noreferrer">zero-knowledge</a> circuits. We wrote a translation tool from this language to a representation in the formal language <a href="https://rocq-prover.org/" target="_blank" rel="noopener noreferrer">Rocq</a>.</p>
<p>In this blog post, we present how we give a semantics to all the primitive operations of LLZK in Rocq. The end-goal is to provide a way to formally verify that a zero-knowledge circuit is safe, that is to say, without under-constraints.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Follow-up</div><div class="admonitionContent_BuS1"><p>This blog post is a follow-up to:</p><ul>
<li><a href="https://formal.land/blog/2025/07/28/llzk-to-rocq-beginning">ðŸ¥· Beginning of a formal verification tool for LLZK</a></li>
</ul><p>The code we are referring to in this post is available in <a href="https://github.com/formal-land/garden/tree/main/Garden/LLZK" target="_blank" rel="noopener noreferrer">github.com/formal-land/garden/Garden/LLZK</a>.</p></div></div>
<figure><p><img decoding="async" loading="lazy" alt="Green forest" src="https://formal.land/assets/images/green_forest-f8954bcc184f52fe93fea331b1453bf2.png" width="1024" height="1024" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-data-types">ðŸª† Data types<a href="https://formal.land/blog/2025/07/30/llzk-to-rocq-semantics#-data-types" class="hash-link" aria-label="Direct link to ðŸª† Data types" title="Direct link to ðŸª† Data types">â€‹</a></h2>
<p>Here are the main data types that we see appearing in LLZK code examples:</p>
<ul>
<li><code>Felt.t</code>, for integers modulo&nbsp;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span> a large prime number. We represent them with the type of unbounded integers <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="double-struck">Z</mi></mrow><annotation encoding="application/x-tex">\mathbb{Z}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6889em"></span><span class="mord mathbb">Z</span></span></span></span>, and explicitly compute the modulo on the result of each operation.</li>
<li><code>i1</code>, for boolean values. We represent them with the boolean type <code>bool</code> of Rocq.</li>
<li><code>Index.t</code> for length or indexes in arrays. We represent them with the type <code>nat</code> of Rocq (non-negative integers).</li>
<li><code>Array.t</code> for arrays, parametrized by a list of dimensions and a type of elements. We design a custom type for these.</li>
<li>Structures, defined in an LLZK module with a list of fields. We represent them with a record type in Rocq.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="feltt"><code>Felt.t</code><a href="https://formal.land/blog/2025/07/30/llzk-to-rocq-semantics#feltt" class="hash-link" aria-label="Direct link to feltt" title="Direct link to feltt">â€‹</a></h3>
<p>We define the primitive arithmetic operations on <code>Felt.t</code> as pure functions in Rocq, parametrized by an implicit prime number <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span>. For example, for the binary operations we do:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BinOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> add </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x y </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> mod p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> sub </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x y </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> mod p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> mul </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x y </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> mod p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> div </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x y </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> mod p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> mod_ </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x y </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x mod y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> mod p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BinOp</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We do not check if the parameters are in the bounds <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mo>â‰¤</mo><mi>n</mi><mo>&lt;</mo><mi>p</mi></mrow><annotation encoding="application/x-tex">0 \leq n &lt; p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7804em;vertical-align:-0.136em"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">â‰¤</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span>, but we apply the modulo operation on the result of each function. This is a convention that we will try to use for the rest of the formalizations.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="arrayt"><code>Array.t</code><a href="https://formal.land/blog/2025/07/30/llzk-to-rocq-semantics#arrayt" class="hash-link" aria-label="Direct link to arrayt" title="Direct link to arrayt">â€‹</a></h3>
<p>We represent arrays as a record wrapping a <code>get</code> function:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Record</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Ns </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list nat</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  get </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> MultiIndex</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Ns </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Arguments</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> clear implicits</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We use a function rather than a list, as in our experience, for many zero-knowledge circuits, there exists an expression relating the values in an array to their indices. A limitation is that we need to find a default value for out-of-bounds indexes. This is generally easy to find, as most data structures are built around the <code>Felt.t</code> type with zero as a default value.</p>
<p>Because arrays can be multi-dimensional, define a type for multi-dimensional indices instead of using a plain <code>nat</code>:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> MultiIndex</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Fixpoint</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ns </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list nat</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> Ns </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> nil </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> unit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ns </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> Index</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> t Ns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> MultiIndex</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>A multi-index is simply a tuple with as many integers as there are dimensions. We prefer to use an array with multi-indices instead of arrays of arrays, in order to have a representation following the choices of LLZK.</p>
<p>There is an <code>array.extract</code> operator in LLZK, to extract a sub-array from an array, which isgeneralized to the case of multidimensional arrays. We define it as:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> extract </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Ns Ms </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list nat</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">array </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t A </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ns </span><span class="token operator" style="color:#393A34">+</span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> Ms</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">indexes </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> MultiIndex</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Ns</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    t A Ms </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punct punctuation" style="color:#393A34">{|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    get indexes</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> array</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MultiIndex</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">concat indexes indexes</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It takes an array whose multi-dimension is a list of dimensions <code>Ns</code> followed by dimensions <code>Ms</code>. It returns a sub-array whose multi-dimension is <code>Ms</code>. It relies on an operator <code>MultiIndex.concat</code> to concatenate two multi-indexes of the right dimensions:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Fixpoint</span><span class="token plain"> concat </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Ns Ms </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list nat</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">indexes </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> MultiIndex</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Ns</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">indexes</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> MultiIndex</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Ms</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MultiIndex</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ns </span><span class="token operator" style="color:#393A34">+</span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> Ms</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> Ns</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> indexes </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> indexes</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ns</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> indexes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> concat indexes indexes</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="structures">Structures<a href="https://formal.land/blog/2025/07/30/llzk-to-rocq-semantics#structures" class="hash-link" aria-label="Direct link to Structures" title="Direct link to Structures">â€‹</a></h3>
<p>We found that directly using the <code>Record</code> construct of Rocq to represent structures was enough. Here is how a typical structure is defined in LLZK:</p>
<div class="language-mlir codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-mlir codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct.def @MatrixConstrain {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct.field @check0 : !struct.type&lt;@ArrayConstrain&lt;[7, 11]&gt;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct.field @check1 : !struct.type&lt;@ArrayConstrain&lt;[13, 17]&gt;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is translated to a record type in Rocq:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> MatrixConstrain</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Record</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    check0 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ArrayConstrain</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    check1 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ArrayConstrain</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token number" style="color:#36acaa">13</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">17</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> MatrixConstrain</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-monad">ðŸ”® Monad<a href="https://formal.land/blog/2025/07/30/llzk-to-rocq-semantics#-monad" class="hash-link" aria-label="Direct link to ðŸ”® Monad" title="Direct link to ðŸ”® Monad">â€‹</a></h2>
<p>While we try to represent as many operations as possible in the purely functional fragment of Rocq, since it simplifies formal reasoning, for some operations we must use a monad. The main monadic operation is the check of equality between two integers modulo <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span>. This is the main building block for circuits, to ensure that only valid witnesses are accepted.</p>
<p>We design our monad as a free-monad, in order to be able to define the reasoning rules independently:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Pure </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> AssertEqual </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x1 x2 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t unit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> AssertIn </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Ns </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list nat</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">array </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t A Ns</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t unit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> AssertBool </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t unit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CreateStruct </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> ArrayWrite </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Ns </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list nat</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">array </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t A Ns</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">indexes </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MultiIndex</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Ns</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      t unit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> FieldWrite </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">field </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t unit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Let</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A B </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t B</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t B</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The two standard monadic operators are:</p>
<ul>
<li><code>Pure</code> that we note <code>M.Pure</code>, and</li>
<li><code>Let</code> that we note <code>let* x := ... in ...</code>.</li>
</ul>
<p>We also define some primitives, in particular:</p>
<ul>
<li><code>AssertEqual</code> typically used to enforce the equality between two integers modulo <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span>.</li>
<li><code>AssertIn</code> to check that an element is in an array.</li>
<li><code>CreateStruct</code> to instantiate a value for a structure in a non-deterministic way. The structure is to be defined in subsequent write operations.</li>
<li><code>FieldWrite</code> to write a value in a field of a structure and force its definition.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ï¸-conclusion">âœ’ï¸ Conclusion<a href="https://formal.land/blog/2025/07/30/llzk-to-rocq-semantics#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to âœ’ï¸ Conclusion" title="Direct link to âœ’ï¸ Conclusion">â€‹</a></h2>
<p>We have seen how to define the main primitives for the LLZK language in Rocq. In the upcoming blog posts, we will show how to reason about LLZK circuits in Rocq, thanks to the introduction of reasoning rules for each monadic operation.</p>
<blockquote>
<p>You want to secure your code? Contact us! â‡¨ <a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a></p>
</blockquote>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions!</em></p></div></div>]]></content:encoded>
            <category>LLZK</category>
            <category>semantics</category>
            <category>zero-knowledge</category>
        </item>
        <item>
            <title><![CDATA[ðŸ¥· Beginning of a formal verification tool for LLZK]]></title>
            <link>https://formal.land/blog/2025/07/28/llzk-to-rocq-beginning</link>
            <guid>https://formal.land/blog/2025/07/28/llzk-to-rocq-beginning</guid>
            <pubDate>Mon, 28 Jul 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Here we present the beginning of our work to develop a formal verification tool for LLZK from Veridise, a new language designed to implement zero-knowledge circuits. The zero-knowledge technology is how future versions of Ethereum are planned to be implemented.]]></description>
            <content:encoded><![CDATA[<p>Here we present the beginning of our work to develop a formal verification tool for <a href="https://github.com/Veridise/llzk-lib" target="_blank" rel="noopener noreferrer">LLZK</a> from <a href="https://veridise.com/" target="_blank" rel="noopener noreferrer">Veridise</a>, a new language designed to implement zero-knowledge circuits. The zero-knowledge technology is how future versions of Ethereum are planned to be implemented.</p>
<p>As usual, our technique is to work by translation to the <a href="https://rocq-prover.org/" target="_blank" rel="noopener noreferrer">Rocq</a> formal verification language, using a representation as similar as possible to the source code to simplify reasoning. Then, we will be able to verify that:</p>
<ul>
<li>For any possible inputs, a circuit correctly computes a functional specification (no over-constraint).</li>
<li>There are no possible invalid witnesses that can be accepted by the circuit (no under-constraint).</li>
</ul>
<figure><p><img decoding="async" loading="lazy" alt="Green forest" src="https://formal.land/assets/images/green_forest-e9db66923a95f185ffea68ab417b3837.png" width="1024" height="1024" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-llzk-language">ðŸ¥· LLZK language<a href="https://formal.land/blog/2025/07/28/llzk-to-rocq-beginning#-llzk-language" class="hash-link" aria-label="Direct link to ðŸ¥· LLZK language" title="Direct link to ðŸ¥· LLZK language">â€‹</a></h2>
<p>LLZK is a language made to define <a href="https://en.wikipedia.org/wiki/Zero-knowledge_proof" target="_blank" rel="noopener noreferrer">zero-knowledge</a> circuits, a cryptographic primitive that states that you know about the execution of a program without revealing any information about it. LLZK is defined as a dialect of <a href="https://mlir.llvm.org/" target="_blank" rel="noopener noreferrer">MLIR</a>, which is a general-purpose intermediate representation to build compilers, itself built on top of <a href="https://llvm.org/" target="_blank" rel="noopener noreferrer">LLVM</a>.</p>
<p>In MLIR, you have access to a set of <a href="https://github.com/llvm/llvm-project/tree/main/mlir/include/mlir/Dialect" target="_blank" rel="noopener noreferrer">pre-defined operations</a> that you can extend with new dialects. Each dialect is a set of types or primitive functions and notations that you can add. These are generally defined in C++ or using the custom language <code>.td</code> like in <a href="https://github.com/llvm/llvm-project/blob/main/mlir/include/mlir/Dialect/SCF/IR/SCFOps.td" target="_blank" rel="noopener noreferrer">Dialect/SCF/IR/SCFOps.td</a>. Here is an example of LLZK circuit:</p>
<div class="language-mlir codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-mlir codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">function.def @global_add(%a: !felt.type, %b: !felt.type) -&gt; !felt.type {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  %c = felt.add %a, %b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  function.return %c : !felt.type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">struct.def @Adder {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  struct.field @sum : !felt.type {llzk.pub}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  function.def @compute(%a: !felt.type, %b: !felt.type) -&gt; !struct.type&lt;@Adder&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    %self = struct.new : !struct.type&lt;@Adder&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    %sum = function.call @global_add(%a, %b) : (!felt.type, !felt.type) -&gt; (!felt.type)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct.writef %self[@sum] = %sum : !struct.type&lt;@Adder&gt;, !felt.type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function.return %self : !struct.type&lt;@Adder&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  function.def @constrain(%self: !struct.type&lt;@Adder&gt;, %a: !felt.type, %b: !felt.type) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    %sum = struct.readf %self[@sum] : !struct.type&lt;@Adder&gt;, !felt.type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    %c = function.call @global_add(%a, %b) : (!felt.type, !felt.type) -&gt; (!felt.type)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    constrain.eq %sum, %c : !felt.type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function.return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The code is rather verbose, with type annotations on every line, but this is built as an intermediate language to be used for analyses or compilation to zero-knowledge constraints. The two main functions are:</p>
<ul>
<li><code>compute</code> that computes a witness for the circuit, given the inputs.</li>
<li><code>constrain</code> that constrains the witness to the circuit specification.</li>
</ul>
<p>For the constraints, we have access to a special operator:</p>
<div class="language-mlir codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-mlir codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">constrain.eq %sum, %c : !felt.type</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It checks that two values are equal and aborts the execution if they are not. The security property we will need to show is that the witness computed by the <code>compute</code> function is the only possible parameter <code>self</code> for the function <code>constrain</code> in order to execute it without aborting. This will ensure that our circuit correctly and safely represents the <code>compute</code> function acting as a specification and a way to generate the zero-knowledge witness.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Note</div><div class="admonitionContent_BuS1"><p>Zero-knowledge circuits are ultimately compiled down to a set of equations on polynomials using integers modulo&nbsp;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span> a large prime number. This is why the main type appearing in the code is <code>!felt.type</code>, which is a type for integers modulo&nbsp;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span>. This differs from most programming languages, where the main type is computed modulo&nbsp;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>32</mn></msup></mrow><annotation encoding="application/x-tex">2^{32}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">32</span></span></span></span></span></span></span></span></span></span></span></span> or&nbsp;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>64</mn></msup></mrow><annotation encoding="application/x-tex">2^{64}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">64</span></span></span></span></span></span></span></span></span></span></span></span>.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-llzk-api">ðŸ”Œ LLZK API<a href="https://formal.land/blog/2025/07/28/llzk-to-rocq-beginning#-llzk-api" class="hash-link" aria-label="Direct link to ðŸ”Œ LLZK API" title="Direct link to ðŸ”Œ LLZK API">â€‹</a></h2>
<p>To parse LLZK code, we wrote an MLIR pass as part of the LLZK code base that we extend in <a href="https://github.com/formal-land/llzk-lib/pull/1" target="_blank" rel="noopener noreferrer">this pull request</a>. All the code is in C++. This is, in our experience, the simplest way to connect to the MLIR infrastructure, after trying a few other alternatives. That way, you get access to all of MLIR facilities, as most of the project is written in C++.</p>
<p>We use the C++ primitives of MLIR to iterate over the whole syntax tree of a given LLZK file. Our translation works by directly pretty-printing the corresponding Rocq file on the standard output: we try not to do additional translation passes to keep the translation simple and predictable. Here is an example of the code where we parse and pretty-print the operations of LLZK (the functions that you can call on each line of the SSA form):</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> addFeltOp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">dyn_cast</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">AddFeltOp</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  llvm</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">outs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"BinOp.add "</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">printOperand</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">topLevelOperation</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> addFeltOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getLhs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  llvm</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">outs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">" "</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">printOperand</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">topLevelOperation</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> addFeltOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getRhs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> subFeltOp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">dyn_cast</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">SubFeltOp</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  llvm</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">outs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"BinOp.sub "</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">printOperand</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">topLevelOperation</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> subFeltOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getLhs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  llvm</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">outs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">" "</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">printOperand</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">topLevelOperation</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> subFeltOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getRhs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> mulFeltOp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">dyn_cast</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">MulFeltOp</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We use a dynamic cast to check the type of the operation and print the corresponding Rocq code. There, the operations are either addition or subtraction. The payload differs for each of the operations, with two operands <code>lhs</code> and <code>rhs</code> that we retrieve with the methods <code>getLhs</code> and <code>getRhs</code> in this case. These felt operations are defined in the <code>.td</code> file <a href="https://github.com/Veridise/llzk-lib/blob/main/include/llzk/Dialect/Felt/IR/Ops.td" target="_blank" rel="noopener noreferrer">llzk/Dialect/Felt/IR/Ops.td</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-rocq-output">ðŸ“ Rocq output<a href="https://formal.land/blog/2025/07/28/llzk-to-rocq-beginning#-rocq-output" class="hash-link" aria-label="Direct link to ðŸ“ Rocq output" title="Direct link to ðŸ“ Rocq output">â€‹</a></h2>
<p>We obtain the following output in Rocq for the LLZK example above:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> global_add </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg_fun_0 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg_fun_1 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> var_0 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BinOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add arg_fun_0 arg_fun_1 </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pure var_0</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Record</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sum </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token attribute attr-name" style="color:#00a4db">Global</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Instance</span><span class="token plain"> IsMapMop </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Ï</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime Ï</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> MapMod t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    map_mod Î± </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punct punctuation" style="color:#393A34">{|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      sum </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> map_mod Î±</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">sum</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> constrain </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg_fun_0 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg_fun_1 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg_fun_2 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t unit </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> var_0 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> arg_fun_0</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sum</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> var_1 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> global_add arg_fun_1 arg_fun_2 </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> unit </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AssertEqual var_0 var_1 </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pure tt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> compute </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg_fun_0 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg_fun_1 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> var_self </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CreateStruct </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> var_0 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> global_add arg_fun_0 arg_fun_1 </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> unit </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FieldWrite var_self</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sum</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> var_0 </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pure var_self</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This code should be fairly similar to the original LLZK code, with the addition of the <code>M.t</code> monad all the potential side effects. We add an implicit parameter&nbsp;<code>p</code> to all the functions for the prime number with which we are working for the modulo operation. The type-class instance <code>IsMapMop</code> is a helper that we generate to help with the proofs: it applies a modulo operation to all the integer fields of a data structure.</p>
<p>In the function <code>constrain</code>, we have one side effect: <code>M.AssertEqual</code> to check for the equality of <code>var_0</code> and <code>var_1</code>. In the function <code>compute</code>, we have two side effects: <code>M.CreateStruct</code> to create an arbitrary value of type <code>Adder.t</code> and <code>M.FieldWrite</code> to write the result of the addition to the <code>sum</code> field.</p>
<p>The function <code>global_add</code> is defined as effectful even if it is actually purely functional. This is because we do not make an effect analysis for simplicity, so we suppose by default that all the functions are effectful.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ï¸-conclusion">âœ’ï¸ Conclusion<a href="https://formal.land/blog/2025/07/28/llzk-to-rocq-beginning#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to âœ’ï¸ Conclusion" title="Direct link to âœ’ï¸ Conclusion">â€‹</a></h2>
<p>We have had an overview of how to parse an example of zero-knowledge circuits written in LLZK to pretty-print them in the formal verification language Rocq.</p>
<p>In the upcoming blog posts, we will show how to give a semantics to the Rocq translation in order to formally verify properties on this example.</p>
<blockquote>
<p>You want to secure your code? Contact us! â‡¨ <a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a></p>
</blockquote>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions!</em></p></div></div>]]></content:encoded>
            <category>LLZK</category>
            <category>translation</category>
            <category>zero-knowledge</category>
        </item>
        <item>
            <title><![CDATA[ðŸ¦€ Functional specification of the ADD instruction of the EVM]]></title>
            <link>https://formal.land/blog/2025/07/06/functional-specification-add</link>
            <guid>https://formal.land/blog/2025/07/06/functional-specification-add</guid>
            <pubDate>Sun, 06 Jul 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[In this blog post, we present how we specify and verify the implementation of the ADD instruction of the EVM virtual machine in Rust.]]></description>
            <content:encoded><![CDATA[<p>In this blog post, we present how we specify and verify the implementation of the ADD instruction of the <a href="https://www.evm.codes/" target="_blank" rel="noopener noreferrer">EVM</a> virtual machine in Rust.</p>
<p>We give a functional specification, meaning that we show the implementation to be equivalent to an idealized version written in the Rocq language. As the Rust code for this instruction involves rather advanced features of Rust, the same techniques could apply to verify a large set of Rust programs.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Work with us!</div><div class="admonitionContent_BuS1"><p>With <strong>formal verification</strong>, you can <strong>guarantee</strong> that your code is safe, given the specifications, and you do not need to re-audit <strong>from scratch</strong> after each upgrade.</p><p><strong>Contact us</strong> at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">&nbsp;ðŸ’Œcontact@formal.land</a> to discuss how to make sure your code is safe to deploy and upgrade!&nbsp;ðŸ›¡ï¸</p><p>We cover <strong>Rust</strong>, <strong>Solidity</strong>, and <strong>ZK systems</strong>.</p></div></div>
<figure><p><img decoding="async" loading="lazy" alt="Green forest" src="https://formal.land/assets/images/forest-b0db7e049b5c4a263771795501f99e8f.webp" width="1024" height="1024" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-target">ðŸŽ¯ Target<a href="https://formal.land/blog/2025/07/06/functional-specification-add#-target" class="hash-link" aria-label="Direct link to ðŸŽ¯ Target" title="Direct link to ðŸŽ¯ Target">â€‹</a></h2>
<p>Here is the implementation of the ADD instruction in <a href="https://github.com/bluealloy/revm" target="_blank" rel="noopener noreferrer">Revm</a>, probably the most popular implementation of the EVM in Rust:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">add</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">WIRE</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">InterpreterTypes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">H</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Host</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token class-name">Sized</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    interpreter</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token class-name">Interpreter</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">WIRE</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token class-name">H</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property" style="color:#36acaa">gas!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">interpreter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">gas</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token constant" style="color:#36acaa">VERYLOW</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property" style="color:#36acaa">popn_top!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">op1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> op2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> interpreter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">op2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> op1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">wrapping_add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">op2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It takes the two topmost values of the stack, adds them, and stores the result on the top of the stack. It also computes how much gas is consumed. Some code is hidden in the macros <code>gas!</code> and <code>popn_top!</code>, as well as in the traits <code>InterpreterTypes</code> and <code>Host</code>, which contain all the methods needed to define the EVM instructions (stack and memory access, gas consumption, etc.).</p>
<p>Here is our functional specification of the ADD instruction in Rocq:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Output</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Success tt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> gas </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> ILoop</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Loop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gas</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">RefStub</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">projection</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> interpreter</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">control</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> Impl_Gas</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">record_cost gas constants</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VERYLOW </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> None </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> control </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ILoop</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Loop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_instruction_result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      interpreter</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">control</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      instruction_result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">InstructionResult</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OutOfGas </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    interpreter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">control </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> control </span><span class="token operator" style="color:#393A34">|</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Some gas </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> control </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> ILoop</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Loop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gas</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">RefStub</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">injection</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> interpreter</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">control</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> gas </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> stack </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> interpreter</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stack</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> stack</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> IStack</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Stack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">popn_top</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punct punctuation" style="color:#393A34">{|</span><span class="token plain"> Integer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> stack </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> result </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Some </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> top</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">'</span><span class="token punct punctuation" style="color:#393A34">{|</span><span class="token plain"> ArrayPair</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> x1 </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> arr</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> x2 </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> top</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">RefStub</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">projection</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> stack </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> stack </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> top</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">RefStub</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">injection</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> stack </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Impl_Uint</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">wrapping_add x1 x2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    interpreter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">control </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> control </span><span class="token operator" style="color:#393A34">|</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stack </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> stack </span><span class="token operator" style="color:#393A34">|</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> None </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> control </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ILoop</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Loop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_instruction_result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      control</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      instruction_result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">InstructionResult</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StackUnderflow </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    interpreter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">control </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> control </span><span class="token operator" style="color:#393A34">|</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stack </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> stack </span><span class="token operator" style="color:#393A34">|</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_host</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is a bit longer! But if you look precisely at the code, it is actually doing what the original Rust code was doing once you unroll the macros. It explicitly handles the error cases of:</p>
<ul>
<li>A gas level being too low, with the error <code>instruction_result.InstructionResult.OutOfGas</code>.</li>
<li>A stack underflow, with the error <code>instruction_result.InstructionResult.StackUnderflow</code>.</li>
</ul>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Note</div><div class="admonitionContent_BuS1"><p>At the first line, with <code>Output.Success tt</code>, we are saying that the function is always successful, that is to say, without possible panics, and so for any possible input. This safety property in itself is very important, and sometimes enough to consider a software safe to deploy.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-challenges">ðŸ¤” Challenges<a href="https://formal.land/blog/2025/07/06/functional-specification-add#-challenges" class="hash-link" aria-label="Direct link to ðŸ¤” Challenges" title="Direct link to ðŸ¤” Challenges">â€‹</a></h2>
<p>One challenge in this code is that there are a lot of parameters through the use of traits. For example, the type of the stack is abstract, and it can only be manipulated through methods of the corresponding trait. You can look at the list of traits provided to the implementations of the instructions in the file <a href="https://github.com/formal-land/coq-of-rust/blob/main/CoqOfRust/revm/revm_interpreter/interpreter_types.rs" target="_blank" rel="noopener noreferrer">revm_interpreter/interpreter_types.rs</a>.</p>
<p>Here is an example for the stack:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">trait</span><span class="token plain"> </span><span class="token type-definition class-name">StackTrait</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">is_empty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">U256</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">push_b256</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">B256</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">popn</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token class-name">N</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usize</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">U256</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token class-name">N</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">popn_top</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">POPN</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usize</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">U256</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">POPN</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">U256</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">top</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">U256</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">pop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">U256</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">pop_address</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Address</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">exchange</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> n</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">dup</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> n</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We specify the functions of interest for us in <a href="https://github.com/formal-land/coq-of-rust/blob/main/CoqOfRust/revm/revm_interpreter/simulate/interpreter_types.v" target="_blank" rel="noopener noreferrer">revm_interpreter/simulate/interpreter_types.v</a> (the code is too long to copy here).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-technique">ðŸ¤– Technique<a href="https://formal.land/blog/2025/07/06/functional-specification-add#-technique" class="hash-link" aria-label="Direct link to ðŸ¤– Technique" title="Direct link to ðŸ¤– Technique">â€‹</a></h2>
<p>We first use our tool <a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">coq-of-rust</a>, to translate the Rust code to Rocq. We then refine the translated code in two steps to obtain the functional specification:</p>
<ol>
<li>Adding type and trait information. This information is lost in our translation as they are hard to map in a very general way to equivalent Rocq code, but we retrieve it mostly automatically with the <code>run_symbolic</code> tactic that we designed. Only the handling of trait instances is somewhat manual, and we are working on automating it more.</li>
<li>Showing that the translated code is equivalent to the functional specification, using the predicate:<!-- -->
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> expression ðŸŒ² functional_specification </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ol>
<p>With this predicate, we symbolically execute the typed version of the translated code, using a typed stack, and show the code to be equal in the mathematical sense to the functional specification. This statement holds for any possible input, and so we have shown that the implementation is correct according to our specification. All the semantic rules associated with our Rust monad are in the files:</p>
<ul>
<li><a href="https://github.com/formal-land/coq-of-rust/blob/main/CoqOfRust/M.v" target="_blank" rel="noopener noreferrer">M.v</a> for the definition of the monad.</li>
<li><a href="https://github.com/formal-land/coq-of-rust/blob/main/CoqOfRust/links/M.v" target="_blank" rel="noopener noreferrer">links/M.v</a> for the typing and trait instances rules.</li>
<li><a href="https://github.com/formal-land/coq-of-rust/blob/main/CoqOfRust/simulate/M.v" target="_blank" rel="noopener noreferrer">simulate/M.v</a> for the memory allocation rules and equality with the functional specification.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ï¸-conclusion">âœ’ï¸ Conclusion<a href="https://formal.land/blog/2025/07/06/functional-specification-add#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to âœ’ï¸ Conclusion" title="Direct link to âœ’ï¸ Conclusion">â€‹</a></h2>
<p>This shows that we can fully specify complex Rust code, using many dependencies and language features. There are still steps that we are continuing to automate more, like the functional specification on function calls.</p>
<p>If you have complex Rust code that you need to certify as bug-free (smart contracts, zkVMs, etc.), please contact us as it is now possible to do so at a reasonable cost.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions!</em></p></div></div>]]></content:encoded>
            <category>Rust</category>
            <category>EVM</category>
            <category>coq-of-rust</category>
            <category>functional specification</category>
        </item>
        <item>
            <title><![CDATA[ðŸ¦€ Beginning of translation of OpenVM to Rocq]]></title>
            <link>https://formal.land/blog/2025/06/15/beginning-of-openvm-to-rocq</link>
            <guid>https://formal.land/blog/2025/06/15/beginning-of-openvm-to-rocq</guid>
            <pubDate>Sun, 15 Jun 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Here, we present our beginning work of translating part of the OpenVM code to the proof assistant &nbsp;Rocq. The aim is to experiment around the formal verification of the zero-knowledge circuits of this zkVM based on the Plonky3 library. One of the aims of the zkVMs is to increase the scalability of the blockchains by packing many transactions in a single zk proof.]]></description>
            <content:encoded><![CDATA[<p>Here, we present our beginning work of translating part of the <a href="https://openvm.dev/" target="_blank" rel="noopener noreferrer">OpenVM</a> code to the proof assistant <a href="https://rocq-prover.org/" target="_blank" rel="noopener noreferrer"><img src="https://raw.githubusercontent.com/coq/rocq-prover.org/refs/heads/main/rocq-id/logos/SVG/icon-rocq-orange.svg" height="18px">&nbsp;Rocq</a>. The aim is to experiment around the formal verification of the zero-knowledge circuits of this zkVM based on the <a href="https://github.com/Plonky3/Plonky3" target="_blank" rel="noopener noreferrer">Plonky3</a> library. One of the aims of the zkVMs is to increase the scalability of the blockchains by packing many transactions in a single zk proof.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Work with us!</div><div class="admonitionContent_BuS1"><p>With <strong>formal verification</strong> you can <strong>guarantee</strong> that your code is safe, given the specifications.</p><p><strong>Contact us</strong> at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">&nbsp;ðŸ’Œcontact@formal.land</a> to discuss how to apply formal verification to your code!&nbsp;ðŸ›¡ï¸</p><p>We cover <strong>Rust</strong>, <strong>Solidity</strong>, and <strong>ZK systems</strong>.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-target">ðŸŽ¯ Target<a href="https://formal.land/blog/2025/06/15/beginning-of-openvm-to-rocq#-target" class="hash-link" aria-label="Direct link to ðŸŽ¯ Target" title="Direct link to ðŸŽ¯ Target">â€‹</a></h2>
<p>Our goal is to formally verify that the circuit of the component <a href="https://github.com/openvm-org/openvm/blob/main/extensions/rv32im/circuit/src/branch_eq/core.rs" target="_blank" rel="noopener noreferrer">BranchEq</a> of OpenVM is not underconstrained. This is one of the main security properties to look for in a circuit. This means that it is not possible to provide a proof of execution with a behavior different from what is expected.</p>
<p>A circuit is a set of equality assertions between values in a prime field using only addition or multiplication. Said otherwise, they are a set of equations on polynomials. The OpenVM project uses the Plonky3 library to define these. It adds a wrapper on top of Plonky3 with APIs to define custom instructions. An implementation for the RISC-V instruction set is provided but it could be anything, and it is easily extensible. This is convenient for example to provide optimized circuits for hashing primitives.</p>
<p>We will attempt to directly translate the Rust code describing the circuit to Rocq. There are a lot of challenge in this translation, as the Rust language contains a lot of hidden complexities, but it has the promise to be easy to maintain as we get a circuit description that closely matches its implementation.</p>
<p>The source links are:</p>
<ul>
<li><a href="https://github.com/openvm-org/openvm/blob/main/extensions/rv32im/circuit/src/branch_eq/core.rs" target="_blank" rel="noopener noreferrer">github.com/openvm-org/openvm/blob/main/extensions/rv32im/circuit/src/branch_eq/core.rs</a></li>
<li><a href="https://github.com/openvm-org/openvm/blob/main/extensions/rv32im/circuit/src/README.md" target="_blank" rel="noopener noreferrer">github.com/openvm-org/openvm/blob/main/extensions/rv32im/circuit/src/README.md</a></li>
</ul>
<p>The main datatype on which the circuit computes is:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">BranchEqualCoreCols</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NUM_LIMBS</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usize</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NUM_LIMBS</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NUM_LIMBS</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Boolean result of a op b. Should branch if and only if cmp_result = 1.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> cmp_result</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> imm</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> opcode_beq_flag</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> opcode_bne_flag</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> diff_inv_marker</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NUM_LIMBS</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>where you can consider&nbsp;<code>T</code> as being the type of a prime field. The Rust function to generate the equations is:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">impl</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">I</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NUM_LIMBS</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usize</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token class-name">VmCoreAir</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">I</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token class-name">BranchEqualCoreAir</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">NUM_LIMBS</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">InteractionBuilder</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">I</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">VmAdapterInterface</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Expr</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">I</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Reads</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">From</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Expr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NUM_LIMBS</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">I</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Writes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Default</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">I</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">ProcessedInstruction</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">From</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">ImmInstruction</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Expr</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">eval</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        builder</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        local</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Var</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        from_pc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Var</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">AdapterAirContext</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Expr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">I</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> cols</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token class-name">BranchEqualCoreCols</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NUM_LIMBS</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> local</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">borrow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> flags </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">opcode_beq_flag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">opcode_bne_flag</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> is_valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">iter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fold</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Expr</span><span class="token punctuation" style="color:#393A34">::</span><span class="token constant" style="color:#36acaa">ZERO</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token closure-params">acc</span><span class="token closure-params punctuation" style="color:#393A34">,</span><span class="token closure-params"> </span><span class="token closure-params operator" style="color:#393A34">&amp;</span><span class="token closure-params">flag</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            builder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">assert_bool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">flag</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            acc </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> flag</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">into</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        builder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">assert_bool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">is_valid</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        builder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">assert_bool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cmp_result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> a </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> b </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> inv_marker </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">diff_inv_marker</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> cmp_eq </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cmp_result </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">opcode_beq_flag </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">not</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cmp_result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">opcode_bne_flag</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> sum </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cmp_eq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">..</span><span class="token constant" style="color:#36acaa">NUM_LIMBS</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> inv_marker</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            builder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">assert_zero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cmp_eq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        builder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">when</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">is_valid</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">assert_one</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sum</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> expected_opcode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">iter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">zip</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">BranchEqualOpcode</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">iter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fold</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Expr</span><span class="token punctuation" style="color:#393A34">::</span><span class="token constant" style="color:#36acaa">ZERO</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token closure-params">acc</span><span class="token closure-params punctuation" style="color:#393A34">,</span><span class="token closure-params"> </span><span class="token closure-params punctuation" style="color:#393A34">(</span><span class="token closure-params">flag</span><span class="token closure-params punctuation" style="color:#393A34">,</span><span class="token closure-params"> opcode</span><span class="token closure-params punctuation" style="color:#393A34">)</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                acc </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">flag</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">into</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Expr</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">from_canonical_u8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">opcode </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Expr</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">from_canonical_usize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">offset</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> to_pc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> from_pc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cmp_result </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">imm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">not</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cmp_result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Expr</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">from_canonical_u32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pc_step</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">AdapterAirContext</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            to_pc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Some</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">to_pc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            reads</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Into</span><span class="token punctuation" style="color:#393A34">::</span><span class="token plain">into</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Into</span><span class="token punctuation" style="color:#393A34">::</span><span class="token plain">into</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">into</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            writes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Default</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">default</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            instruction</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">ImmInstruction</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                is_valid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                opcode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> expected_opcode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                immediate</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">imm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">into</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">into</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>An interesting part of this code is that it returns polynomial expressions to be used later, in addition to generating equations.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-why-is-rust-code-complex">â“ Why is Rust code complex?<a href="https://formal.land/blog/2025/06/15/beginning-of-openvm-to-rocq#-why-is-rust-code-complex" class="hash-link" aria-label="Direct link to â“ Why is Rust code complex?" title="Direct link to â“ Why is Rust code complex?">â€‹</a></h2>
<p>Although the code of the function is relatively short (around 50 lines), it contains a lot of implicit function calls. This mainly comes from the fact that it is parametrized by many traits, as you can see in the signature of the function. To know exactly which function is being called, you need to unroll a lot of the definitions.</p>
<p>This applies to all the definitions handling field elements, like <code>AB::Expr</code>, as well as iterators, with calls to the <code>zip</code> and <code>fold</code> functions for example. We are exposed to this complexity when formally verifying the code above, and this is one of the reasons Rust is a complex language to formally verify, although it is very elegant with a lot of abstractions.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-what-is-the-plan">ðŸ” What is the plan?<a href="https://formal.land/blog/2025/06/15/beginning-of-openvm-to-rocq#-what-is-the-plan" class="hash-link" aria-label="Direct link to ðŸ” What is the plan?" title="Direct link to ðŸ” What is the plan?">â€‹</a></h2>
<p>Our plan is as follows:</p>
<ol>
<li>Translate the Rust code to Rocq using <a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">coq-of-rust</a> (this part is automatically done).</li>
<li>Express all the data types using native Rocq types and resolving the trait hierarchies (phase that we call <strong>linking</strong>).</li>
<li>Define an API for Plonky3 as a free monad in Rocq, with all the primitive operations like creating an expression, building a constraint, etc.</li>
<li>Show that the translated Rust code can be expressed in an equivalent way using this Plonky3 monad. Alternatively we could pretty-print the constraints at this point and compare them between the Rust and Rocq versions, if showing the equivalence is too hard.</li>
<li>Formally verify that the circuits are not underconstrained.</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-linking">ðŸ”— Linking<a href="https://formal.land/blog/2025/06/15/beginning-of-openvm-to-rocq#-linking" class="hash-link" aria-label="Direct link to ðŸ”— Linking" title="Direct link to ðŸ”— Linking">â€‹</a></h2>
<p>We are focusing on producing a typed-version for the <code>eval</code> function above, with an explicit trait hierarchy. Indeed <code>coq-of-rust</code> produces definitions that are untyped (all values have the type <code>Value.t</code>) and the relation between identifiers and function definitions or trait instances is defined by equations.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="trait-hierarchy">Trait hierarchy<a href="https://formal.land/blog/2025/06/15/beginning-of-openvm-to-rocq#trait-hierarchy" class="hash-link" aria-label="Direct link to Trait hierarchy" title="Direct link to Trait hierarchy">â€‹</a></h3>
<p>In the file <a href="https://github.com/formal-land/coq-of-rust/blob/e91da9613fee8c2ba6b12f60d6a979935ed1d811/CoqOfRust/plonky3/commit_539bbc84/field/links/field.v" target="_blank" rel="noopener noreferrer">CoqOfRust/plonky3/commit_539bbc84/field/links/field.v</a> we define the trait hierarchy corresponding to the Plonky3 definitions for fields in <a href="https://github.com/Plonky3/Plonky3/blob/539bbc84085efb609f4f62cb03cf49588388abdb/field/src/field.rs" target="_blank" rel="noopener noreferrer">field/src/field.rs</a>. One thing we had to do was to break the mutual dependency between the traits <code>FieldAlgebra</code> and <code>Field</code>:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">trait</span><span class="token plain"> </span><span class="token type-definition class-name">FieldAlgebra</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token type-definition class-name">F</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Field</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">trait</span><span class="token plain"> </span><span class="token type-definition class-name">Field</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">FieldAlgebra</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">F</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Self</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>by defining on the Rocq side:</p>
<ol>
<li>A trait <code>FieldAlgebraWithoutField</code> that is like <code>FieldAlgebra</code> but without the <code>Field</code> trait constraint on the associated type <code>F</code>.</li>
<li>A trait <code>Field</code> depending on <code>FieldAlgebraWithoutField</code>. Note that here, we do not need to add the <code>Field</code> constraint on <code>F</code> to be equivalent to the Rust code, as it is the <code>Self</code> type of <code>Field</code>, so it necessarily implements the <code>Field</code> trait.</li>
<li>A trait <code>FieldAlgebra</code> taking the trait <code>FieldAlgebraWithoutField</code> and adding the <code>Field</code> trait constraint on the associated type <code>F</code>.</li>
</ol>
<p>On the Rocq side, we are free to organize our trait definitions as we want as long as they correspond to the trait equations generated by <code>coq-of-rust</code>. If we do not build our trait hierarchy properly, we will be stuck when defining the typed version of the functions' bodies.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="eval-body">Eval body<a href="https://formal.land/blog/2025/06/15/beginning-of-openvm-to-rocq#eval-body" class="hash-link" aria-label="Direct link to Eval body" title="Direct link to Eval body">â€‹</a></h3>
<p>For now, the typed version of the <code>eval</code> function is defined as follows:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Instance</span><span class="token plain"> run_eval</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">AB I </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">NUM_LIMBS </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Usize</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Link AB</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Link I</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">AirBuilder_types </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AirBuilder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AssociatedTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">AirBuilder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AssociatedTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AreLinks AirBuilder_types</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">VmAdapterInterface_types </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> VmAdapterInterface</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AssociatedTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">VmAdapterInterface</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AssociatedTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AreLinks VmAdapterInterface_types</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">run_InteractionBuilder_for_AB </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> InteractionBuilder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Run AB AirBuilder_types</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">run_VmAdapterInterface_for_I </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        VmAdapterInterface</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          I</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          AirBuilder_types</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">AirBuilder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AssociatedTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Expr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          VmAdapterInterface_types</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ref</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Pointer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Kind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ref </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Self NUM_LIMBS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">builder </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ref</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Pointer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Kind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MutRef AB</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">local </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Ref</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Pointer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Kind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ref </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">list AirBuilder_types</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">AirBuilder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AssociatedTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Var</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">from_pc </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AirBuilder_types</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">AirBuilder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AssociatedTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Var</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">eval </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ï† NUM_LIMBS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Î¦ AB</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Î¦ I</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Ï† self</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> Ï† builder</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> Ï† local</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> Ï† from_pc</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      unit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Proof</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    constructor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    destruct run_InteractionBuilder_for_AB</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    destruct run_AirBuilder_for_Self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    destruct run_VmAdapterInterface_for_I</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    destruct </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Impl_Borrow_BranchEqualCoreCols_for_slice_T</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      AirBuilder_types</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">AirBuilder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AssociatedTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Var</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      NUM_LIMBS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    destruct run_FieldAlgebra_for_Expr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    destruct run_FieldAlgebra_for_Self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    destruct run_Clone_for_Self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pose proof </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Impl_Into_for_From_T</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Impl_From_for_T</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run AirBuilder_types</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">AirBuilder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AssociatedTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Expr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    destruct run_Add_for_Self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    destruct run_Mul_for_Self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    destruct run_Add_Expr_for_Var</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    destruct run_Mul_Var_for_Var</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    destruct run_Mul_Var_for_Expr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    run_symbolic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Admitted</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We generate the typed definition automatically with the tactic <code>run_symbolic</code>, based on the code translated by <code>coq-of-rust</code> and knowing there should only be one possible typed definition corresponding to each untyped one.</p>
<p>A difficulty that is not solved yet is that we need to provide in context all the trait instances which will be used. This is the series of <code>destruct</code> at the beginning of the proof. Unfortunately, a lot of them are needed and it is sometimes hard to find them, especially for those that require specific parameters which we need to make explicit.</p>
<p>There are also a few closures used in this code, for which the handling is not automated enough yet.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ï¸-naming-the-versions">ðŸ·ï¸ Naming the versions<a href="https://formal.land/blog/2025/06/15/beginning-of-openvm-to-rocq#%EF%B8%8F-naming-the-versions" class="hash-link" aria-label="Direct link to ðŸ·ï¸ Naming the versions" title="Direct link to ðŸ·ï¸ Naming the versions">â€‹</a></h2>
<p>For now, we put all the Rocq translation of Rust code in a folder <a href="https://github.com/formal-land/coq-of-rust/tree/main/CoqOfRust" target="_blank" rel="noopener noreferrer">CoqOfRust/</a>. To avoid collisions between different versions of the same library, we started using a sub-folder for each crate with the name of the version in use. For example, the Plonky3 translation is now put in the folder <code>CoqOfRust/plonky3/commit_539bbc84</code> as this is the precise version used by the OpenVM code we are looking at.</p>
<p>In the long run, it will also be useful to make backward compatibility proofs, where we show that a newer version of a crate behaves the same as an older one on all the common endpoints. The only downside of this naming scheme is that it makes the paths longer in the <code>Require</code> commands.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ï¸-conclusion">âœ’ï¸ Conclusion<a href="https://formal.land/blog/2025/06/15/beginning-of-openvm-to-rocq#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to âœ’ï¸ Conclusion" title="Direct link to âœ’ï¸ Conclusion">â€‹</a></h2>
<p>We have not succeeded yet in extracting a typed Rocq version of the <code>BranchEq</code> module of OpenVM. We will work next on adding more automation to <code>coq-of-rust</code> to make the linking phase easier.</p>
<p>In parallel, we are working on a hand-written version of the <code>BranchEq</code> module in Rocq, to start verifying the circuits, which we will show equivalent to the translated version once the linking phase is automated.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions!</em></p></div></div>]]></content:encoded>
            <category>Rust</category>
            <category>OpenVM</category>
            <category>coq-of-rust</category>
        </item>
        <item>
            <title><![CDATA[ðŸ¦€ Typing and naming of Rust code in Rocq (2/3)]]></title>
            <link>https://formal.land/blog/2025/02/05/links-for-rust-in-rocq-2</link>
            <guid>https://formal.land/blog/2025/02/05/links-for-rust-in-rocq-2</guid>
            <pubDate>Wed, 05 Feb 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[In this blog post we present how represent a proof of execution for translated ðŸ¦€&nbsp;Rust programs in &nbsp;Rocq/Coq, to show that it is possible to type the values and resolve the names. Resolving the names amounts to finding the trait instances and an ordering for the function definitions.]]></description>
            <content:encoded><![CDATA[<p>In this blog post we present how represent a proof of execution for translated <a href="https://www.rust-lang.org/" target="_blank" rel="noopener noreferrer">ðŸ¦€&nbsp;Rust</a> programs in <a href="https://rocq-prover.org/" target="_blank" rel="noopener noreferrer"><img src="https://raw.githubusercontent.com/coq/rocq-prover.org/refs/heads/main/rocq-id/logos/SVG/icon-rocq-orange.svg" height="18px">&nbsp;Rocq/Coq</a>, to show that it is possible to type the values and resolve the names. Resolving the names amounts to finding the trait instances and an ordering for the function definitions.</p>
<p>We call these proofs of execution "links". They do not contain memory allocation strategies, which can be defined later in a second step called "simulation". From these links we have all the information to extract a typed execution that is equivalent to the translated code from <a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">coq-of-rust</a>. The core of the work presented in this article is in the file <a href="https://github.com/formal-land/coq-of-rust/blob/main/CoqOfRust/links/M.v" target="_blank" rel="noopener noreferrer">CoqOfRust/links/M.v</a> on GitHub.</p>
<p>This is the continuation of the following article:</p>
<ul>
<li><a href="https://formal.land/blog/2025/01/30/links-for-rust-in-rocq">ðŸ¦€ Typing and naming of Rust code in Rocq (1/3)</a></li>
</ul>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Ask for the highest security!</div><div class="admonitionContent_BuS1"><p>When millions are at stake, bug bounties are not enough. How do you ensure your security audits are exhaustive?</p><p>The best way is to use <strong>formal verification</strong>.</p><p><strong>Contact us</strong> at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">&nbsp;ðŸ’Œcontact@formal.land</a> to make sure your code is safe!&nbsp;ðŸ›¡ï¸</p><p>We cover <strong>Rust</strong>, <strong>Solidity</strong>, and <strong>ZK systems</strong>.</p></div></div>
<figure><p><img decoding="async" loading="lazy" alt="Green forest" src="https://formal.land/assets/images/green-forest-a051f559898a800a1ed19191d4c1372f.webp" width="1024" height="1024" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-untyped-code">ðŸª¨ Untyped code<a href="https://formal.land/blog/2025/02/05/links-for-rust-in-rocq-2#-untyped-code" class="hash-link" aria-label="Direct link to ðŸª¨ Untyped code" title="Direct link to ðŸª¨ Untyped code">â€‹</a></h2>
<p>Representing Rust programs as typed code in Rocq in a systematic way is challenging. Indeed, even if the two systems share many similarities (enum types, polymorphism, traits, ...) there are obstacles that prevent most Rust programs from being well-typed once represented in Rocq:</p>
<ul>
<li>There are lifetime annotations in Rust that are not present in Rocq. We can ignore them without too much loss on the typing side.</li>
<li>The trait/type inference mechanism in Rocq fails in rare cases where it succeeds in Rust. These rare cases are enough to make almost all Rust programs untypable in Rocq. A solution is to add type annotations on all sub-expressions, but this is very verbose and we still encountered some examples where it did not work!</li>
<li>The type definitions might not be correctly ordered, with mutual dependencies between files or between traits and types. This is probably the biggest issue, as mutually recursive types cannot be defined in Rocq in a general way or can make the reasoning about code too complex when they can.</li>
</ul>
<p>For all the reasons above, we chose to instead translate the Rust code in Rocq collapsing all the types to a single type <code>Value.t</code>:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Bool </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bool </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Integer </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kind </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">z </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Float </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> UnicodeChar </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">String</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Tuple </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Array </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> StructRecord </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> list </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">string </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> StructTuple </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> list t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Pointer </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Pointer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Closure </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">@</span><span class="token plain"> list Value </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Error </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> DeclaredButUndefined</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We represent enums and structs using the <code>StructRecord</code> or <code>StructTuple</code> constructors, depending on when the fields are named or ordered. The first string parameter is the absolute name of the type or the name of the type concatenated to the name of the constructor for enums. Note that in Rust there is always a unique absolute name for all type/value definitions.</p>
<p>For example, if we have the type <code>Foo</code> in Rust:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">Foo</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    a</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">i32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    b</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>we would represent a value:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> foo </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Foo</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">42</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>as:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StructRecord </span><span class="token string" style="color:#e3116c">"Foo"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"a"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">I32 </span><span class="token number" style="color:#36acaa">42</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"b"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Bool true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In our experience, the named fields always appear in the same order.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-typed-version">ðŸ—¿ Typed version<a href="https://formal.land/blog/2025/02/05/links-for-rust-in-rocq-2#-typed-version" class="hash-link" aria-label="Direct link to ðŸ—¿ Typed version" title="Direct link to ðŸ—¿ Typed version">â€‹</a></h2>
<p>We let the user define a typed version of the code according to its need. Most of the time, the definitions will be straightforward, following the definitions in Rust. It will still be the opportunity to order the definitions in their order of dependencies, and break some mutual dependencies with custom definitions.</p>
<p>To relate typed values of some type <code>A</code> with their representation in <code>Value.t</code>, we use a conversion function from <code>A</code> to <code>Value.t</code> that should ideally be an injection. To help in the proofs and debugging, there should be at most one type and value of this type for each value in <code>Value.t</code>. We also add for each type <code>A</code> a serialized version of this type in <code>Ty.t</code> which may be used on the Rust side to know in a unique way which trait instance to use.</p>
<p>Here is the Rocq type-class we use to represent the conversion:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Class</span><span class="token plain"> Link </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Î¦ </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Ï† </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It gives, for a user-defined type <code>A</code> in Rocq, a way to represent this type in <code>Ty.t</code> on the Rust side, and a way to convert values of this type to <code>Value.t</code>. We use the Greek letters <code>Î¦</code> and <code>Ï†</code> to shorten the definitions. Here is the definition of the <code>Link</code> instance for the boolean type:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Bool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token attribute attr-name" style="color:#00a4db">Global</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Instance</span><span class="token plain"> IsLink </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Link bool </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Î¦ </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path </span><span class="token string" style="color:#e3116c">"bool"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ï† b </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Bool b</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Most of the definitions follow the same pattern. Note that we avoid defining a <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>Ï†</mi><mrow><mo>âˆ’</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">Ï†^{-1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0085em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">Ï†</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span> function that would be impossible or hard to define in general and not needed. In our proofs of equivalence between the untyped translated Rust code and the typed version, we will attempt to show the commutativity of the following diagram:</p>
<figure><p><img decoding="async" loading="lazy" alt="Commutative diagram" src="https://formal.land/assets/images/commutative-diagram-bbb4c911ed7560df3ed98090561652e4.png" width="453" height="303" class="img_ev3q"></p></figure>
<p>where:</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span></span></span></span> is the function from the translated Rust code,</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>f</mi><mo>~</mo></mover></mrow><annotation encoding="application/x-tex">\tilde{f}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1257em;vertical-align:-0.1944em"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9313em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span></span><span style="top:-3.6134em"><span class="pstrut" style="height:3em"></span><span class="accent-body" style="left:-0.0833em"><span class="mord">~</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em"><span></span></span></span></span></span></span></span></span> is its typed version that we define,</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Ï†</mi><mi>A</mi></msub></mrow><annotation encoding="application/x-tex">Ï†_A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">Ï†</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Ï†</mi><mi>B</mi></msub></mrow><annotation encoding="application/x-tex">Ï†_B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">Ï†</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em">B</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> are the conversion functions for the types <code>A</code> and <code>B</code> respectively.</li>
</ul>
<p>The commutativity of the diagram mean that all the paths are the same, that is to say that:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">âˆ€</mi><mo stretchy="false">(</mo><mi>x</mi><mo>:</mo><mi>A</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace width="1em"></mspace><mi>f</mi><mo stretchy="false">(</mo><msub><mi>Ï†</mi><mi>A</mi></msub><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi>Ï†</mi><mi>B</mi></msub><mo stretchy="false">(</mo><mover accent="true"><mi>f</mi><mo>~</mo></mover><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\forall (x : A),\quad f (Ï†_A x) = Ï†_B (\tilde{f} x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">âˆ€</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">A</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em"></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">Ï†</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.1813em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal">Ï†</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em">B</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9313em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span></span><span style="top:-3.6134em"><span class="pstrut" style="height:3em"></span><span class="accent-body" style="left:-0.0833em"><span class="mord">~</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em"><span></span></span></span></span></span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-proof-of-execution">ðŸ”® Proof of execution<a href="https://formal.land/blog/2025/02/05/links-for-rust-in-rocq-2#-proof-of-execution" class="hash-link" aria-label="Direct link to ðŸ”® Proof of execution" title="Direct link to ðŸ”® Proof of execution">â€‹</a></h2>
<p>To both define the typed <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>f</mi><mo>~</mo></mover></mrow><annotation encoding="application/x-tex">\tilde{f}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1257em;vertical-align:-0.1944em"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9313em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span></span><span style="top:-3.6134em"><span class="pstrut" style="height:3em"></span><span class="accent-body" style="left:-0.0833em"><span class="mord">~</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em"><span></span></span></span></span></span></span></span></span> version of the Rust code and to prove the commutativity of the diagram, we will define a tree that follows that the tree-like structure of the monad for the translated code.</p>
<p>Here are its basic combinators for the "return" and the "bind" of the monad:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Output </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Link Output</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Pure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">output </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Output</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Output</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">output</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> Exception</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  output</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Output</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_value output </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pure output</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> ðŸ”½ Output </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Let</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Output</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ty </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">to_value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Output</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> Exception</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Build_Link </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> ty to_value </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> e ðŸ”½ Output</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">forall</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value_inter </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Output</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Output</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> k </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Output</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_value value_inter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> ðŸ”½ Output </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Let</span><span class="token plain"> e k ðŸ”½ Output </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It reads as follows:</p>
<ul>
<li><strong>Pure</strong> If we have some <code>output'</code> value of type <code>Value.t</code> some <code>output</code> of type <code>A</code> that are related through the <code>Link</code> instance, then we can build a tree saying that the monadic untyped term <code>LowM.pure output'</code> executes to some value of type <code>Output</code> using the conversion from the <code>Link</code> instance. We wrap the conversion in the <code>Output.t</code> type to also represent exceptions, which are special error values that we propagate, for example, in case of <code>panic!</code> or premature <code>return</code> in a function.</li>
<li><strong>Let</strong> If an expression <code>e</code> can be reduced to a value of type <code>Output'</code> and if, for any value of type <code>Output'</code>, using the same link instance, we can execute <code>k</code> of this value to some value of type <code>Output</code>, then we can execute the monadic term <code>LowM.let e k</code> to some value of type <code>Output</code>.</li>
</ul>
<p>Note that in most of the expressions above the <code>Link</code> instance is implicit but still uniquely inferred by Rocq as there is only one for the types <code>Output</code> and <code>Output'</code> at a time.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-pointers">ðŸŽ£ Pointers<a href="https://formal.land/blog/2025/02/05/links-for-rust-in-rocq-2#-pointers" class="hash-link" aria-label="Direct link to ðŸŽ£ Pointers" title="Direct link to ðŸŽ£ Pointers">â€‹</a></h2>
<p>One difficulty is maintaining the consistency of the <code>Ï†</code> function that we use, especially for pointer operations (allocate, read, and write). Indeed, if one allocates a pointer to a boolean with the function:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>Ï†</mi><mtext>bool</mtext></msub><mo>:</mo><mtext>bool</mtext><mo>â†’</mo><mtext>Value.t</mtext><mspace linebreak="newline"></mspace><msub><mi>Ï†</mi><mtext>bool</mtext></msub><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>Value.Bool</mtext><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\varphi_{\text{bool}} : \text{bool} \to \text{Value.t}\\
\varphi_{\text{bool}}(b) = \text{Value.Bool}(b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">Ï†</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">bool</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord text"><span class="mord">bool</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">â†’</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord text"><span class="mord">Value.t</span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal">Ï†</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">bool</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord text"><span class="mord">Value.Bool</span></span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span>
<p>and reads it with the function:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mi>Ï†</mi><mtext>bool</mtext><mo mathvariant="normal" lspace="0em" rspace="0em">â€²</mo></msubsup><mo>:</mo><mtext>bool</mtext><mo>â†’</mo><mtext>Value.t</mtext><mspace linebreak="newline"></mspace><msubsup><mi>Ï†</mi><mtext>bool</mtext><mo mathvariant="normal" lspace="0em" rspace="0em">â€²</mo></msubsup><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>Value.Bool</mtext><mo stretchy="false">(</mo><mtext>not</mtext><mo stretchy="false">(</mo><mtext>b</mtext><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\varphi'_{\text{bool}} : \text{bool} \to \text{Value.t}\\
\varphi'_{\text{bool}}(b) = \text{Value.Bool}(\text{not}(\text{b}))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0489em;vertical-align:-0.247em"></span><span class="mord"><span class="mord mathnormal">Ï†</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8019em"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">bool</span></span></span></span></span><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord text"><span class="mord">bool</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">â†’</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord text"><span class="mord">Value.t</span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1.0519em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal">Ï†</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8019em"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">bool</span></span></span></span></span><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord text"><span class="mord">Value.Bool</span></span><span class="mopen">(</span><span class="mord text"><span class="mord">not</span></span><span class="mopen">(</span><span class="mord text"><span class="mord">b</span></span><span class="mclose">))</span></span></span></span></span>
<p>the value that is read will be different from the value that was allocated.</p>
<p>In order to maintain the consistency of the pointer operations, we attach an extra function <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Ï†</mi><mi>A</mi></msub></mrow><annotation encoding="application/x-tex">\varphi_A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">Ï†</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> to pointers that we allocated in the untyped translation and make sure that this function, acting as a meta-data at the level of the untyped code, is properly forwarded to all subsequent use. That way, we make sure we always use the same <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Ï†</mi></mrow><annotation encoding="application/x-tex">\varphi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">Ï†</span></span></span></span> function when allocating, reading, or writing a pointer.</p>
<p>Here is the rule to define a proof of execution for the allocation of a pointer:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CallPrimitiveStateAlloc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">of_value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> OfValue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t value</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">forall</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ref</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Pointer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Kind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Raw </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">OfValue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_Set of_value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> k </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ï† ref</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> ðŸ”½ Output </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallPrimitive </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Primitive</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StateAlloc value</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> k ðŸ”½ Output </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We have the <code>Ref.t</code> type on the side of the typed version to represent the Rust pointers. We reason for any possible references that could be allocated for the untyped value <code>value'</code>. We use the <code>OfValue.t</code> type to represent a combination of a type&nbsp;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal">A</span></span></span></span> and a certain function&nbsp;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Ï†</mi><mi>A</mi></msub></mrow><annotation encoding="application/x-tex">\varphi_A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">Ï†</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> with the property that:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">âˆƒ</mi><mo stretchy="false">(</mo><mi>x</mi><mo>:</mo><mi>A</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace width="1em"></mspace><msub><mi>Ï†</mi><mi>A</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>valueâ€™</mtext></mrow><annotation encoding="application/x-tex">\exists (x : A),\quad \varphi_A(x) = \text{value'}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">âˆƒ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">A</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em"></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal">Ï†</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord text"><span class="mord">valueâ€™</span></span></span></span></span></span>
<p>For more details, you can look at the file <a href="https://github.com/formal-land/coq-of-rust/blob/main/CoqOfRust/links/M.v" target="_blank" rel="noopener noreferrer">CoqOfRust/links/M.v</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-extracting-an-execution">ðŸ’§ Extracting an execution<a href="https://formal.land/blog/2025/02/05/links-for-rust-in-rocq-2#-extracting-an-execution" class="hash-link" aria-label="Direct link to ðŸ’§ Extracting an execution" title="Direct link to ðŸ’§ Extracting an execution">â€‹</a></h2>
<p>The Rocq relation above:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> e ðŸ”½ Output </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>is defined in <code>Set</code> instead of <code>Prop</code>. This means that it contains data in addition to stating the property that there exists an execution of with a certain type. We can then define a Rocq function <code>evaluate</code> that is total and builds this execution. Here is its signature:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Fixpoint</span><span class="token plain"> evaluate </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Output </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Link Output</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">e </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">run </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> e ðŸ”½ Output </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Output</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Output</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here <code>LowM.t</code> is the type version of the untyped <code>LowM.t</code> monad from above. We define this function by induction on the proof of execution <code>run</code>. We write this definition using the proof mode of Rocq as it is more convenient for this definition. Here is, for example, the definition for the allocation case (better read using the interactive mode of Rocq):</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">(* Alloc *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallPrimitive </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Primitive</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StateAlloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">OfValue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_value of_value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  intros ref_core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  eapply evaluate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">(* here is the recursive call *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> goal </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> H </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">forall</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|-</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">H </span><span class="token punct punctuation" style="color:#393A34">{|</span><span class="token plain"> Ref</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">core </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> ref_core </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Having access to the typed execution will be useful for the next phase, in which we will define the memory allocation strategies.</p>
<p>With the method we use, we do not need to define the execution explicitly: we derive it automatically from its equivalence proof with the untyped code, thus saving us time. In addition, as proofs can be generated semi-automatically in Rocq, we also hope to automate a lot of our definitions and have more robust scripts for when the source code changes.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ï¸-conclusion">âœ’ï¸ Conclusion<a href="https://formal.land/blog/2025/02/05/links-for-rust-in-rocq-2#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to âœ’ï¸ Conclusion" title="Direct link to âœ’ï¸ Conclusion">â€‹</a></h2>
<p>We have seen how to define a proof of execution using equivalent typed values for the untyped translated code from <code>coq-of-rust</code>, and extract a runnable typed code from it. In the next article we will see how to do the same for the resolution of names: to find the trait instances and the order of the function definitions.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions or requests!</em></p></div></div>]]></content:encoded>
            <category>Rust</category>
            <category>links</category>
            <category>simulations</category>
        </item>
        <item>
            <title><![CDATA[ðŸ¦€ Typing and naming of Rust code in Rocq (1/3)]]></title>
            <link>https://formal.land/blog/2025/01/30/links-for-rust-in-rocq</link>
            <guid>https://formal.land/blog/2025/01/30/links-for-rust-in-rocq</guid>
            <pubDate>Thu, 30 Jan 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[In this article we show how we re-build the type and naming information of ðŸ¦€&nbsp;Rust code in &nbsp;Rocq/Coq, the formal verification system we use. A challenge is to be able to represent arbitrary Rust programs, including the standard library of Rust and the whole of Revm, a virtual machine to run EVM programs.]]></description>
            <content:encoded><![CDATA[<p>In this article we show how we re-build the type and naming information of <a href="https://www.rust-lang.org/" target="_blank" rel="noopener noreferrer">ðŸ¦€&nbsp;Rust</a> code in <a href="https://rocq-prover.org/" target="_blank" rel="noopener noreferrer"><img src="https://raw.githubusercontent.com/coq/rocq-prover.org/refs/heads/main/rocq-id/logos/SVG/icon-rocq-orange.svg" height="18px">&nbsp;Rocq/Coq</a>, the formal verification system we use. A challenge is to be able to represent arbitrary Rust programs, including the standard library of Rust and the whole of <a href="https://github.com/bluealloy/revm" target="_blank" rel="noopener noreferrer">Revm</a>, a virtual machine to run <a href="https://en.wikipedia.org/wiki/Ethereum#Virtual_machine" target="_blank" rel="noopener noreferrer">EVM</a> programs.</p>
<p>This is the continuation of the following article:</p>
<ul>
<li><a href="https://formal.land/blog/2024/04/26/translation-core-alloc-crates">ðŸ¦€ Translation of the Rust's core and alloc crates</a></li>
</ul>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Ask for the highest security!</div><div class="admonitionContent_BuS1"><p>When millions are at stake, bug bounties are not enough. How do you ensure your security audits are exhaustive?</p><p>The best way is to use <strong>formal verification</strong>.</p><p><strong>Contact us</strong> at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">&nbsp;ðŸ’Œcontact@formal.land</a> to make sure your code is safe!&nbsp;ðŸ›¡ï¸</p><p>We cover <strong>Rust</strong>, <strong>Solidity</strong>, and <strong>ZK systems</strong>.</p></div></div>
<figure><p><img decoding="async" loading="lazy" alt="Green forest" src="https://formal.land/assets/images/green-forest-00d5ecf11d8ae6a919d6f5e8ce6aeb7e.webp" width="1024" height="1024" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-the-challenge">ðŸŽ¯ The challenge<a href="https://formal.land/blog/2025/01/30/links-for-rust-in-rocq#-the-challenge" class="hash-link" aria-label="Direct link to ðŸŽ¯ The challenge" title="Direct link to ðŸŽ¯ The challenge">â€‹</a></h2>
<p>Our goal is to be able to formally verify large Rust codebases, counting thousands of lines, and without having to modify the code to make it more amenable to formal verification. Our concrete example is the verification of the Revm that includes about 10,000 lines of Rust code, depending on how far we include the dependencies.</p>
<p>This requires to have a methodology of verification that both:</p>
<ul>
<li>Scales with the size of the codebase. Rust programs often use a lot of abstractions, and we make the choice to keep these abstractions in the formal model. Combined with the expressivity of the Rocq prover, we hope this will ensure we can scale our reasoning.</li>
<li>Supports most of the Rust language, noting that Rust is a complex and feature-rich language.</li>
</ul>
<p>To make sure our translation from the Rust language to the Rocq system has good support, we generate a translation that is very verbose and rather low-level without interpreting the meaning of the various Rust primitives too much. For example, our translation tool is only about 5,000 lines long. It is written in Rust and uses the APIs of the <code>rustc</code> compiler.</p>
<p>This approach leaves the burdens of defining the semantics of Rust and designing the reasoning primitives on the Rocq side.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-strategy">ðŸ› Strategy<a href="https://formal.land/blog/2025/01/30/links-for-rust-in-rocq#-strategy" class="hash-link" aria-label="Direct link to ðŸ› Strategy" title="Direct link to ðŸ› Strategy">â€‹</a></h2>
<p>We plan to reason on the translated Rust code with two intermediate steps:</p>
<ol>
<li><strong>Links</strong> These represent a complete rewriting of the translated code, adding type and naming information that are erased during the translation to Rocq. We also prove that this rewriting is equivalent to the initial translation. We hope to automate this step as much as possible.</li>
<li><strong>Simulations</strong> In this step we make the less obvious transformations, in particular representing the memory mutations in a clean and custom state monad, as well as various optimizations such as collapsing all the integer types if it helps for the proofs later. We also prove that this rewriting is equivalent to the links.</li>
</ol>
<p>At the end of the <strong>Simulations</strong> step, we should obtain a purely functional and idiomatic representation of the original Rust code in Rocq. This representation should be easier to reason about, and we will be able to formally verify properties of the code.</p>
<p>As a summary, here are the steps we want to follow:</p>
<figure class="text--center"><p><img decoding="async" loading="lazy" alt="Compilation steps" src="https://formal.land/assets/images/compilation-steps-28e6722120c86d9e17aa05e4d38f1515.svg" width="214" height="696" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-example">ðŸ§ª Example<a href="https://formal.land/blog/2025/01/30/links-for-rust-in-rocq#-example" class="hash-link" aria-label="Direct link to ðŸ§ª Example" title="Direct link to ðŸ§ª Example">â€‹</a></h2>
<p>Here is an example from the standard library of Rust, which is used to define other comparison operators:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">max_by</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">F</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">FnOnce</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Ordering</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v2</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> compare</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">F</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">compare</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">v2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Ordering</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Less</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token class-name">Ordering</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Equal</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> v2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Ordering</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Greater</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> v1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This example is interesting as it uses some abstractions, with polymorphism, traits, closures, and a bit of pointer manipulations. Ideally, we should be able to represent it with a Rocq code of a similar size, without the explicit references&nbsp;<code>&amp;</code> that are mostly useless in a purely functional setting. But here is the Rocq code we obtain after running&nbsp;<a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">coq-of-rust</a>:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> max_by </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Îµ </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ï„ </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Î± </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> Îµ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Ï„</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Î± </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> T</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> F </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> v1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> v2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> compare </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">monadic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> v1 </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> v1 </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> v2 </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> v2 </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> compare </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> compare </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">match_operator </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">call_closure </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_trait_method </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">"core::ops::function::FnOnce"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                F</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tuple </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path </span><span class="token string" style="color:#e3116c">"&amp;"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> T </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path </span><span class="token string" style="color:#e3116c">"&amp;"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> T </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">"call_once"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> compare </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tuple</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">borrow </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      Pointer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Kind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ref</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">deref </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">borrow </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Pointer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Kind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ref</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v1 </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">borrow </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      Pointer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Kind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ref</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">deref </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">borrow </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Pointer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Kind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ref</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v2 </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> Î³ </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">monadic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find_or_pattern </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  Î³</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> Î³ </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">monadic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_struct_tuple </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Î³</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"core::cmp::Ordering::Less"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tuple </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> Î³ </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">monadic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_struct_tuple </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Î³</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"core::cmp::Ordering::Equal"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tuple </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> Î³ </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">monadic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> Î³ </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">monadic v2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">impossible </span><span class="token string" style="color:#e3116c">"wrong number of arguments"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> Î³ </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">monadic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_struct_tuple </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Î³</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"core::cmp::Ordering::Greater"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                v1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">impossible </span><span class="token string" style="color:#e3116c">"wrong number of arguments"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is extremely verbose and not idiomatic for Rocq! We can see some of the Rust features that are made explicit:</p>
<ul>
<li>The list of constant generics <code>Îµ</code>, the list of type generics <code>Ï„</code>, and the list of arguments <code>Î±</code>.</li>
<li>The memory operations <code>alloc</code> and <code>read</code>, and the pointers manipulations <code>borrow</code> and <code>deref</code>.</li>
<li>The trait instance resolution with <code>M.get_trait_method</code>.</li>
<li>The decomposition of the pattern matching in more elementary operations like <code>M.is_struct_tuple</code>.</li>
</ul>
<p>Most of this information comes from the <a href="https://rustc-dev-guide.rust-lang.org/thir.html" target="_blank" rel="noopener noreferrer">THIR intermediate representation</a> of the code as provided by the Rust compiler.</p>
<p>Here is the link definition we will write, proven equivalent to the code above by construction:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> run_max_by </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">T F </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Link T</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Link F</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Run_FnOnce_for_F </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      function</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FnOnce</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        F</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ref</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Pointer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Kind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ref T </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Ref</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Pointer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Kind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ref T</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Output </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Ordering</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v1 v2 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> T</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">compare </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> F</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> cmp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">max_by </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> Î¦ T</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> Î¦ F </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> Ï† v1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> Ï† v2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> Ï† compare </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> ðŸ”½ T </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Proof</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  destruct Run_FnOnce_for_F </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">call_once </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">H_call_once run_call_once</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  run_symbolic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  eapply Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallPrimitiveGetTraitMethod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> H_call_once</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  run_symbolic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  eapply Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallClosure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">run_call_once compare </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ref</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">immediate </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> v1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Ref</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">immediate </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> v2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  intros </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ordering </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> cbn</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">run_symbolic</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  destruct ordering</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> run_symbolic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Defined</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The beginning of the definition corresponds to the trait resolution and calls to the <code>compare</code> function. The last part with <code>destruct ordering</code> is the representation of the <code>match</code> statement in the Rust code. With this definition, we add explicit Rocq types instead of the universal <code>Value.t</code> type of the translated code and make explicit the trait resolution. The trait instance has to be provided as an explicit parameter with the <code>Run_FnOnce_for_F</code> argument.</p>
<p>With the statement:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> cmp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">max_by </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> Î¦ T</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> Î¦ F </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> Ï† v1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> Ï† v2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> Ï† compare </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> ðŸ”½ T </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>we say that the translated function <code>cmp.max_by</code> has a "link" definition, built implicitly in the proof, returning a value of type <code>T</code>. We can extract the definition of this function calling the primitive:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">evaluate </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">forall</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Output </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Link Output</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">e </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> e ðŸ”½ Output </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Output</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Output</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It returns a "link" computation in the <code>LowM.t</code> monad. The output is often unreadable as it is, but we can step through it by symbolic execution. This will be useful for the next step to define and prove equivalent the "simulations".</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-links-monad">ðŸ”® Link's monad<a href="https://formal.land/blog/2025/01/30/links-for-rust-in-rocq#-links-monad" class="hash-link" aria-label="Direct link to ðŸ”® Link's monad" title="Direct link to ðŸ”® Link's monad">â€‹</a></h2>
<p>Like the monad used for the translation of Rust programs by <code>coq-of-rust</code>, the link's monad is a free monad but with fewer primitive operations. The primitive operations are only related to the memory handling:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> StateAlloc </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Link A</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ref</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> StateRead </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Link A</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref_core </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ref</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> StateWrite </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Link A</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref_core </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ref</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t unit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> GetSubPointer </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A Sub_A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Link A</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Link Sub_A</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref_core </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ref</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">runner </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SubPointer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Runner</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t A Sub_A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ref</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Sub_A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Compared to the side effects in the generated translation, we eliminate all the operations related to name handling (trait resolution, function calls, etc.). We also always use explicit types instead of the universal <code>Value.t</code> type and get rid of the <code>M.impossible</code> operation that was necessary to represent impossible branches in the absence of types.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ï¸-conclusion">âœ’ï¸ Conclusion<a href="https://formal.land/blog/2025/01/30/links-for-rust-in-rocq#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to âœ’ï¸ Conclusion" title="Direct link to âœ’ï¸ Conclusion">â€‹</a></h2>
<p>We have presented our general strategy to formally verify large Rust codebases. In the next blog posts, we will go into more details to look at the definition of the proof of equivalence for the links, and at how we automate the most repetitive parts of the proofs.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions or requests!</em></p></div></div>]]></content:encoded>
            <category>Rust</category>
            <category>links</category>
            <category>simulations</category>
        </item>
        <item>
            <title><![CDATA[ðŸ¤– Designing a coding assistant for Rocq]]></title>
            <link>https://formal.land/blog/2025/01/21/designing-a-coding-assistant-for-rocq</link>
            <guid>https://formal.land/blog/2025/01/21/designing-a-coding-assistant-for-rocq</guid>
            <pubDate>Tue, 21 Jan 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[This blog post provides a review of the existing literature on agent-based systems for automated theorem proving, while presenting a general approach to the problem. Additionally, it serves as an informal specification outlining the requirements for a future system we intend to develop.]]></description>
            <content:encoded><![CDATA[<p>This blog post provides a review of the existing literature on agent-based systems for automated theorem proving, while presenting a general approach to the problem. Additionally, it serves as an informal specification outlining the requirements for a future system we intend to develop.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Ask for the highest security!</div><div class="admonitionContent_BuS1"><p>To ensure your code is fully secure today, contact us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">&nbsp;ðŸ’Œcontact@formal.land</a>!&nbsp;ðŸš€</p><p>We exclusively focus on formal verification to offer you the highest degree of security for your application.</p><p>We cover <strong>Rust</strong>, <strong>Solidity</strong>, and <strong>zero-knowledge</strong> projects.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-our-goal">ðŸŽ¯ Our goal<a href="https://formal.land/blog/2025/01/21/designing-a-coding-assistant-for-rocq#-our-goal" class="hash-link" aria-label="Direct link to ðŸŽ¯ Our goal" title="Direct link to ðŸŽ¯ Our goal">â€‹</a></h2>
<p>We aim to develop an integrated coding assistant for the proof assistant <a href="https://rocq-prover.org/" target="_blank" rel="noopener noreferrer"><img src="https://raw.githubusercontent.com/coq/rocq-prover.org/refs/heads/main/rocq-id/logos/SVG/icon-rocq-orange.svg" height="18px">&nbsp;Rocq/Coq</a> within <a href="https://code.visualstudio.com/" target="_blank" rel="noopener noreferrer">Visual Studio Code</a>. Despite recent advancements in artificial intelligence, the challenge of creating systems that effectively assist users in writing formal verification code remains unresolved. Our primary focus is on providing support for theorem proving, which we consider the most compelling aspect of the task; other functionalities, such as definition writing, may be explored in future work.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-automated-theorem-proving-as-a-search-in-a-state-space">ðŸŒ³ Automated theorem proving as a search in a state space<a href="https://formal.land/blog/2025/01/21/designing-a-coding-assistant-for-rocq#-automated-theorem-proving-as-a-search-in-a-state-space" class="hash-link" aria-label="Direct link to ðŸŒ³ Automated theorem proving as a search in a state space" title="Direct link to ðŸŒ³ Automated theorem proving as a search in a state space">â€‹</a></h2>
<p>A coding assistant for a proof assistant can take advantage of a fundamental property that is not possessed by traditional programming languages: it is always possible to deterministically verify whether the code generated for a demonstration is correct (or simply, not incorrect). It only requires the code to be well-typed. More broadly, the assistant can track the progress of the solution.
A proof can be seen as a sequence of tactics, each of which modifies the current goal. Consequently, the proof construction process can be framed as a search through a state space. Using classical terminology for such problems, we can categorize the components of our system as follows:</p>
<ul>
<li><strong>state</strong>: enriched representation of the current goal</li>
<li><strong>starting state</strong>: initial goal associated with the theorem (its definition)</li>
<li><strong>arrival state</strong>: closed goal</li>
<li><strong>actions</strong>: tactics</li>
</ul>
<div class="text--center"><figure><p><img decoding="async" loading="lazy" alt="Tree search simple" src="https://formal.land/assets/images/tree_search_simple-5e8ad122ea65ccba44a6566afd2c80c5.svg" width="553" height="350" class="img_ev3q"></p></figure></div>
<p>Certain states can be pruned if they do not meet some conditions, such as error states, those where with certainty no progress has been made (e.g., the <a href="https://github.com/trishullab/copra" target="_blank" rel="noopener noreferrer">copra</a> system proposes a simple symbolic approach to recognize some trivial cases) or if too many attempts have already been made at a certain node.</p>
<p>The set of tactics that can be applied in a given state is potentially infinite. To guide the search, one or more oracles are queried, which provide suggestions on applicable tactics. These oracles can be either LLM-based agents or traditional symbolic procedures (e.g., <a href="https://coqhammer.github.io/" target="_blank" rel="noopener noreferrer">CoqHammer</a>). Multiple oracles may coexist, offering alternative solutions. Two examples of LLM-based oracles are:</p>
<ul>
<li>oracle that produces a list of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal" style="margin-right:0.03148em">k</span></span></span></span> possible alternative tactics to be applied at a given goal;</li>
<li>oracle that produces a complete demonstration for a given goal.</li>
</ul>
<p>It is not obvious whether a procedure that proceeds in depth or one that proceeds in breadth is preferable. As is often the case with research problems, a "hybrid" approach might be preferable. In any case, one could imagine ordering the frontier on the basis of how promising a certain state is, thereby guiding the search process. The problem of determining whether one state is more promising than another through heuristics (a kind of "distance" from the successful state) is certainly interesting and would merit future study.</p>
<p>One can imagine two procedures, one in breadth and one in depth. From the union of the two, a hybrid solution could be devised.</p>
<div class="text--center"><figure><p><img decoding="async" loading="lazy" alt="Depth search" src="https://formal.land/assets/images/depth_tree_search-170da44a3a6f6cd52bf1ec8a7ad9a997.svg" width="894" height="329" class="img_ev3q">
</p><figcaption>Depth search</figcaption><p></p></figure></div>
<div class="text--center"><figure><p><img decoding="async" loading="lazy" alt="Breadth search" src="https://formal.land/assets/images/breadth_tree_search-d2afb8d55c7415d5b2d8e81bb5e86d6a.svg" width="932" height="457" class="img_ev3q">
</p><figcaption>Breadth search by beam search: in this specific case, a heuristic is employed to limit the number of expanded nodes</figcaption><p></p></figure></div>
<p>The system should be flexible enough and allow for the implementation of different versions of the search algorithm that could be refined as the work progresses.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="learning-from-errors">Learning from errors<a href="https://formal.land/blog/2025/01/21/designing-a-coding-assistant-for-rocq#learning-from-errors" class="hash-link" aria-label="Direct link to Learning from errors" title="Direct link to Learning from errors">â€‹</a></h3>
<p>By leveraging the ability of an LLM to generate an infinite number of tactics and possibly update the prompt to refine the query, errors can be exploited to generate new tactics. For example, a node (state) might not be closed as soon as it is expanded, but it could be re-expanded in the future, enriched with the knowledge of past errors.</p>
<div class="text--center"><figure><p><img decoding="async" loading="lazy" alt="Tree errors" src="https://formal.land/assets/images/tree_errors-f170535941e783f1b8035dcd3f2f22f6.svg" width="379" height="205" class="img_ev3q"></p></figure></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-integration-with-the-user">ðŸ‘¨ðŸ»â€ðŸ’» Integration with the user<a href="https://formal.land/blog/2025/01/21/designing-a-coding-assistant-for-rocq#-integration-with-the-user" class="hash-link" aria-label="Direct link to ðŸ‘¨ðŸ»â€ðŸ’» Integration with the user" title="Direct link to ðŸ‘¨ðŸ»â€ðŸ’» Integration with the user">â€‹</a></h2>
<p>The system must integrate forms of communication and interaction with the user, which guide the user's construction of the proof. In this context, the coding assistant is not envisioned as a fully automated proof tool, but rather as a coding companion that leverages the support of the human developer. For instance, such a companion system does not necessarily need to complete the proof, but could instead generate partial solutions, offering the user multiple incomplete options and allowing them to select the one they deem most appropriate as a starting point.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-the-technology-stack">ðŸ”§ The technology stack<a href="https://formal.land/blog/2025/01/21/designing-a-coding-assistant-for-rocq#-the-technology-stack" class="hash-link" aria-label="Direct link to ðŸ”§ The technology stack" title="Direct link to ðŸ”§ The technology stack">â€‹</a></h2>
<p>The system is designed to be distributed as a Visual Studio Code extension. This approach offers several advantages, including access to the editor's extensive ecosystem of APIs, which facilitates seamless integration into standard development workflows and user interactions. Additionally, it simplifies the publishing and installation processes.</p>
<div class="text--center"><figure><p><img decoding="async" loading="lazy" alt="Tech stack" src="https://formal.land/assets/images/tech_stack-d5d9848eaba1e69b8b41c093f174c807.svg" width="811" height="607" class="img_ev3q"></p></figure></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="large-language-models">Large language models<a href="https://formal.land/blog/2025/01/21/designing-a-coding-assistant-for-rocq#large-language-models" class="hash-link" aria-label="Direct link to Large language models" title="Direct link to Large language models">â€‹</a></h3>
<p>Models and ad-hoc architectures for theorem proving have been proposed in the literature, including <a href="https://github.com/lean-dojo/ReProver" target="_blank" rel="noopener noreferrer">ReProver</a> (for <a href="https://lean-lang.org/" target="_blank" rel="noopener noreferrer">Lean</a>). The cost of maintaining and the complexity of configuring and adapting these systems is generally high. More simply, commercial versions of the most common LLMs (GPTs, , ...) can be used, leveraging prompt-engineering techniques. Several papers demonstrate that comparable results to state-of-the-art models can be achieved using such approaches.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-vscode-api-ecosystem">The VSCode API ecosystem<a href="https://formal.land/blog/2025/01/21/designing-a-coding-assistant-for-rocq#the-vscode-api-ecosystem" class="hash-link" aria-label="Direct link to The VSCode API ecosystem" title="Direct link to The VSCode API ecosystem">â€‹</a></h3>
<p>VSCode offers a rich ecosystem of APIs that can be used to integrate your extension with common development processes, simplify user interaction, and communicate with external tools. In particular, the new <a href="https://code.visualstudio.com/api/extension-guides/language-model" target="_blank" rel="noopener noreferrer">Language Model API</a> is particularly useful for our purposes. It offers a common interface as well as tools to simplify communication with popular LLMs. Through the use of <a href="https://github.com/microsoft/vscode/blob/main/src/vscode-dts/vscode.proposed.chatProvider.d.ts" target="_blank" rel="noopener noreferrer">Proposed API</a>, it is also possible to integrate local models, which are useful mainly in the testing phase of the first iterations. VSCode's <a href="https://code.visualstudio.com/api/references/vscode-api#languages" target="_blank" rel="noopener noreferrer">Language API</a> simplifies the development and integration of an LSP client.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="language-server">Language server<a href="https://formal.land/blog/2025/01/21/designing-a-coding-assistant-for-rocq#language-server" class="hash-link" aria-label="Direct link to Language server" title="Direct link to Language server">â€‹</a></h3>
<p>Language analysis capabilities are provided by the language server <a href="https://github.com/ejgallego/rocq-lsp" target="_blank" rel="noopener noreferrer">Coq-LSP</a>, which has recently been released as part of the <a href="https://github.com/ejgallego/rocq-lsp/tree/main/petanque" target="_blank" rel="noopener noreferrer">PÃ©tanque</a> project, a lightweight environment for intensive applications targeted at automated theorem-proving projects and especially at agent-based systems. PÃ©tanque operates as a <a href="https://gymnasium.farama.org/index.html" target="_blank" rel="noopener noreferrer">Gymnasium</a> environment and has already been successfully used in the <a href="https://github.com/LLM4Rocq/nlir" target="_blank" rel="noopener noreferrer">NLIR</a> system.
At the architectural level, Coq-LSP (and PÃ©tanque) operates as a server towards the coding assistant (the client), providing some functionality in the form of an API via an extended version of the <a href="https://microsoft.github.io/language-server-protocol/" target="_blank" rel="noopener noreferrer">LSP</a> protocol, including:</p>
<ul>
<li>obtaining the current goal for a given theorem,</li>
<li>obtaining the location of a given theorem's definition,</li>
</ul>
<p>and many other functionalities commonly accessible through IDEs.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-the-agent-perspective">ðŸ§  The agent perspective<a href="https://formal.land/blog/2025/01/21/designing-a-coding-assistant-for-rocq#-the-agent-perspective" class="hash-link" aria-label="Direct link to ðŸ§  The agent perspective" title="Direct link to ðŸ§  The agent perspective">â€‹</a></h2>
<p>An alternative description of the system can be accomplished from the agent's perspective. We understand an <em>agent</em> as a software system whose behavior is conditioned by an environment that it can actively alter by performing some actions whose effects condition subsequent observations and, consequently, its future choices.</p>
<div class="text--center"><figure><p><img decoding="async" loading="lazy" alt="Agent RL" src="data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgdmlld0JveD0iMCAwIDMzMi40NDc4MDY3NjA3NDc5IDE1Ny45MTY0NTY5NDAxMTcxIiB3aWR0aD0iMzMyLjQ0NzgwNjc2MDc0NzkiIGhlaWdodD0iMTU3LjkxNjQ1Njk0MDExNzEiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9IndoaXRlIi8+PCEtLSBzdmctc291cmNlOmV4Y2FsaWRyYXcgLS0+PG1ldGFkYXRhPjwvbWV0YWRhdGE+PGRlZnM+PHN0eWxlIGNsYXNzPSJzdHlsZS1mb250cyI+CiAgICAgIEBmb250LWZhY2UgeyBmb250LWZhbWlseTogRXhjYWxpZm9udDsgc3JjOiB1cmwoZGF0YTpmb250L3dvZmYyO2Jhc2U2NCxkMDlHTWdBQkFBQUFBQXZRQUE0QUFBQUFFK2dBQUF0OUFBRUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBR2hZYmd4Z2NOQVpnQUh3UkNBcWJHSlFQQ3lRQUFUWUNKQU5FQkNBRmd4Z0hJQnRLRDZPaWhMUml5UDZaa0ExWjZCc3VHRzJNa3JZaDJyaUx1czhaTFBncDN2S1NvU1ArdEo5OURORTZoUnlvTW85VVB0R1RWSjUvZjNmZS9aUnVYWWttRkYweEV5aEprSXZhNlg4QS8vN3p1ZGtITGZ6ZnpReVJGWXQrRTBOT0tpMnZ1bnM5NmU1Qk96UFlKbXNRV2JMN2plU0wyY0EweGZuUDM2djZYN2FPaVdNTFpvdEhhS3lUbTlIYUd2UkRIV09ETGJFNWFWRWJ5Zzl0ajVXZ0xFV3ZFUFFJYnlQdTBvU2ZXYmtBQXNCaDBJMUJTSUozcXdCWWZFVWpwamtoQXl5MjNyWUdzRGphS3V2QjRpcnRhQUlMQkFDNE41YWNlMXNUTUVEQWlJQUJzZDJZbDdRSjBGalVCZUtCa1Z2QmIyV0JvWkdMbnJJcC8wRWJrdVN1MjRFWVM5Z1A3K2NSSmd5T1FLSzlVUTR1d1p3V0FTaFloRWdpWTRGbWV4bll1WUFTd0tPQmFRQ1BZSDRCQWFLc0hMMG1Xbi8rM213NFNLMUx6QnRKUnMxdVlVbW1KZ2RBdkhVU3RQTDNHWVFpcjJvWFF4S1lRS1dyZFgwV1VwdFVYUU5ZbFltZWVraXgzZ3dEcmtIeUppUXFDVFhkTW9KSWFSUVZuV1RsS2xXcjFheERWNy9pU2RKU1ZhTzJuMnJFNUlURWtrVUw1alVGL0JCd1F6L0FrSkJtOXB4OEduRURjaVR2SmZZMllWaEFZa3lNWS90THFBYi9HYTF0QTJWbFJ3M29oWkh6eC9Kak93Ny9ldXB2QzlHTmlDNmhSb0ZLS0dRem9XUWhDVDk4Q1BCSFlJbXRUY1lMdnNuaDEyL2ZMamJtVUZ4UjdGNU94Zk11V0pobkFwSHRpQkFDQ1FaNE44T25BbWw2OFR6KzNiN1R3YXAwRkdWYTFNWDVEUFFad0VSckl3ekNPaTBZaHNPTEltMkpyWEVuUStkQXlmbkNCOFY1YzBkMmR1eUFkWDFXd0NHaWowR21ZbllYQUpidnlIS0g4MHFldHdid1hzNmJ3VVBwTlZOREJ1enFZT0VPdHp1MjB1RXkxNGdITUVqWURINzVFdUFFL1dGbGVtWndmcW5vRjBva0xiMUxOWE5GR0RGVnhsU21kN0RObFBqQmx4ZEZQcldhN1IxSzFuN2NGY0x3YnU0aHdDNTJJWm4wSHZWcVBTM002cFQ2MUc4b2MvekpQa2Q1SXRzYWlRaUFFU1FhU2VFS2hCaURjQ2ZOOFJGQ3ZzNllibGMrSEhveDNwaWJ6U2MrOXRkM04vUitlNmxuV1B0eEkrRFRqdU1vam15UHpySWMwK0pkYjJUN3pDQWQ4VzUwcTB6bjA4SHpjbHV5em1NTU1URUovS253MVZvcnNZWW9PN3BxekwwNDlJVHY2TnpyMVR3djV3SXJwS2lGNkJBa1g5ZWJzeDcwemtScHhTQTl3ZHlkR0l2OEdEZVVEbnlWVGk2dzQ2RmtuUzI3d2tKNmFuQ3Uwam5WeVFzUHQ4K3duVXpQakVnbUpMSnR1Zk9rR0p3dFczZTcxZHhmNy9WMmU3blFxc1N5RGNtelhzbFdPcmU1RXZEaVM4azZlVDhiVytMN0hzajJFUk9Za29Yb3lmYmRmaFVEakR2Ym9FaTIrWmNpM3lWSEd5QnFzaHhUWjIrczc4L2dYM0g3UFdxM2lzR0RFbkVJWFM0a0I4Z3MrQ21zTHlPYVpjZ3ZCanRJM214NkM5Q2NkUVVNMWRTU0F2VkZNWkR0SHN5N2t5L0c0OEtEVXJSQmlIbnhlbVZRdTZtNXpTYjBjamhFN1V4elduUlI5Q1hjcFljQTJBOHNZUmlFYlVSRlVhS0FxZmczQzlGVmxFM1JGcUxMa2hYKzVpem5sZytLQVZjYUJTbzJZbWpuUGNHY0ZaenIxeFVuanBWNGx4T3RrSHdxYUdaVDhBQU90ZGZEKzZ0akJtMG9ENHdIc3AwZVNUY3pGU2ZoYThQbWZKejZQbDFHbVdTQkVPQXV1SnZEYmxNZ0t6RDY5ZmErSjZmZTdPa0pKdWhLVmh0SlNiWGFCL2d4ZHo1UFBPeGlnTTJoeHdXOXBUUzNHRlNjQ0JJaW1KcmhCTXFyQTJRd2lON0lkc1VKVUR0RG1VNlhmZFRhZDRrYmRtUlBZTzJhVmVzbFRzSVFZQmZlUzJ1cFlLb3ZzNzNEMzRaMWVxdFZ6S2FETVIrRndFclFCaFZNNTVSOWQwNHBZcnlqbHljcExIWGVkSGJzR0l4MFFaZ3dZRzBIdTJpV3VZRkVGUWVnNUs4a0tEa2tuNThIL2U3SDB6alJMSXFXbjIvTXh2eWpyV0s2d0xqaVBNcW5XdDd6ZXBBb3poUG51aE1IU2pCK2U1MVRJdktHekl6TWRhYUxLb0R4L3pvc0s3OXQ3ZUQvZjgrc0dSNlJxQ2JPUC80ZjhvQzh4akhjb2Z5UFZsUnNFbXgyRUtlY0tjcCszN25tN1Vvdm5lYVRwQUNOUmMwdHV5WEhnSzdsTzloUUNHRmxGa3Q0bUdqT1Q1T2NFQnR0dWU4YmtDaU1KUmtaNHFWL2JLRGVVUzBLZGZ1Ri9SVyszbUI0ZjdMVFhQWE5iVmtCR2xqTmtZeG8yWHBxUmhTZHk5QXc2TnpNNG9EYnBGTHJ6RHdvTUF4TEgyM2VQKy9IblJNdFZqc0ZMMXkwK0Y4eUp1UzN0WDVPZTVvSnZYeTlScmIvV3lWZDNWTGw1b2tYV1duNXUxbTdUWnFmL3FrT3ZwdzJSRnpvbENkYk9xVTVIQjVqSk02V3Rpb3gyeFJLVU5GSmtVbDRCdi9zdytpK1RiTm44b2RML3NoZE43b3hGU0pRNGJ4aVFhTExSSThNYTJOWnoxaDNWQ2diUFM5WFprVnB0TjVLNU0xWTRHQWViMitzS2t6MFNyT055K0U1Ni80dHZkVWo5L3ZYVWp2c2taMDB1OWZDdDhXNUhtM2NrclU3MFZPNklpYlIyV2Q5ZGU5bzB4djRrYnFqTW5PZVVYY3hPVlBxanR4MVJ6d3I3T2NZK2NtMHNIWnA2TjhGK1RQbFNYTDdmTE1adkdUaUM1QWVaWnYxUHprR2JwR3BYRFN0R2VwQzRRVTBVR25FZStqQU9DSmdYczYrRnFMV0FpUjJoY0V0enB0WmdOSUhxUXhMNlhPdXRPNnFjQkhMNmlYSm4yVEZuNDZuakhaOGFHTmNhdXVkWWgvYU1tVlJRcUJmYnBiZ3Q3N2ZmOHNRR3Q0K1h1bnBtTXc4cGIrZStaY3dEd3E0Sm92VTErV0NLNThwZmRPc3NiSmlsNGZLMyt5cWhtT2NmalBocDkrRm5WN3dhTTRyMThCam1EcGkvUnYvTDRsb2J6M1pGa2liOVJTQ1M5YlBqbFYxMGFrSlpxL0xUYTJwTWM1RWFpNHVrd1kwWFArRHQ2a3NZWng0ekc5WE5HMU85cExiRTFOa3FjbUUyazNya1BlNG0yeC9wMkpaWStsM0EyYTJTaVYvK1ZldkFVbVhXQitTMTdoTWFaNVVLaGNkMDg3OVlJL0Q1YkhNeENJUmtZck5EUGFMbUJSdVpBWGwxSHhJQ2pFQXlmWmxrOTBIZFNuZlh0ZnI3YlVSRWJGYnE0NEtyemdxMUpKaVcwYlhDbnpUUkVjb2hpNVB0cTNsZFNzcWxsMzFmQWl6ZnJqOXlWckIyamkyVkN4TVNWdWduT3pmNTlDTHdvVFp3a2xtZjY4SHJyVWxuVUxuMEJiV2o1eC8rVS9hMkh6R2kySHZnekFmdHpyb2cvVWxqaXV4TitFeXpwejg0cURsWCs3a3VCMStKd2xwRjBlbDM3cTRhMzZjaVpHTHNrOVpMM1BtZFArWU1kTFVuK28xZ0pVei9kSzFQY0lWeVNzQ0VwN053NjdHWkxQYk1UL1ltUkJRUEEzMllTeHpVVlcxU0ZYZ3ZOTW90NmNZZHFxUW9EU3hkMUxyR3UxeDIxajJBbXN5RVdjS05DOFZQOVY1OEVLUVp1ODVoNnhtaDh0S3UzVjFzK3YzMmhneVJhbjREOGppc2FJR3JoTHV0U2RqdnhDMWRlNjFPMVd1aTJQaUpzZjhGcURmRWRNNGFQV3Vzc1ZYRWUrYUpZc04xYk5WcTZ1UmZZYTNwKzB2UjRVWmM3UU1GdzgyWWpXKzNGc1BzeHptOGJRU2NvODlSeDVnejBYclZzczNUTThmV3l3aG1SWXpqQkxPWnNQZ0ZKYllhU3EweWJqVHd5STIzQnFPNHVHeHVBelRna29uUHVjVTZ2L0VldjBlSmR2cXozbEJYVjRyRTlXWkZxb2dmZGxwUzZyeFFZRmpPb25aNGEvODltbTdqTkswQ1dUcXkvMmRYeTZjbmZEaHhiN01WemtoNnFMYnRMRFZibWdJSktIRCtVNm5EenF4KzUwbHhpek5qeGVaMW52S3J0elVoSWx6T0tiUTZzTTFzdlhlTG5oTGxaUGY1VDJxNFEzYllFenBCNzFnajd4UXp3OWxKZSt5K0Y0WjZQc21aWjlxdks2N2RzQkFkRXAybW9hdnBTcEwra01TVTFvVlEzQ2RGdjUwNUkvUVF2T1VYZDF5NnpGZ2oreGdKdVVkK09NYTgvcEprdzZ2ZkhQbnE3MVo5dW9WRnVmeno5NVBweGJ2VVJDbUJENTlNMVRWbzgzUUZVNFB1YWJhS0t5dzAvaXFLUG9mbGhOYitOcHE3Y3BpZnVRN0JodC9XQUlBYnZXNlR3QUF0OWMrNlI4Wi8zN2ljUmNHZ0FFckVmL0w3ZWhGQk1XK2J2elBXYjZ3bGRGbFBjQmUvaGxKRkNYbmVBaXFqeFF4WitsVjd1RXRRUmFKREEvQ2tzTzNsdk9MTGRlNFFlRUN0MGFMMEFXZ2dJbEFhQU5RQXA2V0I0OTJka3hQMitDMERaRTRhY1B3N0xiaDNFMjBFUnlWMlVqUkhFRUpwUVBvOUNoWHFrR3RLczJhZFBDUzl2ZU56Z1NVNnNnS2RMVnBKOGFFeVFwK3ZQbGlkd1FEbWUvVm9vYUpKTElBK0Z0d0Zabi84U0hjYXZlZ1dGL2I3YlhTR1NTSktMVmUySndJamRYZG9wZUEybHhVMHhKY2M4RE42dmJuKzBTZ2d6TGlma1ZaVk9RdWx1cm1MWFNyTk9CZVJYbHFENkRTWXBYb0VpWlY4SWFEY0NQZmtRQUEpOyB9PC9zdHlsZT48L2RlZnM+PGcgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMCA2NC42NjY4NjQxMzY4MjQ0Mikgcm90YXRlKDAgNjMuNTc2MzE0Mzk5NTQ1OTM2IDE1KSI+PHBhdGggZD0iTTcuNSAwIEMzNC4xNCAtMS4yMywgNjEuNTcgLTEuMzksIDExOS42NSAwIE03LjUgMCBDMzUuODQgLTAuMTEsIDYzLjYzIDEuODIsIDExOS42NSAwIE0xMTkuNjUgMCBDMTIyLjY3IDAuNTgsIDEyNi42OCAzLjQ3LCAxMjcuMTUgNy41IE0xMTkuNjUgMCBDMTIyLjc5IC0xLjgzLCAxMjYuMTQgMS4wNSwgMTI3LjE1IDcuNSBNMTI3LjE1IDcuNSBDMTI1Ljc2IDExLjY5LCAxMjcuMjMgMTcuNDksIDEyNy4xNSAyMi41IE0xMjcuMTUgNy41IEMxMjcuNzggMTIuMTIsIDEyNi45OCAxOC4yNywgMTI3LjE1IDIyLjUgTTEyNy4xNSAyMi41IEMxMjUuNDYgMjcuNDYsIDEyNS45NyAzMC4xNSwgMTE5LjY1IDMwIE0xMjcuMTUgMjIuNSBDMTI2LjU3IDI2LjA2LCAxMjIuNzUgMzEuMzksIDExOS42NSAzMCBNMTE5LjY1IDMwIEM5MS42IDI5LjUsIDY1LjI2IDI5LjE4LCA3LjUgMzAgTTExOS42NSAzMCBDODguNzUgMjkuNzgsIDU5LjA0IDMxLjA0LCA3LjUgMzAgTTcuNSAzMCBDMy42NyAzMS40MiwgLTAuMzggMjcuNSwgMCAyMi41IE03LjUgMzAgQzMuNzcgMzIuMDgsIDEuODQgMjkuMTcsIDAgMjIuNSBNMCAyMi41IEMwLjM0IDE4Ljg1LCAwLjY5IDE0LjUsIDAgNy41IE0wIDIyLjUgQy0wLjAzIDE4LjE3LCAwLjU4IDEzLjk4LCAwIDcuNSBNMCA3LjUgQy0wLjYzIDMuNTksIDEuNjEgLTEuNDQsIDcuNSAwIE0wIDcuNSBDMS45MyAxLjAxLCAzLjUzIDAuOTksIDcuNSAwIiBzdHJva2U9IiMxZTFlMWUiIHN0cm9rZS13aWR0aD0iMSIgZmlsbD0ibm9uZSI+PC9wYXRoPjwvZz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSg1MC4yMjQzMjQ2NTM0NTIxODYgNjkuNjY2ODY0MTM2ODI0NDIpIHJvdGF0ZSgwIDIzLjM1MTk4OTc0NjA5Mzc1IDEwKSI+PHRleHQgeD0iMjMuMzUxOTg5NzQ2MDkzNzUiIHk9IjE0LjA5NiIgZm9udC1mYW1pbHk9IkV4Y2FsaWZvbnQsIFhpYW9sYWksIFNlZ29lIFVJIEVtb2ppIiBmb250LXNpemU9IjE2cHgiIGZpbGw9IiMxZTFlMWUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIHN0eWxlPSJ3aGl0ZS1zcGFjZTogcHJlOyIgZGlyZWN0aW9uPSJsdHIiIGRvbWluYW50LWJhc2VsaW5lPSJhbHBoYWJldGljIj5BZ2VudDwvdGV4dD48L2c+PGcgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxOTIuNTc4MjU4MDMxNzE4NjMgNjMuMjUxNTYzMjgzNjk0MTcpIHJvdGF0ZSgwIDY0LjkzNDc3NDM2NDUxNDYyIDE1KSI+PHBhdGggZD0iTTcuNSAwIEM0OC45NyAwLjIzLCA4Ni4wNCAxLjA2LCAxMjIuMzcgMCBNNy41IDAgQzMyLjAxIDAuOSwgNTUuMDIgMC4xMywgMTIyLjM3IDAgTTEyMi4zNyAwIEMxMjUuOTggMS4xLCAxMzEuNzMgMy4xMywgMTI5Ljg3IDcuNSBNMTIyLjM3IDAgQzEyNi41IC0wLjM2LCAxMjguMTIgMy4xNiwgMTI5Ljg3IDcuNSBNMTI5Ljg3IDcuNSBDMTI4LjU2IDE0LjA3LCAxMzAuNDggMTcuMzcsIDEyOS44NyAyMi41IE0xMjkuODcgNy41IEMxMjkuMjggMTEuNTgsIDEyOS4xNCAxNC41NiwgMTI5Ljg3IDIyLjUgTTEyOS44NyAyMi41IEMxMjkuMDcgMjYuOTksIDEyNy44MSAzMS41OSwgMTIyLjM3IDMwIE0xMjkuODcgMjIuNSBDMTI5LjUgMjUuNjcsIDEyNy4yMiAzMS44MSwgMTIyLjM3IDMwIE0xMjIuMzcgMzAgQzk4LjE1IDMyLjIxLCA3My4yNCAzMS40MSwgNy41IDMwIE0xMjIuMzcgMzAgQzkwLjA1IDMwLjA0LCA1Ny40NSAyOS44NiwgNy41IDMwIE03LjUgMzAgQzIuNDMgMjkuMzEsIC0wLjU2IDI2LjM1LCAwIDIyLjUgTTcuNSAzMCBDMi4wOSAyOC44MywgMC4xOCAyNS41MSwgMCAyMi41IE0wIDIyLjUgQy0wLjk2IDE3LjQzLCAtMC43MSAxMi4wNCwgMCA3LjUgTTAgMjIuNSBDLTAuNzEgMTkuMTQsIC0wLjU0IDE0LjA3LCAwIDcuNSBNMCA3LjUgQzAuNjggMC45NSwgMS40MiAtMC4wNSwgNy41IDAgTTAgNy41IEMxLjM3IDQuNTcsIDEuNjIgMS4yMiwgNy41IDAiIHN0cm9rZT0iIzFlMWUxZSIgc3Ryb2tlLXdpZHRoPSIxIiBmaWxsPSJub25lIj48L3BhdGg+PC9nPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDIxMC44ODUwNTY5MzIzNjU4NCA2OC4yNTE1NjMyODM2OTQxNykgcm90YXRlKDAgNDYuNjI3OTc1NDYzODY3MTkgMTApIj48dGV4dCB4PSI0Ni42Mjc5NzU0NjM4NjcxOSIgeT0iMTQuMDk2IiBmb250LWZhbWlseT0iRXhjYWxpZm9udCwgWGlhb2xhaSwgU2Vnb2UgVUkgRW1vamkiIGZvbnQtc2l6ZT0iMTZweCIgZmlsbD0iIzFlMWUxZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgc3R5bGU9IndoaXRlLXNwYWNlOiBwcmU7IiBkaXJlY3Rpb249Imx0ciIgZG9taW5hbnQtYmFzZWxpbmU9ImFscGhhYmV0aWMiPkVudmlyb25tZW50PC90ZXh0PjwvZz48ZyBzdHJva2UtbGluZWNhcD0icm91bmQiPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDI1NS42MTEwOTM5MjI5NTAyIDU3LjYwMjgxMjYyMDY3Njc5KSByb3RhdGUoMCAtOTIuOTE5MjUzNjEyMDk0NzQgLTExLjQxMTEzMzM1Mzc2NDYyNikiPjxwYXRoIGQ9Ik0wLjkyIDEuMTggQy0xNC41MiAtMi41MSwgLTYwLjc1IC0yMi44NSwgLTkxLjc1IC0yMy4xMSBDLTEyMi43NSAtMjMuMzgsIC0xNjkuNDggLTQuMjksIC0xODUuMDYgLTAuNCBNLTAuMDUgMC43NSBDLTE1LjcyIC0zLjIzLCAtNjEuNzYgLTI1LjA1LCAtOTIuNjUgLTI1LjEgQy0xMjMuNTUgLTI1LjE2LCAtMTcwLjA5IC0zLjk1LCAtMTg1LjQxIDAuNDIiIHN0cm9rZT0iIzFlMWUxZSIgc3Ryb2tlLXdpZHRoPSIxIiBmaWxsPSJub25lIj48L3BhdGg+PC9nPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDI1NS42MTEwOTM5MjI5NTAyIDU3LjYwMjgxMjYyMDY3Njc5KSByb3RhdGUoMCAtOTIuOTE5MjUzNjEyMDk0NzQgLTExLjQxMTEzMzM1Mzc2NDYyNikiPjxwYXRoIGQ9Ik0tMTY2LjE0IC0xNS41MSBDLTE3MS41MiAtOS4yNiwgLTE4MC4yOCAtMi4xMywgLTE4NS40MSAwLjQyIE0tMTY2LjE0IC0xNS41MSBDLTE3MS4wNyAtMTEuMTgsIC0xNzQuMzQgLTguMzEsIC0xODUuNDEgMC40MiIgc3Ryb2tlPSIjMWUxZTFlIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiPjwvcGF0aD48L2c+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjU1LjYxMTA5MzkyMjk1MDIgNTcuNjAyODEyNjIwNjc2NzkpIHJvdGF0ZSgwIC05Mi45MTkyNTM2MTIwOTQ3NCAtMTEuNDExMTMzMzUzNzY0NjI2KSI+PHBhdGggZD0iTS0xNjAuNDEgMC42IEMtMTY3LjggMC44NywgLTE3OC43MSAxLjk2LCAtMTg1LjQxIDAuNDIgTS0xNjAuNDEgMC42IEMtMTY2LjY5IDEuMzUsIC0xNzEuMjMgMC42NSwgLTE4NS40MSAwLjQyIiBzdHJva2U9IiMxZTFlMWUiIHN0cm9rZS13aWR0aD0iMSIgZmlsbD0ibm9uZSI+PC9wYXRoPjwvZz48L2c+PG1hc2s+PC9tYXNrPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDgyLjI3MDUyNzgyMzM3NDMyIDEwKSByb3RhdGUoMCA3My42Mjg5NjI5MTQwNDYwNCA4LjI2MjE5NDc5ODU3NTU5MikiPjx0ZXh0IHg9IjczLjYyODk2MjkxNDA0NjA0IiB5PSIxMS42NDYzODk3ODgwNzIxNDUiIGZvbnQtZmFtaWx5PSJFeGNhbGlmb250LCBYaWFvbGFpLCBTZWdvZSBVSSBFbW9qaSIgZm9udC1zaXplPSIxMy4yMTk1MTE2Nzc3MjA5MzhweCIgZmlsbD0iIzFlMWUxZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgc3R5bGU9IndoaXRlLXNwYWNlOiBwcmU7IiBkaXJlY3Rpb249Imx0ciIgZG9taW5hbnQtYmFzZWxpbmU9ImFscGhhYmV0aWMiPk9ic2VydmF0aW9uPC90ZXh0PjwvZz48ZyBzdHJva2UtbGluZWNhcD0icm91bmQiPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDcyLjQ4OTUwNjYyODY5NzIgMTAxLjA3Mzc4MDI0MjYzMDM5KSByb3RhdGUoMCA5My4xOTA5ODA0MjkxMDQyMyAxMC44Njc3NTQzNDI2MzY2NTgpIj48cGF0aCBkPSJNLTAuMzEgMC44OSBDMTUuMzUgNC40OSwgNjIuMjggMjIuMDMsIDkzLjQ2IDIxLjk2IEMxMjQuNjMgMjEuODksIDE3MS4xIDQuMDYsIDE4Ni43NiAwLjQ4IE0xLjczIDAuMyBDMTcuNzggMy40OSwgNjQuODUgMTkuNzEsIDk1LjU5IDE5Ljk1IEMxMjYuMzQgMjAuMiwgMTcwLjc2IDQuODMsIDE4Ni4xOSAxLjc3IiBzdHJva2U9IiMxZTFlMWUiIHN0cm9rZS13aWR0aD0iMSIgZmlsbD0ibm9uZSI+PC9wYXRoPjwvZz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSg3Mi40ODk1MDY2Mjg2OTcyIDEwMS4wNzM3ODAyNDI2MzAzOSkgcm90YXRlKDAgOTMuMTkwOTgwNDI5MTA0MjMgMTAuODY3NzU0MzQyNjM2NjU4KSI+PHBhdGggZD0iTTE2NS41OSAxNS45MyBDMTcyLjM4IDEwLjQ4LCAxNzYuNjQgOS4yNSwgMTg2LjE5IDEuNzcgTTE2NS41OSAxNS45MyBDMTcxLjk0IDEyLjYsIDE3Ni45MyA4LjQxLCAxODYuMTkgMS43NyIgc3Ryb2tlPSIjMWUxZTFlIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiPjwvcGF0aD48L2c+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNzIuNDg5NTA2NjI4Njk3MiAxMDEuMDczNzgwMjQyNjMwMzkpIHJvdGF0ZSgwIDkzLjE5MDk4MDQyOTEwNDIzIDEwLjg2Nzc1NDM0MjYzNjY1OCkiPjxwYXRoIGQ9Ik0xNjEuMzEgLTAuNjIgQzE2OS4yNiAtMS43NiwgMTc0LjYzIDEuMzIsIDE4Ni4xOSAxLjc3IE0xNjEuMzEgLTAuNjIgQzE2OS4wNyAwLjkzLCAxNzUuMzIgMS42MywgMTg2LjE5IDEuNzciIHN0cm9rZT0iIzFlMWUxZSIgc3Ryb2tlLXdpZHRoPSIxIiBmaWxsPSJub25lIj48L3BhdGg+PC9nPjwvZz48bWFzaz48L21hc2s+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoOTguODQzODIzOTY4NTk2NTUgMTMxLjM5MjA2NzM0Mjk2NTkpIHJvdGF0ZSgwIDczLjYyODk2MjkxNDA0NjA0IDguMjYyMTk0Nzk4NTc1NTkyKSI+PHRleHQgeD0iNzMuNjI4OTYyOTE0MDQ2MDQiIHk9IjExLjY0NjM4OTc4ODA3MjE0NSIgZm9udC1mYW1pbHk9IkV4Y2FsaWZvbnQsIFhpYW9sYWksIFNlZ29lIFVJIEVtb2ppIiBmb250LXNpemU9IjEzLjIxOTUxMTY3NzcyMDkzOHB4IiBmaWxsPSIjMWUxZTFlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBzdHlsZT0id2hpdGUtc3BhY2U6IHByZTsiIGRpcmVjdGlvbj0ibHRyIiBkb21pbmFudC1iYXNlbGluZT0iYWxwaGFiZXRpYyI+QWN0aW9uPC90ZXh0PjwvZz48L3N2Zz4=" width="332" height="158" class="img_ev3q"></p></figure></div>
<p>Based on the above definition, we can attempt to classify the components of our system within a classic agent context as follows:</p>
<ul>
<li><strong>Agent</strong>: prompting + large language model + parsing</li>
<li><strong>Environment</strong>: user, language server and search algorithm</li>
<li><strong>Actions</strong>: tactics</li>
<li><strong>Observations</strong>: current goal, examples, definitions, ...</li>
</ul>
<figure><p><img decoding="async" loading="lazy" alt="Agent loop" src="https://formal.land/assets/images/agent_loop-0a837a1284810e14d15c2b0c7f468ab4.svg" width="1649" height="1373" class="img_ev3q"></p></figure>
<p>Let us recall that in the proposed general architecture, the agent is only one of the possible types of <em>oracle</em> from which we can obtain useful information to advance the demonstration (albeit the most interesting one), and that multiple <em>oracles</em> at the same time can coexist, e.g., agents implementing different resolution strategies or configurations.</p>
<p>The agent is designed to interact with various components of the environment, for example, by requesting examples, additional information, or simple advice from the user; the current goal; the list of previously attempted and failed tactics for the search algorithm; or semantic data from the language server. The interaction process could be deliberative (guided by the LLM's reasoning) or, more simply, a form of abstraction for a predetermined set of information we intend to request. This interaction with the environment is crucial for defining the goal, enriching the agent's context, and generating input for the prompt. In a recent <a href="https://formal.land/blog/2025/01/06/annotating-what-we-are-doing">blog post</a>, we documented our interest in internally gathering as much information as possible about the recurring human processes of building a demonstration in order to standardize and emulate them within the agent's interaction logic with the environment.</p>
<p>Several propting techniques can be tried. In the <a href="https://github.com/LLM4Coq/nlir" target="_blank" rel="noopener noreferrer">NLIR</a> system, the prompt is gradually refined through a chain-of-thought approach: first, a natural language response is requested from the LLM, and this response is then used to generate a more precise Rocq code response.</p>
<p>Once the LLM produces an outputâ€”whether a tactic, a list of tactics, or a complete proof, depending on the type of agentâ€”the response is parsed and executed within the environment via PÃ©tanque. If an error occurs, the environment is either reverted to its previous state (backtracking), or an error recovery technique is applied (e.g., replacing the problematic code with <code>admit.</code>).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-evaluation-strategies">ðŸ“Š Evaluation strategies<a href="https://formal.land/blog/2025/01/21/designing-a-coding-assistant-for-rocq#-evaluation-strategies" class="hash-link" aria-label="Direct link to ðŸ“Š Evaluation strategies" title="Direct link to ðŸ“Š Evaluation strategies">â€‹</a></h2>
<p>Benchmarks used for evaluating automated demonstration systems tend to be limited to classical mathematics, focusing on demonstration systems that are <em>completely automated</em> and not of <em>support</em> to demonstration writing.
As a result, these benchmarks can be misleading with regard to the practical utility of such tools in real-world contexts. In addition to traditional evaluation methods, the system should be tested in practical scenarios, such as by applying it to ongoing formal verification projects within <a href="https://formal.land/">Formal Land</a>.</p>
<p>A second critical consideration when evaluating a practical support tool is the cost per request. Integrated LLMs should not be viewed as infinite resources, but rather as constrained resources whose usage must be optimized and minimized, even if that means sacrificing some efficiency.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ï¸-similar-projects-and-resources">ðŸ—‚ï¸ Similar projects and resources<a href="https://formal.land/blog/2025/01/21/designing-a-coding-assistant-for-rocq#%EF%B8%8F-similar-projects-and-resources" class="hash-link" aria-label="Direct link to ðŸ—‚ï¸ Similar projects and resources" title="Direct link to ðŸ—‚ï¸ Similar projects and resources">â€‹</a></h2>
<p>The research field in fully autonomous automated theorem using proof assistants is very active and has received a strong boost since the advent of LLMs. The proposed system architecture has been influenced by the following works:</p>
<ul>
<li>LeanCopilot (<a href="https://github.com/lean-dojo/LeanCopilot" target="_blank" rel="noopener noreferrer">code</a>, <a href="https://arxiv.org/abs/2404.12534" target="_blank" rel="noopener noreferrer">paper</a>)</li>
<li>copra (<a href="https://github.com/trishullab/copra" target="_blank" rel="noopener noreferrer">code</a>, <a href="https://arxiv.org/abs/2310.04353" target="_blank" rel="noopener noreferrer">paper</a>)</li>
<li>CoqPilot (<a href="https://github.com/JetBrains-Research/coqpilot" target="_blank" rel="noopener noreferrer">code</a>, <a href="https://arxiv.org/abs/2410.19605" target="_blank" rel="noopener noreferrer">paper</a>)</li>
<li>NLIR (<a href="https://github.com/LLM4Coq/nlir" target="_blank" rel="noopener noreferrer">code</a>, <a href="https://openreview.net/forum?id=QzOc0tpdef" target="_blank" rel="noopener noreferrer">paper</a>)</li>
</ul>
<p>Other interesting resources to further explore this topic:</p>
<ul>
<li>ðŸ“½ï¸ <a href="https://www.youtube.com/watch?v=Yr8dzfVkeHg" target="_blank" rel="noopener noreferrer">Lean Together 2025: Jason Rute, The last mile</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-key-takeaway">ðŸ¥¡ Key takeaway<a href="https://formal.land/blog/2025/01/21/designing-a-coding-assistant-for-rocq#-key-takeaway" class="hash-link" aria-label="Direct link to ðŸ¥¡ Key takeaway" title="Direct link to ðŸ¥¡ Key takeaway">â€‹</a></h2>
<ul>
<li>The agent perspective and the search perspective are here complemented in a single system</li>
<li>The automatic demonstration process can be seen as a sophisticated search in a space of states</li>
<li>The system must be flexible overall and adapt to different refinements that might be decided in the process</li>
<li>In a support tool, completeness of proof is not mandatory</li>
<li>User interaction is crucial</li>
<li>Evaluation must be carried out in a practical context</li>
</ul>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions or requests!</em></p></div></div>]]></content:encoded>
            <category>llm</category>
            <category>ai</category>
        </item>
        <item>
            <title><![CDATA[ðŸ¦€ Verification of one instruction of the Move's type-checker]]></title>
            <link>https://formal.land/blog/2025/01/13/verification-one-instruction-sui</link>
            <guid>https://formal.land/blog/2025/01/13/verification-one-instruction-sui</guid>
            <pubDate>Mon, 13 Jan 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[This is the last article of a series of blog post presenting our formal verification effort in &nbsp;Rocq/Coq to ensure the correctness of the type-checker of the Move language for Sui.]]></description>
            <content:encoded><![CDATA[<p>This is the last article of a series of blog post presenting our formal verification effort in <a href="https://rocq-prover.org/" target="_blank" rel="noopener noreferrer"><img src="https://raw.githubusercontent.com/coq/rocq-prover.org/refs/heads/main/rocq-id/logos/SVG/icon-rocq-orange.svg" height="18px">&nbsp;Rocq/Coq</a> to ensure the correctness of the type-checker of the <a href="https://sui.io/move" target="_blank" rel="noopener noreferrer">Move language</a> for <a href="https://sui.io/" target="_blank" rel="noopener noreferrer">Sui</a>.</p>
<p>Here we show how the formal proof works to check that the type-checker is correct on a particular instruction, for any possible initial states. The general idea is to symbolically execute the code step by step on the type-checker side, accumulating properties about the stack assuming the type-checker succeeds, and then to show that the interpreter will produce a stack of the expected type as a result.</p>
<p>Previous post:</p>
<ul>
<li><a href="https://formal.land/blog/2024/11/14/sui-move-checker-abstract-stack">ðŸ¦€ Example of verification for the Move's checker of Sui</a></li>
</ul>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Ask for the highest security!</div><div class="admonitionContent_BuS1"><p>When millions are at stake, bug bounties are not enough.</p><p>How do you ensure your security audits are exhaustive?</p><p>The best way to do this is to use <strong>formal verification</strong>.</p><p>This is what we provide as a service. <strong>Contact us</strong> at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">&nbsp;ðŸ’Œcontact@formal.land</a> to make sure your code is safe!&nbsp;ðŸ›¡ï¸</p><p>We cover <strong>Rust</strong>, <strong>Solidity</strong>, and <strong>ZK systems</strong>.</p></div></div>
<figure><p><img decoding="async" loading="lazy" alt="Green forest with water" src="https://formal.land/assets/images/green-forest-with-water-d585bfd8843e8c87210ace14398fae84.webp" width="1024" height="1024" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-the-rust-code">ðŸ¦€ The Rust code<a href="https://formal.land/blog/2025/01/13/verification-one-instruction-sui#-the-rust-code" class="hash-link" aria-label="Direct link to ðŸ¦€ The Rust code" title="Direct link to ðŸ¦€ The Rust code">â€‹</a></h2>
<p>We are verifying the type-checking for the Move bytecode instruction <code>CastU8</code>. This instruction takes the top-most element of the stack, checks that it is an integer, and pushes it back on the stack as a <code>U8</code> if it is in the right range or fails with an error <code>StatusCode::ARITHMETIC_ERROR</code> otherwise.</p>
<p>Here is the code of the interpreter:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">Bytecode</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">CastU8</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gas_meter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">charge_simple_instr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">S</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">CastU8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> integer_value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">operand_stack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">pop_as</span><span class="token punctuation" style="color:#393A34">::</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">IntegerValue</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    interpreter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">operand_stack</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Value</span><span class="token punctuation" style="color:#393A34">::</span><span class="token keyword" style="color:#00009f">u8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">integer_value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">cast_u8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We ignore the gas metering for now. The <code>pop_as</code> method pops the top-most element of the stack and checks that it is an integer. The <code>cast_u8</code> method checks that the integer is in the right range (<code>0</code> to <code>255</code>) and returns the value as a <code>U8</code>. The <code>push</code> method pushes the value back on the stack. The question mark operator <code>?</code> is used to propagate errors.</p>
<p>Here is the corresponding code in the type-checker:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">Bytecode</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">CastU8</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> operand </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token macro property" style="color:#36acaa">safe_unwrap_err!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">verifier</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">pop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">operand</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">is_integer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">Err</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">verifier</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">StatusCode</span><span class="token punctuation" style="color:#393A34">::</span><span class="token constant" style="color:#36acaa">INTEGER_OP_TYPE_MISMATCH_ERROR</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            offset</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    verifier</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">meter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ST</span><span class="token punctuation" style="color:#393A34">::</span><span class="token constant" style="color:#36acaa">U8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It pops the top-most element of the stack of types (we do not have values here) and checks that it is an integer type. If it is not, it returns an error. Otherwise, it pushes the type <code>U8</code> on the stack. Note that there are no ways to know, in the type-checker, if the value is in the right range.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-the-rocq-translation">ðŸ¦â€â¬› The Rocq translation<a href="https://formal.land/blog/2025/01/13/verification-one-instruction-sui#-the-rocq-translation" class="hash-link" aria-label="Direct link to ðŸ¦â€â¬› The Rocq translation" title="Direct link to ðŸ¦â€â¬› The Rocq translation">â€‹</a></h2>
<p>In previous posts, we covered our manual translation of the Rust code in Rocq. We repeat it here. The interpreter code in Rocq:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Bytecode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CastU8 </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  letS</span><span class="token operator" style="color:#393A34">!</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> integer_value </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> liftS</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Lens</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interpreter </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    liftS</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> Interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Lens</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">operand_stack $</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Stack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Impl_Stack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pop_as IntegerValue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  letS</span><span class="token operator" style="color:#393A34">!</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> integer_value </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    returnS</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> $ IntegerValue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cast_u8 integer_value </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  doS</span><span class="token operator" style="color:#393A34">!</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> liftS</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Lens</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interpreter </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    liftS</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> Interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Lens</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">operand_stack $</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Stack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Impl_Stack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">push $</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ValueImpl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 integer_value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  returnS</span><span class="token operator" style="color:#393A34">!</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> InstrRet</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ok</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The type-checker code in Rocq:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Bytecode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CastU8 </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  letS</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> operand </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    liftS</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> TypeSafetyChecker</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lens_self_stack AbstractStack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pop </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  letS</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> operand </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">toS</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> $ safe_unwrap_err operand </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> negb $ SignatureToken</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_integer operand </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    returnS</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> $</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Err $</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      TypeSafetyChecker</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Impl_TypeSafetyChecker</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">error</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        verifier StatusCode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">INTEGER_OP_TYPE_MISMATCH_ERROR offset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TypeSafetyChecker</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Impl_TypeSafetyChecker</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">push SignatureToken</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-formal-statement">ðŸ“œ Formal statement<a href="https://formal.land/blog/2025/01/13/verification-one-instruction-sui#-formal-statement" class="hash-link" aria-label="Direct link to ðŸ“œ Formal statement" title="Direct link to ðŸ“œ Formal statement">â€‹</a></h2>
<p>Here is the formal statement of the property we want to prove to ensure the correctness of the type-checker:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Lemma</span><span class="token plain"> progress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(* [...] parameters and hypothesis *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(* We assume that the initial state is well-typed *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  IsInterpreterContextOfType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t locals interpreter type_safety_checker </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    verify_instr instruction pc type_safety_checker</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    execute_instruction ty_args function resolver instruction state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Panic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Value </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ok </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> type_safety_checker</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Panic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Value </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ok </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">'</span><span class="token punct punctuation" style="color:#393A34">{|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pc </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">locals </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> locals</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interpreter </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> interpreter</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> state</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IsInterpreterContextOfType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t locals</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> interpreter</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> type_safety_checker</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(* If the type-checker succeeds, then the interpreter cannot return a panic *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Panic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Value </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ok </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Panic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Panic </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> False</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(* Other errors are allowed *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Panic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Value </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ok </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Panic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Value </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Err </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Panic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Value </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Err </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Panic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Panic </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This lemma is in the file <a href="https://github.com/formal-land/coq-of-rust/blob/main/CoqOfRust/move_sui/proofs/move_bytecode_verifier/type_safety.v" target="_blank" rel="noopener noreferrer">proofs/move_bytecode_verifier/type_safety.v</a>. It compares the behavior of the type-checker and the interpreter when executing an instruction. If the type-checker succeeds, then the interpreter cannot return a panic. If the interpreter also succeeds, then the new state is well-typed according to the types returned by the type-checker.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ï¸-proof-time">ðŸ›¡ï¸ Proof time<a href="https://formal.land/blog/2025/01/13/verification-one-instruction-sui#%EF%B8%8F-proof-time" class="hash-link" aria-label="Direct link to ðŸ›¡ï¸ Proof time" title="Direct link to ðŸ›¡ï¸ Proof time">â€‹</a></h2>
<p>We prove the statement above by reasoning about all possible instructions. For the <code>CastU8</code> instruction, the Rocq proof is as follows:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> guard_instruction Bytecode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CastU8</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  destruct_abstract_pop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  step</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> cbn</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">exact I</span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  destruct_abstract_push</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  step</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> cbn</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">try easy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">try now destruct operand_ty</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    repeat </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">step</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> cbn</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> try easy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    constructor</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> cbn</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> try assumption</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sauto lq</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> on</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here is what this script does:</p>
<ul>
<li><code>guard_instruction Bytecode.CastU8</code> checks that the current instruction is <code>CastU8</code>. This helps debugging if we are not at the right place.</li>
<li><code>destruct_abstract_pop</code> pops the top-most element of the stack of types and gives it the name <code>operand_ty</code>. It handles the cases where the stack is empty.</li>
<li><code>step; cbn; [exact I|]</code> is a command to handle the next <code>if</code> in the code of the type-checker. We are only interested in the success branch (<code>else</code> branch in this case).</li>
<li><code>destruct_abstract_push</code> pushes the type <code>U8</code> on the stack of types.</li>
</ul>
<p>Then, there is a set of automated tactics iterating over all the possible types of values that can be on the stack. Just before the end of the proof, we have the following proof state:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">List</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Forall2 IsValueImplOfType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ValueImpl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 z </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> x0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SignatureToken</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AbstractStack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flatten stack_ty0</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This proof state is repeated identically six times, once for each possible integer type (<code>U8</code>, <code>U16</code>, <code>U32</code>, <code>U64</code>, <code>U128</code>, <code>U256</code>). It says that the stack of values:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ValueImpl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 z </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> x0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>must have the stack of types:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SignatureToken</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AbstractStack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flatten stack_ty0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The value <code>z</code> is the result of the <code>cast_u8</code> function in the interpreter. The <code>flatten</code> function is used to flatten the stack of types that may contain duplicates.</p>
<p>For the head of the stack the property is trivially true. For the tail of the stack, we use one of the hypotheses from the context, coming from the fact that the stack was initially well-typed and with did not modify the tail.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ï¸-conclusion">âœ’ï¸ Conclusion<a href="https://formal.land/blog/2025/01/13/verification-one-instruction-sui#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to âœ’ï¸ Conclusion" title="Direct link to âœ’ï¸ Conclusion">â€‹</a></h2>
<p>We have show how to formally verify that the type-checker for the Move's bytecode virtual machine is correct on a simple instruction <code>CastU8</code>. This is part of a larger effort to ensure the correctness of the whole type-checker.</p>
<p>Other instructions operating on atomic types (integers, booleans, addresses) are similar to this one. The most complex instructions are the ones operating on references and data structures like vectors and structs. These require more work, and we have not yet tackled them.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions or requests!</em></p></div></div>]]></content:encoded>
            <category>Rust</category>
            <category>Move</category>
            <category>Sui</category>
            <category>type-checker</category>
        </item>
        <item>
            <title><![CDATA[ðŸ¤– Annotating what we are doing for an LLM to pick up]]></title>
            <link>https://formal.land/blog/2025/01/06/annotating-what-we-are-doing</link>
            <guid>https://formal.land/blog/2025/01/06/annotating-what-we-are-doing</guid>
            <pubDate>Mon, 06 Jan 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[We want to write a series of blog posts about our efforts to use LLMs to formally verify code faster with the &nbsp;Rocq/Coq theorem prover. Here, we present an experiment consisting of writing all that we are doing so that we can document our reasoning and help LLMs to pick up human techniques.]]></description>
            <content:encoded><![CDATA[<p>We want to write a series of blog posts about our efforts to use LLMs to formally verify code faster with the <a href="https://rocq-prover.org/" target="_blank" rel="noopener noreferrer"><img src="https://raw.githubusercontent.com/coq/rocq-prover.org/refs/heads/main/rocq-id/logos/SVG/icon-rocq-orange.svg" height="18px">&nbsp;Rocq/Coq</a> theorem prover. Here, we present an experiment consisting of writing all that we are doing so that we can document our reasoning and help LLMs to pick up human techniques.</p>
<p>According to many publications about using generative AI to help formal verification, it is almost impossible to find a proof in "one shot". So, one certainly has to interact with the system, maybe by following the human way. Here we aim to document this "human way" of writing proofs.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Ask for the highest security!</div><div class="admonitionContent_BuS1"><p>How do you ensure your security audits are exhaustive?</p><p>When millions are at stake, bug bounties are not enough.</p><p>The only way to do this is to use <strong>formal verification</strong> to <em>prove</em> your code is correct.</p><p>This is what we provide as a service. <strong>Contact us</strong> at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">&nbsp;ðŸ’Œcontact@formal.land</a> to ensure your code is safe!&nbsp;ðŸš€</p><p>We cover <strong>Rust</strong>, <strong>Solidity</strong>, and soon <strong>zk circuits</strong>.</p></div></div>
<figure><p><img decoding="async" loading="lazy" alt="Robot" src="https://formal.land/assets/images/robot-forest-f7370f18c8ef9dd0c0d6bdb53c64d96c.webp" width="1024" height="1024" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-example">ðŸ” Example<a href="https://formal.land/blog/2025/01/06/annotating-what-we-are-doing#-example" class="hash-link" aria-label="Direct link to ðŸ” Example" title="Direct link to ðŸ” Example">â€‹</a></h2>
<p>We take as an example our verification effort for the type-checker of the Move language. We have a big lemma to verify with 77 cases, one per Move instruction. We now write everything we do in a single linear document <a href="https://github.com/formal-land/coq-of-rust/blob/main/CoqOfRust/what_we_do.md" target="_blank" rel="noopener noreferrer">what_we_do.md</a>. Here is an extract:</p>
<blockquote>
<p>Now a previous case is failing:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hauto l: on.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>with:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Error: hauto failed</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As this is a tactic generated by <code>best</code>, we try to use <code>best</code> again. It works! We continue and arrive at our current goal. Out of curiosity, we try <code>best</code> again. It works! The idea is that since we made weaker the definition of what we want to prove, maybe we can now solve it automatically.</p>
<p>We have six cases which are solved by <code>best</code>:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{ best. }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{ best. }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{ best. }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{ best. }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{ best. }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{ best. }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We replace it by <code>; best</code> after the block of previous tactics:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">step; cbn; (try easy); (try now destruct operand_ty);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> repeat (step; cbn; try easy);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> constructor; cbn; try assumption;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> best.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It works! By running <code>make</code> again we get that we can replace the <code>best</code> by `</p>
<p>So now we have done the <code>Bytecode.CastU8</code> case.</p>
</blockquote>
<p>We document both our successes and failures, as this is what we do when we interact with the system to try to find the proof of a property.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-quick-takeaways">ðŸ† Quick takeaways<a href="https://formal.land/blog/2025/01/06/annotating-what-we-are-doing#-quick-takeaways" class="hash-link" aria-label="Direct link to ðŸ† Quick takeaways" title="Direct link to ðŸ† Quick takeaways">â€‹</a></h2>
<p>This is time-consuming. Hopefully, this pays off in the long run. There may be a way to automatically record what we are doing, by recording the user interactions in a VSCode plugin. In addition, when writing what we do by hand we might forget to write some important steps but seemingly obvious steps, like checking into another file, due to laziness.</p>
<p>The autocomplete from GitHub Copilot, while writing the document, already generated the right steps to do from the journal we are writing, like "compile the project again" or a good tactic to try.</p>
<p>We realize that we have a lot to write in consolidated documents and that a lot of what we do are coding conventions we have taken. These might not be the ones used by everyone, so we have to distinguish between our conventions and general Rocq knowledge.</p>
<p>There is a lot of domain-specific knowledge that only a human can provide and that is specific to each project. For example, here, a human has to give hints related to how the Move type-checker is implemented, which can only be understood by reading the source code.</p>
<p>Here we try to give some sense of mid-level intuitions: how to navigate the project, go to a definition, add a new property, ... We do not focus too much on the details of the tactics to use (more low-level), or the high-level intuition behind the proof which might be better done by a human.</p>
<p>This helps to understand how an LLM thinks and which information it has access to.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ï¸-conclusion">âœ’ï¸ Conclusion<a href="https://formal.land/blog/2025/01/06/annotating-what-we-are-doing#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to âœ’ï¸ Conclusion" title="Direct link to âœ’ï¸ Conclusion">â€‹</a></h2>
<p>We have quickly presented the idea of writing what we are doing along the way to help LLMs understand how to verify some code.</p>
<p>Please tell us what you think or if you have some ideas for improving this process!</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions or requests!</em></p></div></div>]]></content:encoded>
            <category>llm</category>
            <category>ai</category>
        </item>
        <item>
            <title><![CDATA[ðŸ¦„ Mutually recursive functions with notation]]></title>
            <link>https://formal.land/blog/2024/12/26/mutually-recursive-functions-with-notation</link>
            <guid>https://formal.land/blog/2024/12/26/mutually-recursive-functions-with-notation</guid>
            <pubDate>Thu, 26 Dec 2024 00:00:00 GMT</pubDate>
            <description><![CDATA[In this blog post, we present a technique with the &nbsp;Rocq/Coq theorem prover to define mutually recursive functions using a notation. This is sometimes convenient for types defined using a container type, such as types depending on a list of itself.]]></description>
            <content:encoded><![CDATA[<p>In this blog post, we present a technique with the <a href="https://rocq-prover.org/" target="_blank" rel="noopener noreferrer"><img src="https://raw.githubusercontent.com/coq/rocq-prover.org/refs/heads/main/rocq-id/logos/SVG/icon-rocq-orange.svg" height="18px">&nbsp;Rocq/Coq</a> theorem prover to define mutually recursive functions using a notation. This is sometimes convenient for types defined using a container type, such as types depending on a list of itself.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Ask for the highest security!</div><div class="admonitionContent_BuS1"><p>To ensure your code is fully secure today, contact us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">&nbsp;ðŸ’Œcontact@formal.land</a>!&nbsp;ðŸš€</p><p>We exclusively focus on formal verification to offer you the highest degree of security for your application.</p><p>We currently work with some of the leading blockchain entities, such as:</p><ul>
<li>The <a href="https://ethereum.foundation/" target="_blank" rel="noopener noreferrer">Ethereum Foundation</a></li>
<li>The <a href="https://sui.io/about" target="_blank" rel="noopener noreferrer">Sui Foundation</a></li>
<li>Previously, the <a href="https://alephzero.org/" target="_blank" rel="noopener noreferrer">Aleph Zero</a> and <a href="https://tezos.com/" target="_blank" rel="noopener noreferrer">Tezos</a> foundations</li>
</ul></div></div>
<figure><p><img decoding="async" loading="lazy" alt="Forest" src="https://formal.land/assets/images/two-trees-4e9d1d0b0d813576a958ece5726466fb.jpg" width="1472" height="832" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-example">ðŸ” Example<a href="https://formal.land/blog/2024/12/26/mutually-recursive-functions-with-notation#-example" class="hash-link" aria-label="Direct link to ðŸ” Example" title="Direct link to ðŸ” Example">â€‹</a></h2>
<p>Here is a typical example of a type defined using a container of itself, written in <a href="https://www.rust-lang.org/" target="_blank" rel="noopener noreferrer">ðŸ¦€&nbsp;Rust</a>:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">Trees</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">A</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Tree</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">A</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">enum</span><span class="token plain"> </span><span class="token type-definition class-name">Tree</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">A</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Leaf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Node</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">A</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> children</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Trees</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">A</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>These two definitions are mutually dependent. We choose to represent it in Rocq/Coq with the following definition:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> Tree </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Leaf </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Tree A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Node </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> list </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Tree A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> Tree A</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> Trees </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  list </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Tree A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If we define a recursive function on this type, for example, to compute the sum of all the values in the tree, we would naturally write a function that iterates both on:</p>
<ul>
<li>The tree constructors,</li>
<li>The list of the <code>Node</code> case.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-first-solution">ðŸ“ First solution<a href="https://formal.land/blog/2024/12/26/mutually-recursive-functions-with-notation#-first-solution" class="hash-link" aria-label="Direct link to ðŸ“ First solution" title="Direct link to ðŸ“ First solution">â€‹</a></h2>
<p>Here is a first attempt to define a <code>sum</code> function that adds all the elements of the tree:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Fixpoint</span><span class="token plain"> sum_tree </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> nat</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Tree A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nat </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> t </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Leaf </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Node a ts </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> f a </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> sum_trees f ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> sum_trees </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> nat</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ts </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Trees A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nat </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> ts </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> nil </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ts </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> sum_tree f t </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> sum_trees f ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This definition does not work as the <code>Tree</code> type is not mutually recursive, but the function <code>sum_tree</code> is. The error message is:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Error: Cannot guess decreasing argument of fix.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>A first solution is to define the function <code>sum_trees</code> as a local definition in <code>sum_tree</code>:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Fixpoint</span><span class="token plain"> sum_tree </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> nat</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Tree A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nat </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fix</span><span class="token plain"> sum_trees </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ts </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Trees A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nat </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> ts </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> nil </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ts </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> sum_tree f t </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> sum_trees ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">end</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> t </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Leaf </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Node a ts </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> f a </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> sum_trees ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This definition gets accepted by the prover!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-second-solution">ðŸš€ Second solution<a href="https://formal.land/blog/2024/12/26/mutually-recursive-functions-with-notation#-second-solution" class="hash-link" aria-label="Direct link to ðŸš€ Second solution" title="Direct link to ðŸš€ Second solution">â€‹</a></h2>
<p>An issue is that we cannot call <code>sum_trees</code> directly as its definition is hidden in the one of <code>sum_tree</code>. This is a problem if further top-level definitions depend on <code>sum_trees</code>, or if we want to verify intermediate properties about <code>sum_trees</code> itself.</p>
<p>A solution we use for this kind of problem is to add a notation to make <code>sum_trees</code> a top-level definition while keeping the mutual recursion with <code>sum_tree</code>:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Reserved</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"'sum_trees"</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Fixpoint</span><span class="token plain"> sum_tree </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> nat</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Tree A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nat </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> t </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Leaf </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Node a ts </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> f a </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">'</span><span class="token plain">sum_trees </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> f ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"'sum_trees"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fix</span><span class="token plain"> sum_trees </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> nat</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ts </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Trees A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nat </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> ts </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> nil </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ts </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> sum_tree f t </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> sum_trees </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> f ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> sum_trees </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">'</span><span class="token plain">sum_trees A</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here, both <code>sum_tree</code> and <code>sum_trees</code> are defined as top-level, and the mutually recursive definition is accepted. Note that we have to make the type <code>A</code> explicit in the notation, as implicit parameters are not allowed there.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ï¸-conclusion">âœ’ï¸ Conclusion<a href="https://formal.land/blog/2024/12/26/mutually-recursive-functions-with-notation#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to âœ’ï¸ Conclusion" title="Direct link to âœ’ï¸ Conclusion">â€‹</a></h2>
<p>We have shown a technique that is sometimes useful for us to define complex, mutually dependent data structures. This was recently useful for defining the <code>ValueImpl</code> type in the type-checker of <a href="https://sui.io/move" target="_blank" rel="noopener noreferrer">Move</a> for the blockchain <a href="https://sui.io/" target="_blank" rel="noopener noreferrer">Sui</a>.</p>
<p>You can tell us what you think or if you prefer another way to define mutually recursive functions!</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions or requests!</em></p></div></div>]]></content:encoded>
            <category>recursion</category>
            <category>notation</category>
            <category>mutual</category>
        </item>
        <item>
            <title><![CDATA[ðŸ‘» Translation of Circom to Coq]]></title>
            <link>https://formal.land/blog/2024/12/20/translation-of-circom-to-coq</link>
            <guid>https://formal.land/blog/2024/12/20/translation-of-circom-to-coq</guid>
            <pubDate>Fri, 20 Dec 2024 00:00:00 GMT</pubDate>
            <description><![CDATA[In this post, we present the beginning of our work to translate programs written in the Circom circuit language to the ðŸ“&nbsp;Coq proof assistant. This work is part of our research on the formal verification of zero-knowledge systems.]]></description>
            <content:encoded><![CDATA[<p>In this post, we present the beginning of our work to translate programs written in the <a href="https://iden3.io/circom" target="_blank" rel="noopener noreferrer">Circom</a> circuit language to the <a href="https://coq.inria.fr/" target="_blank" rel="noopener noreferrer">ðŸ“&nbsp;Coq</a> proof assistant. This work is part of our research on the formal verification of zero-knowledge systems.</p>
<p>We will aim to write more regularly about what we are doing, even if the posts are then shorter. Here, we focus on the translation part for a simple example without defining a semantics for the generated Coq code.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Ask for the highest security!</div><div class="admonitionContent_BuS1"><p>To ensure your code is fully secure today, contact us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">&nbsp;ðŸ’Œcontact@formal.land</a>!&nbsp;ðŸš€</p><p>We exclusively focus on formal verification to offer you the highest degree of security for your application.</p><p>We are already working with some of the leading blockchain entities, such as:</p><ul>
<li>The <a href="https://ethereum.foundation/" target="_blank" rel="noopener noreferrer">Ethereum Foundation</a></li>
<li>The <a href="https://sui.io/about" target="_blank" rel="noopener noreferrer">Sui Foundation</a></li>
<li>Previously, the <a href="https://alephzero.org/" target="_blank" rel="noopener noreferrer">Aleph Zero</a> and <a href="https://tezos.com/" target="_blank" rel="noopener noreferrer">Tezos</a> foundations</li>
</ul></div></div>
<figure><p><img decoding="async" loading="lazy" alt="Forest" src="https://formal.land/assets/images/ghost-forest-4e04fc0aca09ad06a1370c3761f0b504.webp" width="1024" height="1024" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-the-circom-language">ðŸ‘» The Circom language<a href="https://formal.land/blog/2024/12/20/translation-of-circom-to-coq#-the-circom-language" class="hash-link" aria-label="Direct link to ðŸ‘» The Circom language" title="Direct link to ðŸ‘» The Circom language">â€‹</a></h2>
<p>This is a language to write composable and optimized zero-knowledge circuits. It has been in use for quite some time, and there are a lot of examples of Circom programs implementing common cryptographic primitives, such as hash functions. See, for example, the <a href="https://github.com/iden3/circomlib" target="_blank" rel="noopener noreferrer">github.com/iden3/circomlib</a> repository. It is quoted by many projects, see for example this blog post <a href="https://www.mystenlabs.com/blog/how-zklogin-made-cryptography-faster-and-more-secure" target="_blank" rel="noopener noreferrer">How zkLogin Made Cryptography Faster and More Secure</a> of the development team of [Sui](How zkLogin Made Cryptography Faster and More Secure) mentioning Circom.</p>
<p>Here is the example which we consider to add <code>ops</code> numbers of <code>n</code> bits:</p>
<div class="language-circom codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-circom codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">function nbits(a) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var n = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var r = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    while (n-1&lt;a) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        r++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        n *= 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return r;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">template BinSum(n, ops) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var nout = nbits((2**n -1)*ops);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    signal input in[ops][n];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    signal output out[nout];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var lin = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var lout = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var k;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var j;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var e2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    e2 = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (k=0; k&lt;n; k++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (j=0; j&lt;ops; j++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            lin += in[j][k] * e2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        e2 = e2 + e2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    e2 = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (k=0; k&lt;nout; k++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        out[k] &lt;-- (lin &gt;&gt; k) &amp; 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Ensure out is binary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        out[k] * (out[k] - 1) === 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lout += out[k] * e2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        e2 = e2+e2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Ensure the sum;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lin === lout;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You can find this example in <a href="https://github.com/iden3/circomlib/blob/master/circuits/binsum.circom" target="_blank" rel="noopener noreferrer">github.com/iden3/circomlib/blob/master/circuits/binsum.circom</a>.</p>
<p>It contains a function <code>nbits</code> to compute the number of bits needed to represent a number, and a template <code>BinSum</code> to add <code>ops</code> numbers of <code>n</code> bits. The function <code>bits</code> does not make any operations related to zero-knowledge. It is a simple imperative function with a loop and mutable variables <code>n</code> and <code>r</code>.</p>
<p>The template <code>BinSum</code> defines what is required to instantiate a new component, with input signals <code>in</code> and output signals <code>out</code>. With the equality assertion <code>===</code> it ensures that the output signals must be the bits of the sum of the input signals, and cannot be anything else. This is the property that we will want to formally verify to ensure that it is not possible to provide a proof of this circuit which does not compute the addition. This is called verifying that the circuit is not <em>underconstrained</em>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-the-coq-proof-assistant">ðŸ“ The Coq proof assistant<a href="https://formal.land/blog/2024/12/20/translation-of-circom-to-coq#-the-coq-proof-assistant" class="hash-link" aria-label="Direct link to ðŸ“ The Coq proof assistant" title="Direct link to ðŸ“ The Coq proof assistant">â€‹</a></h2>
<p>The <a href="https://coq.inria.fr/" target="_blank" rel="noopener noreferrer">Coq proof assistant</a>, which we use exclusively at <a href="https://formal.land/" target="_blank" rel="noopener noreferrer">Formal Land</a>, is a generic formal verification system. You can use it to verify any kind of maths or programs. You can never be stuck in the verification of a property, thanks to its interactive mode to refine proofs step by step. You can express almost any kind of property as it is based on the very expressive <a href="https://en.wikipedia.org/wiki/Calculus_of_constructions" target="_blank" rel="noopener noreferrer">Calculus Of Constructions</a> logic.</p>
<p>Its community focuses a lot on the verification of programs, the most notable example being the full verification of the C compiler <a href="https://compcert.org/" target="_blank" rel="noopener noreferrer">CompCert</a>.</p>
<p>Our strategy is always the same: finding a nice embedding of a language in Coq, so that we can formally verify programs written in this language and reuse all the existing Coq tools and libraries.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-translation-of-circom-to-coq">ðŸš€ Translation of Circom to Coq<a href="https://formal.land/blog/2024/12/20/translation-of-circom-to-coq#-translation-of-circom-to-coq" class="hash-link" aria-label="Direct link to ðŸš€ Translation of Circom to Coq" title="Direct link to ðŸš€ Translation of Circom to Coq">â€‹</a></h2>
<p>The Circom compiler is written in <a href="https://www.rust-lang.org/" target="_blank" rel="noopener noreferrer">ðŸ¦€&nbsp;Rust</a>. Generally, a compiler is composed of many intermediate languages, starting from a language that is essentially a representation of what the parser returns, down to some form of assembly or circuit language.</p>
<p>If you translate a high-level intermediate language to a proof system, you retain a lot of information from the original program and the specifications/proofs tend to be simpler. If you translate a low-level language, the translation itself will be simpler and more trustworthy, but the verification part will be harder. As Circom is a rather small language (compared to a full programming language), we choose to translate its high-level representation to Coq.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="to-json">To JSON<a href="https://formal.land/blog/2024/12/20/translation-of-circom-to-coq#to-json" class="hash-link" aria-label="Direct link to To JSON" title="Direct link to To JSON">â€‹</a></h3>
<p>We write our translation tool in ðŸ&nbsp;Python for simplicity, reading a JSON export of the <a href="https://github.com/iden3/circom/blob/master/program_structure/src/abstract_syntax_tree/ast.rs" target="_blank" rel="noopener noreferrer">abstract syntax tree</a> of Circom. The quickest way to export data from Rust is to use the <a href="https://serde.rs/" target="_blank" rel="noopener noreferrer">Serde</a> to generate pretty-printing functions to JSON. We have done it in this <a href="https://github.com/formal-land/circom/pull/1" target="_blank" rel="noopener noreferrer">pull request</a> from a fork of the Circom compiler.</p>
<p>Here is, for example, the beginning of the JSON version of the <code>nbits</code> function above:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token property" style="color:#36acaa">"Function"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"meta"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"nbits"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"args"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"a"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"arg_location"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"start"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1571</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"end"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1572</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"body"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"Block"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">"meta"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">"stmts"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"InitializationBlock"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"meta"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"xtype"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Var"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"initializations"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"Declaration"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token property" style="color:#36acaa">"meta"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token property" style="color:#36acaa">"xtype"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Var"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token property" style="color:#36acaa">"name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"n"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token property" style="color:#36acaa">"dimensions"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token property" style="color:#36acaa">"is_constant"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"Substitution"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token property" style="color:#36acaa">"meta"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token property" style="color:#36acaa">"var"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"n"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token property" style="color:#36acaa">"access"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token property" style="color:#36acaa">"op"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"AssignVar"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token property" style="color:#36acaa">"rhe"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"Number"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="to-coq">To Coq<a href="https://formal.land/blog/2024/12/20/translation-of-circom-to-coq#to-coq" class="hash-link" aria-label="Direct link to To Coq" title="Direct link to To Coq">â€‹</a></h3>
<p>We iterate over each nodes of this JSON file to produce a corresponding Coq file with the Python script <a href="https://github.com/formal-land/garden/blob/main/scripts/coq_of_circom.py" target="_blank" rel="noopener noreferrer">scipts/coq_of_circom.py</a>. Here is a short extract from this script:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">"""</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">pub enum Access {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    ComponentAccess(String),</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    ArrayAccess(Expression),</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">"""</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">to_coq_access</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ComponentAccess"</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> node</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f"Access.Component (</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">node</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">[</span><span class="token string-interpolation interpolation string" style="color:#e3116c">'ComponentAccess'</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">]</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">)"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ArrayAccess"</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> node</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f"Access.Array (</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">to_coq_expression</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">node</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">[</span><span class="token string-interpolation interpolation string" style="color:#e3116c">'ArrayAccess'</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">]</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">)"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f"Unknown access: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">node</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>For every node type in the Circom AST, we copy its Rust type in triple quotes in Python and let GitHub Copilot write a conversion function, which we complete and fix by hand. That way, we quickly cover all syntax with a reasonable Coq output.</p>
<p>We put all the code of our translation in a monad in Coq to represent the side effects, which are mainly here:</p>
<ul>
<li>imperative effects such as mutations and potentially non-terminating loops,</li>
<li>the instantiation of components with signals, and the enforcement of the equality constraints.</li>
</ul>
<p>Here is the Coq translation for the Circom example above, given in <a href="https://github.com/formal-land/garden/blob/main/Garden/Circom/Example/binsum.v" target="_blank" rel="noopener noreferrer">Garden/Circom/Example/binsum.v</a>:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">(* Function *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> nbits </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">function_body </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">(* Var *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">declare_var </span><span class="token string" style="color:#e3116c">"n"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"n"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">(* Var *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">declare_var </span><span class="token string" style="color:#e3116c">"r"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"r"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">while </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lesser </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sub </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"n"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"a"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"r"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"r"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"n"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mul </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"n"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pure BlockUnit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">return_ </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"r"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pure BlockUnit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">(* Template *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> BinSum </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n ops </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t BlockUnit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(* Var *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">declare_var </span><span class="token string" style="color:#e3116c">"nout"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"nout"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> nbits </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mul </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sub </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pow </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"n"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ops"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(* Signal Input *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">declare_signal </span><span class="token string" style="color:#e3116c">"in"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ops"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"n"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(* Signal Output *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">declare_signal </span><span class="token string" style="color:#e3116c">"out"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"nout"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(* Var *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">declare_var </span><span class="token string" style="color:#e3116c">"lin"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"lin"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(* Var *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">declare_var </span><span class="token string" style="color:#e3116c">"lout"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"lout"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(* Var *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">declare_var </span><span class="token string" style="color:#e3116c">"k"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"k"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(* Var *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">declare_var </span><span class="token string" style="color:#e3116c">"j"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"j"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(* Var *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">declare_var </span><span class="token string" style="color:#e3116c">"e2"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"e2"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"e2"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"k"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">while </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lesser </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"k"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"n"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"j"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">while </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lesser </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"j"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ops"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"lin"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"lin"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mul </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var_access </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"in"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Access</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Array </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"j"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> Access</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Array </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"k"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"e2"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"j"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"j"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pure BlockUnit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"e2"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"e2"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"e2"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"k"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"k"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pure BlockUnit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"e2"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"k"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">while </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lesser </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"k"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"nout"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"out"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bitand </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">shiftr </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"lin"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"k"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">equality_constraint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mul </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var_access </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"out"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Access</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Array </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"k"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sub </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var_access </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"out"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Access</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Array </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"k"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"lout"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"lout"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mul </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var_access </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"out"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Access</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Array </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"k"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"e2"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"e2"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"e2"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"e2"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"k"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"k"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pure BlockUnit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">equality_constraint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"lin"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"lout"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pure BlockUnit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tt</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you compare the translated code to the original Circom code, you will see that the two are very similar, up to a more verbose syntax in Coq. This is because we translate the high-level representation of Circom to Coq.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="free-monad">Free monad<a href="https://formal.land/blog/2024/12/20/translation-of-circom-to-coq#free-monad" class="hash-link" aria-label="Direct link to Free monad" title="Direct link to Free monad">â€‹</a></h3>
<p>Even if we do not define the Circom semantics for now, we need to write a few Coq definitions so that the code above can be type-checked. As in the translations we make for other languages, we use a free-monad to represent side effects. This is convenient, as we can first express which are the various "special" operators of the language (declaring a signal, instantiating a template, ...) and define their behavior in a second step. The behavior might be defined in a computational or relational way later.</p>
<p>The definitions of the monad are in <a href="https://github.com/formal-land/garden/blob/main/Garden/Garden.v" target="_blank" rel="noopener noreferrer">Garden/Garden.v</a>. Here is an extract:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Primitive</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(** We group together primitives that share being impure functions operating over the state. *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> OpenScope </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t unit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CloseScope </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t unit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> DeclareVar </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t unit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> DeclareSignal </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dimensions </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t unit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> SubstituteVar </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t unit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> GetVarAccess </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">access </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list Access</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> GetPrime </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> EqualityConstraint </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value1 value2 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t unit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Primitive</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>These are some of the primitives from the Circom language, which we needed for our example (we will add more as we cover more of the language). For example:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">|</span><span class="token plain"> DeclareVar </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t unit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>corresponds to the Circom construction:</p>
<div class="language-circom codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-circom codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">var n = 1;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>with <code>name</code> the string <code>"n"</code> and value the field element <code>1</code> in this case. We will use a scope of local variables for each function, as a dictionary from the name of the variable to its value. All local variables might be mutated. Compared to more complex languages, such as Rust, we do not need to handle the notion of pointer, simplifying many things.</p>
<p>Note that with the free monad, we only give the list of primitive operations with their signatures, but we have not yet defined how to evaluate them.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ï¸-conclusion">âœ’ï¸ Conclusion<a href="https://formal.land/blog/2024/12/20/translation-of-circom-to-coq#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to âœ’ï¸ Conclusion" title="Direct link to âœ’ï¸ Conclusion">â€‹</a></h2>
<p>We have seen to define a first translation from the Circom language to Coq, for one example, with the goal of having a translation that is well-typed.</p>
<p>In the following article, we will explore the definition of a meaning to the primitive operations of Circom, such as signals and constraints, in order to formally verify that the <code>BinSum</code> is correct.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions or requests!</em></p></div></div>]]></content:encoded>
            <category>Circom</category>
            <category>zero-knowledge</category>
        </item>
    </channel>
</rss>