<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://formal.land/blog</id>
    <title>Formal Land Blog</title>
    <updated>2025-08-11T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://formal.land/blog"/>
    <subtitle>Formal Land Blog</subtitle>
    <icon>https://formal.land/img/land-512.png</icon>
    <entry>
        <title type="html"><![CDATA[ü¶Ñ Short introduction to Rocq]]></title>
        <id>https://formal.land/blog/2025/08/11/quick-rocq-in-a-hurry</id>
        <link href="https://formal.land/blog/2025/08/11/quick-rocq-in-a-hurry"/>
        <updated>2025-08-11T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[In this blog post, we present a short introduction to Rocq, a formal verification system, as a summary of the guide Rocq in a Hurry from Yves Bertot of the Rocq team.]]></summary>
        <content type="html"><![CDATA[<p>In this blog post, we present a short introduction to <a href="https://rocq-prover.org/" target="_blank" rel="noopener noreferrer">Rocq</a>, a formal verification system, as a summary of the guide <a href="https://cel.hal.science/inria-00001173v6/document" target="_blank" rel="noopener noreferrer">Rocq in a Hurry</a> from <a href="https://www-sop.inria.fr/members/Yves.Bertot/research.html" target="_blank" rel="noopener noreferrer">Yves Bertot</a> of the Rocq team.</p>
<p>Rocq is the formal system that we use exclusively, but other interactive theorem provers work the same way. From this introduction, you can get a sense of how the verification of mathematical statements or security properties of programs works.</p>
<figure><p><img decoding="async" loading="lazy" alt="Green forest" src="https://formal.land/assets/images/forest-4f0bdc03b8188e8b1d6e2410c466cff6.png" width="1024" height="1024" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-definitions">üß© Definitions<a href="https://formal.land/blog/2025/08/11/quick-rocq-in-a-hurry#-definitions" class="hash-link" aria-label="Direct link to üß© Definitions" title="Direct link to üß© Definitions">‚Äã</a></h2>
<p>There are propositions for logical formulas, which can be <code>True</code>, <code>False</code>, <code>/\</code> (and), <code>\/</code> (or), <code>-&gt;</code> (implies), <code>~</code> (not), using quantifiers <code>forall</code> and <code>exists</code>, and operators like <code>=</code> for equality. These can be proven to be correct. There are expressions like <code>3 * x</code> that can be computed. We can define these as in a purely functional programming language.</p>
<p>Basic data types for computations are booleans (not to be confused with propositions, on which you cannot compute), natural numbers defined as being either <code>0</code> or <code>n + 1</code> for some other <code>n</code> a natural number, and lists which are either <code>[]</code> or <code>x :: l</code> like in many functional languages. You can define functions on those data types by pattern-matching (<code>match</code> operator) with recursive calls restricted to sub-elements of the patterns, to make sure all functions terminate.</p>
<p>Here is an example of a recursive function combining booleans, natural numbers, and lists:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Fixpoint</span><span class="token plain"> insert n l </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> l </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> n </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> a </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tl </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> n </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> a </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      n </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> l</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      a </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> insert n tl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-proofs">üìù Proofs<a href="https://formal.land/blog/2025/08/11/quick-rocq-in-a-hurry#-proofs" class="hash-link" aria-label="Direct link to üìù Proofs" title="Direct link to üìù Proofs">‚Äã</a></h2>
<p>For propositions, like <code>forall (n : nat), n &lt; n + 1</code>, the goal is to find a proof of it, as we cannot simply evaluate a proposition to know if it is true or false. To write the proof, we use the interactive mode of Rocq, where we will step through the proof to construct it while being checked as correct. There are also automation primitives to go faster, but we will not see them here.</p>
<p>An example is the commutativity of the <code>and</code>:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">forall</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">A B </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Prop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">/\</span><span class="token plain"> B </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> B </span><span class="token operator" style="color:#393A34">/\</span><span class="token plain"> A</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In proof mode, we see what the hypotheses are and what the goal is, separated by a horizontal bar. Originally, the whole proposition is the goal, and there are no hypotheses. Then with <code>intros</code> we move everything we can (in the <code>forall</code> or before the <code>-&gt;</code>) to the hypotheses:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">A</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> B </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Prop</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">H </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">/\</span><span class="token plain"> B</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">B </span><span class="token operator" style="color:#393A34">/\</span><span class="token plain"> A</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now the goal is <code>B /\ A</code>. We can use <code>split</code> to split the goal into two, first <code>B</code> and then <code>A</code>. To solve the first goal, you can use <code>destruct H</code> to split it into two. We obtain:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">A</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> B </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Prop</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">H1 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">H2 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> B</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">B</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now we have in hypothesis exactly what we want to prove, that is to say, <code>B</code>. We can now conclude the proof with <code>apply H2</code>, and do similarly for the other goal <code>A</code>. We completed our first proof!</p>
<p>For all the propositional operators, there is a command to use them when they are in a hypothesis, and a command to build them when they are in the goal. Most common commands, named tactics, are: <code>intros</code>, <code>apply</code>, <code>split</code>, <code>destruct</code>, <code>rewrite</code>, <code>exists</code>, <code>reflexivity</code>, <code>unfold</code>. As an exercise, you can try to prove the commutativity of the <code>or</code> operator.</p>
<p>Proofs are generally organized into a lot of sub-steps called lemmas. These are intermediate properties used to prove the main goal. The standard library or other packages provide a lot of such lemmas. You can find them using the <code>Search</code> command.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-reasoning-by-cases">‚òØÔ∏è Reasoning by cases<a href="https://formal.land/blog/2025/08/11/quick-rocq-in-a-hurry#%EF%B8%8F-reasoning-by-cases" class="hash-link" aria-label="Direct link to ‚òØÔ∏è Reasoning by cases" title="Direct link to ‚òØÔ∏è Reasoning by cases">‚Äã</a></h2>
<p>To reason on propositions over expressions, and in particular programs, we can use the same tactics. The <code>destruct</code> tactic enables reasoning by cases. For example, on booleans this means reasoning on the two cases <code>false</code> and <code>true</code> to verify that a property is correct for any boolean. On infinite data structures, like natural numbers, we reason by induction using the tactic <code>induction</code>. For a given <code>n</code>, a natural number in the hypotheses, it will generate two sub-goals, one with <code>n</code> replaced by <code>0</code>, and one with <code>n</code> replaced by <code>n + 1</code>, assuming an additional hypothesis which is the goal assumed correct for <code>n</code>. An example of property is that the length of the concatenation of two lists is the sum of the lengths of the two lists, for any possible lists.</p>
<p>We can compose the reasoning by cases, yielding an arbitrary number of sub-goals. In practice, we will often get stuck in the wrong direction, like we would be stuck on paper, probably even more so than on paper.</p>
<p>The reasoning by induction works on arbitrary infinite data structures. For example, on lists it generates a sub-goal for the empty list, and one for the list <code>x :: l</code>, assuming an additional hypothesis which is the goal assumed correct for <code>l</code>.</p>
<p>We can define new data types with several constructors with potential parameters, and the possibility to reference itself in the parameters of the constructors. This is similar to the definition of <code>enum</code> in Rust. For example, for binary trees with empty leaves:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> bin </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Leaf </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Node </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bin </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> bin </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> bin</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It is then possible to define functions by pattern-matching and recursing on this new data type, like we were doing on natural numbers or lists, as well as prove properties by induction.</p>
<p>There are additional common data types. An important one is <code>Z</code> which represents unbounded integers in binary encoding. It is more efficient than <code>nat</code> for computations that use an unary encoding, but sometimes less convenient for proofs.</p>
<p>Finally, you can also define new propositions using the <code>Inductive</code> keyword to define complex and recursive propositions. This is, for example, useful when defining the execution rules of programming languages.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-conclusion">‚úíÔ∏è Conclusion<a href="https://formal.land/blog/2025/08/11/quick-rocq-in-a-hurry#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to ‚úíÔ∏è Conclusion" title="Direct link to ‚úíÔ∏è Conclusion">‚Äã</a></h2>
<p>We have seen a quick introduction to understand to state and formally verify properties in a system like Rocq. In practice, to formally verify the security of a program, we will wrap these primitives in automation layers, and connect the definitions to the actual source code with translation tools such as <a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">coq-of-rust</a>.</p>
<blockquote>
<p>You want to secure your code? Contact us! ‚á® <a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a></p>
</blockquote>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions!</em></p></div></div>]]></content>
        <category label="Rocq" term="Rocq"/>
        <category label="formal verification" term="formal verification"/>
        <category label="introduction" term="introduction"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[ü•∑ Formal verification of LLZK circuits in Rocq]]></title>
        <id>https://formal.land/blog/2025/07/31/llzk-to-rocq-verification</id>
        <link href="https://formal.land/blog/2025/07/31/llzk-to-rocq-verification"/>
        <updated>2025-07-31T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[In this blog post, we present a short example about how we define reasoning rules in Rocq to formally verify the safety of zero-knowledge circuits written in LLZK.]]></summary>
        <content type="html"><![CDATA[<p>In this blog post, we present a short example about how we define reasoning rules in <a href="https://rocq-prover.org/" target="_blank" rel="noopener noreferrer">Rocq</a> to formally verify the safety of zero-knowledge circuits written in <a href="https://github.com/Veridise/llzk-lib" target="_blank" rel="noopener noreferrer">LLZK</a>.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Follow-up</div><div class="admonitionContent_BuS1"><p>This blog post is a follow-up to:</p><ul>
<li><a href="https://formal.land/blog/2025/07/30/llzk-to-rocq-semantics">ü•∑ Semantics for LLZK in Rocq</a></li>
</ul><p>The code we are referring to in this post is available in <a href="https://github.com/formal-land/garden/tree/main/Garden/LLZK" target="_blank" rel="noopener noreferrer">github.com/formal-land/garden/Garden/LLZK</a>.</p></div></div>
<figure><p><img decoding="async" loading="lazy" alt="Green forest" src="https://formal.land/assets/images/green_forest-67a5dfcc71e922dadfd45e6929435a0d.png" width="1024" height="1024" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-reasoning-rules">üßÆ Reasoning rules<a href="https://formal.land/blog/2025/07/31/llzk-to-rocq-verification#-reasoning-rules" class="hash-link" aria-label="Direct link to üßÆ Reasoning rules" title="Direct link to üßÆ Reasoning rules">‚Äã</a></h2>
<p>As we use a free monad to represent the effectful operations of LLZK, we need to define reasoning rules to evaluate each operator.</p>
<p>In order to optimize the proofs for the verification of safety properties (no under-constraints), we will assume that the execution of LLZK terms is always complete. By complete, we mean that there are no out-of-bound accesses in arrays. We also mean that we initialize each value exactly once, for the pattern where we declare an array and then set its elements in a second step, for example.</p>
<p>For the circuits, this is a reasonable assumption, as they are executed only once, unrolling all the loops and function calls in a large set of polynomial equations. For the <code>compute</code> functions that generate the witnesses, since they are stored off-chain, we can always upgrade them if we realize they are not complete. A proof of completeness for the <code>compute</code> functions could be done independently using a dedicated semantics.</p>
<p>We define a predicate:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> e üîΩ result </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> P </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>saying that a monadic computation <code>e</code> can reduce to the value <code>output</code>, and that its successful execution implies that the predicate <code>P</code> holds. The predicate <code>P</code> typically applies to the input and output field variables of the circuit. A typical predicate is:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>output</mtext><mo>=</mo><mtext>expected_output(input)</mtext></mrow><annotation encoding="application/x-tex">\text{output} = \text{expected\_output(\text{input})}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8095em;vertical-align:-0.1944em"></span><span class="mord text"><span class="mord">output</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em"></span><span class="mord text"><span class="mord">expected_output(</span><span class="mord text"><span class="mord">input</span></span><span class="mord">)</span></span></span></span></span></span>
<p>stating that the circuit is deterministic.</p>
<p>The main reasoning rules are, in Rocq code:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">forall</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Prop</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Prop</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Pure </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pure value üîΩ value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> True </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> AssertEqual </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x1 x2 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AssertEqual x1 x2 üîΩ tt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> x1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> x2 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CreateStruct </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CreateStruct üîΩ value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> True </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> FieldWrite </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">field </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FieldWrite field field üîΩ tt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> True </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Let</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A B </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t B</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">output </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> B</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">P1 P2 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Prop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> e üîΩ value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> P1 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">P1 </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> k value üîΩ output</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> P2 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Let</span><span class="token plain"> e k üîΩ output</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> P1 </span><span class="token operator" style="color:#393A34">/\</span><span class="token plain"> P2 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Implies </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">P1 P2 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Prop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> e üîΩ value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> P1 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">P1 </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> P2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> e üîΩ value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> P2 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"{{ e üîΩ output , P }}"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t e output P</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="pure"><code>Pure</code><a href="https://formal.land/blog/2025/07/31/llzk-to-rocq-verification#pure" class="hash-link" aria-label="Direct link to pure" title="Direct link to pure">‚Äã</a></h3>
<p>There is nothing special to say about the rule of the <code>M.Pure</code> operator of the monad. We return the <code>value</code> that we are supposed to return, whether it is in a fully evaluated form or still as an expression with some free variables. The predicate is <code>True</code> as we do not assert any constraints.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="assertequal"><code>AssertEqual</code><a href="https://formal.land/blog/2025/07/31/llzk-to-rocq-verification#assertequal" class="hash-link" aria-label="Direct link to assertequal" title="Direct link to assertequal">‚Äã</a></h3>
<p>For the <code>M.AssertEqual</code> operator, we always return the unit value <code>tt</code>, and we assert that the two parameters are equal. The predicate is the equality between the two parameters, as this is the condition to successfully execute the operator.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="createstruct"><code>CreateStruct</code><a href="https://formal.land/blog/2025/07/31/llzk-to-rocq-verification#createstruct" class="hash-link" aria-label="Direct link to createstruct" title="Direct link to createstruct">‚Äã</a></h3>
<p>With this operator, we can declare a new structure element, whose fields are to be set later. This is a non-deterministic operation, and we let the user choose the value of the structure when verifying the circuit. However, in practice, there is only one possible choice as the value of the structure must be compatible with the write operations that will follow.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="fieldwrite"><code>FieldWrite</code><a href="https://formal.land/blog/2025/07/31/llzk-to-rocq-verification#fieldwrite" class="hash-link" aria-label="Direct link to fieldwrite" title="Direct link to fieldwrite">‚Äã</a></h3>
<p>This operator is used to write a value in a field of a structure. We can apply this rule only if we have chosen the right value for the structure. We assume that all LLZK functions are complete, which can be checked at runtime, so that each declared structure has exactly one write operation, and we cannot make a read before the write.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="let"><code>Let</code><a href="https://formal.land/blog/2025/07/31/llzk-to-rocq-verification#let" class="hash-link" aria-label="Direct link to let" title="Direct link to let">‚Äã</a></h3>
<p>The <code>Let</code> rule is for the binding operator of the monad. It combines the conditions <code>P1</code> and <code>P2</code> to form a new predicate <code>P1 /\ P2</code> for the execution of <code>e</code> and <code>k</code>. We can also use the knowledge of <code>P1</code> to reason about the execution of <code>k</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="implies"><code>Implies</code><a href="https://formal.land/blog/2025/07/31/llzk-to-rocq-verification#implies" class="hash-link" aria-label="Direct link to implies" title="Direct link to implies">‚Äã</a></h3>
<p>Finally, the <code>Implies</code> rule is used to simplify the expression of the predicate <code>P</code>. We generally wrap our proofs in an <code>Implies</code> call to have a clean predicate at the end. Otherwise, the final expression would contain a lot of clutter, like <code>True /\ ...</code> operations.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-example">üìù Example<a href="https://formal.land/blog/2025/07/31/llzk-to-rocq-verification#-example" class="hash-link" aria-label="Direct link to üìù Example" title="Direct link to üìù Example">‚Äã</a></h2>
<p>We now look at the specification and verification of the LLZK example we took at the beginning of this blog post series:</p>
<div class="language-mlir codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-mlir codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">function.def @global_add(%a: !felt.type, %b: !felt.type) -&gt; !felt.type {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  %c = felt.add %a, %b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  function.return %c : !felt.type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">struct.def @Adder {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  struct.field @sum : !felt.type {llzk.pub}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  function.def @compute(%a: !felt.type, %b: !felt.type) -&gt; !struct.type&lt;@Adder&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    %self = struct.new : !struct.type&lt;@Adder&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    %sum = function.call @global_add(%a, %b) : (!felt.type, !felt.type) -&gt; (!felt.type)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct.writef %self[@sum] = %sum : !struct.type&lt;@Adder&gt;, !felt.type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function.return %self : !struct.type&lt;@Adder&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  function.def @constrain(%self: !struct.type&lt;@Adder&gt;, %a: !felt.type, %b: !felt.type) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    %sum = struct.readf %self[@sum] : !struct.type&lt;@Adder&gt;, !felt.type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    %c = function.call @global_add(%a, %b) : (!felt.type, !felt.type) -&gt; (!felt.type)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    constrain.eq %sum, %c : !felt.type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function.return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="global_add"><code>global_add</code><a href="https://formal.land/blog/2025/07/31/llzk-to-rocq-verification#global_add" class="hash-link" aria-label="Direct link to global_add" title="Direct link to global_add">‚Äã</a></h3>
<p>For the <code>global_add</code> function, we write the following specification in the file <a href="https://github.com/formal-land/garden/blob/main/Garden/LLZK/verification.v" target="_blank" rel="noopener noreferrer">Garden/LLZK/verification.v</a>:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Lemma</span><span class="token plain"> global_add_eq </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x y </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> global_add x y üîΩ </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> mod p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> True </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The generated Rocq translation of the <code>global_add</code> function is:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> global_add </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg_fun_0 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg_fun_1 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> var_0 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BinOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add arg_fun_0 arg_fun_1 </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pure var_0</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We can now prove the specification with the application of the single rule <code>Run.Pure</code>, as the code is purely functional:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Proof</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Qed</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Most of the auxiliary functions or the <code>compute</code> functions will have a specification of a similar form, where the predicate is <code>True</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="compute"><code>compute</code><a href="https://formal.land/blog/2025/07/31/llzk-to-rocq-verification#compute" class="hash-link" aria-label="Direct link to compute" title="Direct link to compute">‚Äã</a></h3>
<p>The translation of the <code>compute</code> function is:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> compute </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg_fun_0 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg_fun_1 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> var_self </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CreateStruct </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> var_0 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> global_add arg_fun_0 arg_fun_1 </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> unit </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FieldWrite var_self</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sum</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> var_0 </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pure var_self</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here, there are some side-effects composed with the <code>M.Let</code> operator, noted <code>let*</code>. We can apply the <code>Run.Let</code> rule to prove the specification:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> spec </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x y </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punct punctuation" style="color:#393A34">{|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sum </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> mod p</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Lemma</span><span class="token plain"> compute_eq </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x y </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compute x y üîΩ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec x y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Proof</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unfold Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compute</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  eapply Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Implies</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    eapply Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Let</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      eapply Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CreateStruct </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Build_t </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    intros </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    eapply Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Let</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> global_add_eq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    intros </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    eapply Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Let</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      eapply Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FieldWrite</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    intros </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  easy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Qed</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The specification states that we are creating a structure with the addition modulo <code>p</code> of the two input parameters. We make the proof with a succession of <code>Run.Let</code> rules. For the line:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> var_self </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CreateStruct </span><span class="token keyword" style="color:#00009f">in</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>we apply the <code>Run.CreateStruct</code> rule, with an existential variable <code>_</code> for the field of the structure. This existential variable is later unified with the right value when we evaluate the line:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> unit </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FieldWrite var_self</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sum</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> var_0 </span><span class="token keyword" style="color:#00009f">in</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>which forces its value to be <code>var_0</code>.</p>
<p>The last tactic:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">easy</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>at the end of the proof is there to aggregate the predicate <code>True /\ ... /\ True</code> that we obtain from the <code>Run.Let</code> rules into a single <code>True</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="constrain"><code>constrain</code><a href="https://formal.land/blog/2025/07/31/llzk-to-rocq-verification#constrain" class="hash-link" aria-label="Direct link to constrain" title="Direct link to constrain">‚Äã</a></h3>
<p>The translation of the <code>constrain</code> function is:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> constrain </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg_fun_0 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg_fun_1 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg_fun_2 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t unit </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> var_0 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> arg_fun_0</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sum</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> var_1 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> global_add arg_fun_1 arg_fun_2 </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> unit </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AssertEqual var_0 var_1 </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pure tt</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We specify it as follows:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Lemma</span><span class="token plain"> contrain_implies </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x y </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> self </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> map_mod self </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">constrain self x y üîΩ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> spec x y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here, we always return the unit value <code>tt</code>, and we assert that the <code>self</code> parameter must be equal to the expected structure containing the sum of the two input parameters. Note that we use the <code>map_mod</code> function to make sure to apply the modulo operation to the fields of the structure, as otherwise they could be arbitrary <code>Z</code> values. This is a way to express that we consider equality to be modulo <code>p</code>.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>No under-constraints</div><div class="admonitionContent_BuS1"><p>This specification states that there are no under-constraints in the <code>constrain</code> function. Indeed, the <code>self</code> parameter is only allowed to be equal to a single value <code>spec x y</code>. However, we do not show that the circuit is not over-constrained: we show that all solutions must be equal to <code>spec x y</code>, but there might be no solutions, and this statement would hold.</p><p>The no over-constraints property is generally considered less critical than the no under-constraints property, and easier to formally verify: it amounts to verifying that the expected output validates all the assertions of the circuit.</p></div></div>
<p>For the proof, we again apply the <code>Run.t</code> rules in a straightforward way:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Proof</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unfold Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">constrain</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  eapply Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Implies</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    eapply Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Let</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> global_add_eq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    intros </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    eapply Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Let</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AssertEqual</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    intros </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unfold spec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hauto lq</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> on</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Qed</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-conclusion">‚úíÔ∏è Conclusion<a href="https://formal.land/blog/2025/07/31/llzk-to-rocq-verification#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to ‚úíÔ∏è Conclusion" title="Direct link to ‚úíÔ∏è Conclusion">‚Äã</a></h2>
<p>We have seen how to formally specify and verify the safety of an LLZK circuit in Rocq. There are a few things that need to be improved now:</p>
<ul>
<li>Adding more automation to the proofs: as you can see, they are rather verbose, even if LLM auto-complete catches repetitive patterns.</li>
<li>Adding more support for the LLZK language, translating bigger examples (in the thousands of lines, the one above is 500 lines long). Indeed, other <code>.llzk</code> files use features that we do not support yet, like arrays whose size is dynamic with respect to a <code>for</code> loop counter. Our plan is to add dynamic typing rules capabilities in a refined version of our reasoning rules.</li>
</ul>
<blockquote>
<p>You want to secure your code? Contact us! ‚á® <a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a></p>
</blockquote>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions!</em></p></div></div>]]></content>
        <category label="LLZK" term="LLZK"/>
        <category label="formal verification" term="formal verification"/>
        <category label="zero-knowledge" term="zero-knowledge"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[ü•∑ Semantics for LLZK in Rocq]]></title>
        <id>https://formal.land/blog/2025/07/30/llzk-to-rocq-semantics</id>
        <link href="https://formal.land/blog/2025/07/30/llzk-to-rocq-semantics"/>
        <updated>2025-07-30T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[LLZK is a language designed to implement zero-knowledge circuits. We wrote a translation tool from this language to a representation in the formal language Rocq.]]></summary>
        <content type="html"><![CDATA[<p><a href="https://github.com/Veridise/llzk-lib" target="_blank" rel="noopener noreferrer">LLZK</a> is a language designed to implement <a href="https://en.wikipedia.org/wiki/Zero-knowledge_proof" target="_blank" rel="noopener noreferrer">zero-knowledge</a> circuits. We wrote a translation tool from this language to a representation in the formal language <a href="https://rocq-prover.org/" target="_blank" rel="noopener noreferrer">Rocq</a>.</p>
<p>In this blog post, we present how we give a semantics to all the primitive operations of LLZK in Rocq. The end-goal is to provide a way to formally verify that a zero-knowledge circuit is safe, that is to say, without under-constraints.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Follow-up</div><div class="admonitionContent_BuS1"><p>This blog post is a follow-up to:</p><ul>
<li><a href="https://formal.land/blog/2025/07/28/llzk-to-rocq-beginning">ü•∑ Beginning of a formal verification tool for LLZK</a></li>
</ul><p>The code we are referring to in this post is available in <a href="https://github.com/formal-land/garden/tree/main/Garden/LLZK" target="_blank" rel="noopener noreferrer">github.com/formal-land/garden/Garden/LLZK</a>.</p></div></div>
<figure><p><img decoding="async" loading="lazy" alt="Green forest" src="https://formal.land/assets/images/green_forest-f8954bcc184f52fe93fea331b1453bf2.png" width="1024" height="1024" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-data-types">ü™Ü Data types<a href="https://formal.land/blog/2025/07/30/llzk-to-rocq-semantics#-data-types" class="hash-link" aria-label="Direct link to ü™Ü Data types" title="Direct link to ü™Ü Data types">‚Äã</a></h2>
<p>Here are the main data types that we see appearing in LLZK code examples:</p>
<ul>
<li><code>Felt.t</code>, for integers modulo&nbsp;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span> a large prime number. We represent them with the type of unbounded integers <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="double-struck">Z</mi></mrow><annotation encoding="application/x-tex">\mathbb{Z}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6889em"></span><span class="mord mathbb">Z</span></span></span></span>, and explicitly compute the modulo on the result of each operation.</li>
<li><code>i1</code>, for boolean values. We represent them with the boolean type <code>bool</code> of Rocq.</li>
<li><code>Index.t</code> for length or indexes in arrays. We represent them with the type <code>nat</code> of Rocq (non-negative integers).</li>
<li><code>Array.t</code> for arrays, parametrized by a list of dimensions and a type of elements. We design a custom type for these.</li>
<li>Structures, defined in an LLZK module with a list of fields. We represent them with a record type in Rocq.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="feltt"><code>Felt.t</code><a href="https://formal.land/blog/2025/07/30/llzk-to-rocq-semantics#feltt" class="hash-link" aria-label="Direct link to feltt" title="Direct link to feltt">‚Äã</a></h3>
<p>We define the primitive arithmetic operations on <code>Felt.t</code> as pure functions in Rocq, parametrized by an implicit prime number <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span>. For example, for the binary operations we do:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BinOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> add </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x y </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> mod p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> sub </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x y </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> mod p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> mul </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x y </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> mod p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> div </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x y </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> mod p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> mod_ </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x y </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x mod y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> mod p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BinOp</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We do not check if the parameters are in the bounds <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mo>‚â§</mo><mi>n</mi><mo>&lt;</mo><mi>p</mi></mrow><annotation encoding="application/x-tex">0 \leq n &lt; p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7804em;vertical-align:-0.136em"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">‚â§</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span>, but we apply the modulo operation on the result of each function. This is a convention that we will try to use for the rest of the formalizations.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="arrayt"><code>Array.t</code><a href="https://formal.land/blog/2025/07/30/llzk-to-rocq-semantics#arrayt" class="hash-link" aria-label="Direct link to arrayt" title="Direct link to arrayt">‚Äã</a></h3>
<p>We represent arrays as a record wrapping a <code>get</code> function:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Record</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Ns </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list nat</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  get </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> MultiIndex</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Ns </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Arguments</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> clear implicits</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We use a function rather than a list, as in our experience, for many zero-knowledge circuits, there exists an expression relating the values in an array to their indices. A limitation is that we need to find a default value for out-of-bounds indexes. This is generally easy to find, as most data structures are built around the <code>Felt.t</code> type with zero as a default value.</p>
<p>Because arrays can be multi-dimensional, define a type for multi-dimensional indices instead of using a plain <code>nat</code>:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> MultiIndex</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Fixpoint</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ns </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list nat</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> Ns </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> nil </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> unit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ns </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> Index</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> t Ns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> MultiIndex</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>A multi-index is simply a tuple with as many integers as there are dimensions. We prefer to use an array with multi-indices instead of arrays of arrays, in order to have a representation following the choices of LLZK.</p>
<p>There is an <code>array.extract</code> operator in LLZK, to extract a sub-array from an array, which isgeneralized to the case of multidimensional arrays. We define it as:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> extract </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Ns Ms </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list nat</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">array </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t A </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ns </span><span class="token operator" style="color:#393A34">+</span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> Ms</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">indexes </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> MultiIndex</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Ns</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    t A Ms </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punct punctuation" style="color:#393A34">{|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    get indexes</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> array</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MultiIndex</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">concat indexes indexes</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It takes an array whose multi-dimension is a list of dimensions <code>Ns</code> followed by dimensions <code>Ms</code>. It returns a sub-array whose multi-dimension is <code>Ms</code>. It relies on an operator <code>MultiIndex.concat</code> to concatenate two multi-indexes of the right dimensions:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Fixpoint</span><span class="token plain"> concat </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Ns Ms </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list nat</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">indexes </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> MultiIndex</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Ns</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">indexes</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> MultiIndex</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Ms</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MultiIndex</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ns </span><span class="token operator" style="color:#393A34">+</span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> Ms</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> Ns</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> indexes </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> indexes</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ns</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> indexes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> concat indexes indexes</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="structures">Structures<a href="https://formal.land/blog/2025/07/30/llzk-to-rocq-semantics#structures" class="hash-link" aria-label="Direct link to Structures" title="Direct link to Structures">‚Äã</a></h3>
<p>We found that directly using the <code>Record</code> construct of Rocq to represent structures was enough. Here is how a typical structure is defined in LLZK:</p>
<div class="language-mlir codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-mlir codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct.def @MatrixConstrain {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct.field @check0 : !struct.type&lt;@ArrayConstrain&lt;[7, 11]&gt;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct.field @check1 : !struct.type&lt;@ArrayConstrain&lt;[13, 17]&gt;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is translated to a record type in Rocq:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> MatrixConstrain</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Record</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    check0 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ArrayConstrain</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    check1 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ArrayConstrain</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token number" style="color:#36acaa">13</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">17</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> MatrixConstrain</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-monad">üîÆ Monad<a href="https://formal.land/blog/2025/07/30/llzk-to-rocq-semantics#-monad" class="hash-link" aria-label="Direct link to üîÆ Monad" title="Direct link to üîÆ Monad">‚Äã</a></h2>
<p>While we try to represent as many operations as possible in the purely functional fragment of Rocq, since it simplifies formal reasoning, for some operations we must use a monad. The main monadic operation is the check of equality between two integers modulo <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span>. This is the main building block for circuits, to ensure that only valid witnesses are accepted.</p>
<p>We design our monad as a free-monad, in order to be able to define the reasoning rules independently:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Pure </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> AssertEqual </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x1 x2 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t unit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> AssertIn </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Ns </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list nat</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">array </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t A Ns</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t unit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> AssertBool </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t unit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CreateStruct </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> ArrayWrite </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Ns </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list nat</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">array </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t A Ns</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">indexes </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MultiIndex</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Ns</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      t unit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> FieldWrite </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">field </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t unit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Let</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A B </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t B</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t B</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The two standard monadic operators are:</p>
<ul>
<li><code>Pure</code> that we note <code>M.Pure</code>, and</li>
<li><code>Let</code> that we note <code>let* x := ... in ...</code>.</li>
</ul>
<p>We also define some primitives, in particular:</p>
<ul>
<li><code>AssertEqual</code> typically used to enforce the equality between two integers modulo <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span>.</li>
<li><code>AssertIn</code> to check that an element is in an array.</li>
<li><code>CreateStruct</code> to instantiate a value for a structure in a non-deterministic way. The structure is to be defined in subsequent write operations.</li>
<li><code>FieldWrite</code> to write a value in a field of a structure and force its definition.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-conclusion">‚úíÔ∏è Conclusion<a href="https://formal.land/blog/2025/07/30/llzk-to-rocq-semantics#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to ‚úíÔ∏è Conclusion" title="Direct link to ‚úíÔ∏è Conclusion">‚Äã</a></h2>
<p>We have seen how to define the main primitives for the LLZK language in Rocq. In the upcoming blog posts, we will show how to reason about LLZK circuits in Rocq, thanks to the introduction of reasoning rules for each monadic operation.</p>
<blockquote>
<p>You want to secure your code? Contact us! ‚á® <a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a></p>
</blockquote>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions!</em></p></div></div>]]></content>
        <category label="LLZK" term="LLZK"/>
        <category label="semantics" term="semantics"/>
        <category label="zero-knowledge" term="zero-knowledge"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[ü•∑ Beginning of a formal verification tool for LLZK]]></title>
        <id>https://formal.land/blog/2025/07/28/llzk-to-rocq-beginning</id>
        <link href="https://formal.land/blog/2025/07/28/llzk-to-rocq-beginning"/>
        <updated>2025-07-28T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Here we present the beginning of our work to develop a formal verification tool for LLZK from Veridise, a new language designed to implement zero-knowledge circuits. The zero-knowledge technology is how future versions of Ethereum are planned to be implemented.]]></summary>
        <content type="html"><![CDATA[<p>Here we present the beginning of our work to develop a formal verification tool for <a href="https://github.com/Veridise/llzk-lib" target="_blank" rel="noopener noreferrer">LLZK</a> from <a href="https://veridise.com/" target="_blank" rel="noopener noreferrer">Veridise</a>, a new language designed to implement zero-knowledge circuits. The zero-knowledge technology is how future versions of Ethereum are planned to be implemented.</p>
<p>As usual, our technique is to work by translation to the <a href="https://rocq-prover.org/" target="_blank" rel="noopener noreferrer">Rocq</a> formal verification language, using a representation as similar as possible to the source code to simplify reasoning. Then, we will be able to verify that:</p>
<ul>
<li>For any possible inputs, a circuit correctly computes a functional specification (no over-constraint).</li>
<li>There are no possible invalid witnesses that can be accepted by the circuit (no under-constraint).</li>
</ul>
<figure><p><img decoding="async" loading="lazy" alt="Green forest" src="https://formal.land/assets/images/green_forest-e9db66923a95f185ffea68ab417b3837.png" width="1024" height="1024" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-llzk-language">ü•∑ LLZK language<a href="https://formal.land/blog/2025/07/28/llzk-to-rocq-beginning#-llzk-language" class="hash-link" aria-label="Direct link to ü•∑ LLZK language" title="Direct link to ü•∑ LLZK language">‚Äã</a></h2>
<p>LLZK is a language made to define <a href="https://en.wikipedia.org/wiki/Zero-knowledge_proof" target="_blank" rel="noopener noreferrer">zero-knowledge</a> circuits, a cryptographic primitive that states that you know about the execution of a program without revealing any information about it. LLZK is defined as a dialect of <a href="https://mlir.llvm.org/" target="_blank" rel="noopener noreferrer">MLIR</a>, which is a general-purpose intermediate representation to build compilers, itself built on top of <a href="https://llvm.org/" target="_blank" rel="noopener noreferrer">LLVM</a>.</p>
<p>In MLIR, you have access to a set of <a href="https://github.com/llvm/llvm-project/tree/main/mlir/include/mlir/Dialect" target="_blank" rel="noopener noreferrer">pre-defined operations</a> that you can extend with new dialects. Each dialect is a set of types or primitive functions and notations that you can add. These are generally defined in C++ or using the custom language <code>.td</code> like in <a href="https://github.com/llvm/llvm-project/blob/main/mlir/include/mlir/Dialect/SCF/IR/SCFOps.td" target="_blank" rel="noopener noreferrer">Dialect/SCF/IR/SCFOps.td</a>. Here is an example of LLZK circuit:</p>
<div class="language-mlir codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-mlir codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">function.def @global_add(%a: !felt.type, %b: !felt.type) -&gt; !felt.type {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  %c = felt.add %a, %b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  function.return %c : !felt.type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">struct.def @Adder {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  struct.field @sum : !felt.type {llzk.pub}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  function.def @compute(%a: !felt.type, %b: !felt.type) -&gt; !struct.type&lt;@Adder&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    %self = struct.new : !struct.type&lt;@Adder&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    %sum = function.call @global_add(%a, %b) : (!felt.type, !felt.type) -&gt; (!felt.type)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct.writef %self[@sum] = %sum : !struct.type&lt;@Adder&gt;, !felt.type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function.return %self : !struct.type&lt;@Adder&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  function.def @constrain(%self: !struct.type&lt;@Adder&gt;, %a: !felt.type, %b: !felt.type) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    %sum = struct.readf %self[@sum] : !struct.type&lt;@Adder&gt;, !felt.type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    %c = function.call @global_add(%a, %b) : (!felt.type, !felt.type) -&gt; (!felt.type)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    constrain.eq %sum, %c : !felt.type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function.return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The code is rather verbose, with type annotations on every line, but this is built as an intermediate language to be used for analyses or compilation to zero-knowledge constraints. The two main functions are:</p>
<ul>
<li><code>compute</code> that computes a witness for the circuit, given the inputs.</li>
<li><code>constrain</code> that constrains the witness to the circuit specification.</li>
</ul>
<p>For the constraints, we have access to a special operator:</p>
<div class="language-mlir codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-mlir codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">constrain.eq %sum, %c : !felt.type</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It checks that two values are equal and aborts the execution if they are not. The security property we will need to show is that the witness computed by the <code>compute</code> function is the only possible parameter <code>self</code> for the function <code>constrain</code> in order to execute it without aborting. This will ensure that our circuit correctly and safely represents the <code>compute</code> function acting as a specification and a way to generate the zero-knowledge witness.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Note</div><div class="admonitionContent_BuS1"><p>Zero-knowledge circuits are ultimately compiled down to a set of equations on polynomials using integers modulo&nbsp;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span> a large prime number. This is why the main type appearing in the code is <code>!felt.type</code>, which is a type for integers modulo&nbsp;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span>. This differs from most programming languages, where the main type is computed modulo&nbsp;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>32</mn></msup></mrow><annotation encoding="application/x-tex">2^{32}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">32</span></span></span></span></span></span></span></span></span></span></span></span> or&nbsp;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>64</mn></msup></mrow><annotation encoding="application/x-tex">2^{64}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">64</span></span></span></span></span></span></span></span></span></span></span></span>.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-llzk-api">üîå LLZK API<a href="https://formal.land/blog/2025/07/28/llzk-to-rocq-beginning#-llzk-api" class="hash-link" aria-label="Direct link to üîå LLZK API" title="Direct link to üîå LLZK API">‚Äã</a></h2>
<p>To parse LLZK code, we wrote an MLIR pass as part of the LLZK code base that we extend in <a href="https://github.com/formal-land/llzk-lib/pull/1" target="_blank" rel="noopener noreferrer">this pull request</a>. All the code is in C++. This is, in our experience, the simplest way to connect to the MLIR infrastructure, after trying a few other alternatives. That way, you get access to all of MLIR facilities, as most of the project is written in C++.</p>
<p>We use the C++ primitives of MLIR to iterate over the whole syntax tree of a given LLZK file. Our translation works by directly pretty-printing the corresponding Rocq file on the standard output: we try not to do additional translation passes to keep the translation simple and predictable. Here is an example of the code where we parse and pretty-print the operations of LLZK (the functions that you can call on each line of the SSA form):</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> addFeltOp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">dyn_cast</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">AddFeltOp</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  llvm</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">outs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"BinOp.add "</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">printOperand</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">topLevelOperation</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> addFeltOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getLhs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  llvm</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">outs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">" "</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">printOperand</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">topLevelOperation</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> addFeltOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getRhs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> subFeltOp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">dyn_cast</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">SubFeltOp</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  llvm</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">outs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"BinOp.sub "</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">printOperand</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">topLevelOperation</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> subFeltOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getLhs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  llvm</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">outs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">" "</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">printOperand</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">topLevelOperation</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> subFeltOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getRhs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">auto</span><span class="token plain"> mulFeltOp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">dyn_cast</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">MulFeltOp</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">operation</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We use a dynamic cast to check the type of the operation and print the corresponding Rocq code. There, the operations are either addition or subtraction. The payload differs for each of the operations, with two operands <code>lhs</code> and <code>rhs</code> that we retrieve with the methods <code>getLhs</code> and <code>getRhs</code> in this case. These felt operations are defined in the <code>.td</code> file <a href="https://github.com/Veridise/llzk-lib/blob/main/include/llzk/Dialect/Felt/IR/Ops.td" target="_blank" rel="noopener noreferrer">llzk/Dialect/Felt/IR/Ops.td</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-rocq-output">üêì Rocq output<a href="https://formal.land/blog/2025/07/28/llzk-to-rocq-beginning#-rocq-output" class="hash-link" aria-label="Direct link to üêì Rocq output" title="Direct link to üêì Rocq output">‚Äã</a></h2>
<p>We obtain the following output in Rocq for the LLZK example above:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> global_add </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg_fun_0 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg_fun_1 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> var_0 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BinOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add arg_fun_0 arg_fun_1 </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pure var_0</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Record</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sum </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token attribute attr-name" style="color:#00a4db">Global</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Instance</span><span class="token plain"> IsMapMop </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">œÅ</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime œÅ</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> MapMod t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    map_mod Œ± </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punct punctuation" style="color:#393A34">{|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      sum </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> map_mod Œ±</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">sum</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> constrain </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg_fun_0 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg_fun_1 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg_fun_2 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t unit </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> var_0 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> arg_fun_0</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sum</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> var_1 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> global_add arg_fun_1 arg_fun_2 </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> unit </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AssertEqual var_0 var_1 </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pure tt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> compute </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Prime p</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg_fun_0 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg_fun_1 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> var_self </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CreateStruct </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> var_0 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Felt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> global_add arg_fun_0 arg_fun_1 </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> unit </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FieldWrite var_self</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Adder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sum</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> var_0 </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pure var_self</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This code should be fairly similar to the original LLZK code, with the addition of the <code>M.t</code> monad all the potential side effects. We add an implicit parameter&nbsp;<code>p</code> to all the functions for the prime number with which we are working for the modulo operation. The type-class instance <code>IsMapMop</code> is a helper that we generate to help with the proofs: it applies a modulo operation to all the integer fields of a data structure.</p>
<p>In the function <code>constrain</code>, we have one side effect: <code>M.AssertEqual</code> to check for the equality of <code>var_0</code> and <code>var_1</code>. In the function <code>compute</code>, we have two side effects: <code>M.CreateStruct</code> to create an arbitrary value of type <code>Adder.t</code> and <code>M.FieldWrite</code> to write the result of the addition to the <code>sum</code> field.</p>
<p>The function <code>global_add</code> is defined as effectful even if it is actually purely functional. This is because we do not make an effect analysis for simplicity, so we suppose by default that all the functions are effectful.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-conclusion">‚úíÔ∏è Conclusion<a href="https://formal.land/blog/2025/07/28/llzk-to-rocq-beginning#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to ‚úíÔ∏è Conclusion" title="Direct link to ‚úíÔ∏è Conclusion">‚Äã</a></h2>
<p>We have had an overview of how to parse an example of zero-knowledge circuits written in LLZK to pretty-print them in the formal verification language Rocq.</p>
<p>In the upcoming blog posts, we will show how to give a semantics to the Rocq translation in order to formally verify properties on this example.</p>
<blockquote>
<p>You want to secure your code? Contact us! ‚á® <a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a></p>
</blockquote>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions!</em></p></div></div>]]></content>
        <category label="LLZK" term="LLZK"/>
        <category label="translation" term="translation"/>
        <category label="zero-knowledge" term="zero-knowledge"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[ü¶Ä Functional specification of the ADD instruction of the EVM]]></title>
        <id>https://formal.land/blog/2025/07/06/functional-specification-add</id>
        <link href="https://formal.land/blog/2025/07/06/functional-specification-add"/>
        <updated>2025-07-06T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[In this blog post, we present how we specify and verify the implementation of the ADD instruction of the EVM virtual machine in Rust.]]></summary>
        <content type="html"><![CDATA[<p>In this blog post, we present how we specify and verify the implementation of the ADD instruction of the <a href="https://www.evm.codes/" target="_blank" rel="noopener noreferrer">EVM</a> virtual machine in Rust.</p>
<p>We give a functional specification, meaning that we show the implementation to be equivalent to an idealized version written in the Rocq language. As the Rust code for this instruction involves rather advanced features of Rust, the same techniques could apply to verify a large set of Rust programs.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Work with us!</div><div class="admonitionContent_BuS1"><p>With <strong>formal verification</strong>, you can <strong>guarantee</strong> that your code is safe, given the specifications, and you do not need to re-audit <strong>from scratch</strong> after each upgrade.</p><p><strong>Contact us</strong> at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">&nbsp;üíåcontact@formal.land</a> to discuss how to make sure your code is safe to deploy and upgrade!&nbsp;üõ°Ô∏è</p><p>We cover <strong>Rust</strong>, <strong>Solidity</strong>, and <strong>ZK systems</strong>.</p></div></div>
<figure><p><img decoding="async" loading="lazy" alt="Green forest" src="https://formal.land/assets/images/forest-b0db7e049b5c4a263771795501f99e8f.webp" width="1024" height="1024" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-target">üéØ Target<a href="https://formal.land/blog/2025/07/06/functional-specification-add#-target" class="hash-link" aria-label="Direct link to üéØ Target" title="Direct link to üéØ Target">‚Äã</a></h2>
<p>Here is the implementation of the ADD instruction in <a href="https://github.com/bluealloy/revm" target="_blank" rel="noopener noreferrer">Revm</a>, probably the most popular implementation of the EVM in Rust:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">add</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">WIRE</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">InterpreterTypes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">H</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Host</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token class-name">Sized</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    interpreter</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token class-name">Interpreter</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">WIRE</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token class-name">H</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property" style="color:#36acaa">gas!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">interpreter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">gas</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token constant" style="color:#36acaa">VERYLOW</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property" style="color:#36acaa">popn_top!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">op1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> op2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> interpreter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">op2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> op1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">wrapping_add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">op2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It takes the two topmost values of the stack, adds them, and stores the result on the top of the stack. It also computes how much gas is consumed. Some code is hidden in the macros <code>gas!</code> and <code>popn_top!</code>, as well as in the traits <code>InterpreterTypes</code> and <code>Host</code>, which contain all the methods needed to define the EVM instructions (stack and memory access, gas consumption, etc.).</p>
<p>Here is our functional specification of the ADD instruction in Rocq:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Output</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Success tt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> gas </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> ILoop</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Loop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gas</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">RefStub</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">projection</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> interpreter</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">control</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> Impl_Gas</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">record_cost gas constants</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VERYLOW </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> None </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> control </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ILoop</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Loop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_instruction_result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      interpreter</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">control</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      instruction_result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">InstructionResult</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OutOfGas </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    interpreter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">control </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> control </span><span class="token operator" style="color:#393A34">|</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Some gas </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> control </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> ILoop</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Loop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gas</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">RefStub</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">injection</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> interpreter</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">control</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> gas </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> stack </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> interpreter</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stack</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> stack</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> IStack</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Stack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">popn_top</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punct punctuation" style="color:#393A34">{|</span><span class="token plain"> Integer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> stack </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> result </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Some </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> top</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">'</span><span class="token punct punctuation" style="color:#393A34">{|</span><span class="token plain"> ArrayPair</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> x1 </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> arr</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> x2 </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> top</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">RefStub</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">projection</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> stack </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> stack </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> top</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">RefStub</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">injection</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> stack </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Impl_Uint</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">wrapping_add x1 x2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    interpreter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">control </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> control </span><span class="token operator" style="color:#393A34">|</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stack </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> stack </span><span class="token operator" style="color:#393A34">|</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> None </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> control </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ILoop</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Loop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_instruction_result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      control</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      instruction_result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">InstructionResult</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StackUnderflow </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    interpreter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">control </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> control </span><span class="token operator" style="color:#393A34">|</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stack </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> stack </span><span class="token operator" style="color:#393A34">|</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_host</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is a bit longer! But if you look precisely at the code, it is actually doing what the original Rust code was doing once you unroll the macros. It explicitly handles the error cases of:</p>
<ul>
<li>A gas level being too low, with the error <code>instruction_result.InstructionResult.OutOfGas</code>.</li>
<li>A stack underflow, with the error <code>instruction_result.InstructionResult.StackUnderflow</code>.</li>
</ul>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Note</div><div class="admonitionContent_BuS1"><p>At the first line, with <code>Output.Success tt</code>, we are saying that the function is always successful, that is to say, without possible panics, and so for any possible input. This safety property in itself is very important, and sometimes enough to consider a software safe to deploy.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-challenges">ü§î Challenges<a href="https://formal.land/blog/2025/07/06/functional-specification-add#-challenges" class="hash-link" aria-label="Direct link to ü§î Challenges" title="Direct link to ü§î Challenges">‚Äã</a></h2>
<p>One challenge in this code is that there are a lot of parameters through the use of traits. For example, the type of the stack is abstract, and it can only be manipulated through methods of the corresponding trait. You can look at the list of traits provided to the implementations of the instructions in the file <a href="https://github.com/formal-land/coq-of-rust/blob/main/CoqOfRust/revm/revm_interpreter/interpreter_types.rs" target="_blank" rel="noopener noreferrer">revm_interpreter/interpreter_types.rs</a>.</p>
<p>Here is an example for the stack:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">trait</span><span class="token plain"> </span><span class="token type-definition class-name">StackTrait</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">is_empty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">U256</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">push_b256</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">B256</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">popn</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token class-name">N</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usize</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">U256</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token class-name">N</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">popn_top</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">POPN</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usize</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">U256</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">POPN</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">U256</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">top</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">U256</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">pop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">U256</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">pop_address</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Address</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">exchange</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> n</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">dup</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> n</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We specify the functions of interest for us in <a href="https://github.com/formal-land/coq-of-rust/blob/main/CoqOfRust/revm/revm_interpreter/simulate/interpreter_types.v" target="_blank" rel="noopener noreferrer">revm_interpreter/simulate/interpreter_types.v</a> (the code is too long to copy here).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-technique">ü§ñ Technique<a href="https://formal.land/blog/2025/07/06/functional-specification-add#-technique" class="hash-link" aria-label="Direct link to ü§ñ Technique" title="Direct link to ü§ñ Technique">‚Äã</a></h2>
<p>We first use our tool <a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">coq-of-rust</a>, to translate the Rust code to Rocq. We then refine the translated code in two steps to obtain the functional specification:</p>
<ol>
<li>Adding type and trait information. This information is lost in our translation as they are hard to map in a very general way to equivalent Rocq code, but we retrieve it mostly automatically with the <code>run_symbolic</code> tactic that we designed. Only the handling of trait instances is somewhat manual, and we are working on automating it more.</li>
<li>Showing that the translated code is equivalent to the functional specification, using the predicate:<!-- -->
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> expression üå≤ functional_specification </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ol>
<p>With this predicate, we symbolically execute the typed version of the translated code, using a typed stack, and show the code to be equal in the mathematical sense to the functional specification. This statement holds for any possible input, and so we have shown that the implementation is correct according to our specification. All the semantic rules associated with our Rust monad are in the files:</p>
<ul>
<li><a href="https://github.com/formal-land/coq-of-rust/blob/main/CoqOfRust/M.v" target="_blank" rel="noopener noreferrer">M.v</a> for the definition of the monad.</li>
<li><a href="https://github.com/formal-land/coq-of-rust/blob/main/CoqOfRust/links/M.v" target="_blank" rel="noopener noreferrer">links/M.v</a> for the typing and trait instances rules.</li>
<li><a href="https://github.com/formal-land/coq-of-rust/blob/main/CoqOfRust/simulate/M.v" target="_blank" rel="noopener noreferrer">simulate/M.v</a> for the memory allocation rules and equality with the functional specification.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-conclusion">‚úíÔ∏è Conclusion<a href="https://formal.land/blog/2025/07/06/functional-specification-add#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to ‚úíÔ∏è Conclusion" title="Direct link to ‚úíÔ∏è Conclusion">‚Äã</a></h2>
<p>This shows that we can fully specify complex Rust code, using many dependencies and language features. There are still steps that we are continuing to automate more, like the functional specification on function calls.</p>
<p>If you have complex Rust code that you need to certify as bug-free (smart contracts, zkVMs, etc.), please contact us as it is now possible to do so at a reasonable cost.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions!</em></p></div></div>]]></content>
        <author>
            <name>Guillaume Claret</name>
            <uri>https://github.com/clarus</uri>
        </author>
        <category label="Rust" term="Rust"/>
        <category label="EVM" term="EVM"/>
        <category label="coq-of-rust" term="coq-of-rust"/>
        <category label="functional specification" term="functional specification"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[ü¶Ä Beginning of translation of OpenVM to Rocq]]></title>
        <id>https://formal.land/blog/2025/06/15/beginning-of-openvm-to-rocq</id>
        <link href="https://formal.land/blog/2025/06/15/beginning-of-openvm-to-rocq"/>
        <updated>2025-06-15T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Here, we present our beginning work of translating part of the OpenVM code to the proof assistant &nbsp;Rocq. The aim is to experiment around the formal verification of the zero-knowledge circuits of this zkVM based on the Plonky3 library. One of the aims of the zkVMs is to increase the scalability of the blockchains by packing many transactions in a single zk proof.]]></summary>
        <content type="html"><![CDATA[<p>Here, we present our beginning work of translating part of the <a href="https://openvm.dev/" target="_blank" rel="noopener noreferrer">OpenVM</a> code to the proof assistant <a href="https://rocq-prover.org/" target="_blank" rel="noopener noreferrer"><img src="https://raw.githubusercontent.com/coq/rocq-prover.org/refs/heads/main/rocq-id/logos/SVG/icon-rocq-orange.svg" height="18px">&nbsp;Rocq</a>. The aim is to experiment around the formal verification of the zero-knowledge circuits of this zkVM based on the <a href="https://github.com/Plonky3/Plonky3" target="_blank" rel="noopener noreferrer">Plonky3</a> library. One of the aims of the zkVMs is to increase the scalability of the blockchains by packing many transactions in a single zk proof.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Work with us!</div><div class="admonitionContent_BuS1"><p>With <strong>formal verification</strong> you can <strong>guarantee</strong> that your code is safe, given the specifications.</p><p><strong>Contact us</strong> at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">&nbsp;üíåcontact@formal.land</a> to discuss how to apply formal verification to your code!&nbsp;üõ°Ô∏è</p><p>We cover <strong>Rust</strong>, <strong>Solidity</strong>, and <strong>ZK systems</strong>.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-target">üéØ Target<a href="https://formal.land/blog/2025/06/15/beginning-of-openvm-to-rocq#-target" class="hash-link" aria-label="Direct link to üéØ Target" title="Direct link to üéØ Target">‚Äã</a></h2>
<p>Our goal is to formally verify that the circuit of the component <a href="https://github.com/openvm-org/openvm/blob/main/extensions/rv32im/circuit/src/branch_eq/core.rs" target="_blank" rel="noopener noreferrer">BranchEq</a> of OpenVM is not underconstrained. This is one of the main security properties to look for in a circuit. This means that it is not possible to provide a proof of execution with a behavior different from what is expected.</p>
<p>A circuit is a set of equality assertions between values in a prime field using only addition or multiplication. Said otherwise, they are a set of equations on polynomials. The OpenVM project uses the Plonky3 library to define these. It adds a wrapper on top of Plonky3 with APIs to define custom instructions. An implementation for the RISC-V instruction set is provided but it could be anything, and it is easily extensible. This is convenient for example to provide optimized circuits for hashing primitives.</p>
<p>We will attempt to directly translate the Rust code describing the circuit to Rocq. There are a lot of challenge in this translation, as the Rust language contains a lot of hidden complexities, but it has the promise to be easy to maintain as we get a circuit description that closely matches its implementation.</p>
<p>The source links are:</p>
<ul>
<li><a href="https://github.com/openvm-org/openvm/blob/main/extensions/rv32im/circuit/src/branch_eq/core.rs" target="_blank" rel="noopener noreferrer">github.com/openvm-org/openvm/blob/main/extensions/rv32im/circuit/src/branch_eq/core.rs</a></li>
<li><a href="https://github.com/openvm-org/openvm/blob/main/extensions/rv32im/circuit/src/README.md" target="_blank" rel="noopener noreferrer">github.com/openvm-org/openvm/blob/main/extensions/rv32im/circuit/src/README.md</a></li>
</ul>
<p>The main datatype on which the circuit computes is:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">BranchEqualCoreCols</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NUM_LIMBS</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usize</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NUM_LIMBS</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NUM_LIMBS</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Boolean result of a op b. Should branch if and only if cmp_result = 1.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> cmp_result</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> imm</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> opcode_beq_flag</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> opcode_bne_flag</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> diff_inv_marker</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NUM_LIMBS</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>where you can consider&nbsp;<code>T</code> as being the type of a prime field. The Rust function to generate the equations is:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">impl</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">I</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NUM_LIMBS</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usize</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token class-name">VmCoreAir</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">I</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token class-name">BranchEqualCoreAir</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">NUM_LIMBS</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">InteractionBuilder</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">I</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">VmAdapterInterface</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Expr</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">I</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Reads</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">From</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Expr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NUM_LIMBS</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">I</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Writes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Default</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">I</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">ProcessedInstruction</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">From</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">ImmInstruction</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Expr</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">eval</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        builder</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        local</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Var</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        from_pc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Var</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">AdapterAirContext</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Expr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">I</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> cols</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token class-name">BranchEqualCoreCols</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NUM_LIMBS</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> local</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">borrow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> flags </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">opcode_beq_flag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">opcode_bne_flag</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> is_valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">iter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fold</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Expr</span><span class="token punctuation" style="color:#393A34">::</span><span class="token constant" style="color:#36acaa">ZERO</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token closure-params">acc</span><span class="token closure-params punctuation" style="color:#393A34">,</span><span class="token closure-params"> </span><span class="token closure-params operator" style="color:#393A34">&amp;</span><span class="token closure-params">flag</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            builder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">assert_bool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">flag</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            acc </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> flag</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">into</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        builder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">assert_bool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">is_valid</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        builder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">assert_bool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cmp_result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> a </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> b </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> inv_marker </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">diff_inv_marker</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> cmp_eq </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cmp_result </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">opcode_beq_flag </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">not</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cmp_result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">opcode_bne_flag</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> sum </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cmp_eq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">..</span><span class="token constant" style="color:#36acaa">NUM_LIMBS</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> inv_marker</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            builder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">assert_zero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cmp_eq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        builder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">when</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">is_valid</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">assert_one</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sum</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> expected_opcode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">iter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">zip</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">BranchEqualOpcode</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">iter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">fold</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Expr</span><span class="token punctuation" style="color:#393A34">::</span><span class="token constant" style="color:#36acaa">ZERO</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token closure-params">acc</span><span class="token closure-params punctuation" style="color:#393A34">,</span><span class="token closure-params"> </span><span class="token closure-params punctuation" style="color:#393A34">(</span><span class="token closure-params">flag</span><span class="token closure-params punctuation" style="color:#393A34">,</span><span class="token closure-params"> opcode</span><span class="token closure-params punctuation" style="color:#393A34">)</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                acc </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">flag</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">into</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Expr</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">from_canonical_u8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">opcode </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Expr</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">from_canonical_usize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">offset</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> to_pc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> from_pc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cmp_result </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">imm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">not</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cmp_result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">AB</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Expr</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">from_canonical_u32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pc_step</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">AdapterAirContext</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            to_pc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Some</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">to_pc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            reads</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Into</span><span class="token punctuation" style="color:#393A34">::</span><span class="token plain">into</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Into</span><span class="token punctuation" style="color:#393A34">::</span><span class="token plain">into</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">into</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            writes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Default</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">default</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            instruction</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">ImmInstruction</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                is_valid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                opcode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> expected_opcode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                immediate</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cols</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">imm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">into</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">into</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>An interesting part of this code is that it returns polynomial expressions to be used later, in addition to generating equations.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-why-is-rust-code-complex">‚ùì Why is Rust code complex?<a href="https://formal.land/blog/2025/06/15/beginning-of-openvm-to-rocq#-why-is-rust-code-complex" class="hash-link" aria-label="Direct link to ‚ùì Why is Rust code complex?" title="Direct link to ‚ùì Why is Rust code complex?">‚Äã</a></h2>
<p>Although the code of the function is relatively short (around 50 lines), it contains a lot of implicit function calls. This mainly comes from the fact that it is parametrized by many traits, as you can see in the signature of the function. To know exactly which function is being called, you need to unroll a lot of the definitions.</p>
<p>This applies to all the definitions handling field elements, like <code>AB::Expr</code>, as well as iterators, with calls to the <code>zip</code> and <code>fold</code> functions for example. We are exposed to this complexity when formally verifying the code above, and this is one of the reasons Rust is a complex language to formally verify, although it is very elegant with a lot of abstractions.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-what-is-the-plan">üîç What is the plan?<a href="https://formal.land/blog/2025/06/15/beginning-of-openvm-to-rocq#-what-is-the-plan" class="hash-link" aria-label="Direct link to üîç What is the plan?" title="Direct link to üîç What is the plan?">‚Äã</a></h2>
<p>Our plan is as follows:</p>
<ol>
<li>Translate the Rust code to Rocq using <a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">coq-of-rust</a> (this part is automatically done).</li>
<li>Express all the data types using native Rocq types and resolving the trait hierarchies (phase that we call <strong>linking</strong>).</li>
<li>Define an API for Plonky3 as a free monad in Rocq, with all the primitive operations like creating an expression, building a constraint, etc.</li>
<li>Show that the translated Rust code can be expressed in an equivalent way using this Plonky3 monad. Alternatively we could pretty-print the constraints at this point and compare them between the Rust and Rocq versions, if showing the equivalence is too hard.</li>
<li>Formally verify that the circuits are not underconstrained.</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-linking">üîó Linking<a href="https://formal.land/blog/2025/06/15/beginning-of-openvm-to-rocq#-linking" class="hash-link" aria-label="Direct link to üîó Linking" title="Direct link to üîó Linking">‚Äã</a></h2>
<p>We are focusing on producing a typed-version for the <code>eval</code> function above, with an explicit trait hierarchy. Indeed <code>coq-of-rust</code> produces definitions that are untyped (all values have the type <code>Value.t</code>) and the relation between identifiers and function definitions or trait instances is defined by equations.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="trait-hierarchy">Trait hierarchy<a href="https://formal.land/blog/2025/06/15/beginning-of-openvm-to-rocq#trait-hierarchy" class="hash-link" aria-label="Direct link to Trait hierarchy" title="Direct link to Trait hierarchy">‚Äã</a></h3>
<p>In the file <a href="https://github.com/formal-land/coq-of-rust/blob/e91da9613fee8c2ba6b12f60d6a979935ed1d811/CoqOfRust/plonky3/commit_539bbc84/field/links/field.v" target="_blank" rel="noopener noreferrer">CoqOfRust/plonky3/commit_539bbc84/field/links/field.v</a> we define the trait hierarchy corresponding to the Plonky3 definitions for fields in <a href="https://github.com/Plonky3/Plonky3/blob/539bbc84085efb609f4f62cb03cf49588388abdb/field/src/field.rs" target="_blank" rel="noopener noreferrer">field/src/field.rs</a>. One thing we had to do was to break the mutual dependency between the traits <code>FieldAlgebra</code> and <code>Field</code>:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">trait</span><span class="token plain"> </span><span class="token type-definition class-name">FieldAlgebra</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token type-definition class-name">F</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Field</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">trait</span><span class="token plain"> </span><span class="token type-definition class-name">Field</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">FieldAlgebra</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">F</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Self</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>by defining on the Rocq side:</p>
<ol>
<li>A trait <code>FieldAlgebraWithoutField</code> that is like <code>FieldAlgebra</code> but without the <code>Field</code> trait constraint on the associated type <code>F</code>.</li>
<li>A trait <code>Field</code> depending on <code>FieldAlgebraWithoutField</code>. Note that here, we do not need to add the <code>Field</code> constraint on <code>F</code> to be equivalent to the Rust code, as it is the <code>Self</code> type of <code>Field</code>, so it necessarily implements the <code>Field</code> trait.</li>
<li>A trait <code>FieldAlgebra</code> taking the trait <code>FieldAlgebraWithoutField</code> and adding the <code>Field</code> trait constraint on the associated type <code>F</code>.</li>
</ol>
<p>On the Rocq side, we are free to organize our trait definitions as we want as long as they correspond to the trait equations generated by <code>coq-of-rust</code>. If we do not build our trait hierarchy properly, we will be stuck when defining the typed version of the functions' bodies.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="eval-body">Eval body<a href="https://formal.land/blog/2025/06/15/beginning-of-openvm-to-rocq#eval-body" class="hash-link" aria-label="Direct link to Eval body" title="Direct link to Eval body">‚Äã</a></h3>
<p>For now, the typed version of the <code>eval</code> function is defined as follows:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Instance</span><span class="token plain"> run_eval</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">AB I </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">NUM_LIMBS </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Usize</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Link AB</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Link I</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">AirBuilder_types </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AirBuilder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AssociatedTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">AirBuilder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AssociatedTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AreLinks AirBuilder_types</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">VmAdapterInterface_types </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> VmAdapterInterface</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AssociatedTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">VmAdapterInterface</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AssociatedTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AreLinks VmAdapterInterface_types</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">run_InteractionBuilder_for_AB </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> InteractionBuilder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Run AB AirBuilder_types</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">run_VmAdapterInterface_for_I </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        VmAdapterInterface</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          I</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          AirBuilder_types</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">AirBuilder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AssociatedTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Expr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          VmAdapterInterface_types</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ref</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Pointer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Kind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ref </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Self NUM_LIMBS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">builder </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ref</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Pointer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Kind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MutRef AB</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">local </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Ref</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Pointer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Kind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ref </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">list AirBuilder_types</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">AirBuilder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AssociatedTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Var</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">from_pc </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AirBuilder_types</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">AirBuilder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AssociatedTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Var</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">eval </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">œÜ NUM_LIMBS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Œ¶ AB</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Œ¶ I</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">œÜ self</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> œÜ builder</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> œÜ local</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> œÜ from_pc</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      unit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Proof</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    constructor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    destruct run_InteractionBuilder_for_AB</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    destruct run_AirBuilder_for_Self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    destruct run_VmAdapterInterface_for_I</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    destruct </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Impl_Borrow_BranchEqualCoreCols_for_slice_T</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      AirBuilder_types</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">AirBuilder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AssociatedTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Var</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      NUM_LIMBS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    destruct run_FieldAlgebra_for_Expr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    destruct run_FieldAlgebra_for_Self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    destruct run_Clone_for_Self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pose proof </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Impl_Into_for_From_T</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Impl_From_for_T</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run AirBuilder_types</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">AirBuilder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AssociatedTypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Expr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    destruct run_Add_for_Self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    destruct run_Mul_for_Self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    destruct run_Add_Expr_for_Var</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    destruct run_Mul_Var_for_Var</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    destruct run_Mul_Var_for_Expr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    run_symbolic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Admitted</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We generate the typed definition automatically with the tactic <code>run_symbolic</code>, based on the code translated by <code>coq-of-rust</code> and knowing there should only be one possible typed definition corresponding to each untyped one.</p>
<p>A difficulty that is not solved yet is that we need to provide in context all the trait instances which will be used. This is the series of <code>destruct</code> at the beginning of the proof. Unfortunately, a lot of them are needed and it is sometimes hard to find them, especially for those that require specific parameters which we need to make explicit.</p>
<p>There are also a few closures used in this code, for which the handling is not automated enough yet.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-naming-the-versions">üè∑Ô∏è Naming the versions<a href="https://formal.land/blog/2025/06/15/beginning-of-openvm-to-rocq#%EF%B8%8F-naming-the-versions" class="hash-link" aria-label="Direct link to üè∑Ô∏è Naming the versions" title="Direct link to üè∑Ô∏è Naming the versions">‚Äã</a></h2>
<p>For now, we put all the Rocq translation of Rust code in a folder <a href="https://github.com/formal-land/coq-of-rust/tree/main/CoqOfRust" target="_blank" rel="noopener noreferrer">CoqOfRust/</a>. To avoid collisions between different versions of the same library, we started using a sub-folder for each crate with the name of the version in use. For example, the Plonky3 translation is now put in the folder <code>CoqOfRust/plonky3/commit_539bbc84</code> as this is the precise version used by the OpenVM code we are looking at.</p>
<p>In the long run, it will also be useful to make backward compatibility proofs, where we show that a newer version of a crate behaves the same as an older one on all the common endpoints. The only downside of this naming scheme is that it makes the paths longer in the <code>Require</code> commands.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-conclusion">‚úíÔ∏è Conclusion<a href="https://formal.land/blog/2025/06/15/beginning-of-openvm-to-rocq#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to ‚úíÔ∏è Conclusion" title="Direct link to ‚úíÔ∏è Conclusion">‚Äã</a></h2>
<p>We have not succeeded yet in extracting a typed Rocq version of the <code>BranchEq</code> module of OpenVM. We will work next on adding more automation to <code>coq-of-rust</code> to make the linking phase easier.</p>
<p>In parallel, we are working on a hand-written version of the <code>BranchEq</code> module in Rocq, to start verifying the circuits, which we will show equivalent to the translated version once the linking phase is automated.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions!</em></p></div></div>]]></content>
        <author>
            <name>Guillaume Claret</name>
            <uri>https://github.com/clarus</uri>
        </author>
        <category label="Rust" term="Rust"/>
        <category label="OpenVM" term="OpenVM"/>
        <category label="coq-of-rust" term="coq-of-rust"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[ü¶Ä Typing and naming of Rust code in Rocq (2/3)]]></title>
        <id>https://formal.land/blog/2025/02/05/links-for-rust-in-rocq-2</id>
        <link href="https://formal.land/blog/2025/02/05/links-for-rust-in-rocq-2"/>
        <updated>2025-02-05T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[In this blog post we present how represent a proof of execution for translated ü¶Ä&nbsp;Rust programs in &nbsp;Rocq/Coq, to show that it is possible to type the values and resolve the names. Resolving the names amounts to finding the trait instances and an ordering for the function definitions.]]></summary>
        <content type="html"><![CDATA[<p>In this blog post we present how represent a proof of execution for translated <a href="https://www.rust-lang.org/" target="_blank" rel="noopener noreferrer">ü¶Ä&nbsp;Rust</a> programs in <a href="https://rocq-prover.org/" target="_blank" rel="noopener noreferrer"><img src="https://raw.githubusercontent.com/coq/rocq-prover.org/refs/heads/main/rocq-id/logos/SVG/icon-rocq-orange.svg" height="18px">&nbsp;Rocq/Coq</a>, to show that it is possible to type the values and resolve the names. Resolving the names amounts to finding the trait instances and an ordering for the function definitions.</p>
<p>We call these proofs of execution "links". They do not contain memory allocation strategies, which can be defined later in a second step called "simulation". From these links we have all the information to extract a typed execution that is equivalent to the translated code from <a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">coq-of-rust</a>. The core of the work presented in this article is in the file <a href="https://github.com/formal-land/coq-of-rust/blob/main/CoqOfRust/links/M.v" target="_blank" rel="noopener noreferrer">CoqOfRust/links/M.v</a> on GitHub.</p>
<p>This is the continuation of the following article:</p>
<ul>
<li><a href="https://formal.land/blog/2025/01/30/links-for-rust-in-rocq">ü¶Ä Typing and naming of Rust code in Rocq (1/3)</a></li>
</ul>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Ask for the highest security!</div><div class="admonitionContent_BuS1"><p>When millions are at stake, bug bounties are not enough. How do you ensure your security audits are exhaustive?</p><p>The best way is to use <strong>formal verification</strong>.</p><p><strong>Contact us</strong> at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">&nbsp;üíåcontact@formal.land</a> to make sure your code is safe!&nbsp;üõ°Ô∏è</p><p>We cover <strong>Rust</strong>, <strong>Solidity</strong>, and <strong>ZK systems</strong>.</p></div></div>
<figure><p><img decoding="async" loading="lazy" alt="Green forest" src="https://formal.land/assets/images/green-forest-a051f559898a800a1ed19191d4c1372f.webp" width="1024" height="1024" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-untyped-code">ü™® Untyped code<a href="https://formal.land/blog/2025/02/05/links-for-rust-in-rocq-2#-untyped-code" class="hash-link" aria-label="Direct link to ü™® Untyped code" title="Direct link to ü™® Untyped code">‚Äã</a></h2>
<p>Representing Rust programs as typed code in Rocq in a systematic way is challenging. Indeed, even if the two systems share many similarities (enum types, polymorphism, traits, ...) there are obstacles that prevent most Rust programs from being well-typed once represented in Rocq:</p>
<ul>
<li>There are lifetime annotations in Rust that are not present in Rocq. We can ignore them without too much loss on the typing side.</li>
<li>The trait/type inference mechanism in Rocq fails in rare cases where it succeeds in Rust. These rare cases are enough to make almost all Rust programs untypable in Rocq. A solution is to add type annotations on all sub-expressions, but this is very verbose and we still encountered some examples where it did not work!</li>
<li>The type definitions might not be correctly ordered, with mutual dependencies between files or between traits and types. This is probably the biggest issue, as mutually recursive types cannot be defined in Rocq in a general way or can make the reasoning about code too complex when they can.</li>
</ul>
<p>For all the reasons above, we chose to instead translate the Rust code in Rocq collapsing all the types to a single type <code>Value.t</code>:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Bool </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bool </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Integer </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kind </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">z </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Float </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> UnicodeChar </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">String</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Tuple </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Array </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> StructRecord </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> list </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">string </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> StructTuple </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> list t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Pointer </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Pointer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Closure </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">@</span><span class="token plain"> list Value </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Error </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> DeclaredButUndefined</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We represent enums and structs using the <code>StructRecord</code> or <code>StructTuple</code> constructors, depending on when the fields are named or ordered. The first string parameter is the absolute name of the type or the name of the type concatenated to the name of the constructor for enums. Note that in Rust there is always a unique absolute name for all type/value definitions.</p>
<p>For example, if we have the type <code>Foo</code> in Rust:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">Foo</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    a</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">i32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    b</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>we would represent a value:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> foo </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Foo</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">42</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>as:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StructRecord </span><span class="token string" style="color:#e3116c">"Foo"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"a"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">I32 </span><span class="token number" style="color:#36acaa">42</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"b"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Bool true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In our experience, the named fields always appear in the same order.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-typed-version">üóø Typed version<a href="https://formal.land/blog/2025/02/05/links-for-rust-in-rocq-2#-typed-version" class="hash-link" aria-label="Direct link to üóø Typed version" title="Direct link to üóø Typed version">‚Äã</a></h2>
<p>We let the user define a typed version of the code according to its need. Most of the time, the definitions will be straightforward, following the definitions in Rust. It will still be the opportunity to order the definitions in their order of dependencies, and break some mutual dependencies with custom definitions.</p>
<p>To relate typed values of some type <code>A</code> with their representation in <code>Value.t</code>, we use a conversion function from <code>A</code> to <code>Value.t</code> that should ideally be an injection. To help in the proofs and debugging, there should be at most one type and value of this type for each value in <code>Value.t</code>. We also add for each type <code>A</code> a serialized version of this type in <code>Ty.t</code> which may be used on the Rust side to know in a unique way which trait instance to use.</p>
<p>Here is the Rocq type-class we use to represent the conversion:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Class</span><span class="token plain"> Link </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Œ¶ </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  œÜ </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It gives, for a user-defined type <code>A</code> in Rocq, a way to represent this type in <code>Ty.t</code> on the Rust side, and a way to convert values of this type to <code>Value.t</code>. We use the Greek letters <code>Œ¶</code> and <code>œÜ</code> to shorten the definitions. Here is the definition of the <code>Link</code> instance for the boolean type:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Bool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token attribute attr-name" style="color:#00a4db">Global</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Instance</span><span class="token plain"> IsLink </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Link bool </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Œ¶ </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path </span><span class="token string" style="color:#e3116c">"bool"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    œÜ b </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Bool b</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Most of the definitions follow the same pattern. Note that we avoid defining a <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>œÜ</mi><mrow><mo>‚àí</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">œÜ^{-1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0085em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">œÜ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">‚àí</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span> function that would be impossible or hard to define in general and not needed. In our proofs of equivalence between the untyped translated Rust code and the typed version, we will attempt to show the commutativity of the following diagram:</p>
<figure><p><img decoding="async" loading="lazy" alt="Commutative diagram" src="https://formal.land/assets/images/commutative-diagram-bbb4c911ed7560df3ed98090561652e4.png" width="453" height="303" class="img_ev3q"></p></figure>
<p>where:</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span></span></span></span> is the function from the translated Rust code,</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>f</mi><mo>~</mo></mover></mrow><annotation encoding="application/x-tex">\tilde{f}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1257em;vertical-align:-0.1944em"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9313em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span></span><span style="top:-3.6134em"><span class="pstrut" style="height:3em"></span><span class="accent-body" style="left:-0.0833em"><span class="mord">~</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em"><span></span></span></span></span></span></span></span></span> is its typed version that we define,</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>œÜ</mi><mi>A</mi></msub></mrow><annotation encoding="application/x-tex">œÜ_A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">œÜ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>œÜ</mi><mi>B</mi></msub></mrow><annotation encoding="application/x-tex">œÜ_B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">œÜ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em">B</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> are the conversion functions for the types <code>A</code> and <code>B</code> respectively.</li>
</ul>
<p>The commutativity of the diagram mean that all the paths are the same, that is to say that:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">‚àÄ</mi><mo stretchy="false">(</mo><mi>x</mi><mo>:</mo><mi>A</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace width="1em"></mspace><mi>f</mi><mo stretchy="false">(</mo><msub><mi>œÜ</mi><mi>A</mi></msub><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi>œÜ</mi><mi>B</mi></msub><mo stretchy="false">(</mo><mover accent="true"><mi>f</mi><mo>~</mo></mover><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\forall (x : A),\quad f (œÜ_A x) = œÜ_B (\tilde{f} x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">‚àÄ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">A</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em"></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">œÜ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.1813em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal">œÜ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em">B</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9313em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span></span><span style="top:-3.6134em"><span class="pstrut" style="height:3em"></span><span class="accent-body" style="left:-0.0833em"><span class="mord">~</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em"><span></span></span></span></span></span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-proof-of-execution">üîÆ Proof of execution<a href="https://formal.land/blog/2025/02/05/links-for-rust-in-rocq-2#-proof-of-execution" class="hash-link" aria-label="Direct link to üîÆ Proof of execution" title="Direct link to üîÆ Proof of execution">‚Äã</a></h2>
<p>To both define the typed <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>f</mi><mo>~</mo></mover></mrow><annotation encoding="application/x-tex">\tilde{f}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1257em;vertical-align:-0.1944em"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9313em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span></span><span style="top:-3.6134em"><span class="pstrut" style="height:3em"></span><span class="accent-body" style="left:-0.0833em"><span class="mord">~</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em"><span></span></span></span></span></span></span></span></span> version of the Rust code and to prove the commutativity of the diagram, we will define a tree that follows that the tree-like structure of the monad for the translated code.</p>
<p>Here are its basic combinators for the "return" and the "bind" of the monad:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Output </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Link Output</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Pure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">output </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Output</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Output</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">output</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> Exception</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  output</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Output</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_value output </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pure output</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> üîΩ Output </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Let</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Output</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ty </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">to_value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Output</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> Exception</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Build_Link </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> ty to_value </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> e üîΩ Output</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">forall</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value_inter </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Output</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Output</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> k </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Output</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_value value_inter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> üîΩ Output </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Let</span><span class="token plain"> e k üîΩ Output </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It reads as follows:</p>
<ul>
<li><strong>Pure</strong> If we have some <code>output'</code> value of type <code>Value.t</code> some <code>output</code> of type <code>A</code> that are related through the <code>Link</code> instance, then we can build a tree saying that the monadic untyped term <code>LowM.pure output'</code> executes to some value of type <code>Output</code> using the conversion from the <code>Link</code> instance. We wrap the conversion in the <code>Output.t</code> type to also represent exceptions, which are special error values that we propagate, for example, in case of <code>panic!</code> or premature <code>return</code> in a function.</li>
<li><strong>Let</strong> If an expression <code>e</code> can be reduced to a value of type <code>Output'</code> and if, for any value of type <code>Output'</code>, using the same link instance, we can execute <code>k</code> of this value to some value of type <code>Output</code>, then we can execute the monadic term <code>LowM.let e k</code> to some value of type <code>Output</code>.</li>
</ul>
<p>Note that in most of the expressions above the <code>Link</code> instance is implicit but still uniquely inferred by Rocq as there is only one for the types <code>Output</code> and <code>Output'</code> at a time.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-pointers">üé£ Pointers<a href="https://formal.land/blog/2025/02/05/links-for-rust-in-rocq-2#-pointers" class="hash-link" aria-label="Direct link to üé£ Pointers" title="Direct link to üé£ Pointers">‚Äã</a></h2>
<p>One difficulty is maintaining the consistency of the <code>œÜ</code> function that we use, especially for pointer operations (allocate, read, and write). Indeed, if one allocates a pointer to a boolean with the function:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>œÜ</mi><mtext>bool</mtext></msub><mo>:</mo><mtext>bool</mtext><mo>‚Üí</mo><mtext>Value.t</mtext><mspace linebreak="newline"></mspace><msub><mi>œÜ</mi><mtext>bool</mtext></msub><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>Value.Bool</mtext><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\varphi_{\text{bool}} : \text{bool} \to \text{Value.t}\\
\varphi_{\text{bool}}(b) = \text{Value.Bool}(b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">œÜ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">bool</span></span></span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord text"><span class="mord">bool</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">‚Üí</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord text"><span class="mord">Value.t</span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal">œÜ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">bool</span></span></span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord text"><span class="mord">Value.Bool</span></span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span>
<p>and reads it with the function:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mi>œÜ</mi><mtext>bool</mtext><mo mathvariant="normal" lspace="0em" rspace="0em">‚Ä≤</mo></msubsup><mo>:</mo><mtext>bool</mtext><mo>‚Üí</mo><mtext>Value.t</mtext><mspace linebreak="newline"></mspace><msubsup><mi>œÜ</mi><mtext>bool</mtext><mo mathvariant="normal" lspace="0em" rspace="0em">‚Ä≤</mo></msubsup><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>Value.Bool</mtext><mo stretchy="false">(</mo><mtext>not</mtext><mo stretchy="false">(</mo><mtext>b</mtext><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\varphi'_{\text{bool}} : \text{bool} \to \text{Value.t}\\
\varphi'_{\text{bool}}(b) = \text{Value.Bool}(\text{not}(\text{b}))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0489em;vertical-align:-0.247em"></span><span class="mord"><span class="mord mathnormal">œÜ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8019em"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">bool</span></span></span></span></span><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">‚Ä≤</span></span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord text"><span class="mord">bool</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">‚Üí</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord text"><span class="mord">Value.t</span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1.0519em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal">œÜ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8019em"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">bool</span></span></span></span></span><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">‚Ä≤</span></span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord text"><span class="mord">Value.Bool</span></span><span class="mopen">(</span><span class="mord text"><span class="mord">not</span></span><span class="mopen">(</span><span class="mord text"><span class="mord">b</span></span><span class="mclose">))</span></span></span></span></span>
<p>the value that is read will be different from the value that was allocated.</p>
<p>In order to maintain the consistency of the pointer operations, we attach an extra function <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>œÜ</mi><mi>A</mi></msub></mrow><annotation encoding="application/x-tex">\varphi_A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">œÜ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> to pointers that we allocated in the untyped translation and make sure that this function, acting as a meta-data at the level of the untyped code, is properly forwarded to all subsequent use. That way, we make sure we always use the same <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>œÜ</mi></mrow><annotation encoding="application/x-tex">\varphi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">œÜ</span></span></span></span> function when allocating, reading, or writing a pointer.</p>
<p>Here is the rule to define a proof of execution for the allocation of a pointer:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CallPrimitiveStateAlloc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">of_value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> OfValue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t value</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">forall</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ref</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Pointer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Kind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Raw </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">OfValue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_Set of_value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> k </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">œÜ ref</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> üîΩ Output </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallPrimitive </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Primitive</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StateAlloc value</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> k üîΩ Output </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We have the <code>Ref.t</code> type on the side of the typed version to represent the Rust pointers. We reason for any possible references that could be allocated for the untyped value <code>value'</code>. We use the <code>OfValue.t</code> type to represent a combination of a type&nbsp;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal">A</span></span></span></span> and a certain function&nbsp;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>œÜ</mi><mi>A</mi></msub></mrow><annotation encoding="application/x-tex">\varphi_A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">œÜ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> with the property that:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">‚àÉ</mi><mo stretchy="false">(</mo><mi>x</mi><mo>:</mo><mi>A</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace width="1em"></mspace><msub><mi>œÜ</mi><mi>A</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>value‚Äô</mtext></mrow><annotation encoding="application/x-tex">\exists (x : A),\quad \varphi_A(x) = \text{value'}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">‚àÉ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">A</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em"></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal">œÜ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord text"><span class="mord">value‚Äô</span></span></span></span></span></span>
<p>For more details, you can look at the file <a href="https://github.com/formal-land/coq-of-rust/blob/main/CoqOfRust/links/M.v" target="_blank" rel="noopener noreferrer">CoqOfRust/links/M.v</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-extracting-an-execution">üíß Extracting an execution<a href="https://formal.land/blog/2025/02/05/links-for-rust-in-rocq-2#-extracting-an-execution" class="hash-link" aria-label="Direct link to üíß Extracting an execution" title="Direct link to üíß Extracting an execution">‚Äã</a></h2>
<p>The Rocq relation above:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> e üîΩ Output </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>is defined in <code>Set</code> instead of <code>Prop</code>. This means that it contains data in addition to stating the property that there exists an execution of with a certain type. We can then define a Rocq function <code>evaluate</code> that is total and builds this execution. Here is its signature:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Fixpoint</span><span class="token plain"> evaluate </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Output </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Link Output</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">e </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">run </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> e üîΩ Output </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Output</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Output</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here <code>LowM.t</code> is the type version of the untyped <code>LowM.t</code> monad from above. We define this function by induction on the proof of execution <code>run</code>. We write this definition using the proof mode of Rocq as it is more convenient for this definition. Here is, for example, the definition for the allocation case (better read using the interactive mode of Rocq):</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">(* Alloc *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallPrimitive </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Primitive</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StateAlloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">OfValue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_value of_value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  intros ref_core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  eapply evaluate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">(* here is the recursive call *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> goal </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> H </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">forall</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|-</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">H </span><span class="token punct punctuation" style="color:#393A34">{|</span><span class="token plain"> Ref</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">core </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> ref_core </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Having access to the typed execution will be useful for the next phase, in which we will define the memory allocation strategies.</p>
<p>With the method we use, we do not need to define the execution explicitly: we derive it automatically from its equivalence proof with the untyped code, thus saving us time. In addition, as proofs can be generated semi-automatically in Rocq, we also hope to automate a lot of our definitions and have more robust scripts for when the source code changes.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-conclusion">‚úíÔ∏è Conclusion<a href="https://formal.land/blog/2025/02/05/links-for-rust-in-rocq-2#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to ‚úíÔ∏è Conclusion" title="Direct link to ‚úíÔ∏è Conclusion">‚Äã</a></h2>
<p>We have seen how to define a proof of execution using equivalent typed values for the untyped translated code from <code>coq-of-rust</code>, and extract a runnable typed code from it. In the next article we will see how to do the same for the resolution of names: to find the trait instances and the order of the function definitions.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions or requests!</em></p></div></div>]]></content>
        <category label="Rust" term="Rust"/>
        <category label="links" term="links"/>
        <category label="simulations" term="simulations"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[ü¶Ä Typing and naming of Rust code in Rocq (1/3)]]></title>
        <id>https://formal.land/blog/2025/01/30/links-for-rust-in-rocq</id>
        <link href="https://formal.land/blog/2025/01/30/links-for-rust-in-rocq"/>
        <updated>2025-01-30T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[In this article we show how we re-build the type and naming information of ü¶Ä&nbsp;Rust code in &nbsp;Rocq/Coq, the formal verification system we use. A challenge is to be able to represent arbitrary Rust programs, including the standard library of Rust and the whole of Revm, a virtual machine to run EVM programs.]]></summary>
        <content type="html"><![CDATA[<p>In this article we show how we re-build the type and naming information of <a href="https://www.rust-lang.org/" target="_blank" rel="noopener noreferrer">ü¶Ä&nbsp;Rust</a> code in <a href="https://rocq-prover.org/" target="_blank" rel="noopener noreferrer"><img src="https://raw.githubusercontent.com/coq/rocq-prover.org/refs/heads/main/rocq-id/logos/SVG/icon-rocq-orange.svg" height="18px">&nbsp;Rocq/Coq</a>, the formal verification system we use. A challenge is to be able to represent arbitrary Rust programs, including the standard library of Rust and the whole of <a href="https://github.com/bluealloy/revm" target="_blank" rel="noopener noreferrer">Revm</a>, a virtual machine to run <a href="https://en.wikipedia.org/wiki/Ethereum#Virtual_machine" target="_blank" rel="noopener noreferrer">EVM</a> programs.</p>
<p>This is the continuation of the following article:</p>
<ul>
<li><a href="https://formal.land/blog/2024/04/26/translation-core-alloc-crates">ü¶Ä Translation of the Rust's core and alloc crates</a></li>
</ul>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Ask for the highest security!</div><div class="admonitionContent_BuS1"><p>When millions are at stake, bug bounties are not enough. How do you ensure your security audits are exhaustive?</p><p>The best way is to use <strong>formal verification</strong>.</p><p><strong>Contact us</strong> at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">&nbsp;üíåcontact@formal.land</a> to make sure your code is safe!&nbsp;üõ°Ô∏è</p><p>We cover <strong>Rust</strong>, <strong>Solidity</strong>, and <strong>ZK systems</strong>.</p></div></div>
<figure><p><img decoding="async" loading="lazy" alt="Green forest" src="https://formal.land/assets/images/green-forest-00d5ecf11d8ae6a919d6f5e8ce6aeb7e.webp" width="1024" height="1024" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-the-challenge">üéØ The challenge<a href="https://formal.land/blog/2025/01/30/links-for-rust-in-rocq#-the-challenge" class="hash-link" aria-label="Direct link to üéØ The challenge" title="Direct link to üéØ The challenge">‚Äã</a></h2>
<p>Our goal is to be able to formally verify large Rust codebases, counting thousands of lines, and without having to modify the code to make it more amenable to formal verification. Our concrete example is the verification of the Revm that includes about 10,000 lines of Rust code, depending on how far we include the dependencies.</p>
<p>This requires to have a methodology of verification that both:</p>
<ul>
<li>Scales with the size of the codebase. Rust programs often use a lot of abstractions, and we make the choice to keep these abstractions in the formal model. Combined with the expressivity of the Rocq prover, we hope this will ensure we can scale our reasoning.</li>
<li>Supports most of the Rust language, noting that Rust is a complex and feature-rich language.</li>
</ul>
<p>To make sure our translation from the Rust language to the Rocq system has good support, we generate a translation that is very verbose and rather low-level without interpreting the meaning of the various Rust primitives too much. For example, our translation tool is only about 5,000 lines long. It is written in Rust and uses the APIs of the <code>rustc</code> compiler.</p>
<p>This approach leaves the burdens of defining the semantics of Rust and designing the reasoning primitives on the Rocq side.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-strategy">üõù Strategy<a href="https://formal.land/blog/2025/01/30/links-for-rust-in-rocq#-strategy" class="hash-link" aria-label="Direct link to üõù Strategy" title="Direct link to üõù Strategy">‚Äã</a></h2>
<p>We plan to reason on the translated Rust code with two intermediate steps:</p>
<ol>
<li><strong>Links</strong> These represent a complete rewriting of the translated code, adding type and naming information that are erased during the translation to Rocq. We also prove that this rewriting is equivalent to the initial translation. We hope to automate this step as much as possible.</li>
<li><strong>Simulations</strong> In this step we make the less obvious transformations, in particular representing the memory mutations in a clean and custom state monad, as well as various optimizations such as collapsing all the integer types if it helps for the proofs later. We also prove that this rewriting is equivalent to the links.</li>
</ol>
<p>At the end of the <strong>Simulations</strong> step, we should obtain a purely functional and idiomatic representation of the original Rust code in Rocq. This representation should be easier to reason about, and we will be able to formally verify properties of the code.</p>
<p>As a summary, here are the steps we want to follow:</p>
<figure class="text--center"><p><img decoding="async" loading="lazy" alt="Compilation steps" src="https://formal.land/assets/images/compilation-steps-28e6722120c86d9e17aa05e4d38f1515.svg" width="214" height="696" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-example">üß™ Example<a href="https://formal.land/blog/2025/01/30/links-for-rust-in-rocq#-example" class="hash-link" aria-label="Direct link to üß™ Example" title="Direct link to üß™ Example">‚Äã</a></h2>
<p>Here is an example from the standard library of Rust, which is used to define other comparison operators:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">max_by</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">F</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">FnOnce</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Ordering</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v2</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> compare</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">F</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">compare</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">v2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Ordering</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Less</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token class-name">Ordering</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Equal</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> v2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Ordering</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Greater</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> v1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This example is interesting as it uses some abstractions, with polymorphism, traits, closures, and a bit of pointer manipulations. Ideally, we should be able to represent it with a Rocq code of a similar size, without the explicit references&nbsp;<code>&amp;</code> that are mostly useless in a purely functional setting. But here is the Rocq code we obtain after running&nbsp;<a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">coq-of-rust</a>:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> max_by </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Œµ </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">œÑ </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Œ± </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> Œµ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> œÑ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Œ± </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> T</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> F </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> v1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> v2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> compare </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">monadic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> v1 </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> v1 </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> v2 </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> v2 </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> compare </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> compare </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">match_operator </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">call_closure </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_trait_method </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">"core::ops::function::FnOnce"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                F</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tuple </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path </span><span class="token string" style="color:#e3116c">"&amp;"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> T </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path </span><span class="token string" style="color:#e3116c">"&amp;"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> T </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">"call_once"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> compare </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tuple</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">borrow </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      Pointer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Kind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ref</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">deref </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">borrow </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Pointer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Kind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ref</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v1 </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">borrow </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      Pointer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Kind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ref</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">deref </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">borrow </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Pointer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Kind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ref</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v2 </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> Œ≥ </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">monadic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find_or_pattern </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  Œ≥</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> Œ≥ </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">monadic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_struct_tuple </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Œ≥</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"core::cmp::Ordering::Less"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tuple </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> Œ≥ </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">monadic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_struct_tuple </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Œ≥</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"core::cmp::Ordering::Equal"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tuple </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> Œ≥ </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">monadic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> Œ≥ </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">monadic v2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">impossible </span><span class="token string" style="color:#e3116c">"wrong number of arguments"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> Œ≥ </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">monadic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_struct_tuple </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Œ≥</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"core::cmp::Ordering::Greater"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                v1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">impossible </span><span class="token string" style="color:#e3116c">"wrong number of arguments"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is extremely verbose and not idiomatic for Rocq! We can see some of the Rust features that are made explicit:</p>
<ul>
<li>The list of constant generics <code>Œµ</code>, the list of type generics <code>œÑ</code>, and the list of arguments <code>Œ±</code>.</li>
<li>The memory operations <code>alloc</code> and <code>read</code>, and the pointers manipulations <code>borrow</code> and <code>deref</code>.</li>
<li>The trait instance resolution with <code>M.get_trait_method</code>.</li>
<li>The decomposition of the pattern matching in more elementary operations like <code>M.is_struct_tuple</code>.</li>
</ul>
<p>Most of this information comes from the <a href="https://rustc-dev-guide.rust-lang.org/thir.html" target="_blank" rel="noopener noreferrer">THIR intermediate representation</a> of the code as provided by the Rust compiler.</p>
<p>Here is the link definition we will write, proven equivalent to the code above by construction:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> run_max_by </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">T F </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Link T</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Link F</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Run_FnOnce_for_F </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      function</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FnOnce</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        F</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ref</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Pointer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Kind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ref T </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Ref</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Pointer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Kind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ref T</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Output </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Ordering</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v1 v2 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> T</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">compare </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> F</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> cmp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">max_by </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> Œ¶ T</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> Œ¶ F </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> œÜ v1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> œÜ v2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> œÜ compare </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> üîΩ T </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Proof</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  destruct Run_FnOnce_for_F </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">call_once </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">H_call_once run_call_once</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  run_symbolic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  eapply Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallPrimitiveGetTraitMethod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> H_call_once</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  run_symbolic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  eapply Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallClosure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">run_call_once compare </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ref</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">immediate </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> v1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Ref</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">immediate </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> v2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  intros </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ordering </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> cbn</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">run_symbolic</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  destruct ordering</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> run_symbolic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Defined</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The beginning of the definition corresponds to the trait resolution and calls to the <code>compare</code> function. The last part with <code>destruct ordering</code> is the representation of the <code>match</code> statement in the Rust code. With this definition, we add explicit Rocq types instead of the universal <code>Value.t</code> type of the translated code and make explicit the trait resolution. The trait instance has to be provided as an explicit parameter with the <code>Run_FnOnce_for_F</code> argument.</p>
<p>With the statement:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> cmp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">max_by </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> Œ¶ T</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> Œ¶ F </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> œÜ v1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> œÜ v2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> œÜ compare </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> üîΩ T </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>we say that the translated function <code>cmp.max_by</code> has a "link" definition, built implicitly in the proof, returning a value of type <code>T</code>. We can extract the definition of this function calling the primitive:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">evaluate </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">forall</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Output </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Link Output</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">e </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> e üîΩ Output </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Output</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Output</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It returns a "link" computation in the <code>LowM.t</code> monad. The output is often unreadable as it is, but we can step through it by symbolic execution. This will be useful for the next step to define and prove equivalent the "simulations".</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-links-monad">üîÆ Link's monad<a href="https://formal.land/blog/2025/01/30/links-for-rust-in-rocq#-links-monad" class="hash-link" aria-label="Direct link to üîÆ Link's monad" title="Direct link to üîÆ Link's monad">‚Äã</a></h2>
<p>Like the monad used for the translation of Rust programs by <code>coq-of-rust</code>, the link's monad is a free monad but with fewer primitive operations. The primitive operations are only related to the memory handling:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> StateAlloc </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Link A</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ref</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> StateRead </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Link A</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref_core </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ref</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> StateWrite </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Link A</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref_core </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ref</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t unit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> GetSubPointer </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A Sub_A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Link A</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Link Sub_A</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref_core </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ref</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">runner </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SubPointer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Runner</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t A Sub_A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ref</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Sub_A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Compared to the side effects in the generated translation, we eliminate all the operations related to name handling (trait resolution, function calls, etc.). We also always use explicit types instead of the universal <code>Value.t</code> type and get rid of the <code>M.impossible</code> operation that was necessary to represent impossible branches in the absence of types.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-conclusion">‚úíÔ∏è Conclusion<a href="https://formal.land/blog/2025/01/30/links-for-rust-in-rocq#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to ‚úíÔ∏è Conclusion" title="Direct link to ‚úíÔ∏è Conclusion">‚Äã</a></h2>
<p>We have presented our general strategy to formally verify large Rust codebases. In the next blog posts, we will go into more details to look at the definition of the proof of equivalence for the links, and at how we automate the most repetitive parts of the proofs.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions or requests!</em></p></div></div>]]></content>
        <category label="Rust" term="Rust"/>
        <category label="links" term="links"/>
        <category label="simulations" term="simulations"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[ü§ñ Designing a coding assistant for Rocq]]></title>
        <id>https://formal.land/blog/2025/01/21/designing-a-coding-assistant-for-rocq</id>
        <link href="https://formal.land/blog/2025/01/21/designing-a-coding-assistant-for-rocq"/>
        <updated>2025-01-21T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[This blog post provides a review of the existing literature on agent-based systems for automated theorem proving, while presenting a general approach to the problem. Additionally, it serves as an informal specification outlining the requirements for a future system we intend to develop.]]></summary>
        <content type="html"><![CDATA[<p>This blog post provides a review of the existing literature on agent-based systems for automated theorem proving, while presenting a general approach to the problem. Additionally, it serves as an informal specification outlining the requirements for a future system we intend to develop.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Ask for the highest security!</div><div class="admonitionContent_BuS1"><p>To ensure your code is fully secure today, contact us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">&nbsp;üíåcontact@formal.land</a>!&nbsp;üöÄ</p><p>We exclusively focus on formal verification to offer you the highest degree of security for your application.</p><p>We cover <strong>Rust</strong>, <strong>Solidity</strong>, and <strong>zero-knowledge</strong> projects.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-our-goal">üéØ Our goal<a href="https://formal.land/blog/2025/01/21/designing-a-coding-assistant-for-rocq#-our-goal" class="hash-link" aria-label="Direct link to üéØ Our goal" title="Direct link to üéØ Our goal">‚Äã</a></h2>
<p>We aim to develop an integrated coding assistant for the proof assistant <a href="https://rocq-prover.org/" target="_blank" rel="noopener noreferrer"><img src="https://raw.githubusercontent.com/coq/rocq-prover.org/refs/heads/main/rocq-id/logos/SVG/icon-rocq-orange.svg" height="18px">&nbsp;Rocq/Coq</a> within <a href="https://code.visualstudio.com/" target="_blank" rel="noopener noreferrer">Visual Studio Code</a>. Despite recent advancements in artificial intelligence, the challenge of creating systems that effectively assist users in writing formal verification code remains unresolved. Our primary focus is on providing support for theorem proving, which we consider the most compelling aspect of the task; other functionalities, such as definition writing, may be explored in future work.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-automated-theorem-proving-as-a-search-in-a-state-space">üå≥ Automated theorem proving as a search in a state space<a href="https://formal.land/blog/2025/01/21/designing-a-coding-assistant-for-rocq#-automated-theorem-proving-as-a-search-in-a-state-space" class="hash-link" aria-label="Direct link to üå≥ Automated theorem proving as a search in a state space" title="Direct link to üå≥ Automated theorem proving as a search in a state space">‚Äã</a></h2>
<p>A coding assistant for a proof assistant can take advantage of a fundamental property that is not possessed by traditional programming languages: it is always possible to deterministically verify whether the code generated for a demonstration is correct (or simply, not incorrect). It only requires the code to be well-typed. More broadly, the assistant can track the progress of the solution.
A proof can be seen as a sequence of tactics, each of which modifies the current goal. Consequently, the proof construction process can be framed as a search through a state space. Using classical terminology for such problems, we can categorize the components of our system as follows:</p>
<ul>
<li><strong>state</strong>: enriched representation of the current goal</li>
<li><strong>starting state</strong>: initial goal associated with the theorem (its definition)</li>
<li><strong>arrival state</strong>: closed goal</li>
<li><strong>actions</strong>: tactics</li>
</ul>
<div class="text--center"><figure><p><img decoding="async" loading="lazy" alt="Tree search simple" src="https://formal.land/assets/images/tree_search_simple-5e8ad122ea65ccba44a6566afd2c80c5.svg" width="553" height="350" class="img_ev3q"></p></figure></div>
<p>Certain states can be pruned if they do not meet some conditions, such as error states, those where with certainty no progress has been made (e.g., the <a href="https://github.com/trishullab/copra" target="_blank" rel="noopener noreferrer">copra</a> system proposes a simple symbolic approach to recognize some trivial cases) or if too many attempts have already been made at a certain node.</p>
<p>The set of tactics that can be applied in a given state is potentially infinite. To guide the search, one or more oracles are queried, which provide suggestions on applicable tactics. These oracles can be either LLM-based agents or traditional symbolic procedures (e.g., <a href="https://coqhammer.github.io/" target="_blank" rel="noopener noreferrer">CoqHammer</a>). Multiple oracles may coexist, offering alternative solutions. Two examples of LLM-based oracles are:</p>
<ul>
<li>oracle that produces a list of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal" style="margin-right:0.03148em">k</span></span></span></span> possible alternative tactics to be applied at a given goal;</li>
<li>oracle that produces a complete demonstration for a given goal.</li>
</ul>
<p>It is not obvious whether a procedure that proceeds in depth or one that proceeds in breadth is preferable. As is often the case with research problems, a "hybrid" approach might be preferable. In any case, one could imagine ordering the frontier on the basis of how promising a certain state is, thereby guiding the search process. The problem of determining whether one state is more promising than another through heuristics (a kind of "distance" from the successful state) is certainly interesting and would merit future study.</p>
<p>One can imagine two procedures, one in breadth and one in depth. From the union of the two, a hybrid solution could be devised.</p>
<div class="text--center"><figure><p><img decoding="async" loading="lazy" alt="Depth search" src="https://formal.land/assets/images/depth_tree_search-170da44a3a6f6cd52bf1ec8a7ad9a997.svg" width="894" height="329" class="img_ev3q">
</p><figcaption>Depth search</figcaption><p></p></figure></div>
<div class="text--center"><figure><p><img decoding="async" loading="lazy" alt="Breadth search" src="https://formal.land/assets/images/breadth_tree_search-d2afb8d55c7415d5b2d8e81bb5e86d6a.svg" width="932" height="457" class="img_ev3q">
</p><figcaption>Breadth search by beam search: in this specific case, a heuristic is employed to limit the number of expanded nodes</figcaption><p></p></figure></div>
<p>The system should be flexible enough and allow for the implementation of different versions of the search algorithm that could be refined as the work progresses.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="learning-from-errors">Learning from errors<a href="https://formal.land/blog/2025/01/21/designing-a-coding-assistant-for-rocq#learning-from-errors" class="hash-link" aria-label="Direct link to Learning from errors" title="Direct link to Learning from errors">‚Äã</a></h3>
<p>By leveraging the ability of an LLM to generate an infinite number of tactics and possibly update the prompt to refine the query, errors can be exploited to generate new tactics. For example, a node (state) might not be closed as soon as it is expanded, but it could be re-expanded in the future, enriched with the knowledge of past errors.</p>
<div class="text--center"><figure><p><img decoding="async" loading="lazy" alt="Tree errors" src="https://formal.land/assets/images/tree_errors-f170535941e783f1b8035dcd3f2f22f6.svg" width="379" height="205" class="img_ev3q"></p></figure></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-integration-with-the-user">üë®üèª‚Äçüíª Integration with the user<a href="https://formal.land/blog/2025/01/21/designing-a-coding-assistant-for-rocq#-integration-with-the-user" class="hash-link" aria-label="Direct link to üë®üèª‚Äçüíª Integration with the user" title="Direct link to üë®üèª‚Äçüíª Integration with the user">‚Äã</a></h2>
<p>The system must integrate forms of communication and interaction with the user, which guide the user's construction of the proof. In this context, the coding assistant is not envisioned as a fully automated proof tool, but rather as a coding companion that leverages the support of the human developer. For instance, such a companion system does not necessarily need to complete the proof, but could instead generate partial solutions, offering the user multiple incomplete options and allowing them to select the one they deem most appropriate as a starting point.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-the-technology-stack">üîß The technology stack<a href="https://formal.land/blog/2025/01/21/designing-a-coding-assistant-for-rocq#-the-technology-stack" class="hash-link" aria-label="Direct link to üîß The technology stack" title="Direct link to üîß The technology stack">‚Äã</a></h2>
<p>The system is designed to be distributed as a Visual Studio Code extension. This approach offers several advantages, including access to the editor's extensive ecosystem of APIs, which facilitates seamless integration into standard development workflows and user interactions. Additionally, it simplifies the publishing and installation processes.</p>
<div class="text--center"><figure><p><img decoding="async" loading="lazy" alt="Tech stack" src="https://formal.land/assets/images/tech_stack-d5d9848eaba1e69b8b41c093f174c807.svg" width="811" height="607" class="img_ev3q"></p></figure></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="large-language-models">Large language models<a href="https://formal.land/blog/2025/01/21/designing-a-coding-assistant-for-rocq#large-language-models" class="hash-link" aria-label="Direct link to Large language models" title="Direct link to Large language models">‚Äã</a></h3>
<p>Models and ad-hoc architectures for theorem proving have been proposed in the literature, including <a href="https://github.com/lean-dojo/ReProver" target="_blank" rel="noopener noreferrer">ReProver</a> (for <a href="https://lean-lang.org/" target="_blank" rel="noopener noreferrer">Lean</a>). The cost of maintaining and the complexity of configuring and adapting these systems is generally high. More simply, commercial versions of the most common LLMs (GPTs, , ...) can be used, leveraging prompt-engineering techniques. Several papers demonstrate that comparable results to state-of-the-art models can be achieved using such approaches.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-vscode-api-ecosystem">The VSCode API ecosystem<a href="https://formal.land/blog/2025/01/21/designing-a-coding-assistant-for-rocq#the-vscode-api-ecosystem" class="hash-link" aria-label="Direct link to The VSCode API ecosystem" title="Direct link to The VSCode API ecosystem">‚Äã</a></h3>
<p>VSCode offers a rich ecosystem of APIs that can be used to integrate your extension with common development processes, simplify user interaction, and communicate with external tools. In particular, the new <a href="https://code.visualstudio.com/api/extension-guides/language-model" target="_blank" rel="noopener noreferrer">Language Model API</a> is particularly useful for our purposes. It offers a common interface as well as tools to simplify communication with popular LLMs. Through the use of <a href="https://github.com/microsoft/vscode/blob/main/src/vscode-dts/vscode.proposed.chatProvider.d.ts" target="_blank" rel="noopener noreferrer">Proposed API</a>, it is also possible to integrate local models, which are useful mainly in the testing phase of the first iterations. VSCode's <a href="https://code.visualstudio.com/api/references/vscode-api#languages" target="_blank" rel="noopener noreferrer">Language API</a> simplifies the development and integration of an LSP client.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="language-server">Language server<a href="https://formal.land/blog/2025/01/21/designing-a-coding-assistant-for-rocq#language-server" class="hash-link" aria-label="Direct link to Language server" title="Direct link to Language server">‚Äã</a></h3>
<p>Language analysis capabilities are provided by the language server <a href="https://github.com/ejgallego/coq-lsp" target="_blank" rel="noopener noreferrer">Coq-LSP</a>, which has recently been released as part of the <a href="https://github.com/ejgallego/coq-lsp/tree/main/petanque" target="_blank" rel="noopener noreferrer">P√©tanque</a> project, a lightweight environment for intensive applications targeted at automated theorem-proving projects and especially at agent-based systems. P√©tanque operates as a <a href="https://gymnasium.farama.org/index.html" target="_blank" rel="noopener noreferrer">Gymnasium</a> environment and has already been successfully used in the <a href="https://github.com/LLM4Coq/nlir" target="_blank" rel="noopener noreferrer">NLIR</a> system.
At the architectural level, Coq-LSP (and P√©tanque) operates as a server towards the coding assistant (the client), providing some functionality in the form of an API via an extended version of the <a href="https://microsoft.github.io/language-server-protocol/" target="_blank" rel="noopener noreferrer">LSP</a> protocol, including:</p>
<ul>
<li>obtaining the current goal for a given theorem,</li>
<li>obtaining the location of a given theorem's definition,</li>
</ul>
<p>and many other functionalities commonly accessible through IDEs.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-the-agent-perspective">üß† The agent perspective<a href="https://formal.land/blog/2025/01/21/designing-a-coding-assistant-for-rocq#-the-agent-perspective" class="hash-link" aria-label="Direct link to üß† The agent perspective" title="Direct link to üß† The agent perspective">‚Äã</a></h2>
<p>An alternative description of the system can be accomplished from the agent's perspective. We understand an <em>agent</em> as a software system whose behavior is conditioned by an environment that it can actively alter by performing some actions whose effects condition subsequent observations and, consequently, its future choices.</p>
<div class="text--center"><figure><p><img decoding="async" loading="lazy" alt="Agent RL" src="data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgdmlld0JveD0iMCAwIDMzMi40NDc4MDY3NjA3NDc5IDE1Ny45MTY0NTY5NDAxMTcxIiB3aWR0aD0iMzMyLjQ0NzgwNjc2MDc0NzkiIGhlaWdodD0iMTU3LjkxNjQ1Njk0MDExNzEiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9IndoaXRlIi8+PCEtLSBzdmctc291cmNlOmV4Y2FsaWRyYXcgLS0+PG1ldGFkYXRhPjwvbWV0YWRhdGE+PGRlZnM+PHN0eWxlIGNsYXNzPSJzdHlsZS1mb250cyI+CiAgICAgIEBmb250LWZhY2UgeyBmb250LWZhbWlseTogRXhjYWxpZm9udDsgc3JjOiB1cmwoZGF0YTpmb250L3dvZmYyO2Jhc2U2NCxkMDlHTWdBQkFBQUFBQXZRQUE0QUFBQUFFK2dBQUF0OUFBRUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBR2hZYmd4Z2NOQVpnQUh3UkNBcWJHSlFQQ3lRQUFUWUNKQU5FQkNBRmd4Z0hJQnRLRDZPaWhMUml5UDZaa0ExWjZCc3VHRzJNa3JZaDJyaUx1czhaTFBncDN2S1NvU1ArdEo5OURORTZoUnlvTW85VVB0R1RWSjUvZjNmZS9aUnVYWWttRkYweEV5aEprSXZhNlg4QS8vN3p1ZGtITGZ6ZnpReVJGWXQrRTBOT0tpMnZ1bnM5NmU1Qk96UFlKbXNRV2JMN2plU0wyY0EweGZuUDM2djZYN2FPaVdNTFpvdEhhS3lUbTlIYUd2UkRIV09ETGJFNWFWRWJ5Zzl0ajVXZ0xFV3ZFUFFJYnlQdTBvU2ZXYmtBQXNCaDBJMUJTSUozcXdCWWZFVWpwamtoQXl5MjNyWUdzRGphS3V2QjRpcnRhQUlMQkFDNE41YWNlMXNUTUVEQWlJQUJzZDJZbDdRSjBGalVCZUtCa1Z2QmIyV0JvWkdMbnJJcC8wRWJrdVN1MjRFWVM5Z1A3K2NSSmd5T1FLSzlVUTR1d1p3V0FTaFloRWdpWTRGbWV4bll1WUFTd0tPQmFRQ1BZSDRCQWFLc0hMMG1Xbi8rM213NFNLMUx6QnRKUnMxdVlVbW1KZ2RBdkhVU3RQTDNHWVFpcjJvWFF4S1lRS1dyZFgwV1VwdFVYUU5ZbFltZWVraXgzZ3dEcmtIeUppUXFDVFhkTW9KSWFSUVZuV1RsS2xXcjFheERWNy9pU2RKU1ZhTzJuMnJFNUlURWtrVUw1alVGL0JCd1F6L0FrSkJtOXB4OEduRURjaVR2SmZZMllWaEFZa3lNWS90THFBYi9HYTF0QTJWbFJ3M29oWkh6eC9Kak93Ny9ldXB2QzlHTmlDNmhSb0ZLS0dRem9XUWhDVDk4Q1BCSFlJbXRUY1lMdnNuaDEyL2ZMamJtVUZ4UjdGNU94Zk11V0pobkFwSHRpQkFDQ1FaNE44T25BbWw2OFR6KzNiN1R3YXAwRkdWYTFNWDVEUFFad0VSckl3ekNPaTBZaHNPTEltMkpyWEVuUStkQXlmbkNCOFY1YzBkMmR1eUFkWDFXd0NHaWowR21ZbllYQUpidnlIS0g4MHFldHdid1hzNmJ3VVBwTlZOREJ1enFZT0VPdHp1MjB1RXkxNGdITUVqWURINzVFdUFFL1dGbGVtWndmcW5vRjBva0xiMUxOWE5GR0RGVnhsU21kN0RObFBqQmx4ZEZQcldhN1IxSzFuN2NGY0x3YnU0aHdDNTJJWm4wSHZWcVBTM002cFQ2MUc4b2MvekpQa2Q1SXRzYWlRaUFFU1FhU2VFS2hCaURjQ2ZOOFJGQ3ZzNllibGMrSEhveDNwaWJ6U2MrOXRkM04vUitlNmxuV1B0eEkrRFRqdU1vam15UHpySWMwK0pkYjJUN3pDQWQ4VzUwcTB6bjA4SHpjbHV5em1NTU1URUovS253MVZvcnNZWW9PN3BxekwwNDlJVHY2TnpyMVR3djV3SXJwS2lGNkJBa1g5ZWJzeDcwemtScHhTQTl3ZHlkR0l2OEdEZVVEbnlWVGk2dzQ2RmtuUzI3d2tKNmFuQ3Uwam5WeVFzUHQ4K3duVXpQakVnbUpMSnR1Zk9rR0p3dFczZTcxZHhmNy9WMmU3blFxc1N5RGNtelhzbFdPcmU1RXZEaVM4azZlVDhiVytMN0hzajJFUk9Za29Yb3lmYmRmaFVEakR2Ym9FaTIrWmNpM3lWSEd5QnFzaHhUWjIrczc4L2dYM0g3UFdxM2lzR0RFbkVJWFM0a0I4Z3MrQ21zTHlPYVpjZ3ZCanRJM214NkM5Q2NkUVVNMWRTU0F2VkZNWkR0SHN5N2t5L0c0OEtEVXJSQmlIbnhlbVZRdTZtNXpTYjBjamhFN1V4elduUlI5Q1hjcFljQTJBOHNZUmlFYlVSRlVhS0FxZmczQzlGVmxFM1JGcUxMa2hYKzVpem5sZytLQVZjYUJTbzJZbWpuUGNHY0ZaenIxeFVuanBWNGx4T3RrSHdxYUdaVDhBQU90ZGZEKzZ0akJtMG9ENHdIc3AwZVNUY3pGU2ZoYThQbWZKejZQbDFHbVdTQkVPQXV1SnZEYmxNZ0t6RDY5ZmErSjZmZTdPa0pKdWhLVmh0SlNiWGFCL2d4ZHo1UFBPeGlnTTJoeHdXOXBUUzNHRlNjQ0JJaW1KcmhCTXFyQTJRd2lON0lkc1VKVUR0RG1VNlhmZFRhZDRrYmRtUlBZTzJhVmVzbFRzSVFZQmZlUzJ1cFlLb3ZzNzNEMzRaMWVxdFZ6S2FETVIrRndFclFCaFZNNTVSOWQwNHBZcnlqbHljcExIWGVkSGJzR0l4MFFaZ3dZRzBIdTJpV3VZRkVGUWVnNUs4a0tEa2tuNThIL2U3SDB6alJMSXFXbjIvTXh2eWpyV0s2d0xqaVBNcW5XdDd6ZXBBb3poUG51aE1IU2pCK2U1MVRJdktHekl6TWRhYUxLb0R4L3pvc0s3OXQ3ZUQvZjgrc0dSNlJxQ2JPUC80ZjhvQzh4akhjb2Z5UFZsUnNFbXgyRUtlY0tjcCszN25tN1Vvdm5lYVRwQUNOUmMwdHV5WEhnSzdsTzloUUNHRmxGa3Q0bUdqT1Q1T2NFQnR0dWU4YmtDaU1KUmtaNHFWL2JLRGVVUzBLZGZ1Ri9SVyszbUI0ZjdMVFhQWE5iVmtCR2xqTmtZeG8yWHBxUmhTZHk5QXc2TnpNNG9EYnBGTHJ6RHdvTUF4TEgyM2VQKy9IblJNdFZqc0ZMMXkwK0Y4eUp1UzN0WDVPZTVvSnZYeTlScmIvV3lWZDNWTGw1b2tYV1duNXUxbTdUWnFmL3FrT3ZwdzJSRnpvbENkYk9xVTVIQjVqSk02V3Rpb3gyeFJLVU5GSmtVbDRCdi9zdytpK1RiTm44b2RML3NoZE43b3hGU0pRNGJ4aVFhTExSSThNYTJOWnoxaDNWQ2diUFM5WFprVnB0TjVLNU0xWTRHQWViMitzS2t6MFNyT055K0U1Ni80dHZkVWo5L3ZYVWp2c2taMDB1OWZDdDhXNUhtM2NrclU3MFZPNklpYlIyV2Q5ZGU5bzB4djRrYnFqTW5PZVVYY3hPVlBxanR4MVJ6d3I3T2NZK2NtMHNIWnA2TjhGK1RQbFNYTDdmTE1adkdUaUM1QWVaWnYxUHprR2JwR3BYRFN0R2VwQzRRVTBVR25FZStqQU9DSmdYczYrRnFMV0FpUjJoY0V0enB0WmdOSUhxUXhMNlhPdXRPNnFjQkhMNmlYSm4yVEZuNDZuakhaOGFHTmNhdXVkWWgvYU1tVlJRcUJmYnBiZ3Q3N2ZmOHNRR3Q0K1h1bnBtTXc4cGIrZStaY3dEd3E0Sm92VTErV0NLNThwZmRPc3NiSmlsNGZLMyt5cWhtT2NmalBocDkrRm5WN3dhTTRyMThCam1EcGkvUnYvTDRsb2J6M1pGa2liOVJTQ1M5YlBqbFYxMGFrSlpxL0xUYTJwTWM1RWFpNHVrd1kwWFArRHQ2a3NZWng0ekc5WE5HMU85cExiRTFOa3FjbUUyazNya1BlNG0yeC9wMkpaWStsM0EyYTJTaVYvK1ZldkFVbVhXQitTMTdoTWFaNVVLaGNkMDg3OVlJL0Q1YkhNeENJUmtZck5EUGFMbUJSdVpBWGwxSHhJQ2pFQXlmWmxrOTBIZFNuZlh0ZnI3YlVSRWJGYnE0NEtyemdxMUpKaVcwYlhDbnpUUkVjb2hpNVB0cTNsZFNzcWxsMzFmQWl6ZnJqOXlWckIyamkyVkN4TVNWdWduT3pmNTlDTHdvVFp3a2xtZjY4SHJyVWxuVUxuMEJiV2o1eC8rVS9hMkh6R2kySHZnekFmdHpyb2cvVWxqaXV4TitFeXpwejg0cURsWCs3a3VCMStKd2xwRjBlbDM3cTRhMzZjaVpHTHNrOVpMM1BtZFArWU1kTFVuK28xZ0pVei9kSzFQY0lWeVNzQ0VwN053NjdHWkxQYk1UL1ltUkJRUEEzMllTeHpVVlcxU0ZYZ3ZOTW90NmNZZHFxUW9EU3hkMUxyR3UxeDIxajJBbXN5RVdjS05DOFZQOVY1OEVLUVp1ODVoNnhtaDh0S3UzVjFzK3YzMmhneVJhbjREOGppc2FJR3JoTHV0U2RqdnhDMWRlNjFPMVd1aTJQaUpzZjhGcURmRWRNNGFQV3Vzc1ZYRWUrYUpZc04xYk5WcTZ1UmZZYTNwKzB2UjRVWmM3UU1GdzgyWWpXKzNGc1BzeHptOGJRU2NvODlSeDVnejBYclZzczNUTThmV3l3aG1SWXpqQkxPWnNQZ0ZKYllhU3EweWJqVHd5STIzQnFPNHVHeHVBelRna29uUHVjVTZ2L0VldjBlSmR2cXozbEJYVjRyRTlXWkZxb2dmZGxwUzZyeFFZRmpPb25aNGEvODltbTdqTkswQ1dUcXkvMmRYeTZjbmZEaHhiN01WemtoNnFMYnRMRFZibWdJSktIRCtVNm5EenF4KzUwbHhpek5qeGVaMW52S3J0elVoSWx6T0tiUTZzTTFzdlhlTG5oTGxaUGY1VDJxNFEzYllFenBCNzFnajd4UXp3OWxKZSt5K0Y0WjZQc21aWjlxdks2N2RzQkFkRXAybW9hdnBTcEwra01TVTFvVlEzQ2RGdjUwNUkvUVF2T1VYZDF5NnpGZ2oreGdKdVVkK09NYTgvcEprdzZ2ZkhQbnE3MVo5dW9WRnVmeno5NVBweGJ2VVJDbUJENTlNMVRWbzgzUUZVNFB1YWJhS0t5dzAvaXFLUG9mbGhOYitOcHE3Y3BpZnVRN0JodC9XQUlBYnZXNlR3QUF0OWMrNlI4Wi8zN2ljUmNHZ0FFckVmL0w3ZWhGQk1XK2J2elBXYjZ3bGRGbFBjQmUvaGxKRkNYbmVBaXFqeFF4WitsVjd1RXRRUmFKREEvQ2tzTzNsdk9MTGRlNFFlRUN0MGFMMEFXZ2dJbEFhQU5RQXA2V0I0OTJka3hQMitDMERaRTRhY1B3N0xiaDNFMjBFUnlWMlVqUkhFRUpwUVBvOUNoWHFrR3RLczJhZFBDUzl2ZU56Z1NVNnNnS2RMVnBKOGFFeVFwK3ZQbGlkd1FEbWUvVm9vYUpKTElBK0Z0d0Zabi84U0hjYXZlZ1dGL2I3YlhTR1NTSktMVmUySndJamRYZG9wZUEybHhVMHhKY2M4RE42dmJuKzBTZ2d6TGlma1ZaVk9RdWx1cm1MWFNyTk9CZVJYbHFENkRTWXBYb0VpWlY4SWFEY0NQZmtRQUEpOyB9PC9zdHlsZT48L2RlZnM+PGcgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMCA2NC42NjY4NjQxMzY4MjQ0Mikgcm90YXRlKDAgNjMuNTc2MzE0Mzk5NTQ1OTM2IDE1KSI+PHBhdGggZD0iTTcuNSAwIEMzNC4xNCAtMS4yMywgNjEuNTcgLTEuMzksIDExOS42NSAwIE03LjUgMCBDMzUuODQgLTAuMTEsIDYzLjYzIDEuODIsIDExOS42NSAwIE0xMTkuNjUgMCBDMTIyLjY3IDAuNTgsIDEyNi42OCAzLjQ3LCAxMjcuMTUgNy41IE0xMTkuNjUgMCBDMTIyLjc5IC0xLjgzLCAxMjYuMTQgMS4wNSwgMTI3LjE1IDcuNSBNMTI3LjE1IDcuNSBDMTI1Ljc2IDExLjY5LCAxMjcuMjMgMTcuNDksIDEyNy4xNSAyMi41IE0xMjcuMTUgNy41IEMxMjcuNzggMTIuMTIsIDEyNi45OCAxOC4yNywgMTI3LjE1IDIyLjUgTTEyNy4xNSAyMi41IEMxMjUuNDYgMjcuNDYsIDEyNS45NyAzMC4xNSwgMTE5LjY1IDMwIE0xMjcuMTUgMjIuNSBDMTI2LjU3IDI2LjA2LCAxMjIuNzUgMzEuMzksIDExOS42NSAzMCBNMTE5LjY1IDMwIEM5MS42IDI5LjUsIDY1LjI2IDI5LjE4LCA3LjUgMzAgTTExOS42NSAzMCBDODguNzUgMjkuNzgsIDU5LjA0IDMxLjA0LCA3LjUgMzAgTTcuNSAzMCBDMy42NyAzMS40MiwgLTAuMzggMjcuNSwgMCAyMi41IE03LjUgMzAgQzMuNzcgMzIuMDgsIDEuODQgMjkuMTcsIDAgMjIuNSBNMCAyMi41IEMwLjM0IDE4Ljg1LCAwLjY5IDE0LjUsIDAgNy41IE0wIDIyLjUgQy0wLjAzIDE4LjE3LCAwLjU4IDEzLjk4LCAwIDcuNSBNMCA3LjUgQy0wLjYzIDMuNTksIDEuNjEgLTEuNDQsIDcuNSAwIE0wIDcuNSBDMS45MyAxLjAxLCAzLjUzIDAuOTksIDcuNSAwIiBzdHJva2U9IiMxZTFlMWUiIHN0cm9rZS13aWR0aD0iMSIgZmlsbD0ibm9uZSI+PC9wYXRoPjwvZz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSg1MC4yMjQzMjQ2NTM0NTIxODYgNjkuNjY2ODY0MTM2ODI0NDIpIHJvdGF0ZSgwIDIzLjM1MTk4OTc0NjA5Mzc1IDEwKSI+PHRleHQgeD0iMjMuMzUxOTg5NzQ2MDkzNzUiIHk9IjE0LjA5NiIgZm9udC1mYW1pbHk9IkV4Y2FsaWZvbnQsIFhpYW9sYWksIFNlZ29lIFVJIEVtb2ppIiBmb250LXNpemU9IjE2cHgiIGZpbGw9IiMxZTFlMWUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIHN0eWxlPSJ3aGl0ZS1zcGFjZTogcHJlOyIgZGlyZWN0aW9uPSJsdHIiIGRvbWluYW50LWJhc2VsaW5lPSJhbHBoYWJldGljIj5BZ2VudDwvdGV4dD48L2c+PGcgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxOTIuNTc4MjU4MDMxNzE4NjMgNjMuMjUxNTYzMjgzNjk0MTcpIHJvdGF0ZSgwIDY0LjkzNDc3NDM2NDUxNDYyIDE1KSI+PHBhdGggZD0iTTcuNSAwIEM0OC45NyAwLjIzLCA4Ni4wNCAxLjA2LCAxMjIuMzcgMCBNNy41IDAgQzMyLjAxIDAuOSwgNTUuMDIgMC4xMywgMTIyLjM3IDAgTTEyMi4zNyAwIEMxMjUuOTggMS4xLCAxMzEuNzMgMy4xMywgMTI5Ljg3IDcuNSBNMTIyLjM3IDAgQzEyNi41IC0wLjM2LCAxMjguMTIgMy4xNiwgMTI5Ljg3IDcuNSBNMTI5Ljg3IDcuNSBDMTI4LjU2IDE0LjA3LCAxMzAuNDggMTcuMzcsIDEyOS44NyAyMi41IE0xMjkuODcgNy41IEMxMjkuMjggMTEuNTgsIDEyOS4xNCAxNC41NiwgMTI5Ljg3IDIyLjUgTTEyOS44NyAyMi41IEMxMjkuMDcgMjYuOTksIDEyNy44MSAzMS41OSwgMTIyLjM3IDMwIE0xMjkuODcgMjIuNSBDMTI5LjUgMjUuNjcsIDEyNy4yMiAzMS44MSwgMTIyLjM3IDMwIE0xMjIuMzcgMzAgQzk4LjE1IDMyLjIxLCA3My4yNCAzMS40MSwgNy41IDMwIE0xMjIuMzcgMzAgQzkwLjA1IDMwLjA0LCA1Ny40NSAyOS44NiwgNy41IDMwIE03LjUgMzAgQzIuNDMgMjkuMzEsIC0wLjU2IDI2LjM1LCAwIDIyLjUgTTcuNSAzMCBDMi4wOSAyOC44MywgMC4xOCAyNS41MSwgMCAyMi41IE0wIDIyLjUgQy0wLjk2IDE3LjQzLCAtMC43MSAxMi4wNCwgMCA3LjUgTTAgMjIuNSBDLTAuNzEgMTkuMTQsIC0wLjU0IDE0LjA3LCAwIDcuNSBNMCA3LjUgQzAuNjggMC45NSwgMS40MiAtMC4wNSwgNy41IDAgTTAgNy41IEMxLjM3IDQuNTcsIDEuNjIgMS4yMiwgNy41IDAiIHN0cm9rZT0iIzFlMWUxZSIgc3Ryb2tlLXdpZHRoPSIxIiBmaWxsPSJub25lIj48L3BhdGg+PC9nPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDIxMC44ODUwNTY5MzIzNjU4NCA2OC4yNTE1NjMyODM2OTQxNykgcm90YXRlKDAgNDYuNjI3OTc1NDYzODY3MTkgMTApIj48dGV4dCB4PSI0Ni42Mjc5NzU0NjM4NjcxOSIgeT0iMTQuMDk2IiBmb250LWZhbWlseT0iRXhjYWxpZm9udCwgWGlhb2xhaSwgU2Vnb2UgVUkgRW1vamkiIGZvbnQtc2l6ZT0iMTZweCIgZmlsbD0iIzFlMWUxZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgc3R5bGU9IndoaXRlLXNwYWNlOiBwcmU7IiBkaXJlY3Rpb249Imx0ciIgZG9taW5hbnQtYmFzZWxpbmU9ImFscGhhYmV0aWMiPkVudmlyb25tZW50PC90ZXh0PjwvZz48ZyBzdHJva2UtbGluZWNhcD0icm91bmQiPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDI1NS42MTEwOTM5MjI5NTAyIDU3LjYwMjgxMjYyMDY3Njc5KSByb3RhdGUoMCAtOTIuOTE5MjUzNjEyMDk0NzQgLTExLjQxMTEzMzM1Mzc2NDYyNikiPjxwYXRoIGQ9Ik0wLjkyIDEuMTggQy0xNC41MiAtMi41MSwgLTYwLjc1IC0yMi44NSwgLTkxLjc1IC0yMy4xMSBDLTEyMi43NSAtMjMuMzgsIC0xNjkuNDggLTQuMjksIC0xODUuMDYgLTAuNCBNLTAuMDUgMC43NSBDLTE1LjcyIC0zLjIzLCAtNjEuNzYgLTI1LjA1LCAtOTIuNjUgLTI1LjEgQy0xMjMuNTUgLTI1LjE2LCAtMTcwLjA5IC0zLjk1LCAtMTg1LjQxIDAuNDIiIHN0cm9rZT0iIzFlMWUxZSIgc3Ryb2tlLXdpZHRoPSIxIiBmaWxsPSJub25lIj48L3BhdGg+PC9nPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDI1NS42MTEwOTM5MjI5NTAyIDU3LjYwMjgxMjYyMDY3Njc5KSByb3RhdGUoMCAtOTIuOTE5MjUzNjEyMDk0NzQgLTExLjQxMTEzMzM1Mzc2NDYyNikiPjxwYXRoIGQ9Ik0tMTY2LjE0IC0xNS41MSBDLTE3MS41MiAtOS4yNiwgLTE4MC4yOCAtMi4xMywgLTE4NS40MSAwLjQyIE0tMTY2LjE0IC0xNS41MSBDLTE3MS4wNyAtMTEuMTgsIC0xNzQuMzQgLTguMzEsIC0xODUuNDEgMC40MiIgc3Ryb2tlPSIjMWUxZTFlIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiPjwvcGF0aD48L2c+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjU1LjYxMTA5MzkyMjk1MDIgNTcuNjAyODEyNjIwNjc2NzkpIHJvdGF0ZSgwIC05Mi45MTkyNTM2MTIwOTQ3NCAtMTEuNDExMTMzMzUzNzY0NjI2KSI+PHBhdGggZD0iTS0xNjAuNDEgMC42IEMtMTY3LjggMC44NywgLTE3OC43MSAxLjk2LCAtMTg1LjQxIDAuNDIgTS0xNjAuNDEgMC42IEMtMTY2LjY5IDEuMzUsIC0xNzEuMjMgMC42NSwgLTE4NS40MSAwLjQyIiBzdHJva2U9IiMxZTFlMWUiIHN0cm9rZS13aWR0aD0iMSIgZmlsbD0ibm9uZSI+PC9wYXRoPjwvZz48L2c+PG1hc2s+PC9tYXNrPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDgyLjI3MDUyNzgyMzM3NDMyIDEwKSByb3RhdGUoMCA3My42Mjg5NjI5MTQwNDYwNCA4LjI2MjE5NDc5ODU3NTU5MikiPjx0ZXh0IHg9IjczLjYyODk2MjkxNDA0NjA0IiB5PSIxMS42NDYzODk3ODgwNzIxNDUiIGZvbnQtZmFtaWx5PSJFeGNhbGlmb250LCBYaWFvbGFpLCBTZWdvZSBVSSBFbW9qaSIgZm9udC1zaXplPSIxMy4yMTk1MTE2Nzc3MjA5MzhweCIgZmlsbD0iIzFlMWUxZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgc3R5bGU9IndoaXRlLXNwYWNlOiBwcmU7IiBkaXJlY3Rpb249Imx0ciIgZG9taW5hbnQtYmFzZWxpbmU9ImFscGhhYmV0aWMiPk9ic2VydmF0aW9uPC90ZXh0PjwvZz48ZyBzdHJva2UtbGluZWNhcD0icm91bmQiPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDcyLjQ4OTUwNjYyODY5NzIgMTAxLjA3Mzc4MDI0MjYzMDM5KSByb3RhdGUoMCA5My4xOTA5ODA0MjkxMDQyMyAxMC44Njc3NTQzNDI2MzY2NTgpIj48cGF0aCBkPSJNLTAuMzEgMC44OSBDMTUuMzUgNC40OSwgNjIuMjggMjIuMDMsIDkzLjQ2IDIxLjk2IEMxMjQuNjMgMjEuODksIDE3MS4xIDQuMDYsIDE4Ni43NiAwLjQ4IE0xLjczIDAuMyBDMTcuNzggMy40OSwgNjQuODUgMTkuNzEsIDk1LjU5IDE5Ljk1IEMxMjYuMzQgMjAuMiwgMTcwLjc2IDQuODMsIDE4Ni4xOSAxLjc3IiBzdHJva2U9IiMxZTFlMWUiIHN0cm9rZS13aWR0aD0iMSIgZmlsbD0ibm9uZSI+PC9wYXRoPjwvZz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSg3Mi40ODk1MDY2Mjg2OTcyIDEwMS4wNzM3ODAyNDI2MzAzOSkgcm90YXRlKDAgOTMuMTkwOTgwNDI5MTA0MjMgMTAuODY3NzU0MzQyNjM2NjU4KSI+PHBhdGggZD0iTTE2NS41OSAxNS45MyBDMTcyLjM4IDEwLjQ4LCAxNzYuNjQgOS4yNSwgMTg2LjE5IDEuNzcgTTE2NS41OSAxNS45MyBDMTcxLjk0IDEyLjYsIDE3Ni45MyA4LjQxLCAxODYuMTkgMS43NyIgc3Ryb2tlPSIjMWUxZTFlIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiPjwvcGF0aD48L2c+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNzIuNDg5NTA2NjI4Njk3MiAxMDEuMDczNzgwMjQyNjMwMzkpIHJvdGF0ZSgwIDkzLjE5MDk4MDQyOTEwNDIzIDEwLjg2Nzc1NDM0MjYzNjY1OCkiPjxwYXRoIGQ9Ik0xNjEuMzEgLTAuNjIgQzE2OS4yNiAtMS43NiwgMTc0LjYzIDEuMzIsIDE4Ni4xOSAxLjc3IE0xNjEuMzEgLTAuNjIgQzE2OS4wNyAwLjkzLCAxNzUuMzIgMS42MywgMTg2LjE5IDEuNzciIHN0cm9rZT0iIzFlMWUxZSIgc3Ryb2tlLXdpZHRoPSIxIiBmaWxsPSJub25lIj48L3BhdGg+PC9nPjwvZz48bWFzaz48L21hc2s+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoOTguODQzODIzOTY4NTk2NTUgMTMxLjM5MjA2NzM0Mjk2NTkpIHJvdGF0ZSgwIDczLjYyODk2MjkxNDA0NjA0IDguMjYyMTk0Nzk4NTc1NTkyKSI+PHRleHQgeD0iNzMuNjI4OTYyOTE0MDQ2MDQiIHk9IjExLjY0NjM4OTc4ODA3MjE0NSIgZm9udC1mYW1pbHk9IkV4Y2FsaWZvbnQsIFhpYW9sYWksIFNlZ29lIFVJIEVtb2ppIiBmb250LXNpemU9IjEzLjIxOTUxMTY3NzcyMDkzOHB4IiBmaWxsPSIjMWUxZTFlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBzdHlsZT0id2hpdGUtc3BhY2U6IHByZTsiIGRpcmVjdGlvbj0ibHRyIiBkb21pbmFudC1iYXNlbGluZT0iYWxwaGFiZXRpYyI+QWN0aW9uPC90ZXh0PjwvZz48L3N2Zz4=" width="332" height="158" class="img_ev3q"></p></figure></div>
<p>Based on the above definition, we can attempt to classify the components of our system within a classic agent context as follows:</p>
<ul>
<li><strong>Agent</strong>: prompting + large language model + parsing</li>
<li><strong>Environment</strong>: user, language server and search algorithm</li>
<li><strong>Actions</strong>: tactics</li>
<li><strong>Observations</strong>: current goal, examples, definitions, ...</li>
</ul>
<figure><p><img decoding="async" loading="lazy" alt="Agent loop" src="https://formal.land/assets/images/agent_loop-0a837a1284810e14d15c2b0c7f468ab4.svg" width="1649" height="1373" class="img_ev3q"></p></figure>
<p>Let us recall that in the proposed general architecture, the agent is only one of the possible types of <em>oracle</em> from which we can obtain useful information to advance the demonstration (albeit the most interesting one), and that multiple <em>oracles</em> at the same time can coexist, e.g., agents implementing different resolution strategies or configurations.</p>
<p>The agent is designed to interact with various components of the environment, for example, by requesting examples, additional information, or simple advice from the user; the current goal; the list of previously attempted and failed tactics for the search algorithm; or semantic data from the language server. The interaction process could be deliberative (guided by the LLM's reasoning) or, more simply, a form of abstraction for a predetermined set of information we intend to request. This interaction with the environment is crucial for defining the goal, enriching the agent's context, and generating input for the prompt. In a recent <a href="https://formal.land/blog/2025/01/06/annotating-what-we-are-doing">blog post</a>, we documented our interest in internally gathering as much information as possible about the recurring human processes of building a demonstration in order to standardize and emulate them within the agent's interaction logic with the environment.</p>
<p>Several propting techniques can be tried. In the <a href="https://github.com/LLM4Coq/nlir" target="_blank" rel="noopener noreferrer">NLIR</a> system, the prompt is gradually refined through a chain-of-thought approach: first, a natural language response is requested from the LLM, and this response is then used to generate a more precise Rocq code response.</p>
<p>Once the LLM produces an output‚Äîwhether a tactic, a list of tactics, or a complete proof, depending on the type of agent‚Äîthe response is parsed and executed within the environment via P√©tanque. If an error occurs, the environment is either reverted to its previous state (backtracking), or an error recovery technique is applied (e.g., replacing the problematic code with <code>admit.</code>).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-evaluation-strategies">üìä Evaluation strategies<a href="https://formal.land/blog/2025/01/21/designing-a-coding-assistant-for-rocq#-evaluation-strategies" class="hash-link" aria-label="Direct link to üìä Evaluation strategies" title="Direct link to üìä Evaluation strategies">‚Äã</a></h2>
<p>Benchmarks used for evaluating automated demonstration systems tend to be limited to classical mathematics, focusing on demonstration systems that are <em>completely automated</em> and not of <em>support</em> to demonstration writing.
As a result, these benchmarks can be misleading with regard to the practical utility of such tools in real-world contexts. In addition to traditional evaluation methods, the system should be tested in practical scenarios, such as by applying it to ongoing formal verification projects within <a href="https://formal.land/">Formal Land</a>.</p>
<p>A second critical consideration when evaluating a practical support tool is the cost per request. Integrated LLMs should not be viewed as infinite resources, but rather as constrained resources whose usage must be optimized and minimized, even if that means sacrificing some efficiency.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-similar-projects-and-resources">üóÇÔ∏è Similar projects and resources<a href="https://formal.land/blog/2025/01/21/designing-a-coding-assistant-for-rocq#%EF%B8%8F-similar-projects-and-resources" class="hash-link" aria-label="Direct link to üóÇÔ∏è Similar projects and resources" title="Direct link to üóÇÔ∏è Similar projects and resources">‚Äã</a></h2>
<p>The research field in fully autonomous automated theorem using proof assistants is very active and has received a strong boost since the advent of LLMs. The proposed system architecture has been influenced by the following works:</p>
<ul>
<li>LeanCopilot (<a href="https://github.com/lean-dojo/LeanCopilot" target="_blank" rel="noopener noreferrer">code</a>, <a href="https://arxiv.org/abs/2404.12534" target="_blank" rel="noopener noreferrer">paper</a>)</li>
<li>copra (<a href="https://github.com/trishullab/copra" target="_blank" rel="noopener noreferrer">code</a>, <a href="https://arxiv.org/abs/2310.04353" target="_blank" rel="noopener noreferrer">paper</a>)</li>
<li>CoqPilot (<a href="https://github.com/JetBrains-Research/coqpilot" target="_blank" rel="noopener noreferrer">code</a>, <a href="https://arxiv.org/abs/2410.19605" target="_blank" rel="noopener noreferrer">paper</a>)</li>
<li>NLIR (<a href="https://github.com/LLM4Coq/nlir" target="_blank" rel="noopener noreferrer">code</a>, <a href="https://openreview.net/forum?id=QzOc0tpdef" target="_blank" rel="noopener noreferrer">paper</a>)</li>
</ul>
<p>Other interesting resources to further explore this topic:</p>
<ul>
<li>üìΩÔ∏è <a href="https://www.youtube.com/watch?v=Yr8dzfVkeHg" target="_blank" rel="noopener noreferrer">Lean Together 2025: Jason Rute, The last mile</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-key-takeaway">ü•° Key takeaway<a href="https://formal.land/blog/2025/01/21/designing-a-coding-assistant-for-rocq#-key-takeaway" class="hash-link" aria-label="Direct link to ü•° Key takeaway" title="Direct link to ü•° Key takeaway">‚Äã</a></h2>
<ul>
<li>The agent perspective and the search perspective are here complemented in a single system</li>
<li>The automatic demonstration process can be seen as a sophisticated search in a space of states</li>
<li>The system must be flexible overall and adapt to different refinements that might be decided in the process</li>
<li>In a support tool, completeness of proof is not mandatory</li>
<li>User interaction is crucial</li>
<li>Evaluation must be carried out in a practical context</li>
</ul>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions or requests!</em></p></div></div>]]></content>
        <author>
            <name>Andrea Delmastro</name>
            <uri>https://github.com/andreadlm</uri>
        </author>
        <category label="llm" term="llm"/>
        <category label="ai" term="ai"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[ü¶Ä Verification of one instruction of the Move's type-checker]]></title>
        <id>https://formal.land/blog/2025/01/13/verification-one-instruction-sui</id>
        <link href="https://formal.land/blog/2025/01/13/verification-one-instruction-sui"/>
        <updated>2025-01-13T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[This is the last article of a series of blog post presenting our formal verification effort in &nbsp;Rocq/Coq to ensure the correctness of the type-checker of the Move language for Sui.]]></summary>
        <content type="html"><![CDATA[<p>This is the last article of a series of blog post presenting our formal verification effort in <a href="https://rocq-prover.org/" target="_blank" rel="noopener noreferrer"><img src="https://raw.githubusercontent.com/coq/rocq-prover.org/refs/heads/main/rocq-id/logos/SVG/icon-rocq-orange.svg" height="18px">&nbsp;Rocq/Coq</a> to ensure the correctness of the type-checker of the <a href="https://sui.io/move" target="_blank" rel="noopener noreferrer">Move language</a> for <a href="https://sui.io/" target="_blank" rel="noopener noreferrer">Sui</a>.</p>
<p>Here we show how the formal proof works to check that the type-checker is correct on a particular instruction, for any possible initial states. The general idea is to symbolically execute the code step by step on the type-checker side, accumulating properties about the stack assuming the type-checker succeeds, and then to show that the interpreter will produce a stack of the expected type as a result.</p>
<p>Previous post:</p>
<ul>
<li><a href="https://formal.land/blog/2024/11/14/sui-move-checker-abstract-stack">ü¶Ä Example of verification for the Move's checker of Sui</a></li>
</ul>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Ask for the highest security!</div><div class="admonitionContent_BuS1"><p>When millions are at stake, bug bounties are not enough.</p><p>How do you ensure your security audits are exhaustive?</p><p>The best way to do this is to use <strong>formal verification</strong>.</p><p>This is what we provide as a service. <strong>Contact us</strong> at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">&nbsp;üíåcontact@formal.land</a> to make sure your code is safe!&nbsp;üõ°Ô∏è</p><p>We cover <strong>Rust</strong>, <strong>Solidity</strong>, and <strong>ZK systems</strong>.</p></div></div>
<figure><p><img decoding="async" loading="lazy" alt="Green forest with water" src="https://formal.land/assets/images/green-forest-with-water-d585bfd8843e8c87210ace14398fae84.webp" width="1024" height="1024" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-the-rust-code">ü¶Ä The Rust code<a href="https://formal.land/blog/2025/01/13/verification-one-instruction-sui#-the-rust-code" class="hash-link" aria-label="Direct link to ü¶Ä The Rust code" title="Direct link to ü¶Ä The Rust code">‚Äã</a></h2>
<p>We are verifying the type-checking for the Move bytecode instruction <code>CastU8</code>. This instruction takes the top-most element of the stack, checks that it is an integer, and pushes it back on the stack as a <code>U8</code> if it is in the right range or fails with an error <code>StatusCode::ARITHMETIC_ERROR</code> otherwise.</p>
<p>Here is the code of the interpreter:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">Bytecode</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">CastU8</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gas_meter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">charge_simple_instr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">S</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">CastU8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> integer_value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">operand_stack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">pop_as</span><span class="token punctuation" style="color:#393A34">::</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">IntegerValue</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    interpreter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">operand_stack</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Value</span><span class="token punctuation" style="color:#393A34">::</span><span class="token keyword" style="color:#00009f">u8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">integer_value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">cast_u8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We ignore the gas metering for now. The <code>pop_as</code> method pops the top-most element of the stack and checks that it is an integer. The <code>cast_u8</code> method checks that the integer is in the right range (<code>0</code> to <code>255</code>) and returns the value as a <code>U8</code>. The <code>push</code> method pushes the value back on the stack. The question mark operator <code>?</code> is used to propagate errors.</p>
<p>Here is the corresponding code in the type-checker:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">Bytecode</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">CastU8</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> operand </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token macro property" style="color:#36acaa">safe_unwrap_err!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">verifier</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">pop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">operand</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">is_integer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">Err</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">verifier</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">StatusCode</span><span class="token punctuation" style="color:#393A34">::</span><span class="token constant" style="color:#36acaa">INTEGER_OP_TYPE_MISMATCH_ERROR</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            offset</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    verifier</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">meter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ST</span><span class="token punctuation" style="color:#393A34">::</span><span class="token constant" style="color:#36acaa">U8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It pops the top-most element of the stack of types (we do not have values here) and checks that it is an integer type. If it is not, it returns an error. Otherwise, it pushes the type <code>U8</code> on the stack. Note that there are no ways to know, in the type-checker, if the value is in the right range.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-the-rocq-translation">üê¶‚Äç‚¨õ The Rocq translation<a href="https://formal.land/blog/2025/01/13/verification-one-instruction-sui#-the-rocq-translation" class="hash-link" aria-label="Direct link to üê¶‚Äç‚¨õ The Rocq translation" title="Direct link to üê¶‚Äç‚¨õ The Rocq translation">‚Äã</a></h2>
<p>In previous posts, we covered our manual translation of the Rust code in Rocq. We repeat it here. The interpreter code in Rocq:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Bytecode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CastU8 </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  letS</span><span class="token operator" style="color:#393A34">!</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> integer_value </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> liftS</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Lens</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interpreter </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    liftS</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> Interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Lens</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">operand_stack $</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Stack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Impl_Stack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pop_as IntegerValue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  letS</span><span class="token operator" style="color:#393A34">!</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> integer_value </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    returnS</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> $ IntegerValue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cast_u8 integer_value </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  doS</span><span class="token operator" style="color:#393A34">!</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> liftS</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Lens</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interpreter </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    liftS</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> Interpreter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Lens</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">operand_stack $</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Stack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Impl_Stack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">push $</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ValueImpl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 integer_value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  returnS</span><span class="token operator" style="color:#393A34">!</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> InstrRet</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ok</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The type-checker code in Rocq:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Bytecode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CastU8 </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  letS</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> operand </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    liftS</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> TypeSafetyChecker</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lens_self_stack AbstractStack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pop </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  letS</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> operand </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">toS</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> $ safe_unwrap_err operand </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> negb $ SignatureToken</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_integer operand </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    returnS</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> $</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Err $</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      TypeSafetyChecker</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Impl_TypeSafetyChecker</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">error</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        verifier StatusCode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">INTEGER_OP_TYPE_MISMATCH_ERROR offset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TypeSafetyChecker</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Impl_TypeSafetyChecker</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">push SignatureToken</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-formal-statement">üìú Formal statement<a href="https://formal.land/blog/2025/01/13/verification-one-instruction-sui#-formal-statement" class="hash-link" aria-label="Direct link to üìú Formal statement" title="Direct link to üìú Formal statement">‚Äã</a></h2>
<p>Here is the formal statement of the property we want to prove to ensure the correctness of the type-checker:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Lemma</span><span class="token plain"> progress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(* [...] parameters and hypothesis *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(* We assume that the initial state is well-typed *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  IsInterpreterContextOfType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t locals interpreter type_safety_checker </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    verify_instr instruction pc type_safety_checker</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    execute_instruction ty_args function resolver instruction state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Panic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Value </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ok </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> type_safety_checker</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Panic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Value </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ok </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">'</span><span class="token punct punctuation" style="color:#393A34">{|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pc </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">locals </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> locals</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interpreter </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> interpreter</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> state</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IsInterpreterContextOfType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t locals</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> interpreter</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> type_safety_checker</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(* If the type-checker succeeds, then the interpreter cannot return a panic *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Panic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Value </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ok </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Panic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Panic </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> False</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(* Other errors are allowed *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Panic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Value </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ok </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Panic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Value </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Err </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Panic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Value </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Err </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Panic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Panic </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This lemma is in the file <a href="https://github.com/formal-land/coq-of-rust/blob/main/CoqOfRust/move_sui/proofs/move_bytecode_verifier/type_safety.v" target="_blank" rel="noopener noreferrer">proofs/move_bytecode_verifier/type_safety.v</a>. It compares the behavior of the type-checker and the interpreter when executing an instruction. If the type-checker succeeds, then the interpreter cannot return a panic. If the interpreter also succeeds, then the new state is well-typed according to the types returned by the type-checker.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-proof-time">üõ°Ô∏è Proof time<a href="https://formal.land/blog/2025/01/13/verification-one-instruction-sui#%EF%B8%8F-proof-time" class="hash-link" aria-label="Direct link to üõ°Ô∏è Proof time" title="Direct link to üõ°Ô∏è Proof time">‚Äã</a></h2>
<p>We prove the statement above by reasoning about all possible instructions. For the <code>CastU8</code> instruction, the Rocq proof is as follows:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> guard_instruction Bytecode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CastU8</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  destruct_abstract_pop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  step</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> cbn</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">exact I</span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  destruct_abstract_push</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  step</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> cbn</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">try easy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">try now destruct operand_ty</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    repeat </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">step</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> cbn</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> try easy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    constructor</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> cbn</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> try assumption</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sauto lq</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> on</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here is what this script does:</p>
<ul>
<li><code>guard_instruction Bytecode.CastU8</code> checks that the current instruction is <code>CastU8</code>. This helps debugging if we are not at the right place.</li>
<li><code>destruct_abstract_pop</code> pops the top-most element of the stack of types and gives it the name <code>operand_ty</code>. It handles the cases where the stack is empty.</li>
<li><code>step; cbn; [exact I|]</code> is a command to handle the next <code>if</code> in the code of the type-checker. We are only interested in the success branch (<code>else</code> branch in this case).</li>
<li><code>destruct_abstract_push</code> pushes the type <code>U8</code> on the stack of types.</li>
</ul>
<p>Then, there is a set of automated tactics iterating over all the possible types of values that can be on the stack. Just before the end of the proof, we have the following proof state:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">List</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Forall2 IsValueImplOfType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ValueImpl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 z </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> x0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SignatureToken</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AbstractStack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flatten stack_ty0</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This proof state is repeated identically six times, once for each possible integer type (<code>U8</code>, <code>U16</code>, <code>U32</code>, <code>U64</code>, <code>U128</code>, <code>U256</code>). It says that the stack of values:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ValueImpl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 z </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> x0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>must have the stack of types:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SignatureToken</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AbstractStack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flatten stack_ty0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The value <code>z</code> is the result of the <code>cast_u8</code> function in the interpreter. The <code>flatten</code> function is used to flatten the stack of types that may contain duplicates.</p>
<p>For the head of the stack the property is trivially true. For the tail of the stack, we use one of the hypotheses from the context, coming from the fact that the stack was initially well-typed and with did not modify the tail.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-conclusion">‚úíÔ∏è Conclusion<a href="https://formal.land/blog/2025/01/13/verification-one-instruction-sui#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to ‚úíÔ∏è Conclusion" title="Direct link to ‚úíÔ∏è Conclusion">‚Äã</a></h2>
<p>We have show how to formally verify that the type-checker for the Move's bytecode virtual machine is correct on a simple instruction <code>CastU8</code>. This is part of a larger effort to ensure the correctness of the whole type-checker.</p>
<p>Other instructions operating on atomic types (integers, booleans, addresses) are similar to this one. The most complex instructions are the ones operating on references and data structures like vectors and structs. These require more work, and we have not yet tackled them.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions or requests!</em></p></div></div>]]></content>
        <category label="Rust" term="Rust"/>
        <category label="Move" term="Move"/>
        <category label="Sui" term="Sui"/>
        <category label="type-checker" term="type-checker"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[ü§ñ Annotating what we are doing for an LLM to pick up]]></title>
        <id>https://formal.land/blog/2025/01/06/annotating-what-we-are-doing</id>
        <link href="https://formal.land/blog/2025/01/06/annotating-what-we-are-doing"/>
        <updated>2025-01-06T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[We want to write a series of blog posts about our efforts to use LLMs to formally verify code faster with the &nbsp;Rocq/Coq theorem prover. Here, we present an experiment consisting of writing all that we are doing so that we can document our reasoning and help LLMs to pick up human techniques.]]></summary>
        <content type="html"><![CDATA[<p>We want to write a series of blog posts about our efforts to use LLMs to formally verify code faster with the <a href="https://rocq-prover.org/" target="_blank" rel="noopener noreferrer"><img src="https://raw.githubusercontent.com/coq/rocq-prover.org/refs/heads/main/rocq-id/logos/SVG/icon-rocq-orange.svg" height="18px">&nbsp;Rocq/Coq</a> theorem prover. Here, we present an experiment consisting of writing all that we are doing so that we can document our reasoning and help LLMs to pick up human techniques.</p>
<p>According to many publications about using generative AI to help formal verification, it is almost impossible to find a proof in "one shot". So, one certainly has to interact with the system, maybe by following the human way. Here we aim to document this "human way" of writing proofs.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Ask for the highest security!</div><div class="admonitionContent_BuS1"><p>How do you ensure your security audits are exhaustive?</p><p>When millions are at stake, bug bounties are not enough.</p><p>The only way to do this is to use <strong>formal verification</strong> to <em>prove</em> your code is correct.</p><p>This is what we provide as a service. <strong>Contact us</strong> at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">&nbsp;üíåcontact@formal.land</a> to ensure your code is safe!&nbsp;üöÄ</p><p>We cover <strong>Rust</strong>, <strong>Solidity</strong>, and soon <strong>zk circuits</strong>.</p></div></div>
<figure><p><img decoding="async" loading="lazy" alt="Robot" src="https://formal.land/assets/images/robot-forest-f7370f18c8ef9dd0c0d6bdb53c64d96c.webp" width="1024" height="1024" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-example">üîç Example<a href="https://formal.land/blog/2025/01/06/annotating-what-we-are-doing#-example" class="hash-link" aria-label="Direct link to üîç Example" title="Direct link to üîç Example">‚Äã</a></h2>
<p>We take as an example our verification effort for the type-checker of the Move language. We have a big lemma to verify with 77 cases, one per Move instruction. We now write everything we do in a single linear document <a href="https://github.com/formal-land/coq-of-rust/blob/main/CoqOfRust/what_we_do.md" target="_blank" rel="noopener noreferrer">what_we_do.md</a>. Here is an extract:</p>
<blockquote>
<p>Now a previous case is failing:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hauto l: on.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>with:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Error: hauto failed</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As this is a tactic generated by <code>best</code>, we try to use <code>best</code> again. It works! We continue and arrive at our current goal. Out of curiosity, we try <code>best</code> again. It works! The idea is that since we made weaker the definition of what we want to prove, maybe we can now solve it automatically.</p>
<p>We have six cases which are solved by <code>best</code>:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{ best. }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{ best. }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{ best. }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{ best. }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{ best. }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{ best. }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We replace it by <code>; best</code> after the block of previous tactics:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">step; cbn; (try easy); (try now destruct operand_ty);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> repeat (step; cbn; try easy);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> constructor; cbn; try assumption;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> best.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It works! By running <code>make</code> again we get that we can replace the <code>best</code> by `</p>
<p>So now we have done the <code>Bytecode.CastU8</code> case.</p>
</blockquote>
<p>We document both our successes and failures, as this is what we do when we interact with the system to try to find the proof of a property.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-quick-takeaways">üêÜ Quick takeaways<a href="https://formal.land/blog/2025/01/06/annotating-what-we-are-doing#-quick-takeaways" class="hash-link" aria-label="Direct link to üêÜ Quick takeaways" title="Direct link to üêÜ Quick takeaways">‚Äã</a></h2>
<p>This is time-consuming. Hopefully, this pays off in the long run. There may be a way to automatically record what we are doing, by recording the user interactions in a VSCode plugin. In addition, when writing what we do by hand we might forget to write some important steps but seemingly obvious steps, like checking into another file, due to laziness.</p>
<p>The autocomplete from GitHub Copilot, while writing the document, already generated the right steps to do from the journal we are writing, like "compile the project again" or a good tactic to try.</p>
<p>We realize that we have a lot to write in consolidated documents and that a lot of what we do are coding conventions we have taken. These might not be the ones used by everyone, so we have to distinguish between our conventions and general Rocq knowledge.</p>
<p>There is a lot of domain-specific knowledge that only a human can provide and that is specific to each project. For example, here, a human has to give hints related to how the Move type-checker is implemented, which can only be understood by reading the source code.</p>
<p>Here we try to give some sense of mid-level intuitions: how to navigate the project, go to a definition, add a new property, ... We do not focus too much on the details of the tactics to use (more low-level), or the high-level intuition behind the proof which might be better done by a human.</p>
<p>This helps to understand how an LLM thinks and which information it has access to.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-conclusion">‚úíÔ∏è Conclusion<a href="https://formal.land/blog/2025/01/06/annotating-what-we-are-doing#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to ‚úíÔ∏è Conclusion" title="Direct link to ‚úíÔ∏è Conclusion">‚Äã</a></h2>
<p>We have quickly presented the idea of writing what we are doing along the way to help LLMs understand how to verify some code.</p>
<p>Please tell us what you think or if you have some ideas for improving this process!</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions or requests!</em></p></div></div>]]></content>
        <category label="llm" term="llm"/>
        <category label="ai" term="ai"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[ü¶Ñ Mutually recursive functions with notation]]></title>
        <id>https://formal.land/blog/2024/12/26/mutually-recursive-functions-with-notation</id>
        <link href="https://formal.land/blog/2024/12/26/mutually-recursive-functions-with-notation"/>
        <updated>2024-12-26T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[In this blog post, we present a technique with the &nbsp;Rocq/Coq theorem prover to define mutually recursive functions using a notation. This is sometimes convenient for types defined using a container type, such as types depending on a list of itself.]]></summary>
        <content type="html"><![CDATA[<p>In this blog post, we present a technique with the <a href="https://rocq-prover.org/" target="_blank" rel="noopener noreferrer"><img src="https://raw.githubusercontent.com/coq/rocq-prover.org/refs/heads/main/rocq-id/logos/SVG/icon-rocq-orange.svg" height="18px">&nbsp;Rocq/Coq</a> theorem prover to define mutually recursive functions using a notation. This is sometimes convenient for types defined using a container type, such as types depending on a list of itself.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Ask for the highest security!</div><div class="admonitionContent_BuS1"><p>To ensure your code is fully secure today, contact us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">&nbsp;üíåcontact@formal.land</a>!&nbsp;üöÄ</p><p>We exclusively focus on formal verification to offer you the highest degree of security for your application.</p><p>We currently work with some of the leading blockchain entities, such as:</p><ul>
<li>The <a href="https://ethereum.foundation/" target="_blank" rel="noopener noreferrer">Ethereum Foundation</a></li>
<li>The <a href="https://sui.io/about" target="_blank" rel="noopener noreferrer">Sui Foundation</a></li>
<li>Previously, the <a href="https://alephzero.org/" target="_blank" rel="noopener noreferrer">Aleph Zero</a> and <a href="https://tezos.com/" target="_blank" rel="noopener noreferrer">Tezos</a> foundations</li>
</ul></div></div>
<figure><p><img decoding="async" loading="lazy" alt="Forest" src="https://formal.land/assets/images/two-trees-4e9d1d0b0d813576a958ece5726466fb.jpg" width="1472" height="832" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-example">üîç Example<a href="https://formal.land/blog/2024/12/26/mutually-recursive-functions-with-notation#-example" class="hash-link" aria-label="Direct link to üîç Example" title="Direct link to üîç Example">‚Äã</a></h2>
<p>Here is a typical example of a type defined using a container of itself, written in <a href="https://www.rust-lang.org/" target="_blank" rel="noopener noreferrer">ü¶Ä&nbsp;Rust</a>:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">Trees</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">A</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Tree</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">A</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">enum</span><span class="token plain"> </span><span class="token type-definition class-name">Tree</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">A</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Leaf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Node</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">A</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> children</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Trees</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">A</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>These two definitions are mutually dependent. We choose to represent it in Rocq/Coq with the following definition:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> Tree </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Leaf </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Tree A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Node </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> list </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Tree A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> Tree A</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> Trees </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  list </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Tree A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If we define a recursive function on this type, for example, to compute the sum of all the values in the tree, we would naturally write a function that iterates both on:</p>
<ul>
<li>The tree constructors,</li>
<li>The list of the <code>Node</code> case.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-first-solution">üìù First solution<a href="https://formal.land/blog/2024/12/26/mutually-recursive-functions-with-notation#-first-solution" class="hash-link" aria-label="Direct link to üìù First solution" title="Direct link to üìù First solution">‚Äã</a></h2>
<p>Here is a first attempt to define a <code>sum</code> function that adds all the elements of the tree:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Fixpoint</span><span class="token plain"> sum_tree </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> nat</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Tree A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nat </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> t </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Leaf </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Node a ts </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> f a </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> sum_trees f ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> sum_trees </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> nat</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ts </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Trees A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nat </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> ts </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> nil </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ts </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> sum_tree f t </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> sum_trees f ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This definition does not work as the <code>Tree</code> type is not mutually recursive, but the function <code>sum_tree</code> is. The error message is:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Error: Cannot guess decreasing argument of fix.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>A first solution is to define the function <code>sum_trees</code> as a local definition in <code>sum_tree</code>:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Fixpoint</span><span class="token plain"> sum_tree </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> nat</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Tree A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nat </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fix</span><span class="token plain"> sum_trees </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ts </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Trees A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nat </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> ts </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> nil </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ts </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> sum_tree f t </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> sum_trees ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">end</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> t </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Leaf </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Node a ts </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> f a </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> sum_trees ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This definition gets accepted by the prover!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-second-solution">üöÄ Second solution<a href="https://formal.land/blog/2024/12/26/mutually-recursive-functions-with-notation#-second-solution" class="hash-link" aria-label="Direct link to üöÄ Second solution" title="Direct link to üöÄ Second solution">‚Äã</a></h2>
<p>An issue is that we cannot call <code>sum_trees</code> directly as its definition is hidden in the one of <code>sum_tree</code>. This is a problem if further top-level definitions depend on <code>sum_trees</code>, or if we want to verify intermediate properties about <code>sum_trees</code> itself.</p>
<p>A solution we use for this kind of problem is to add a notation to make <code>sum_trees</code> a top-level definition while keeping the mutual recursion with <code>sum_tree</code>:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Reserved</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"'sum_trees"</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Fixpoint</span><span class="token plain"> sum_tree </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> nat</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Tree A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nat </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> t </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Leaf </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Node a ts </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> f a </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">'</span><span class="token plain">sum_trees </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> f ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"'sum_trees"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fix</span><span class="token plain"> sum_trees </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> nat</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ts </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Trees A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nat </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> ts </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> nil </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ts </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> sum_tree f t </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> sum_trees </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> f ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> sum_trees </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">'</span><span class="token plain">sum_trees A</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here, both <code>sum_tree</code> and <code>sum_trees</code> are defined as top-level, and the mutually recursive definition is accepted. Note that we have to make the type <code>A</code> explicit in the notation, as implicit parameters are not allowed there.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-conclusion">‚úíÔ∏è Conclusion<a href="https://formal.land/blog/2024/12/26/mutually-recursive-functions-with-notation#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to ‚úíÔ∏è Conclusion" title="Direct link to ‚úíÔ∏è Conclusion">‚Äã</a></h2>
<p>We have shown a technique that is sometimes useful for us to define complex, mutually dependent data structures. This was recently useful for defining the <code>ValueImpl</code> type in the type-checker of <a href="https://sui.io/move" target="_blank" rel="noopener noreferrer">Move</a> for the blockchain <a href="https://sui.io/" target="_blank" rel="noopener noreferrer">Sui</a>.</p>
<p>You can tell us what you think or if you prefer another way to define mutually recursive functions!</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions or requests!</em></p></div></div>]]></content>
        <category label="recursion" term="recursion"/>
        <category label="notation" term="notation"/>
        <category label="mutual" term="mutual"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[üëª Translation of Circom to Coq]]></title>
        <id>https://formal.land/blog/2024/12/20/translation-of-circom-to-coq</id>
        <link href="https://formal.land/blog/2024/12/20/translation-of-circom-to-coq"/>
        <updated>2024-12-20T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[In this post, we present the beginning of our work to translate programs written in the Circom circuit language to the üêì&nbsp;Coq proof assistant. This work is part of our research on the formal verification of zero-knowledge systems.]]></summary>
        <content type="html"><![CDATA[<p>In this post, we present the beginning of our work to translate programs written in the <a href="https://iden3.io/circom" target="_blank" rel="noopener noreferrer">Circom</a> circuit language to the <a href="https://coq.inria.fr/" target="_blank" rel="noopener noreferrer">üêì&nbsp;Coq</a> proof assistant. This work is part of our research on the formal verification of zero-knowledge systems.</p>
<p>We will aim to write more regularly about what we are doing, even if the posts are then shorter. Here, we focus on the translation part for a simple example without defining a semantics for the generated Coq code.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Ask for the highest security!</div><div class="admonitionContent_BuS1"><p>To ensure your code is fully secure today, contact us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">&nbsp;üíåcontact@formal.land</a>!&nbsp;üöÄ</p><p>We exclusively focus on formal verification to offer you the highest degree of security for your application.</p><p>We are already working with some of the leading blockchain entities, such as:</p><ul>
<li>The <a href="https://ethereum.foundation/" target="_blank" rel="noopener noreferrer">Ethereum Foundation</a></li>
<li>The <a href="https://sui.io/about" target="_blank" rel="noopener noreferrer">Sui Foundation</a></li>
<li>Previously, the <a href="https://alephzero.org/" target="_blank" rel="noopener noreferrer">Aleph Zero</a> and <a href="https://tezos.com/" target="_blank" rel="noopener noreferrer">Tezos</a> foundations</li>
</ul></div></div>
<figure><p><img decoding="async" loading="lazy" alt="Forest" src="https://formal.land/assets/images/ghost-forest-4e04fc0aca09ad06a1370c3761f0b504.webp" width="1024" height="1024" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-the-circom-language">üëª The Circom language<a href="https://formal.land/blog/2024/12/20/translation-of-circom-to-coq#-the-circom-language" class="hash-link" aria-label="Direct link to üëª The Circom language" title="Direct link to üëª The Circom language">‚Äã</a></h2>
<p>This is a language to write composable and optimized zero-knowledge circuits. It has been in use for quite some time, and there are a lot of examples of Circom programs implementing common cryptographic primitives, such as hash functions. See, for example, the <a href="https://github.com/iden3/circomlib" target="_blank" rel="noopener noreferrer">github.com/iden3/circomlib</a> repository. It is quoted by many projects, see for example this blog post <a href="https://www.mystenlabs.com/blog/how-zklogin-made-cryptography-faster-and-more-secure" target="_blank" rel="noopener noreferrer">How zkLogin Made Cryptography Faster and More Secure</a> of the development team of [Sui](How zkLogin Made Cryptography Faster and More Secure) mentioning Circom.</p>
<p>Here is the example which we consider to add <code>ops</code> numbers of <code>n</code> bits:</p>
<div class="language-circom codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-circom codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">function nbits(a) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var n = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var r = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    while (n-1&lt;a) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        r++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        n *= 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return r;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">template BinSum(n, ops) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var nout = nbits((2**n -1)*ops);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    signal input in[ops][n];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    signal output out[nout];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var lin = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var lout = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var k;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var j;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var e2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    e2 = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (k=0; k&lt;n; k++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (j=0; j&lt;ops; j++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            lin += in[j][k] * e2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        e2 = e2 + e2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    e2 = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (k=0; k&lt;nout; k++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        out[k] &lt;-- (lin &gt;&gt; k) &amp; 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Ensure out is binary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        out[k] * (out[k] - 1) === 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lout += out[k] * e2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        e2 = e2+e2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Ensure the sum;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lin === lout;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You can find this example in <a href="https://github.com/iden3/circomlib/blob/master/circuits/binsum.circom" target="_blank" rel="noopener noreferrer">github.com/iden3/circomlib/blob/master/circuits/binsum.circom</a>.</p>
<p>It contains a function <code>nbits</code> to compute the number of bits needed to represent a number, and a template <code>BinSum</code> to add <code>ops</code> numbers of <code>n</code> bits. The function <code>bits</code> does not make any operations related to zero-knowledge. It is a simple imperative function with a loop and mutable variables <code>n</code> and <code>r</code>.</p>
<p>The template <code>BinSum</code> defines what is required to instantiate a new component, with input signals <code>in</code> and output signals <code>out</code>. With the equality assertion <code>===</code> it ensures that the output signals must be the bits of the sum of the input signals, and cannot be anything else. This is the property that we will want to formally verify to ensure that it is not possible to provide a proof of this circuit which does not compute the addition. This is called verifying that the circuit is not <em>underconstrained</em>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-the-coq-proof-assistant">üêì The Coq proof assistant<a href="https://formal.land/blog/2024/12/20/translation-of-circom-to-coq#-the-coq-proof-assistant" class="hash-link" aria-label="Direct link to üêì The Coq proof assistant" title="Direct link to üêì The Coq proof assistant">‚Äã</a></h2>
<p>The <a href="https://coq.inria.fr/" target="_blank" rel="noopener noreferrer">Coq proof assistant</a>, which we use exclusively at <a href="https://formal.land/" target="_blank" rel="noopener noreferrer">Formal Land</a>, is a generic formal verification system. You can use it to verify any kind of maths or programs. You can never be stuck in the verification of a property, thanks to its interactive mode to refine proofs step by step. You can express almost any kind of property as it is based on the very expressive <a href="https://en.wikipedia.org/wiki/Calculus_of_constructions" target="_blank" rel="noopener noreferrer">Calculus Of Constructions</a> logic.</p>
<p>Its community focuses a lot on the verification of programs, the most notable example being the full verification of the C compiler <a href="https://compcert.org/" target="_blank" rel="noopener noreferrer">CompCert</a>.</p>
<p>Our strategy is always the same: finding a nice embedding of a language in Coq, so that we can formally verify programs written in this language and reuse all the existing Coq tools and libraries.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-translation-of-circom-to-coq">üöÄ Translation of Circom to Coq<a href="https://formal.land/blog/2024/12/20/translation-of-circom-to-coq#-translation-of-circom-to-coq" class="hash-link" aria-label="Direct link to üöÄ Translation of Circom to Coq" title="Direct link to üöÄ Translation of Circom to Coq">‚Äã</a></h2>
<p>The Circom compiler is written in <a href="https://www.rust-lang.org/" target="_blank" rel="noopener noreferrer">ü¶Ä&nbsp;Rust</a>. Generally, a compiler is composed of many intermediate languages, starting from a language that is essentially a representation of what the parser returns, down to some form of assembly or circuit language.</p>
<p>If you translate a high-level intermediate language to a proof system, you retain a lot of information from the original program and the specifications/proofs tend to be simpler. If you translate a low-level language, the translation itself will be simpler and more trustworthy, but the verification part will be harder. As Circom is a rather small language (compared to a full programming language), we choose to translate its high-level representation to Coq.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="to-json">To JSON<a href="https://formal.land/blog/2024/12/20/translation-of-circom-to-coq#to-json" class="hash-link" aria-label="Direct link to To JSON" title="Direct link to To JSON">‚Äã</a></h3>
<p>We write our translation tool in üêç&nbsp;Python for simplicity, reading a JSON export of the <a href="https://github.com/iden3/circom/blob/master/program_structure/src/abstract_syntax_tree/ast.rs" target="_blank" rel="noopener noreferrer">abstract syntax tree</a> of Circom. The quickest way to export data from Rust is to use the <a href="https://serde.rs/" target="_blank" rel="noopener noreferrer">Serde</a> to generate pretty-printing functions to JSON. We have done it in this <a href="https://github.com/formal-land/circom/pull/1" target="_blank" rel="noopener noreferrer">pull request</a> from a fork of the Circom compiler.</p>
<p>Here is, for example, the beginning of the JSON version of the <code>nbits</code> function above:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token property" style="color:#36acaa">"Function"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"meta"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"nbits"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"args"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"a"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"arg_location"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"start"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1571</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"end"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1572</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"body"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"Block"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">"meta"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">"stmts"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"InitializationBlock"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"meta"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"xtype"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Var"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"initializations"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"Declaration"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token property" style="color:#36acaa">"meta"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token property" style="color:#36acaa">"xtype"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Var"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token property" style="color:#36acaa">"name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"n"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token property" style="color:#36acaa">"dimensions"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token property" style="color:#36acaa">"is_constant"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"Substitution"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token property" style="color:#36acaa">"meta"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token property" style="color:#36acaa">"var"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"n"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token property" style="color:#36acaa">"access"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token property" style="color:#36acaa">"op"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"AssignVar"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token property" style="color:#36acaa">"rhe"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"Number"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="to-coq">To Coq<a href="https://formal.land/blog/2024/12/20/translation-of-circom-to-coq#to-coq" class="hash-link" aria-label="Direct link to To Coq" title="Direct link to To Coq">‚Äã</a></h3>
<p>We iterate over each nodes of this JSON file to produce a corresponding Coq file with the Python script <a href="https://github.com/formal-land/garden/blob/main/scripts/coq_of_circom.py" target="_blank" rel="noopener noreferrer">scipts/coq_of_circom.py</a>. Here is a short extract from this script:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">"""</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">pub enum Access {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    ComponentAccess(String),</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    ArrayAccess(Expression),</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">"""</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">to_coq_access</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ComponentAccess"</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> node</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f"Access.Component (</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">node</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">[</span><span class="token string-interpolation interpolation string" style="color:#e3116c">'ComponentAccess'</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">]</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">)"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ArrayAccess"</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> node</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f"Access.Array (</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">to_coq_expression</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">node</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">[</span><span class="token string-interpolation interpolation string" style="color:#e3116c">'ArrayAccess'</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">]</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">)"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f"Unknown access: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">node</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>For every node type in the Circom AST, we copy its Rust type in triple quotes in Python and let GitHub Copilot write a conversion function, which we complete and fix by hand. That way, we quickly cover all syntax with a reasonable Coq output.</p>
<p>We put all the code of our translation in a monad in Coq to represent the side effects, which are mainly here:</p>
<ul>
<li>imperative effects such as mutations and potentially non-terminating loops,</li>
<li>the instantiation of components with signals, and the enforcement of the equality constraints.</li>
</ul>
<p>Here is the Coq translation for the Circom example above, given in <a href="https://github.com/formal-land/garden/blob/main/Garden/Circom/Example/binsum.v" target="_blank" rel="noopener noreferrer">Garden/Circom/Example/binsum.v</a>:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">(* Function *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> nbits </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">function_body </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">(* Var *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">declare_var </span><span class="token string" style="color:#e3116c">"n"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"n"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">(* Var *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">declare_var </span><span class="token string" style="color:#e3116c">"r"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"r"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">while </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lesser </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sub </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"n"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"a"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"r"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"r"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"n"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mul </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"n"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pure BlockUnit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">return_ </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"r"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pure BlockUnit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">(* Template *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> BinSum </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n ops </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t BlockUnit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(* Var *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">declare_var </span><span class="token string" style="color:#e3116c">"nout"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"nout"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> nbits </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mul </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sub </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pow </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"n"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ops"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(* Signal Input *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">declare_signal </span><span class="token string" style="color:#e3116c">"in"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ops"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"n"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(* Signal Output *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">declare_signal </span><span class="token string" style="color:#e3116c">"out"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"nout"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(* Var *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">declare_var </span><span class="token string" style="color:#e3116c">"lin"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"lin"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(* Var *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">declare_var </span><span class="token string" style="color:#e3116c">"lout"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"lout"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(* Var *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">declare_var </span><span class="token string" style="color:#e3116c">"k"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"k"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(* Var *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">declare_var </span><span class="token string" style="color:#e3116c">"j"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"j"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(* Var *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">declare_var </span><span class="token string" style="color:#e3116c">"e2"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"e2"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"e2"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"k"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">while </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lesser </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"k"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"n"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"j"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">while </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lesser </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"j"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ops"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"lin"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"lin"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mul </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var_access </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"in"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Access</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Array </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"j"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> Access</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Array </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"k"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"e2"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"j"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"j"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pure BlockUnit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"e2"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"e2"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"e2"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"k"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"k"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pure BlockUnit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"e2"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"k"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">while </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lesser </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"k"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"nout"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"out"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bitand </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">shiftr </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"lin"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"k"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">equality_constraint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mul </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var_access </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"out"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Access</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Array </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"k"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sub </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var_access </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"out"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Access</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Array </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"k"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"lout"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"lout"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mul </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var_access </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"out"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Access</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Array </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"k"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"e2"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"e2"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"e2"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"e2"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">substitute_var </span><span class="token string" style="color:#e3116c">"k"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> InfixOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"k"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pure BlockUnit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">equality_constraint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"lin"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"lout"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pure BlockUnit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tt</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you compare the translated code to the original Circom code, you will see that the two are very similar, up to a more verbose syntax in Coq. This is because we translate the high-level representation of Circom to Coq.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="free-monad">Free monad<a href="https://formal.land/blog/2024/12/20/translation-of-circom-to-coq#free-monad" class="hash-link" aria-label="Direct link to Free monad" title="Direct link to Free monad">‚Äã</a></h3>
<p>Even if we do not define the Circom semantics for now, we need to write a few Coq definitions so that the code above can be type-checked. As in the translations we make for other languages, we use a free-monad to represent side effects. This is convenient, as we can first express which are the various "special" operators of the language (declaring a signal, instantiating a template, ...) and define their behavior in a second step. The behavior might be defined in a computational or relational way later.</p>
<p>The definitions of the monad are in <a href="https://github.com/formal-land/garden/blob/main/Garden/Garden.v" target="_blank" rel="noopener noreferrer">Garden/Garden.v</a>. Here is an extract:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Primitive</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(** We group together primitives that share being impure functions operating over the state. *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> OpenScope </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t unit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CloseScope </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t unit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> DeclareVar </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t unit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> DeclareSignal </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dimensions </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t unit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> SubstituteVar </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t unit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> GetVarAccess </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">access </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list Access</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> GetPrime </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> EqualityConstraint </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value1 value2 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t unit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Primitive</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>These are some of the primitives from the Circom language, which we needed for our example (we will add more as we cover more of the language). For example:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">|</span><span class="token plain"> DeclareVar </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t unit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>corresponds to the Circom construction:</p>
<div class="language-circom codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-circom codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">var n = 1;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>with <code>name</code> the string <code>"n"</code> and value the field element <code>1</code> in this case. We will use a scope of local variables for each function, as a dictionary from the name of the variable to its value. All local variables might be mutated. Compared to more complex languages, such as Rust, we do not need to handle the notion of pointer, simplifying many things.</p>
<p>Note that with the free monad, we only give the list of primitive operations with their signatures, but we have not yet defined how to evaluate them.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-conclusion">‚úíÔ∏è Conclusion<a href="https://formal.land/blog/2024/12/20/translation-of-circom-to-coq#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to ‚úíÔ∏è Conclusion" title="Direct link to ‚úíÔ∏è Conclusion">‚Äã</a></h2>
<p>We have seen to define a first translation from the Circom language to Coq, for one example, with the goal of having a translation that is well-typed.</p>
<p>In the following article, we will explore the definition of a meaning to the primitive operations of Circom, such as signals and constraints, in order to formally verify that the <code>BinSum</code> is correct.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions or requests!</em></p></div></div>]]></content>
        <category label="Circom" term="Circom"/>
        <category label="zero-knowledge" term="zero-knowledge"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[ü¶Ñ How does formal verification of smart contracts work?]]></title>
        <id>https://formal.land/blog/2024/12/20/what-is-formal-verification-of-smart-contracts</id>
        <link href="https://formal.land/blog/2024/12/20/what-is-formal-verification-of-smart-contracts"/>
        <updated>2024-12-20T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[We make here a general presentation about how the formal verification of smart contracts works by explaining:]]></summary>
        <content type="html"><![CDATA[<p>We make here a general presentation about how the formal verification of smart contracts works by explaining:</p>
<ul>
<li>How people secure their smart contracts without formal verification.</li>
<li>How do formal tools typically work?</li>
<li>How our solution <a href="https://github.com/formal-land/coq-of-solidity" target="_blank" rel="noopener noreferrer">coq-of-solidity</a> works on a short example (an <a href="https://ethereum.org/en/developers/docs/standards/tokens/erc-20/" target="_blank" rel="noopener noreferrer">ERC-20</a> contract).</li>
<li>Where LLMs could be the most useful, according to us, for formal verification work.</li>
</ul>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Ask for the highest security!</div><div class="admonitionContent_BuS1"><p>To ensure your code is fully secure today, contact us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">&nbsp;üíåcontact@formal.land</a>!&nbsp;üöÄ</p><p>Formal verification goes further than traditional audits to make 100% sure you cannot lose your funds, thanks to <strong>mathematical reasoning on the code</strong>. It can also be integrated into your CI pipeline to check that every commit is fully correct <strong>without doing a whole audit again</strong>.</p><p>We are already working with some of the leading blockchain entities such as:</p><ul>
<li>The <a href="https://ethereum.foundation/" target="_blank" rel="noopener noreferrer">Ethereum Foundation</a></li>
<li>The <a href="https://sui.io/about" target="_blank" rel="noopener noreferrer">Sui Foundation</a></li>
<li>Previously, the <a href="https://alephzero.org/" target="_blank" rel="noopener noreferrer">Aleph Zero</a> and <a href="https://tezos.com/" target="_blank" rel="noopener noreferrer">Tezos</a> foundations</li>
</ul></div></div>
<figure><p><img decoding="async" loading="lazy" alt="Forest" src="https://formal.land/assets/images/forest-0a74e8da62e88c6ace8cd983fb4c22f2.webp" width="1792" height="1024" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-securing-smart-contracts-the-common-way">üõ°Ô∏è Securing smart contracts, the common way<a href="https://formal.land/blog/2024/12/20/what-is-formal-verification-of-smart-contracts#%EF%B8%8F-securing-smart-contracts-the-common-way" class="hash-link" aria-label="Direct link to üõ°Ô∏è Securing smart contracts, the common way" title="Direct link to üõ°Ô∏è Securing smart contracts, the common way">‚Äã</a></h2>
<p>Smart contracts are short programs, typically less than 5,000 lines of code, running "on the blockchain" to implement transaction rules. Examples can be virtual marketplaces to trade cryptocurrencies, virtual dollar coins, traceability databases, and NFTs, ... Most of the smart contracts are written in <a href="https://soliditylang.org/" target="_blank" rel="noopener noreferrer">Solidity</a>, a JavaScript-like language, and some are in <a href="https://www.rust-lang.org/" target="_blank" rel="noopener noreferrer">Rust</a>.</p>
<p>To know what a smart contract looks like, you can find a list of the biggest ones (in terms of users) on <a href="https://github.com/shafu0x/awesome-smart-contracts" target="_blank" rel="noopener noreferrer">shafu0x/awesome-smart-contracts</a>. A popular library to write smart contracts is <a href="https://www.openzeppelin.com/solidity-contracts" target="_blank" rel="noopener noreferrer">OpenZeppelin</a>. You can also search for the <a href="https://github.com/search?q=lang%3ASolidity%20&amp;type=repositories" target="_blank" rel="noopener noreferrer">Solidity language</a> on GitHub to find repositories with Solidity code.</p>
<p>Smart contracts are most of the time open-source, as it is important for the users to know what are the rules which handle their money. If a contract is not open-source, <em>it is probably a scam</em>.</p>
<p>Securing smart contracts is very important as a single bug can mean that an attacker can steal all the funds of the users who deposited money on the contract, or just block it to compromise the service. Millions of dollars are stolen every month due to bugs in the contracts, and some projects almost lose everything in such attacks. An historically important attack is the <a href="https://www.gemini.com/fr-fr/cryptopedia/the-dao-hack-makerdao" target="_blank" rel="noopener noreferrer">DAO hack</a> where $60 million was stolen, leading to a hard fork of the <a href="https://ethereum.org/" target="_blank" rel="noopener noreferrer">Ethereum</a> blockchain.</p>
<p>Now, how do people secure their code? First of all, most projects are well aware that software security is important, and if they want to raise money or advertise their product, they need to show that they are secure. They typically do the following:</p>
<ul>
<li><strong>Audits</strong> Projects require a few audits, which are made by specialized companies or individuals, to review the code of a smart contract and find bugs or vulnerabilities. The issues are classified into categories of importance: informational, low, medium, high, or critical. The highest categories mean it is possible to steal all of the funds. Lower categories are more remarks about the coding style/missing documentation. At the end of an audit, a <strong>report</strong> is published together with the corrections for the vulnerabilities that were discovered. As an example, <a href="https://github.com/trailofbits/publications/tree/master/reviews" target="_blank" rel="noopener noreferrer">here</a> is a list of audit reports from the company <a href="https://www.trailofbits.com/" target="_blank" rel="noopener noreferrer">Trail of Bits</a>.</li>
<li><strong>Competitions</strong> They enable anyone, during a pre-defined period of time of like a month, to look for bugs in a smart contract. At the end of the competition, a price pot is shared among the persons who found the most bugs. A typical price pot is $100,000, and some large competitions can go above $1,000,000&nbsp;üí∞. You can see the list of all ongoing competitions on <a href="https://www.dailywarden.com/" target="_blank" rel="noopener noreferrer">www.dailywarden.com</a>.</li>
<li><strong>Bounties</strong> Finally, bounties are like competitions but always live. The aim is to reward critical vulnerabilities, such that there is an incentive to report a bug instead of exploiting it. A popular platform is <a href="https://immunefi.com/" target="_blank" rel="noopener noreferrer">Immunefi</a>.</li>
</ul>
<p>To give an idea of the amounts that are at risk of attacks on the blockchain, the total valuation of Ethereum, the main smart contracts platform, is estimated at more than 300 Billion dollars! Attacks are believed to be mainly done by üá∞üáµ&nbsp;North Korean agents, but sometimes they happen to be single, clever individuals.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-formal-verification-tools">üõ†Ô∏è Formal verification tools<a href="https://formal.land/blog/2024/12/20/what-is-formal-verification-of-smart-contracts#%EF%B8%8F-formal-verification-tools" class="hash-link" aria-label="Direct link to üõ†Ô∏è Formal verification tools" title="Direct link to üõ†Ô∏è Formal verification tools">‚Äã</a></h2>
<p>So, where does formal verification stand in all that?</p>
<p>As it is the idea to mathematically reason about code to show the total absence of bugs in a protocol, formal verification seems to be the ideal tool to ensure the absence of vulnerabilities in a smart contract. In fact, most popular platforms do not take the risk of deploying new versions without a formal verification step, mainly with the leading tool <a href="https://www.certora.com/" target="_blank" rel="noopener noreferrer">Certora</a>.</p>
<p>As the verification is, at the end of the day, a mathematical proof, we can be sure that the code is correct for any possible user inputs, for a given and explicit <em>specification</em>. In addition, when the code changes, there is no need to review everything again: you can just formally verify the code that changed, as you would do when writing tests. This saves you time and money.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-limitations">üöß Limitations<a href="https://formal.land/blog/2024/12/20/what-is-formal-verification-of-smart-contracts#-limitations" class="hash-link" aria-label="Direct link to üöß Limitations" title="Direct link to üöß Limitations">‚Äã</a></h2>
<p>So, what are the limitations? Here are a few:</p>
<ul>
<li><strong>Cost</strong> You need to pay more than with traditional audits. Although the rewards are probably there, given the quantity of funds at risk in a smart contract, many small companies take the risk.</li>
<li><strong>Time</strong> Sometimes, time is an issue, even if the verification can be done in a continuous manner.</li>
<li><strong>Specification</strong> You still to have write the correct specification of your code! This is what defines what is a bug and what is a feature.</li>
<li><strong>Complexity</strong> Formal verification requires some specific knowledge which most developers do not have (This is why we are here to help you!&nbsp;üòÑ).</li>
</ul>
<p>Another one is completeness. Some formal verification tools aim to <em>fully automate</em> the proof part, so that you only need to write the specifications. But then:</p>
<ul>
<li>Some properties are unprovable, or need to be cut into smaller ones in non-trivial ways.</li>
<li>Some parts of the code are not verified. Typically, loops are only unrolled a few times (two or three times), instead of covering all the possible iterations.</li>
<li>Some properties cannot even be expressed!</li>
</ul>
<p>This is a <em>real</em> concern, according to the security teams of a few blockchain companies we talked to. Popular tools such as Certora or <a href="https://github.com/a16z/halmos" target="_blank" rel="noopener noreferrer">Halmos</a> fall into this category.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-how-to-do-better">üåü How to do better?<a href="https://formal.land/blog/2024/12/20/what-is-formal-verification-of-smart-contracts#-how-to-do-better" class="hash-link" aria-label="Direct link to üåü How to do better?" title="Direct link to üåü How to do better?">‚Äã</a></h2>
<p>Using interactive theorem provers, such as <a href="https://coq.inria.fr/" target="_blank" rel="noopener noreferrer">üêì&nbsp;Coq</a> or Lean, you overcome the limitations of automated provers as presented above. Here are a few tools you can use:</p>
<ul>
<li><a href="https://github.com/formal-land/coq-of-solidity" target="_blank" rel="noopener noreferrer">coq-of-solidity</a> using the Coq theorem prover. This is the tool we made!&nbsp;üéâ</li>
<li><a href="https://github.com/NethermindEth/Clear" target="_blank" rel="noopener noreferrer">Clear</a> using the Lean theorem prover. This is a tool made by the company <a href="https://nethermind.io/" target="_blank" rel="noopener noreferrer">Nethermind</a>.</li>
</ul>
<p><a href="https://kontrol.runtimeverification.com/" target="_blank" rel="noopener noreferrer">Kontrol</a> from Runtime Verification is another verification tool providing ways to go further than automated tools.</p>
<p>For the question of correct and complete specifications, here is our idea:</p>
<blockquote>
<p>Build a set of high-level primitives encoding ideas such as "identity", "value", "ownership", "exact calculation", ... which are not necessarily definable in a programming language but can be axiomatized in a proof system. Use them to give the business rules of a contract in a clear manner and to express meta-properties such as "it is impossible to steal"&nbsp;üöì.</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-technical-pipeline">üîß Technical pipeline<a href="https://formal.land/blog/2024/12/20/what-is-formal-verification-of-smart-contracts#-technical-pipeline" class="hash-link" aria-label="Direct link to üîß Technical pipeline" title="Direct link to üîß Technical pipeline">‚Äã</a></h2>
<p>Solidity is a complex language. All the tools we mentioned above translate the code into a formal language to reason about it. They never take the Solidity code as it is. Instead, they first translate it to a simpler language, generally EVM bytecode (the assembly language for Solidity) or <a href="https://docs.soliditylang.org/en/latest/yul.html" target="_blank" rel="noopener noreferrer">Yul</a> which is slightly higher level.</p>
<p>Then, they run several steps to first "üßº&nbsp;clean up the code" and obtain a representation that is high-level again. See, for example, the <a href="https://dl.acm.org/doi/10.1145/3689796" target="_blank" rel="noopener noreferrer">Practical Verification of Smart Contracts using Memory Splitting</a> article from Certora about optimizing the memory representation of EVM code to retrieve some properties from the Solidity representation.</p>
<p>In <code>coq-of-solidity</code>, we call this step of going from low-level to high-level writing a "simulation", which is a high-level representation of the low-level code. This task is time-consuming. An alternative would be to use LLMs to generate it. We can check that the simulation is equivalent to the low-level version, either by writing a formal proof or by testing.</p>
<p>As an example, here is what we get for the verification of an ERC-20 smart contract with <code>coq-of-solidity</code> (you can click on the links to see the code):</p>
<ul>
<li><a href="https://github.com/formal-land/coq-of-solidity/blob/develop/coq/CoqOfSolidity/contracts/erc20/contract.sol" target="_blank" rel="noopener noreferrer">the ERC-20 Solidity contract</a></li>
<li><a href="https://github.com/formal-land/coq-of-solidity/blob/develop/coq/CoqOfSolidity/contracts/erc20/contract.yul" target="_blank" rel="noopener noreferrer">the low-level version (in Yul, generated)</a></li>
<li><a href="https://github.com/formal-land/coq-of-solidity/blob/develop/coq/CoqOfSolidity/contracts/erc20/shallow.v" target="_blank" rel="noopener noreferrer">the Coq translation of the low-level version (generated)</a></li>
<li><a href="https://github.com/formal-land/coq-of-solidity/blob/develop/coq/CoqOfSolidity/contracts/erc20/simulations/contract.v" target="_blank" rel="noopener noreferrer">the simulation in Coq (hand-written)</a></li>
<li><a href="https://github.com/formal-land/coq-of-solidity/blob/develop/coq/CoqOfSolidity/contracts/erc20/proofs/contract.v" target="_blank" rel="noopener noreferrer">the formal proof that the two are equivalent (hand-written)</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-use-cases-for-llms">üß† Use cases for LLMs<a href="https://formal.land/blog/2024/12/20/what-is-formal-verification-of-smart-contracts#-use-cases-for-llms" class="hash-link" aria-label="Direct link to üß† Use cases for LLMs" title="Direct link to üß† Use cases for LLMs">‚Äã</a></h2>
<p>Here are a few areas where LLMs can be useful:</p>
<ol>
<li>Writing formal <strong>specifications</strong> from the code of a smart contract, its documentation, and a dataset of known vulnerabilities. We can find such datasets on the Internet or by reading audits and competition reports.</li>
<li>Writing <strong>formal proofs</strong> for the specifications.</li>
<li>Writing a <strong>high-level representation</strong> of a smart contract in a formal system.</li>
<li>Writing a formal proof that a <strong>high-level representation is valid</strong>.</li>
</ol>
<p>The fact that most of the smart contracts are open-source should also help running learning algorithms. We hope to explore this area more in the future or give ideas to others.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-conclusion">‚úíÔ∏è Conclusion<a href="https://formal.land/blog/2024/12/20/what-is-formal-verification-of-smart-contracts#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to ‚úíÔ∏è Conclusion" title="Direct link to ‚úíÔ∏è Conclusion">‚Äã</a></h2>
<p>We have made a general presentation of security challenges around the deployment of smart contracts and how formal verification works and helps to secure smart contracts even more. We also presented a few ways to potentially improve current tooling.</p>
<p>We hope that this article will help you understand the importance of formal verification and how it can be used to secure your smart contracts. Please contact us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">&nbsp;üíåcontact@formal.land</a> if you need formal verification services or advice!</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions or requests!</em></p></div></div>]]></content>
        <category label="Solidity" term="Solidity"/>
        <category label="smart contract" term="smart contract"/>
        <category label="audit" term="audit"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[‚óºÔ∏è A formal verification tool for Noir ‚Äì 2]]></title>
        <id>https://formal.land/blog/2024/11/15/tool-for-noir-2</id>
        <link href="https://formal.land/blog/2024/11/15/tool-for-noir-2"/>
        <updated>2024-11-15T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[In this blog post, we continue our presentation about our formal verification tool for ‚óºÔ∏è&nbsp;Noir programs coq-of-noir. Noir is a Rust-like language to write programs designed to run efficiently in zero-knowledge environments. It has a growing popularity and a focus on providing optimized libraries for common needs, such as a base64 library using üß†&nbsp;field arithmetic that we use in this series of blog posts.]]></summary>
        <content type="html"><![CDATA[<p>In this blog post, we continue our presentation about our formal verification tool for <a href="https://noir-lang.org/" target="_blank" rel="noopener noreferrer">‚óºÔ∏è&nbsp;Noir</a> programs <a href="https://github.com/formal-land/coq-of-noir" target="_blank" rel="noopener noreferrer">coq-of-noir</a>. Noir is a Rust-like language to write programs designed to run efficiently in zero-knowledge environments. It has a growing popularity and a focus on providing optimized libraries for common needs, such as a <a href="https://github.com/noir-lang/noir_base64" target="_blank" rel="noopener noreferrer">base64</a> library using üß†&nbsp;field arithmetic that we use in this series of blog posts.</p>
<p>Here we present the details of our semantic rules to show that a Noir program has an expected behavior for any possible parameters. We focus, in particular, on our memory-handling approach and the definition of loops.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Require the strongest security!</div><div class="admonitionContent_BuS1"><p>To ensure your code is fully secure today, contact us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">&nbsp;üíåcontact@formal.land</a>!&nbsp;üöÄ</p><p>Formal verification goes further than traditional audits to make 100% sure you cannot lose your funds, thanks to <strong>mathematical reasoning on the code</strong>. It can be integrated into your CI pipeline to check that every commit is fully correct <strong>without doing a whole audit again</strong>.</p><p>We make bugs such as the <a href="https://www.gemini.com/fr-fr/cryptopedia/the-dao-hack-makerdao" target="_blank" rel="noopener noreferrer">DAO hack</a> ($60 million stolen) virtually <strong>impossible to happen again</strong>.</p></div></div>
<figure><p><img decoding="async" loading="lazy" alt="Noir" src="https://formal.land/assets/images/noir-568e4d7ad7afc47d7fe0ace944d49307.webp" width="1792" height="1024" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-semantic-rules">‚öôÔ∏è Semantic rules<a href="https://formal.land/blog/2024/11/15/tool-for-noir-2#%EF%B8%8F-semantic-rules" class="hash-link" aria-label="Direct link to ‚öôÔ∏è Semantic rules" title="Direct link to ‚öôÔ∏è Semantic rules">‚Äã</a></h2>
<p>In the previous blog post <a href="https://formal.land/blog/2024/11/01/tool-for-noir-1">‚óºÔ∏è A formal verification tool for Noir ‚Äì 1</a> we presented our general translation from the Noir syntax to <a href="https://coq.inria.fr/" target="_blank" rel="noopener noreferrer">üêì&nbsp;Coq</a>, as well as the free monad we use to represent side-effects such as mutations. We now need to define semantic rules to be able to say that a particular translated Noir program evaluates to a certain value.</p>
<p>For expressions that do not have side effects we rely on the usual reduction rules of Coq. This is really convenient as we can then reuse the existing Coq tactics and automation to reason about pure expressions.</p>
<p>For side-effects like mutations or function calls, which we also consider as side-effects as there might be infinite recursion, we use a big-step semantics with the following predicate:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state_in </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> e ‚áì output </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state_out </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It says that for a certain prime number&nbsp;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span> which is the size of the arithmetic field, for an initial state&nbsp;<code>state_in</code>, the expression&nbsp;<code>e</code> evaluates to the output&nbsp;<code>output</code> and the final state&nbsp;<code>state_out</code>.</p>
<p>We define this rule with a Coq <code>Inductive</code> with one case per case in our free monad for effects. This is similar to the work we have done for Rust with <a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">coq-of-rust</a>. Here are the relevant rules.</p>
<ul>
<li><code>Pure</code>
Expressions without side effects evaluate to their value and do not change the state. Note that in Coq, we do not distinguish between expressions and values, as all values are equal modulo evaluation rules, so we can directly use the expression as the output.<!-- -->
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Pure </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state_out </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pure output ‚áì output </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state_out </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li><code>GetFieldPrime</code>
To obtain the current size of the field&nbsp;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span> we use the <code>GetFieldPrime</code> primitive. This is a side-effect as it depends on the current settings to compile the Noir program in circuits. We use this operation as an internal operation to define the arithmetic operations in the field by computing modulo&nbsp;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span>.<!-- -->
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CallPrimitiveGetFieldPrime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state_in </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state_in </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> k p ‚áì output </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state_out </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state_in </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallPrimitive </span><span class="token keyword" style="color:#00009f">Primitive</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">GetFieldPrime k ‚áì output</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state_out </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<!-- -->We use a semantics by continuation with a continuation&nbsp;<code>k</code> for most of the operations of the monad. Instead of directly returning some result, we pass it to the continuation and evaluate it. In our experience, this simplifies the reasoning on code instead of having to use another monadic operation to pass this value.</li>
<li><code>CallClosure</code>
We define a closure as a function from a list of values to some monadic expression. In our translation, terms are totally untyped; in particular we do not enforce any arity for the functions. In case a wrong number of arguments is passed to a function, we will have a runtime error. This is a trade-off to keep the translation simple and to avoid having to define a type system for Noir.<!-- -->
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CallClosure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">args </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">output_inter </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state_in state_inter </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> closure </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Closure </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">existS </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state_in </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> f args ‚áì output_inter </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state_inter </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state_inter </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> k output_inter ‚áì output </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state_out </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state_in </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallClosure closure args k ‚áì output </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state_out </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<!-- -->To call a function, we first evaluate its body on the arguments and then the continuation&nbsp;<code>k</code>. If the result is some <code>output</code> and <code>state_out</code>, we can say that the whole expression evaluates to <code>output</code> and <code>state_out</code>.</li>
<li><code>Let</code>
The <code>Let</code> primitive is the monadic bind. It allows to sequentially compose the execution of two expressions. We first evaluate the first expression, then the second one with the result of the first one.<!-- -->
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Let</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">output_inter </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state_in state_inter </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state_in </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> e ‚áì output_inter </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state_inter </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state_inter </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> k output_inter ‚áì output </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state_out </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state_in </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Let</span><span class="token plain"> e k ‚áì output </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state_out </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-memory-handling">üêò Memory handling<a href="https://formal.land/blog/2024/11/15/tool-for-noir-2#-memory-handling" class="hash-link" aria-label="Direct link to üêò Memory handling" title="Direct link to üêò Memory handling">‚Äã</a></h2>
<p>In Noir, you can make a new variable mutable with the keyword <code>let mut</code>:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">u8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token class-name">InputElements</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token class-name">InputElements</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Then you can assign a new value to this variable or its content with the <code>=</code> operator:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Base64Decoder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input_byte </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token class-name">Field</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>There is basic pointer manipulation with the <code>&amp;</code> operator to get a reference to a variable and the <code>*</code> operator to dereference a pointer. You can even pass a mutable reference to a function to modify the value of a variable. There is no deallocation of memory, which entirely removes the need for a garbage collector or deallocation strategy. This is because Noir programs are supposed to be very short-lived.</p>
<p>To handle all expressions in a uniform way, we consider that each Noir expression is an address to its content. For most (intermediate) values, which are not mutable, the address is the value itself. For mutable values, we use a fresh address for each <code>let mut</code> assignment.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Thanks</div><div class="admonitionContent_BuS1"><p>As <a href="https://github.com/features/copilot" target="_blank" rel="noopener noreferrer">GitHub Copilot</a> correctly suggests me, this is similar to the approach we have taken for Rust in <code>coq-of-rust</code>. Thanks for following what we are doing!&nbsp;üôè</p></div></div>
<p>To simplify the proofs, we let the user input a memory model of its choice. The only constraint is to provide memory operations for <code>read</code>, <code>write</code>, and <code>alloc</code>, and to make sure that these operations are consistent. Once it is done, here are the rules for the memory handling of mutable references:</p>
<ul>
<li><code>StateAlloc</code>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CallPrimitiveStateAlloc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">address </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state_in state_in</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> pointer </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Pointer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Mutable </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pointer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Mutable</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Make address </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read address state_in </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> None </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc_write address state_in value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Some state_in</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state_in</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> k </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pointer pointer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> ‚áì output </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state_out </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state_in </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallPrimitive </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Primitive</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StateAlloc value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> k ‚áì output </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state_out </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li><code>StateRead</code>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CallPrimitiveStateRead</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">address </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state_in </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read address state_in </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Some value </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state_in </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> k value ‚áì output </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state_out </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state_in </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallPrimitive </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Primitive</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StateRead address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> k ‚áì output </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state_out </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li><code>StateWrite</code>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CallPrimitiveStateWrite</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">address </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> unit </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state_in state_in</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc_write address state_in value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Some state_in</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state_in</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> k tt ‚áì output </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state_out </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state_in </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallPrimitive </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Primitive</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StateWrite address value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> k ‚áì output</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state_out </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
<p>When using these rules to show that a certain Noir program evaluates to an expression, one has to make the right choice for the address used to allocate the value. This choice is arbitrary but can make the proof more or less complex later. The read and write operations are deterministic.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-loops">‚û∞ Loops<a href="https://formal.land/blog/2024/11/15/tool-for-noir-2#-loops" class="hash-link" aria-label="Direct link to ‚û∞ Loops" title="Direct link to ‚û∞ Loops">‚Äã</a></h2>
<p>There is only one kind of loop in Noir, bounded&nbsp;<code>for</code> loops:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">..</span><span class="token class-name">InputElements</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> input_byte </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> input</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    result</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Base64Decoder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input_byte </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token class-name">Field</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The index&nbsp;<code>i</code> evolves in between statically known bounds. As such, these bounds always terminate, which is a requirement for formal verification to proceed! As a result, we do not need to introduce a dedicated monadic primitive for the loops and can define them with a recursive function:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Fixpoint</span><span class="token plain"> for_nat </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">end_ </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fuel </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nat</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">body </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> fuel</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> fuel </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> O </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> pure </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tuple </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> S fuel</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> body </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">end_ </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">of_nat fuel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for_nat end_ fuel</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> body</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> for_Z </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">start end_ </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">body </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for_nat end_ </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_nat </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">end_ </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> start</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Note that we do not handle <code>break</code> or <code>continue</code> yet but propagate assert failures with <code>let*</code>. We <em>prove</em> the following reasoning rule for loops:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Lemma</span><span class="token plain"> For </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">State Address </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait State Address</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state_in </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">integer_kind </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">start </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">len </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nat</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">body </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Accumulator </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inject </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> Accumulator </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">accumulator_in </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Accumulator</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">body_expression </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> MS</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> Accumulator unit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">H_body </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">forall</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">accumulator_in </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Accumulator</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> output_accumulator_out </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> body_expression i accumulator_in </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inject state_in accumulator_in </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        body </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer integer_kind i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> ‚áì</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Panic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_result </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fst output_accumulator_out</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> inject state_in </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">snd output_accumulator_out</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> output_accumulator_out </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    foldS</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      tt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">List</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">map </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> offset </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> start </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">of_nat offset</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">List</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">seq </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> unit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> body_expression</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      accumulator_in </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inject state_in accumulator_in </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">for_</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer integer_kind start</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer integer_kind </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">start </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">of_nat len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      body ‚áì</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Panic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_result </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fst output_accumulator_out</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> inject state_in </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">snd output_accumulator_out</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It is a little bit involved but basically says that if the body of the loop evaluates to an expression for each possible iteration, then the whole loop evaluates to the recursive function <code>foldS!</code> using the modified memory as an accumulator.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-conclusion">‚úíÔ∏è Conclusion<a href="https://formal.land/blog/2024/11/15/tool-for-noir-2#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to ‚úíÔ∏è Conclusion" title="Direct link to ‚úíÔ∏è Conclusion">‚Äã</a></h2>
<p>We have shown how we define the semantic rules for the Noir language in Coq, for the general monadic primitives, memory, and loops.</p>
<p>In the next blog post, we will apply these reasoning principles to give a semantics to the <code>base64</code> library of Noir.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions or requests!</em></p></div></div>]]></content>
        <category label="Noir" term="Noir"/>
        <category label="smart contract" term="smart contract"/>
        <category label="circuits" term="circuits"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[ü¶Ä Example of verification for the Move's checker of Sui]]></title>
        <id>https://formal.land/blog/2024/11/14/sui-move-checker-abstract-stack</id>
        <link href="https://formal.land/blog/2024/11/14/sui-move-checker-abstract-stack"/>
        <updated>2024-11-14T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[We are continuing our formal verification work for the implementation of the type-checker of the Move language in the üíß&nbsp;Sui blockchain. We verify a manual translation in the proof system üêì&nbsp;Coq of the ü¶Ä&nbsp;Rust code of the Move checker as available on GitHub.]]></summary>
        <content type="html"><![CDATA[<p>We are continuing our formal verification work for the implementation of the type-checker of the <a href="https://sui.io/move" target="_blank" rel="noopener noreferrer">Move</a> language in the <a href="https://sui.io/" target="_blank" rel="noopener noreferrer">üíß&nbsp;Sui</a> blockchain. We verify a manual translation in the proof system <a href="https://coq.inria.fr/" target="_blank" rel="noopener noreferrer">üêì&nbsp;Coq</a> of the <a href="https://www.rust-lang.org/" target="_blank" rel="noopener noreferrer">ü¶Ä&nbsp;Rust</a> code of the Move checker as available on <a href="https://github.com/move-language/move-sui/tree/main/crates/move-bytecode-verifier" target="_blank" rel="noopener noreferrer">GitHub</a>.</p>
<p>In this blog post, we present in detail the verification of a particular function <code>AbstractStack::pop_eq_n</code> that manipulates üìö&nbsp;stacks of types to show that it is equivalent to its naive implementation.</p>
<p>All the code presented here is on our GitHub at <a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">github.com/formal-land/coq-of-rust</a> üßë‚Äçüè´.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Get started</div><div class="admonitionContent_BuS1"><p>To ensure your code is secure today, contact us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">&nbsp;üíåcontact@formal.land</a>!&nbsp;üöÄ</p><p>Formal verification goes further than traditional audits to make 100% sure you cannot lose your funds, thanks to <strong>mathematical reasoning on the code</strong>. It can be integrated into your CI pipeline to check that every commit is fully correct <strong>without doing a whole audit again</strong>.</p><p>We make bugs such as the <a href="https://www.gemini.com/fr-fr/cryptopedia/the-dao-hack-makerdao" target="_blank" rel="noopener noreferrer">DAO hack</a> ($60 million stolen) virtually <strong>impossible to happen again</strong>.</p></div></div>
<figure><p><img decoding="async" loading="lazy" alt="Water in forest" src="https://formal.land/assets/images/water-in-forest-c6f1a042b20e0b0ef9d33cd340ebdb01.webp" width="1792" height="1024" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-the-code-to-verify">üïµÔ∏è The code to verify<a href="https://formal.land/blog/2024/11/14/sui-move-checker-abstract-stack#%EF%B8%8F-the-code-to-verify" class="hash-link" aria-label="Direct link to üïµÔ∏è The code to verify" title="Direct link to üïµÔ∏è The code to verify">‚Äã</a></h2>
<p>Here is the definition in Rust of an <code>AbstractStack</code>, from the file <a href="https://github.com/move-language/move-sui/blob/main/crates/move-abstract-stack/src/lib.rs" target="_blank" rel="noopener noreferrer">move-abstract-stack/src/lib.rs</a>:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/// An abstract value that compresses runs of the same value to reduce space usage</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">AbstractStack</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    values</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    len</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It says that a stack of elements of type&nbsp;<code>T</code> is a vector of pairs of a number and a value. The number is the number of times the value is repeated in the stack. The field&nbsp;<code>len</code> is the total number of elements in the stack. This representation is more efficient than a naive stack, in case the stack contains many repeated values.</p>
<p>Here is one of the primitives to remove elements from this stack:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/// Pops n values off the stack, erroring if there are not enough items or if the n items are</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/// not equal</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">pop_eq_n</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> n</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">NonZeroU64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">AbsStackError</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> n</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> n</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">is_empty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> n </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">len </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">Err</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">AbsStackError</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Underflow</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">count</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> last</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">last_mut</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">unwrap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property" style="color:#36acaa">debug_assert!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">count </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">count</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">cmp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">n</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Ordering</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Less</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">Err</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">AbsStackError</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">ElementNotEqual</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Ordering</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Equal</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> last</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">pop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">unwrap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            last</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Ordering</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Greater</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">count </span><span class="token operator" style="color:#393A34">-=</span><span class="token plain"> n</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            last</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">len </span><span class="token operator" style="color:#393A34">-=</span><span class="token plain"> n</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This function removes <code>n</code> elements from the stack, returning the value of removed elements. It returns an error if there are not enough elements in the stack or if the <code>n</code> last items are not grouped as equal elements.</p>
<p>Our goal is to <strong>show that this function is equal to the naive pop function with repetition</strong> on flattened stacks.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-specification">‚öñÔ∏è Specification<a href="https://formal.land/blog/2024/11/14/sui-move-checker-abstract-stack#%EF%B8%8F-specification" class="hash-link" aria-label="Direct link to ‚öñÔ∏è Specification" title="Direct link to ‚öñÔ∏è Specification">‚Äã</a></h2>
<p>Here is the property we want to verify in the formal language Coq:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Lemma</span><span class="token plain"> flatten_pop_eq_n </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Eq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait A</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stack </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AbstractStack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">H_n </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> n </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> AbstractStack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pop_eq_n n stack </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Panic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Value </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ok item</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> stack</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flatten stack </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> List</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">repeat item </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_nat n</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> flatten stack</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It says that for any possible <code>stack</code> and <code>n</code> greater than 0, if we remove <code>n</code> elements from the stack and when the execution succeeds, the flattened stack is equal to the repetition of the removed element <code>n</code> times followed by the flattened stack.</p>
<p>How did we get from the Rust code above to the expression of this property? We manually converted the Rust code above in Coq with the following definitions:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> AbstractStack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Record</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    values </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Z </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    len </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>for the <code>AbstractStack</code> type, and:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> pop_eq_n </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> MS</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t A AbsStackError</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">is_empty self </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> len self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">bool </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Err AbsStackError</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Underflow</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">count</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> last</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Option</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">unwrap </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">List</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hd_error self</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">values</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> count </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> n </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Err AbsStackError</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ElementNotEqual</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> count </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> n </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> values</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> vec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pop_front self</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">values</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> self </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punct punctuation" style="color:#393A34">{|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      values </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> values</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      len </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> n</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ok last</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> values </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> values self </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> panic</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"unreachable"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> last</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> values </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">count </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> n</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> last</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> values</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">end</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> self </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punct punctuation" style="color:#393A34">{|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      values </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> values</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      len </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> n</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ok last</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>for the <code>pop_eq_n</code> function. Note that this definition uses a lot of user-defined notations, such as <code>let!</code>, that we made in order to simplify the expression of effects in Coq. You can read more about these notations on our previous blog post <a href="https://formal.land/blog/2024/10/14/verification-move-sui-type-checker-2">ü¶Ä&nbsp;Formal verification of the type checker of Sui ‚Äì part 2</a>. We checked by testing that our translation above behaves as the original Rust code, as explained in our blog post <a href="https://formal.land/blog/2024/10/15/verification-move-sui-type-checker-3">ü¶Ä&nbsp;Formal verification of the type checker of Sui ‚Äì part 3</a>. It is not necessary to understand the translation in detail, as its verification will flow naturally.</p>
<p>We define the <code>flatten</code> function to translate a stack with repetitions to a flat stack as:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> flatten </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">abstract_stack </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AbstractStack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list A </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  List</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flat_map </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> List</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">repeat v </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_nat n</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> abstract_stack</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">AbstractStack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It duplicates all the elements&nbsp;<code>n</code> times with <code>List.repeat v (Z.to_nat n)</code> and concatenates them with <code>List.flat_map</code>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-proof">ü§ì Proof<a href="https://formal.land/blog/2024/11/14/sui-move-checker-abstract-stack#-proof" class="hash-link" aria-label="Direct link to ü§ì Proof" title="Direct link to ü§ì Proof">‚Äã</a></h2>
<p>To show that the specification above is correct for any stacks, we cannot test it as it will only cover a finite amount of cases. We must write a Coq proof showing by mathematical reasoning that the code is always correct.</p>
<p>Here is our full proof:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Proof</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  destruct stack </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">stack</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unfold AbstractStack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pop_eq_n</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> flatten</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(* if (is_empty self || (n &gt;? len self))%bool then *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  destruct </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">_</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> simpl</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">reflexivity</span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unfold List</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hd_error</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(* Option.unwrap (List.hd_error self.(values)) *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  destruct stack </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">count last</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> stack</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> simpl</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">reflexivity</span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(* if count &lt;? n then *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  destruct </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> n</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">Z eqn</span><span class="token punctuation" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> simpl</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">reflexivity</span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(* if count =? n then *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  destruct </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> n</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">Z eqn</span><span class="token punctuation" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> simpl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> now replace n </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> count </span><span class="token keyword" style="color:#00009f">by</span><span class="token plain"> lia</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> rewrite List</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">app_assoc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rewrite </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> List</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">repeat_app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    now replace </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_nat n </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_nat </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">count </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> n</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">nat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_nat count</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">by</span><span class="token plain"> lia</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Qed</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The way it works is that we follow all the possible execution branches in the Coq definition of <code>pop_eq_n</code> to show that each branch leads to either an execution error or a <code>Result.Ok</code> value with the correct stack. The <code>destruct</code> tactic is the one that allows us to explore each branch of the code, and is used every time we have a <code>match</code> or an <code>if</code> in the code.</p>
<p>Other reasoning operations include <code>unfold</code> to expand a definition or <code>rewrite</code> and <code>replace</code> to replace an expression with another when we have proved they are equal. For example, we replace:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_nat n </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_nat </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">count </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> n</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>by:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_nat count</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>as addition and subtraction by <code>n</code> cancel each other, and <code>count</code> is greater than <code>n</code> in this context for the <code>Z.to_nat (count - n)</code> operation to be well-defined.</p>
<p>While we write the proof in Coq we get a better view thanks to the interactive proof mode. For example, after the last&nbsp;<code>destruct</code> we have:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">A</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">H</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Eq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">n</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> count</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">last</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stack</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Z </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">len</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">H_n</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> n </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Heqb</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">count </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> n</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Heqb0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">count </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> n</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">List</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">repeat last </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_nat count</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> List</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flat_map </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> List</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">repeat v </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_nat n0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> stack </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">List</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">repeat last </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_nat n</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> List</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flat_map </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> List</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">repeat v </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_nat n0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> stack</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">List</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">repeat last </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_nat count</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> List</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flat_map </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> List</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">repeat v </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_nat n0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> stack </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">List</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">repeat last </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_nat n</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">List</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">repeat last </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_nat </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">count </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> n</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> List</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flat_map </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> List</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">repeat v </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_nat n0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> stack</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is how we can progress in the proof and know which command to type. We see two sub-goals <code>(1/2)</code> and <code>(2/2)</code> for each branch explored by the last <code>destruct</code>. In both cases, we need to show an equality:</p>
<ol>
<li>The first one is solved by the fact that <code>count = n</code> in this branch.</li>
<li>The second one is solved by the fact that <code>count &gt; n</code> in this branch, so that we can group the <code>List.repeat last (Z.to_nat n)</code> with <code>List.repeat last (Z.to_nat (count - n))</code> (repeating a "negative" number of times is the empty list so we need to make sure that <code>count - n</code> is not negative).</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-conclusion">‚úíÔ∏è Conclusion<a href="https://formal.land/blog/2024/11/14/sui-move-checker-abstract-stack#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to ‚úíÔ∏è Conclusion" title="Direct link to ‚úíÔ∏è Conclusion">‚Äã</a></h2>
<p>In this example, we have seen how to verify that the <code>pop_eq_n</code> function of the <code>AbstractStack</code> type in the Move checker of Sui is equivalent to the naive pop function with repetition on flattened stacks. As this is a formal proof, we are sure that this property holds for any possible stack and value of <code>n</code>.</p>
<p>We are continuing the work to verify the other functions of the project, with the final aim to verify the whole type-checker. We will keep you updated on our progress in the next blog posts&nbsp;üöÄ.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions or requests!</em></p></div></div>]]></content>
        <category label="Rust" term="Rust"/>
        <category label="Move" term="Move"/>
        <category label="Sui" term="Sui"/>
        <category label="type-checker" term="type-checker"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[‚óºÔ∏è A formal verification tool for Noir ‚Äì 1]]></title>
        <id>https://formal.land/blog/2024/11/01/tool-for-noir-1</id>
        <link href="https://formal.land/blog/2024/11/01/tool-for-noir-1"/>
        <updated>2024-11-01T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[In this series of blog posts, we present our development of a formal verification tool for the ‚óºÔ∏è&nbsp;Noir smart contract language. It is particularly suited to writing zero-knowledge applications, providing primitive constructs such as a Field type to write programs that run efficiently as circuits. Having a formal verification for Noir enables the development of applications holding a large amount of money in this language, as it ensures that the code is correct with a mathematical level of certainty.]]></summary>
        <content type="html"><![CDATA[<p>In this series of blog posts, we present our development of a formal verification tool for the <a href="https://noir-lang.org/" target="_blank" rel="noopener noreferrer">‚óºÔ∏è&nbsp;Noir</a> smart contract language. It is particularly suited to writing zero-knowledge applications, providing primitive constructs such as a <code>Field</code> type to write programs that run efficiently as circuits. Having a formal verification for Noir enables the development of applications holding a large amount of money in this language, as it ensures that the code is correct with a mathematical level of certainty.</p>
<p>In this first post, we present how we translate Noir code to the <a href="https://coq.inria.fr/" target="_blank" rel="noopener noreferrer">üêì&nbsp;Coq</a> proof system. We explore a translation after monomorphization and then at the HIR level. Note that we are interested in verifying programs <em>written in Noir</em>. The verification of the Noir compiler itself is a separated topic.</p>
<p>All our code is available as open-source on <a href="https://github.com/formal-land/coq-of-noir" target="_blank" rel="noopener noreferrer">github.com/formal-land/coq-of-noir</a>, and you are welcome to use it. We also provide all-included audit services to formally verify your smart contracts using <code>coq-of-noir</code>.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Get started</div><div class="admonitionContent_BuS1"><p>To ensure your code is secure today, contact us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">&nbsp;üíåcontact@formal.land</a>!&nbsp;üöÄ</p><p>Formal verification goes further than traditional audits to make 100% sure you cannot lose your funds, thanks to <strong>mathematical reasoning on the code</strong>. It can be integrated into your CI pipeline to check that every commit is fully correct <strong>without doing a whole audit again</strong>.</p><p>We make bugs such as the <a href="https://www.gemini.com/fr-fr/cryptopedia/the-dao-hack-makerdao" target="_blank" rel="noopener noreferrer">DAO hack</a> ($60 million stolen) virtually <strong>impossible to happen again</strong>.</p></div></div>
<figure><p><img decoding="async" loading="lazy" alt="Noir" src="https://formal.land/assets/images/noir-39f8fd00f708cba305bebb635a1e64e9.webp" width="1792" height="1024" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-quick-presentation-of-noir">‚óºÔ∏è Quick presentation of Noir<a href="https://formal.land/blog/2024/11/01/tool-for-noir-1#%EF%B8%8F-quick-presentation-of-noir" class="hash-link" aria-label="Direct link to ‚óºÔ∏è Quick presentation of Noir" title="Direct link to ‚óºÔ∏è Quick presentation of Noir">‚Äã</a></h2>
<p>Noir is designed as a small version of <a href="https://www.rust-lang.org/" target="_blank" rel="noopener noreferrer">ü¶Ä&nbsp;Rust</a> with many built-in constructs to make it more amenable to efficient compilation to zero-knowledge circuits. Being a smaller version of Rust, this simplifies the development of tooling as the surface of the language is reduced. In addition, as it shares similarities with Rust, we can reuse our knowledge from <a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">coq-of-rust</a>, a formal verification tool for Rust, to propose an equivalent tool for Noir.</p>
<p>A notable difference between Rust and Noir is that Noir has a much simpler memory management model: nothing is ever deallocated! As a result, the various kinds of pointers that exist in Rust (<code>Rc</code>, <code>RefCell</code>, ...) are not present in Noir. Most of the data is immutable, and mutations are encouraged to be done only on local variables.</p>
<p>The loops are restricted to <code>for</code> loops with bounds known at compile time, which simplifies the reasoning about them. For example, we are sure that all the loops terminate, which is required for the verification of the code.</p>
<p>Here is an example of Noir program that we will use in this series of blog posts. It showcases the use of mutable variables in a loop, as well as generic values such as <code>InputElements</code> that are known at compile time and specialized during the monomorphization phase to compile the code down to a circuit. It is part of the <a href="https://github.com/noir-lang/noir_base64" target="_blank" rel="noopener noreferrer">noir_base64</a> library to encode an array of ASCII values into base64 values using finite field operations to stay efficient.</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * @brief Take an array of ASCII values and convert into base64 values</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> **/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">base64_encode_elements</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token class-name">InputElements</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u32</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">u8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token class-name">InputElements</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">u8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token class-name">InputElements</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token class-name">Base64Encoder</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Base64EncodeBE</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">u8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token class-name">InputElements</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token class-name">InputElements</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">..</span><span class="token class-name">InputElements</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        result</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Base64Encoder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token class-name">Field</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1Ô∏è‚É£-monomorphization">1Ô∏è‚É£ Monomorphization<a href="https://formal.land/blog/2024/11/01/tool-for-noir-1#1%EF%B8%8F%E2%83%A3-monomorphization" class="hash-link" aria-label="Direct link to 1Ô∏èÔøΩ‚É£ Monomorphization" title="Direct link to 1Ô∏è‚É£ Monomorphization">‚Äã</a></h2>
<p>In this phase of compilation, all generic types and values are instantiated with their concrete values, as well as trait instances. The resulting code is much simpler as it only contains functions and types. If we translate the code to an untyped representation in Coq, we can even consider that the monomorphized code only contains functions. Thus, for convenience, we started doing our translation from the monomorphized level.</p>
<p>The <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree" target="_blank" rel="noopener noreferrer">abstract syntax tree</a> for this level is in the Rust file <a href="https://github.com/formal-land/coq-of-noir/blob/master/compiler/noirc_frontend/src/monomorphization/ast.rs" target="_blank" rel="noopener noreferrer">compiler/noirc_frontend/src/monomorphization/ast.rs</a> from the Noir's compiler. As an example, here is how the expressions are represented:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">enum</span><span class="token plain"> </span><span class="token type-definition class-name">Expression</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Ident</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Ident</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Literal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Literal</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Block</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Expression</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Unary</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Unary</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Binary</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Binary</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Index</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Cast</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Cast</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">For</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">For</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">If</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">If</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Tuple</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Expression</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">ExtractTupleField</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Box</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Expression</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Call</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Call</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Let</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Let</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Constrain</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Box</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Expression</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Location</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Box</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Expression</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">HirType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Assign</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Assign</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Semi</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Box</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Expression</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Break</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Continue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you look at the various constructors of this enum they correspond to the language's primitives presented in the reference manual of Noir. Expressions (<code>Ident</code>, <code>Binary</code>, <code>Call</code>, ...) and statements (<code>If</code>, <code>Let</code>, <code>Break</code>, ...) are mixed together. If we look at the definition of <code>Ident</code>:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">Ident</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> location</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Location</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> definition</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Definition</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> mutable</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> typ</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Type</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>and then at the definition of <code>Definition</code>:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">enum</span><span class="token plain"> </span><span class="token type-definition class-name">Definition</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Local</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">LocalId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">FuncId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Builtin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">LowLevel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// used as a foreign/externally defined unconstrained function</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Oracle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>we get that most of the names have an associated <em>id</em> that is a unique number. This is because in the monomorphization phase, we duplicate a lot of the definitions (once for each instantiation of a generic type), so we have to give them a unique id to distinguish them.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="translation">Translation<a href="https://formal.land/blog/2024/11/01/tool-for-noir-1#translation" class="hash-link" aria-label="Direct link to Translation" title="Direct link to Translation">‚Äã</a></h3>
<p>We translate the monomorphized code to Coq by doing:</p>
<ol>
<li>An extraction to JSON thanks to the <code>serde</code> serialization library in Rust.</li>
<li>Pretty-printing the resulting JSON to a Coq file with a Python script.</li>
</ol>
<p>We find this development process to be rather efficient as the Python language is quite flexible and allows us to manipulate the JSON data easily. Compared to the work of a full compiler, which can be rather expensive computationally, what we do is mostly a translation from one syntax to another, and Python is a good fit.</p>
<p>Our Noir example is monomorphized to the following code, which can be shown by the development option <code>--show-monomorphized</code> of <code>nargo</code>:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">base64_encode_elements</span><span class="token variable" style="color:#36acaa">$f4</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input</span><span class="token variable" style="color:#36acaa">$l26</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">u8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">36</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">u8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">36</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token class-name">Base64Encoder</span><span class="token variable" style="color:#36acaa">$27</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> new</span><span class="token variable" style="color:#36acaa">$f6</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> result</span><span class="token variable" style="color:#36acaa">$28</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i</span><span class="token variable" style="color:#36acaa">$29</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">36</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        result</span><span class="token variable" style="color:#36acaa">$l28</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token variable" style="color:#36acaa">$l29</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> get</span><span class="token variable" style="color:#36acaa">$f7</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Base64Encoder</span><span class="token variable" style="color:#36acaa">$l27</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input</span><span class="token variable" style="color:#36acaa">$l26</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token variable" style="color:#36acaa">$l29</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token class-name">Field</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    result</span><span class="token variable" style="color:#36acaa">$l28</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We see that the generic variable&nbsp;<code>InputElements</code> is replaced by the constant value&nbsp;<code>36</code> as this is the value we use in the example we translate. All the identifiers have an additional <code>$...</code> suffix to make them unique. Thanks to the serialization library <code>serde</code>, we automatically get the JSON representation of this code that starts with:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"id"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"base64_encode_elements"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"parameters"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token number" style="color:#36acaa">49</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">"input"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"Array"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token number" style="color:#36acaa">118</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"Integer"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token string" style="color:#e3116c">"Unsigned"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token string" style="color:#e3116c">"Eight"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">"body"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">"Block"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">"Let"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"id"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">27</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"mutable"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Base64Encoder"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">"expression"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">"Call"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token property" style="color:#36acaa">"func"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token property" style="color:#36acaa">"Ident"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token property" style="color:#36acaa">"location"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"span"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token property" style="color:#36acaa">"start"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5312</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token property" style="color:#36acaa">"end"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5315</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"file"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">70</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token property" style="color:#36acaa">"definition"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"Function"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token property" style="color:#36acaa">"mutable"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token property" style="color:#36acaa">"name"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"new"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token property" style="color:#36acaa">"typ"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token property" style="color:#36acaa">"Function"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token property" style="color:#36acaa">"Tuple"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token property" style="color:#36acaa">"Array"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              </span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token property" style="color:#36acaa">"Integer"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  </span><span class="token string" style="color:#e3116c">"Unsigned"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  </span><span class="token string" style="color:#e3116c">"Eight"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token comment" style="color:#999988;font-style:italic">// much more JSON code</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is extremely verbose, and there is some information that we do not need, such as the locations of some of the items in the source. The advantage of JSON is that it is easy to parse and handle in most programming languages. In our case, here is an extract of the Python script that translates this JSON to Coq:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">'''</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">pub enum Expression {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Ident(Ident),</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Literal(Literal),</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Block(Vec&lt;Expression&gt;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Unary(Unary),</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Binary(Binary),</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Index(Index),</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Cast(Cast),</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    For(For),</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    If(If),</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Tuple(Vec&lt;Expression&gt;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    ExtractTupleField(Box&lt;Expression&gt;, usize),</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Call(Call),</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Let(Let),</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Constrain(Box&lt;Expression&gt;, Location, Option&lt;Box&lt;(Expression, HirType)&gt;&gt;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Assign(Assign),</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Semi(Box&lt;Expression&gt;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Break,</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Continue,</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">'''</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">expression_to_coq</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    node_type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">keys</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> node_type </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Ident"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        node </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> node</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"Ident"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ident_to_coq</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> node_type </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Literal"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        node </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> node</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"Literal"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> alloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">literal_to_coq</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> node_type </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Block"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        node </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> node</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"Block"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">"\n"</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                expression_inside_block_to_coq</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">expression</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> index </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> expression </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">enumerate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> node_type </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Unary"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        node </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> node</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"Unary"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> unary_to_coq</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> node_type </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Binary"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        node </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> node</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"Binary"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> binary_to_coq</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># more cases...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>For each kind of node in the AST, we write the original Rust type in comments, then let GitHub Copilot write the Python code and refine it. Here is the final Coq code that we get for this example:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> base64_encode_elements‚ÇÑ </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Œ± </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> Œ± </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">input</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> input </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc input </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> Base64Encoder </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">copy_mutable </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">call_closure </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_function </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"new"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">copy_mutable </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Array </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U8 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">for_ </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U32 </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integer IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">U32 </span><span class="token number" style="color:#36acaa">36</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">assign </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">index </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">call_closure </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_function </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"get"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Base64Encoder </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cast </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">index </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> input </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Field</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">impossible </span><span class="token string" style="color:#e3116c">"wrong number of arguments"</span><span class="token plain">re</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you attentively compare this Coq code to the original Noir version, you will see that the two are similar, although the Coq version is much more verbose with all the explicit memory allocations and reads. You might be wondering why we are choosing this specific representation. How did we know we had to use <code>M.for_</code>, for example, to represent the loops?</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="semantics">Semantics<a href="https://formal.land/blog/2024/11/01/tool-for-noir-1#semantics" class="hash-link" aria-label="Direct link to Semantics" title="Direct link to Semantics">‚Äã</a></h3>
<p>This is where the semantics comes in. In the semantics phase, we define the meaning of each construct of the language in Coq. We reused our experience in building the <a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">coq-of-rust</a> and <a href="https://github.com/formal-land/coq-of-solidity" target="_blank" rel="noopener noreferrer">coq-of-solidity</a>, where we also had to define the semantics of imperative languages in Coq.</p>
<p>We remove all the type information to avoid the differences between the Coq's type system and the type system of Noir. All the values have the same type <code>Value.t</code>:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Bool </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Integer </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kind </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> IntegerKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">integer </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">String</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> FmtStr </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> Z </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Pointer </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pointer </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Pointer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Array </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">values </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Slice </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">values </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Tuple </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">values </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Closure </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">@</span><span class="token plain"> list Value </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We have a monad <code>M.t</code> to represent the side-effects of Noir in Coq (memory mutation, non-termination for recursive calls, ...). We define this monad from the composition of two monads:</p>
<ul>
<li>A free monad <code>LowM.t</code> that contains all the effects we cannot directly represent in Coq.</li>
<li>An error monad <code>Result.t</code> to represent special control-flow operations, such as <code>break</code> and <code>continue</code>, which have to interrupt the execution of the current loop prematurely, and a panic value in case of assert failure, which must propagate up to the main function.</li>
</ul>
<p>The definition of these types is as follows:</p>
<ul>
<li>The free monad:<!-- -->
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Pure </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CallPrimitive </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">B </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">primitive </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Primitive</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t B</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> B </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CallClosure </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">closure </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">args </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Let</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Loop </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">body </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Impossible </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> LowM</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>The error monad:<!-- -->
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Ok </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Break</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Panic </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">payload </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> Result</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>The composition of the two monads:<!-- -->
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
<p>Note that since our type of values is always <code>Value.t</code>, we do not parameterize the monad <code>M.t</code> by the type of values.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-conclusion">‚úíÔ∏è Conclusion<a href="https://formal.land/blog/2024/11/01/tool-for-noir-1#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to ‚úíÔ∏è Conclusion" title="Direct link to ‚úíÔ∏è Conclusion">‚Äã</a></h2>
<p>Thanks to all the work above, we obtain a translation for a large subset of the Noir language to the Coq proof system, which type-checks and has a semantics. A difficulty with handling the code we produce from monomorphization is the unique identifier added after each name to make them unique. These identifiers are generated in a rather non-deterministic way that can depend on the machine that runs the compiler. In addition, they change every time we make changes to the source code.</p>
<p>In the next blog post, we will see how we prevent the identifiers from appearing in the generated code by working at a higher level than the monomorphization phase.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions or requests!</em></p></div></div>]]></content>
        <category label="Noir" term="Noir"/>
        <category label="smart contract" term="smart contract"/>
        <category label="circuits" term="circuits"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[‚öà Verification of the Smoo.th library ‚Äì 2]]></title>
        <id>https://formal.land/blog/2024/10/28/verification-smooth-library-2</id>
        <link href="https://formal.land/blog/2024/10/28/verification-smooth-library-2"/>
        <updated>2024-10-28T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[In this blog post, we detail the continuation of our work to formally verify the ‚öà&nbsp;Smoo.th library, which is an optimized implementation of elliptic curve operations in Solidity. We use our tool coq-of-solidity, representing any Solidity code in the generic proof assistant üêì&nbsp;Coq, to verify the code for any execution path.]]></summary>
        <content type="html"><![CDATA[<p>In this blog post, we detail the continuation of our work to formally verify the <a href="https://smoo.th/" target="_blank" rel="noopener noreferrer">‚öà&nbsp;Smoo.th</a> library, which is an optimized implementation of elliptic curve operations in Solidity. We use our tool <a href="https://github.com/formal-land/coq-of-solidity" target="_blank" rel="noopener noreferrer">coq-of-solidity</a>, representing any Solidity code in the generic proof assistant <a href="https://coq.inria.fr/" target="_blank" rel="noopener noreferrer">üêì&nbsp;Coq</a>, to verify the code for any execution path.</p>
<p>In particular, we cover the changes we made to use unoptimized Yul code and how we made a functional representation of the loop to compute the most significant bit of the scalars.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Get started</div><div class="admonitionContent_BuS1"><p>To ensure your code is secure today, contact us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">&nbsp;üíåcontact@formal.land</a>!&nbsp;üöÄ</p><p>Formal verification goes further than traditional audits to make 100% sure you cannot lose your funds, thanks to <strong>mathematical reasoning on the code</strong>. It can be integrated into your CI pipeline to check that every commit is fully correct <strong>without doing a whole audit again</strong>.</p><p>We make bugs such as the <a href="https://www.gemini.com/fr-fr/cryptopedia/the-dao-hack-makerdao" target="_blank" rel="noopener noreferrer">DAO hack</a> ($60 million stolen) virtually <strong>impossible to happen again</strong>.</p></div></div>
<figure><p><img decoding="async" loading="lazy" alt="Smooth in forest" src="https://formal.land/assets/images/forest-smooth-9d52a7b4fe8f74b78bba9c29384633bf.webp" width="1024" height="1024" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-unoptimized-yul">üêå Unoptimized Yul<a href="https://formal.land/blog/2024/10/28/verification-smooth-library-2#-unoptimized-yul" class="hash-link" aria-label="Direct link to üêå Unoptimized Yul" title="Direct link to üêå Unoptimized Yul">‚Äã</a></h2>
<p>We are now verifying the code based on the unoptimized <a href="https://docs.soliditylang.org/en/latest/yul.html" target="_blank" rel="noopener noreferrer">Yul</a> output of the Solidity compiler instead of the optimized one. As a consequence the code is a little bit more verbose, although in our present case the difference is limited as we are verifying a code that is already hand-optimized. The main advantage is that the variables are preserved instead of being moved to locations in the memory, which makes the verification easier, especially when handling loop invariants. A downside is that we now have to trust the correctness of the Solidity compiler's optimization passes.</p>
<p>As an example, here is how we now translate in Coq the loop to compute the most significant bit of the scalars with the unoptimized Yul code:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> var_ZZZ_83 </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let_state</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">var_ZZZ_83</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> var_mask_63</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(* for loop *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Shallow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">for_</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">(* init state *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">var_ZZZ_83</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> var_mask_63</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">(* condition *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">var_ZZZ_83</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> var_mask_63</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      iszero </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> var_ZZZ_83 </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">(* body *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">var_ZZZ_83</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> var_mask_63</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Shallow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lift_state_update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> var_ZZZ_83 </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">var_ZZZ_83</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> var_mask_63</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> var_ZZZ_83 </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> add </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> add </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> sub </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> iszero </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> and </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> var_scalar_u_55</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> var_mask_63 </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> shl </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sub </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> iszero </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> and </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> shr </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">128</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> var_scalar_u_55 </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> var_mask_63 </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> add </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> shl </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sub </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> iszero </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> and </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> var_scalar_v_57</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> var_mask_63 </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> shl </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sub </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> iszero </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> and </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> shr </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">128</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> var_scalar_v_57 </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> var_mask_63 </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pure </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BlockUnit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> var_ZZZ_83</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">(* post *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">var_ZZZ_83</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> var_mask_63</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Shallow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lift_state_update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> var_mask_63 </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">var_ZZZ_83</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> var_mask_63</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> var_mask_63 </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> shr </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> var_mask_63 </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pure </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BlockUnit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> var_mask_63</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As a reference, here is the original smart contract code, in hand-written Yul:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ZZZ </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">iszero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> mask </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">shr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mask</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ZZZ </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">sub</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">iszero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">and</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scalar_u</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mask</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">shl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sub</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">iszero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">and</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">shr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">128</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> scalar_u</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mask</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">shl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sub</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">iszero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">and</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scalar_v</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mask</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">shl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sub</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">iszero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">and</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">shr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">128</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> scalar_v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mask</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We recognize the variables <code>var_ZZZ_83</code> and <code>var_mask_63</code>, corresponding to <code>ZZZ</code> and <code>mask</code> in the original code. They are made explicit in a state monad with the state <code>(var_ZZZ_83, var_mask_63)</code> for the loop.</p>
<p>We had some constructs we were not handling in <code>coq-of-solidity</code>, for constructs that appeared in the optimized code but not in the unoptimized one. An example is the initialization part of the <code>for</code> loop that seems to be always move away in the optimized code. We added those missing cases to our tool to be able to translate the unoptimized Yul code of Smoo.th.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-verification-of-the-loop">üéóÔ∏è Verification of the loop<a href="https://formal.land/blog/2024/10/28/verification-smooth-library-2#%EF%B8%8F-verification-of-the-loop" class="hash-link" aria-label="Direct link to üéóÔ∏è Verification of the loop" title="Direct link to üéóÔ∏è Verification of the loop">‚Äã</a></h2>
<p>Verifying the&nbsp;<code>for</code> loop above can be challenging. Automated verification tools for Solidity typically do not fully handle loops, and instead unroll them three or four times to check the first iterations, which can miss some bugs.</p>
<p>The first step is to prove the loop is equivalent to a recursive function, as this will simplify reasoning. Here is a recursive function that computes the most significant bit of the scalars <code>u</code> and <code>v</code>:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Fixpoint</span><span class="token plain"> get</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u_low u_high v_low v_high </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> U128</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">over_index </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nat</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PointsSelector</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> nat </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> over_index </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> O </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">(* We should never reach this case if the scalars</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">       are not all zero *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">PointsSelector</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Build_t false false false false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> O</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> S index </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> selector </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> HighLow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_selector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      u_low u_high v_low v_high </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Z</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">of_nat index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> PointsSelector</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_zero selector </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> new_over_index </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> index </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      get u_low u_high v_low v_high new_over_index</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> next_over_index </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> index </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">selector</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> next_over_index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here are some notable changes compared to the original <code>for</code> loop:</p>
<ul>
<li>We decompose the scalars <code>u</code> and <code>v</code> of 256 bits into their high and low parts, <code>u_low</code>, <code>u_high</code>, <code>v_low</code>, and <code>v_high</code> of 128 bits each.</li>
<li>We make explicit the scalars that we select with the <code>PointsSelector</code> type, which is a record with four boolean fields. In the original code, the <code>ZZZ</code> variable is used to group these four booleans into a single integer.</li>
<li>We use a natural number <code>over_index</code> to represent the mask. We decrement it at each iteration until it reaches zero, proving by construction the termination of the function. The relation with the mask is:</li>
</ul>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>mask</mtext><mo>=</mo><mo stretchy="false">‚åä</mo><msup><mn>2</mn><mrow><mtext>over_index</mtext><mo>‚àí</mo><mn>1</mn></mrow></msup><mo stretchy="false">‚åã</mo></mrow><annotation encoding="application/x-tex">\text{mask} = \lfloor 2^{\text{over\_index} - 1} \rfloor</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord text"><span class="mord">mask</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.1491em;vertical-align:-0.25em"></span><span class="mopen">‚åä</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">over_index</span></span><span class="mbin mtight">‚àí</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mclose">‚åã</span></span></span></span></span>
<p>Note that this means that when the <code>over_index</code> is zero, then the <code>mask</code> is zero. This corresponds to the last case of the loop. We use the variable name <code>over_index</code> so that if we define:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>over_index</mtext><mo>=</mo><mtext>index</mtext><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\text{over\_index} = \text{index} + 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em"></span><span class="mord text"><span class="mord">over_index</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em"></span><span class="mord text"><span class="mord">index</span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">1</span></span></span></span></span>
<p>then the relation with the mask is:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>mask</mtext><mo>=</mo><msup><mn>2</mn><mtext>index</mtext></msup></mrow><annotation encoding="application/x-tex">\text{mask} = 2^{\text{index}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord text"><span class="mord">mask</span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.8991em"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">index</span></span></span></span></span></span></span></span></span></span></span></span></span></span>
<p>for all cases except the last one.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-reasoning-rule">üí° Reasoning rule<a href="https://formal.land/blog/2024/10/28/verification-smooth-library-2#-reasoning-rule" class="hash-link" aria-label="Direct link to üí° Reasoning rule" title="Direct link to üí° Reasoning rule">‚Äã</a></h2>
<p>Here is the reasoning rule for the smart contract loops in Coq:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Lemma</span><span class="token plain"> LoopStep codes environment </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">In Out </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">init </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> In</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">body </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> In </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Out</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">break_with </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Out </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> In </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> Out</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Out </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Out</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">output output_inter </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Out</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    state state_inter state</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">H_body </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> codes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> environment</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        body init ‚áì output_inter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state_inter </span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">H_break_with </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> break_with output_inter </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> inr output_inter</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> codes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> environment</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state_inter </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          k output_inter</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> ‚áì output</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> inl next_init </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> codes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> environment</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state_inter </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Loop next_init body break_with k ‚áì output</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> codes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> environment</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Loop init body break_with k ‚áì output</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This rule, to be used in combination with some reasoning by induction, allows us to verify that a certain property is true for any number of iterations of the loop. In the present case, we use it to prove that the recursive function <code>get</code> is equivalent to the <code>for</code> loop. Basically, it states that:</p>
<ul>
<li>Assuming that the <code>body</code> of the loop evaluates to some output <code>output_inter</code>,</li>
<li>if the <code>break_with</code> helper, which wraps the end of the end of the loop to either continue the loop or break it, evaluates to <code>output</code>,</li>
<li>then the whole loop evaluates to <code>output</code>.</li>
</ul>
<p>Here, the output of the body of the loop contains the state of the state monad, that is to say, the two variables <code>ZZZ</code> and <code>mask</code>, and a special variable to break or continue the <code>for</code> loop iterations.</p>
<p>Due to a lack of time, we only made a sketch of the proof of evaluation of this loop, admitting some intermediate lemmas about identities over the selector function. This work is available in the file <a href="https://github.com/formal-land/coq-of-solidity/blob/develop/coq/CoqOfSolidity/contracts/scl/mulmuladdX_fullgen_b4/run.v" target="_blank" rel="noopener noreferrer">coq/CoqOfSolidity/contracts/scl/mulmuladdX_fullgen_b4/run.v</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-conclusion">‚úíÔ∏è Conclusion<a href="https://formal.land/blog/2024/10/28/verification-smooth-library-2#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to ‚úíÔ∏è Conclusion" title="Direct link to ‚úíÔ∏è Conclusion">‚Äã</a></h2>
<p>We have seen how to reason about loops with <code>coq-of-solidity</code>. This example with bit-level arithmetic was rather complex, but the general idea is still to reason by induction, showing the equivalence with a recursive function, using the reasoning rule <code>LoopStep</code> above to step through the loop.</p>
<p>If you have smart contracts that you need to secure, talk to us!&nbsp;ü§ù The cost of an attack always far outweights the cost of an audit, and our solution, with full formal verification, is the more extensive in terms of coverage.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more, or comment on this post below! Feel free to DM us for any questions or requests!</em></p></div></div>]]></content>
        <category label="Solidity" term="Solidity"/>
        <category label="Yul" term="Yul"/>
        <category label="elliptic curves" term="elliptic curves"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[üå≤ What we bring you]]></title>
        <id>https://formal.land/blog/2024/10/22/what-we-bring-to-you</id>
        <link href="https://formal.land/blog/2024/10/22/what-we-bring-to-you"/>
        <updated>2024-10-22T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[We bring you the highest possible level of security&nbsp;ü¶∏ for your blockchain applications by using formal verification&nbsp;‚ú® optimized by AI solutions to keep the cost down. We believe that for systems holding a lot of value&nbsp;üí∞, it is necessary to use the most advanced techniques&nbsp;‚öõÔ∏è to ensure their security; otherwise attackers with large means (like North Korea&nbsp;üá∞üáµ, but not only) will be able to steal or damage the system by using these techniques themselves.]]></summary>
        <content type="html"><![CDATA[<p>We bring you the <strong>highest possible level of security&nbsp;ü¶∏</strong> for your blockchain applications by using <strong>formal verification&nbsp;‚ú®</strong> optimized by <strong>AI solutions</strong> to keep the cost down. We believe that for systems <strong>holding a lot of value&nbsp;üí∞</strong>, it is necessary to use the most advanced techniques&nbsp;‚öõÔ∏è to ensure their security; otherwise attackers with large means (like <strong>North Korea&nbsp;üá∞üáµ</strong>, but not only) will be able to <strong>steal or damage</strong> the system by using these techniques themselves.</p>
<p>In this blog post we present how we work with customers to integrate full formal verification in their workflow and ensure that their code is <strong>secure</strong> in the best possible way.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Get started</div><div class="admonitionContent_BuS1"><p>To ensure your code is secure today, contact us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">&nbsp;üíåcontact@formal.land</a>!&nbsp;üöÄ</p><p>Formal verification goes further than traditional audits to make 100% sure you cannot lose your funds, thanks to <strong>mathematical reasoning on the code</strong>. It can be integrated into your CI pipeline to check that every commit is fully correct <strong>without doing a whole audit again</strong>.</p><p>We make bugs such as the <a href="https://www.gemini.com/fr-fr/cryptopedia/the-dao-hack-makerdao" target="_blank" rel="noopener noreferrer">DAO hack</a> ($60 million stolen) virtually <strong>impossible to happen again</strong>.</p></div></div>
<figure><p><img decoding="async" loading="lazy" alt="Network in forest" src="https://formal.land/assets/images/network-in-forest-3ae10f79e6dca7325460629c4a680653.webp" width="1024" height="1024" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-why-formal-verification-matters">üõ°Ô∏è Why Formal Verification Matters<a href="https://formal.land/blog/2024/10/22/what-we-bring-to-you#%EF%B8%8F-why-formal-verification-matters" class="hash-link" aria-label="Direct link to üõ°Ô∏è Why Formal Verification Matters" title="Direct link to üõ°Ô∏è Why Formal Verification Matters">‚Äã</a></h2>
<p>Security is central to the long term success of decentralized platforms. Traditional testing or security audits can catch many issues, but are not enough to guarantee the absence of bugs. Formal verification is a technique that <strong>checks every possible input</strong> of your program to ensure that it is always correct, for a given set of security properties. It works by mathematically reasoning about the code constructs and then checking this reasoning with a computer.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-our-process">üîÑ Our Process<a href="https://formal.land/blog/2024/10/22/what-we-bring-to-you#-our-process" class="hash-link" aria-label="Direct link to üîÑ Our Process" title="Direct link to üîÑ Our Process">‚Äã</a></h2>
<p>Our process is as follows:</p>
<ol>
<li><strong>Understanding Your Needs</strong> We start by meeting with you to understand your system and your security requirements.</li>
<li><strong>Formal Modeling</strong> We then create a formal model of your system in a proof assistant, using automated translation tools to make sure we make no mistakes.</li>
<li><strong>Proof Generation</strong> We then generate mathematical proofs that your system satisfies the security properties you require, using the latest techniques in proof automation to reduce the cost.</li>
<li><strong>Seamless Integration</strong> We help you integrate the proofs into your CI pipeline to ensure that every commit is automatically checked for correctness.</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-benefits-you-can-expect">üéÅ Benefits You Can Expect<a href="https://formal.land/blog/2024/10/22/what-we-bring-to-you#-benefits-you-can-expect" class="hash-link" aria-label="Direct link to üéÅ Benefits You Can Expect" title="Direct link to üéÅ Benefits You Can Expect">‚Äã</a></h2>
<ul>
<li><strong>Enhanced Security</strong> You improve the security of your system by showing that whole classes of bugs are impossible.</li>
<li><strong>Cost Savings</strong> You prevent costly security incidents and reduce the need for extensive manual audits.</li>
<li><strong>Investor Confidence</strong> You demonstrate that your system is secure and that you protect your users.</li>
<li><strong>Regulatory Compliance</strong> Finally, you show that you have taken all necessary steps to meet regulatory requirements.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-why-choose-us">üåê Why Choose Us?<a href="https://formal.land/blog/2024/10/22/what-we-bring-to-you#-why-choose-us" class="hash-link" aria-label="Direct link to üåê Why Choose Us?" title="Direct link to üåê Why Choose Us?">‚Äã</a></h2>
<ul>
<li><strong>Expert Team</strong> Our team has years of experience in formal verification, cryptography, and A, with publications in all of these domains.</li>
<li><strong>Cutting-Edge Tool</strong> We use and develop the latest tools in formal verification to ensure we can provide the best possible service cost-effectively.</li>
<li><strong>Customized Solutions</strong> We customize our solutions to your system. You made a new language for zk-circuits or smart contracts and want the technology to verify it? We can help you.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-get-in-touch">ü§ù Get in Touch<a href="https://formal.land/blog/2024/10/22/what-we-bring-to-you#-get-in-touch" class="hash-link" aria-label="Direct link to ü§ù Get in Touch" title="Direct link to ü§ù Get in Touch">‚Äã</a></h2>
<p>Ready to take your application's security to the next level? Reach out to us at<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">&nbsp;üíåcontact@formal.land</a>, and let's build a secure future together! üöÄ</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Stay Tuned</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a> for more insights into formal verification, blockchain security, and how AI is changing the field. We share our case studies, tutorials, and the latest industry news to keep you ahead of the curve.</em></p></div></div>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[‚öà Verification of the Smoo.th library ‚Äì 1]]></title>
        <id>https://formal.land/blog/2024/10/21/verification-smooth-library-1</id>
        <link href="https://formal.land/blog/2024/10/21/verification-smooth-library-1"/>
        <updated>2024-10-21T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[In this blog post, we present the formal verification effort we started to show the absence of bugs in the ‚öà&nbsp;Smoo.th library, a library for optimized „Ä∞Ô∏è&nbsp;elliptic curve operations in Solidity. We are using our tool coq-of-solidity to make this non-trivial verification using the generic proof assistant üêì&nbsp;Coq.]]></summary>
        <content type="html"><![CDATA[<p>In this blog post, we present the formal verification effort we started to show the absence of bugs in the <a href="https://smoo.th/" target="_blank" rel="noopener noreferrer">‚öà&nbsp;Smoo.th</a> library, a library for optimized <a href="https://en.wikipedia.org/wiki/Elliptic_curve" target="_blank" rel="noopener noreferrer">„Ä∞Ô∏è&nbsp;elliptic curve</a> operations in <a href="https://soliditylang.org/" target="_blank" rel="noopener noreferrer">Solidity</a>. We are using our tool <a href="https://github.com/formal-land/coq-of-solidity" target="_blank" rel="noopener noreferrer">coq-of-solidity</a> to make this non-trivial verification using the generic proof assistant <a href="https://coq.inria.fr/" target="_blank" rel="noopener noreferrer">üêì&nbsp;Coq</a>.</p>
<p>The <strong>Smoo.th</strong> library is interesting as elliptic curves are at the core of many cryptographic protocols, including authentication protocols, and having a generic and fast implementation simplifies the development of <a href="https://en.wikipedia.org/wiki/Decentralized_application" target="_blank" rel="noopener noreferrer">dApps</a> in environments with missing pre-compiled (like L1s) or missing circuits (like zero-knowledge layers).</p>
<p>From a verification point of view, it is very challenging as it combines low-level operations (hand-optimized <a href="https://docs.soliditylang.org/en/latest/yul.html" target="_blank" rel="noopener noreferrer">Yul</a> code with bit shifts, inlined functions, ...) with higher-level reasoning on elliptic curves and arithmetic&nbsp;üí™.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Get started</div><div class="admonitionContent_BuS1"><p>To ensure your code is secure today, contact us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">&nbsp;üíåcontact@formal.land</a>!&nbsp;üöÄ</p><p>Formal verification goes further than traditional audits to make 100% sure you cannot lose your funds, thanks to a <strong>mathematical reasoning on the code</strong>. It can be integrated into your CI pipeline to check that every commit is fully correct <strong>without doing a whole audit again</strong>.</p><p>We make bugs such as the <a href="https://www.gemini.com/fr-fr/cryptopedia/the-dao-hack-makerdao" target="_blank" rel="noopener noreferrer">DAO hack</a> ($60 million stolen) virtually <strong>impossible to happen again</strong>.</p></div></div>
<figure><p><img decoding="async" loading="lazy" alt="Panda in forest" src="https://formal.land/assets/images/panda-in-forest-d00a641f3c2272f5a60b7eb4ef42009a.webp" width="1024" height="1024" class="img_ev3q"></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-design-of-the-library">üó∫Ô∏è Design of the library<a href="https://formal.land/blog/2024/10/21/verification-smooth-library-1#%EF%B8%8F-design-of-the-library" class="hash-link" aria-label="Direct link to üó∫Ô∏è Design of the library" title="Direct link to üó∫Ô∏è Design of the library">‚Äã</a></h2>
<p>The library is implemented in <a href="https://github.com/get-smooth/crypto-lib/blob/main/src/elliptic/SCL_mulmuladdX_fullgen_b4.sol" target="_blank" rel="noopener noreferrer">SCL_mulmuladdX_fullgen_b4.sol</a> mostly in Yul. Given two points <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi></mrow><annotation encoding="application/x-tex">G</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal">G</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em"></span><span class="mord mathnormal">Q</span></span></span></span> on an elliptic curve in the field <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="double-struck">F</mi><mi>p</mi></msub></mrow><annotation encoding="application/x-tex">\mathbb{F}_p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.975em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathbb">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">‚Äã</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span></span></span></span> and two scalars <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi></mrow><annotation encoding="application/x-tex">u</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">u</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi></mrow><annotation encoding="application/x-tex">v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal" style="margin-right:0.03588em">v</span></span></span></span>, it computes the following operation:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>u</mi><mo>‚ãÖ</mo><mi>G</mi><mo>+</mo><mi>v</mi><mo>‚ãÖ</mo><mi>Q</mi></mrow><annotation encoding="application/x-tex">u \cdot G + v \cdot Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4445em"></span><span class="mord mathnormal">u</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">‚ãÖ</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em"></span><span class="mord mathnormal">G</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.4445em"></span><span class="mord mathnormal" style="margin-right:0.03588em">v</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">‚ãÖ</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em"></span><span class="mord mathnormal">Q</span></span></span></span></span>
<p>where the points are represented as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(x, y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="mclose">)</span></span></span></span> coordinates, the scalars are integers, and the curve is described in the short Weierstrass form.</p>
<p>Here is a diagram to summarize the workflow of the library&nbsp;ü§ì:</p>
<figure><p><img decoding="async" loading="lazy" alt="Smoo.th workflow" src="https://formal.land/assets/images/smoo-th-diagram-b4175d005c9ee419c532cde9a22a93cb.svg" width="276" height="782" class="img_ev3q"></p></figure>
<p>You can find more details about the algorithms used in the library in the complete <a href="https://github.com/get-smooth/crypto-lib/blob/main/doc/Audits/CRX_smooth_report_2024_07_11_v1.2.pdf" target="_blank" rel="noopener noreferrer">audit report</a> by <a href="https://www.cryptoexperts.com/" target="_blank" rel="noopener noreferrer">CryptoExperts</a>.</p>
<p>Our goal is to show that all these steps are equivalent to doing the naive operation of adding the points <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi><mo>‚ãÖ</mo><mi>G</mi></mrow><annotation encoding="application/x-tex">u \cdot G</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4445em"></span><span class="mord mathnormal">u</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">‚ãÖ</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal">G</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mo>‚ãÖ</mo><mi>Q</mi></mrow><annotation encoding="application/x-tex">v \cdot Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4445em"></span><span class="mord mathnormal" style="margin-right:0.03588em">v</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">‚ãÖ</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em"></span><span class="mord mathnormal">Q</span></span></span></span> on the elliptic curve, ignoring a higher gas consumption and that the library is then free of bugs. Note that there are a few exceptional points, for example, when <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi></mrow><annotation encoding="application/x-tex">G</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal">G</span></span></span></span> is the opposite of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em"></span><span class="mord mathnormal">Q</span></span></span></span>, where the library does not work as it is and runs another algorithm instead. We need to make these points explicit in the proof and assume we are not in these special cases.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-translation-to-coq">üêì Translation to Coq<a href="https://formal.land/blog/2024/10/21/verification-smooth-library-1#-translation-to-coq" class="hash-link" aria-label="Direct link to üêì Translation to Coq" title="Direct link to üêì Translation to Coq">‚Äã</a></h2>
<p>In order to formally verify that the code is correct for any possible inputs, we need to first translate it to a proof language, in our case Coq. We run our tool <code>coq-of-solidity</code> on the optimized Yul code as generated by the Solidity compiler, that optimizes further the already hand-optimized code of the library. All our verification work is available on GitHub in the folder <a href="https://github.com/formal-land/coq-of-solidity/tree/develop/coq/CoqOfSolidity/contracts/scl/mulmuladdX_fullgen_b4" target="_blank" rel="noopener noreferrer">coq/CoqOfSolidity/contracts/scl/mulmuladdX_fullgen_b4</a> of the <a href="https://github.com/formal-land/coq-of-solidity" target="_blank" rel="noopener noreferrer">coq-of-solidity's repository</a>.</p>
<p>Here is an example of hand-written Yul code from the contract, to compute the most-significant bit from the scalars:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ZZZ </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">iszero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> mask </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">shr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mask</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ZZZ </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">sub</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">iszero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">and</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scalar_u</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mask</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">shl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sub</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">iszero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">and</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">shr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">128</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> scalar_u</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mask</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">shl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sub</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">iszero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">and</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scalar_v</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mask</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">shl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sub</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">iszero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">and</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">shr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">128</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> scalar_v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mask</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The Yul code after optimization by the Solidity compiler is:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mstore</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0xe0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">iszero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">mload</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0xe0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mstore</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x01a0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">shr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mload</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x01a0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">mstore</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0xe0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">sub</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">iszero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">and</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">mload</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x0120</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mload</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x01a0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">shl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sub</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">iszero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">and</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">shr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">128</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mload</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x0120</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mload</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x01a0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">shl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sub</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">iszero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">and</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">mload</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x0160</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mload</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x01a0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">shl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sub</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">iszero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">and</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">shr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">128</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mload</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x0160</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mload</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x01a0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As we can see, the variable names were replaced by fixed memory addresses. As we can see, this will make the verification more complex. The Coq code that we generate with <code>coq-of-solidity</code> is:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> mstore </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xe0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let_state</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">'</span><span class="token plain">tt </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(* for loop *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Shallow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">for_</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">(* init state *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">(* condition *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">'</span><span class="token plain">tt </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      iszero </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> mload </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xe0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">(* body *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">'</span><span class="token plain">tt </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mstore </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xe0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> add </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          add </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sub </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> iszero </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> and </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> mload </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0120</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mload </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x01a0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            shl </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sub </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> iszero </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> and </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> shr </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">128</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mload </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0120</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mload </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x01a0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          add </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            shl </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sub </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> iszero </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> and </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> mload </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0160</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mload </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x01a0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            shl </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sub </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> iszero </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> and </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> shr </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">128</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mload </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0160</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mload </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x01a0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pure </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BlockUnit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">(* post *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">'</span><span class="token plain">tt </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      do</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> mstore </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x01a0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> shr </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mload </span><span class="token operator" style="color:#393A34">~</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x01a0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pure </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BlockUnit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> tt </span><span class="token keyword" style="color:#00009f">in</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We use a monadic notation <code>f ~(| x1, ..., xn |)</code> to represent the side-effects of the EVM, such as memory read and write with <code>mload</code> and <code>mstore</code>. The function <code>Shallow.for_</code> represents a for loop with an initial state, a condition, a body, and a post-action. We implement it using a primitive from our monad to represent potentially non-terminating loops.</p>
<p>Here the proper state of the loop is empty (value <code>tt</code>) and we instead modify the memory with <code>mload</code>. Ideally we should have <code>(ZZZ, mask)</code> as the state of the loop to simplify the verification. For our next attempt at verifying this code, we will look at the Yul code generated before optimizations by the Solidity compiler in order to keep these variables.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-what-we-verified">üî¨ What we verified<a href="https://formal.land/blog/2024/10/21/verification-smooth-library-1#-what-we-verified" class="hash-link" aria-label="Direct link to üî¨ What we verified" title="Direct link to üî¨ What we verified">‚Äã</a></h2>
<p>We are not done yet with the verification of this library. For now, we have verified that:</p>
<ul>
<li>The addition operation <code>ecAddn2</code> is implemented as specified.</li>
<li>The doubling and negation operation <code>ecDblNeg</code> is implemented as in the specification, in an inlined manner.</li>
<li>The pre-computations of the sums of the possible combinations of points are correct.</li>
<li>The retrieval of the pre-computed sums from the current bits of the scalars is correct.</li>
</ul>
<p>For example, here is our statement for the execution of the <code>ecAddn2</code> operation:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Lemma</span><span class="token plain"> run_usr</span><span class="token operator" style="color:#393A34">'</span><span class="token plain">dollar</span><span class="token operator" style="color:#393A34">'</span><span class="token plain">ecAddn2 codes environment state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">P1_X P1_Y P1_ZZ P1_ZZZ P2_X P2_Y </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> U256</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> U256</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> output </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ecAddn2 p</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punct punctuation" style="color:#393A34">{|</span><span class="token plain"> PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> P1_X</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> P1_Y</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> P1_ZZ</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> P1_ZZZ </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punct punctuation" style="color:#393A34">{|</span><span class="token plain"> PA</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> P2_X</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> PA</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> P2_Y </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> output </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ok </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">output</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> output</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> output</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> output</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> codes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> environment</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Some state </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Contract_91</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Contract_91_deployed</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">usr</span><span class="token operator" style="color:#393A34">'</span><span class="token plain">dollar</span><span class="token operator" style="color:#393A34">'</span><span class="token plain">ecAddn2 P1_X P1_Y P1_ZZ P1_ZZZ P2_X P2_Y p ‚áì</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Some state </span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It says that in a given environment (<code>codes</code>, <code>environment</code>, <code>state</code>), the execution of the translated function <code>Contract_91.Contract_91_deployed.usr'dollar'ecAddn2</code> gives the same result as a hand-written purely functional version <code>ecAddn2</code> operating on data types directly representing the curve points (<code>PZZ.t</code> and <code>PA.t</code>).</p>
<p>We verify this execution in a straightforward way by unfolding the definition and executing it step by step:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Proof</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  simpl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unfold Contract_91</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Contract_91_deployed</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">usr</span><span class="token operator" style="color:#393A34">'</span><span class="token plain">dollar</span><span class="token operator" style="color:#393A34">'</span><span class="token plain">ecAddn2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  l</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    repeat </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">l</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">repeat cu</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> p</span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Qed</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>For the verification of the inlined<code>ecDblNeg</code> operation, here is the memory state just after computing the coordinates of the doubled point:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mem0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> mem1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2048</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> mem3</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> mem4</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">addmod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">addmod </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod a </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">addmod </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod a </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sub p </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">addmod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">addmod </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod a </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">addmod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">addmod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">addmod </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod a </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">addmod </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod a </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sub p </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sub p </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  HighLow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">merge u_high u_low</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">480</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> HighLow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">merge v_high v_low</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2048</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">^</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">126</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  p</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> Q</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PA</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> Q</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PA</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> Q</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PA</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> G</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PA</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> G</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PA</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> G</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PA</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> G</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PA</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  P0</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P0</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P0</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  P0</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  P1</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P1</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P1</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P1</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  P2</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P2</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P2</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P2</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  P3</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P3</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P3</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P3</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  P4</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P4</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P4</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P4</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  P5</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P5</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P5</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P5</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  P6</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P6</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P6</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P6</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  P7</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P7</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P7</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P7</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  P8</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P8</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P8</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P8</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  P9</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P9</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P9</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P9</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  P10</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P10</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P10</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P10</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  P11</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P11</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P11</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P11</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  P12</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P12</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P12</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P12</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  P13</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P13</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P13</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P13</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  P14</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P14</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P14</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P14</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  P15</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P15</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P15</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P15</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> p</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The state is very large as we are verifying a large function (250 lines) directly mutating the memory. We recognize the parameters of the function (<code>Q</code>, <code>Q'</code>, <code>G</code>, <code>G'</code>) as well as the pre-computed points (<code>P0</code>, <code>P1</code>, <code>P2</code>, ..., <code>P16</code>). We also see the computation of the coordinates of the doubled point, stored at fixed memory addresses.</p>
<p>We define the <code>dbl_neg_P_127</code> point as:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">set </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dbl_neg_P_127 </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> ecDblNeg a p P_127</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We then rewrite the memory locations of the doubled point with the coordinates of <code>dbl_neg_P_127</code>:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apply_memory_update_at P_127_X_address dbl_neg_P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">reflexivity</span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apply_memory_update_at P_127_Y_address dbl_neg_P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">reflexivity</span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apply_memory_update_at P_127_ZZ_address dbl_neg_P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">reflexivity</span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apply_memory_update_at P_127_ZZZ_address dbl_neg_P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">reflexivity</span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>giving us the new state:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mem0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> mem1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2048</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> mem3</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> mem4</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> dbl_neg_P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mulmod </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dbl_neg_P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> dbl_neg_P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  HighLow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">merge u_high u_low</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">480</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> HighLow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">merge v_high v_low</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> Pure</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2048</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">^</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">126</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dbl_neg_P_127</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  p</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> Q</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PA</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> Q</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PA</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> Q</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PA</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> G</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PA</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> G</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PA</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> G</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PA</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> G</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PA</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  P0</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P0</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P0</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  P0</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  P1</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P1</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P1</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P1</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  P2</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P2</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P2</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P2</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  P3</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P3</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P3</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P3</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  P4</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P4</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P4</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P4</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  P5</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P5</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P5</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P5</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  P6</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P6</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P6</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P6</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  P7</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P7</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P7</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P7</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  P8</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P8</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P8</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P8</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  P9</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P9</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P9</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P9</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  P10</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P10</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P10</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P10</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  P11</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P11</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P11</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P11</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  P12</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P12</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P12</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P12</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  P13</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P13</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P13</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P13</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  P14</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P14</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P14</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P14</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  P15</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P15</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P15</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> P15</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">PZZ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ZZZ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> p</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Still large but much cleaner!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-what-remains-to-be-done">üëÄ What remains to be done<a href="https://formal.land/blog/2024/10/21/verification-smooth-library-1#-what-remains-to-be-done" class="hash-link" aria-label="Direct link to üëÄ What remains to be done" title="Direct link to üëÄ What remains to be done">‚Äã</a></h2>
<p>There are two main parts that remain to be done in order to have a full formal verification of the library:</p>
<ol>
<li>We need to complete the proof stating that the execution of the smart contract is equivalent to the execution of a purely functional version written in Coq, especially using recursive functions instead of <code>for</code> loops. Reasoning on the loops is complex; in the current version, we unroll the loops once in order to have a first step towards the full proof. As the memory used by the main function is quite large, we will first need to change the code we verify by looking at the Yul code generated before optimizations by the Solidity compiler.</li>
<li>Show that the purely functional version of the library is equivalent to the plain addition and scalar multiplication. We have only started this work. The main challenge is to show that we can remove the loop by doing the bitwise addition. This will require some bit-arithmetic reasoning, as well as field arithmetic for the operations modulo the prime number <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span>.</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-conclusion">‚úíÔ∏è Conclusion<a href="https://formal.land/blog/2024/10/21/verification-smooth-library-1#%EF%B8%8F-conclusion" class="hash-link" aria-label="Direct link to ‚úíÔ∏è Conclusion" title="Direct link to ‚úíÔ∏è Conclusion">‚Äã</a></h2>
<p>We have seen how the <strong>Smoo.th</strong> library works at a high level, how we can start verifying it, and what challenges do we face. This is also an interesting example to improve our tool <code>coq-of-solidity</code> and develop reasoning primitives for cryptographic code. We will continue this work in the coming weeks to verify more parts of this library.</p>
<div class="theme-admonition theme-admonition-success admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>For more</div><div class="admonitionContent_BuS1"><p><em>Follow us on <a href="https://x.com/FormalLand" target="_blank" rel="noopener noreferrer">X</a> or <a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer">LinkedIn</a>, or comment on this post below! Feel free to DM us for any formal verification services you need.</em></p></div></div>]]></content>
        <category label="Solidity" term="Solidity"/>
        <category label="Yul" term="Yul"/>
        <category label="elliptic curves" term="elliptic curves"/>
    </entry>
</feed>