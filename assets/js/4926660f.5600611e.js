"use strict";(self.webpackChunkformal_land=self.webpackChunkformal_land||[]).push([[6528],{50558:(s,e,a)=>{a.r(e),a.d(e,{assets:()=>c,contentTitle:()=>i,default:()=>o,frontMatter:()=>l,metadata:()=>r,toc:()=>h});var n=a(74848),t=a(28453);const l={title:"\ud83e\udd80 Typing and naming of Rust code in Rocq (2/3)",tags:["Rust","links","simulations"],authors:[]},i=void 0,r={permalink:"/blog/2025/02/05/links-for-rust-in-rocq-2",source:"@site/blog/2025-02-05-links-for-rust-in-rocq-2.md",title:"\ud83e\udd80 Typing and naming of Rust code in Rocq (2/3)",description:"In this blog post we present how represent a proof of execution for translated \ud83e\udd80&nbsp;Rust programs in &nbsp;Rocq/Coq, to show that it is possible to type the values and resolve the names. Resolving the names amounts to finding the trait instances and an ordering for the function definitions.",date:"2025-02-05T00:00:00.000Z",formattedDate:"February 5, 2025",tags:[{label:"Rust",permalink:"/blog/tags/rust"},{label:"links",permalink:"/blog/tags/links"},{label:"simulations",permalink:"/blog/tags/simulations"}],readingTime:9.82,hasTruncateMarker:!0,authors:[],frontMatter:{title:"\ud83e\udd80 Typing and naming of Rust code in Rocq (2/3)",tags:["Rust","links","simulations"],authors:[]},unlisted:!1,prevItem:{title:"\ud83e\udd80 Beginning of translation of OpenVM to Rocq",permalink:"/blog/2025/06/15/beginning-of-openvm-to-rocq"},nextItem:{title:"\ud83e\udd80 Typing and naming of Rust code in Rocq (1/3)",permalink:"/blog/2025/01/30/links-for-rust-in-rocq"}},c={authorsImageUrls:[]},h=[{value:"\ud83e\udea8 Untyped code",id:"-untyped-code",level:2},{value:"\ud83d\uddff Typed version",id:"-typed-version",level:2},{value:"\ud83d\udd2e Proof of execution",id:"-proof-of-execution",level:2},{value:"\ud83c\udfa3 Pointers",id:"-pointers",level:2},{value:"\ud83d\udca7 Extracting an execution",id:"-extracting-an-execution",level:2},{value:"\u2712\ufe0f Conclusion",id:"\ufe0f-conclusion",level:2}];function m(s){const e={a:"a",admonition:"admonition",annotation:"annotation",code:"code",em:"em",h2:"h2",img:"img",li:"li",math:"math",mi:"mi",mn:"mn",mo:"mo",mover:"mover",mrow:"mrow",mspace:"mspace",msub:"msub",msubsup:"msubsup",msup:"msup",mtext:"mtext",p:"p",pre:"pre",semantics:"semantics",span:"span",strong:"strong",ul:"ul",...(0,t.R)(),...s.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(e.p,{children:["In this blog post we present how represent a proof of execution for translated ",(0,n.jsx)(e.a,{href:"https://www.rust-lang.org/",children:"\ud83e\udd80\xa0Rust"})," programs in ",(0,n.jsxs)(e.a,{href:"https://rocq-prover.org/",children:[(0,n.jsx)("img",{src:"https://raw.githubusercontent.com/coq/rocq-prover.org/refs/heads/main/rocq-id/logos/SVG/icon-rocq-orange.svg",height:"18px"}),"\xa0Rocq/Coq"]}),", to show that it is possible to type the values and resolve the names. Resolving the names amounts to finding the trait instances and an ordering for the function definitions."]}),"\n",(0,n.jsxs)(e.p,{children:['We call these proofs of execution "links". They do not contain memory allocation strategies, which can be defined later in a second step called "simulation". From these links we have all the information to extract a typed execution that is equivalent to the translated code from ',(0,n.jsx)(e.a,{href:"https://github.com/formal-land/coq-of-rust",children:"coq-of-rust"}),". The core of the work presented in this article is in the file ",(0,n.jsx)(e.a,{href:"https://github.com/formal-land/coq-of-rust/blob/main/CoqOfRust/links/M.v",children:"CoqOfRust/links/M.v"})," on GitHub."]}),"\n",(0,n.jsx)(e.p,{children:"This is the continuation of the following article:"}),"\n",(0,n.jsxs)(e.ul,{children:["\n",(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:"/blog/2025/01/30/links-for-rust-in-rocq",children:"\ud83e\udd80 Typing and naming of Rust code in Rocq (1/3)"})}),"\n"]}),"\n",(0,n.jsxs)(e.admonition,{title:"Ask for the highest security!",type:"success",children:[(0,n.jsx)(e.p,{children:"When millions are at stake, bug bounties are not enough. How do you ensure your security audits are exhaustive?"}),(0,n.jsxs)(e.p,{children:["The best way is to use ",(0,n.jsx)(e.strong,{children:"formal verification"}),"."]}),(0,n.jsxs)(e.p,{children:[(0,n.jsx)(e.strong,{children:"Contact us"})," at\xa0",(0,n.jsx)(e.a,{href:"mailto:contact@formal.land",children:"\xa0\ud83d\udc8ccontact@formal.land"})," to make sure your code is safe!\xa0\ud83d\udee1\ufe0f"]}),(0,n.jsxs)(e.p,{children:["We cover ",(0,n.jsx)(e.strong,{children:"Rust"}),", ",(0,n.jsx)(e.strong,{children:"Solidity"}),", and ",(0,n.jsx)(e.strong,{children:"ZK systems"}),"."]})]}),"\n",(0,n.jsx)("figure",{children:(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{alt:"Green forest",src:a(36544).A+"",width:"1024",height:"1024"})})}),"\n",(0,n.jsx)(e.h2,{id:"-untyped-code",children:"\ud83e\udea8 Untyped code"}),"\n",(0,n.jsx)(e.p,{children:"Representing Rust programs as typed code in Rocq in a systematic way is challenging. Indeed, even if the two systems share many similarities (enum types, polymorphism, traits, ...) there are obstacles that prevent most Rust programs from being well-typed once represented in Rocq:"}),"\n",(0,n.jsxs)(e.ul,{children:["\n",(0,n.jsx)(e.li,{children:"There are lifetime annotations in Rust that are not present in Rocq. We can ignore them without too much loss on the typing side."}),"\n",(0,n.jsx)(e.li,{children:"The trait/type inference mechanism in Rocq fails in rare cases where it succeeds in Rust. These rare cases are enough to make almost all Rust programs untypable in Rocq. A solution is to add type annotations on all sub-expressions, but this is very verbose and we still encountered some examples where it did not work!"}),"\n",(0,n.jsx)(e.li,{children:"The type definitions might not be correctly ordered, with mutual dependencies between files or between traits and types. This is probably the biggest issue, as mutually recursive types cannot be defined in Rocq in a general way or can make the reasoning about code too complex when they can."}),"\n"]}),"\n",(0,n.jsxs)(e.p,{children:["For all the reasons above, we chose to instead translate the Rust code in Rocq collapsing all the types to a single type ",(0,n.jsx)(e.code,{children:"Value.t"}),":"]}),"\n",(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:"language-coq",children:"Module Value.\n  Inductive t : Set :=\n  | Bool : bool -> t\n  | Integer (kind : IntegerKind.t) (z : Z) : t\n  | Float : string -> t\n  | UnicodeChar : Z -> t\n  | String : string -> t\n  | Tuple : list t -> t\n  | Array : list t -> t\n  | StructRecord : string -> list (string * t) -> t\n  | StructTuple : string -> list t -> t\n  | Pointer : Pointer.t t -> t\n  | Closure : {'(Value, M) : (Set * Set) @ list Value -> M} -> t\n  | Error (message : string)\n  | DeclaredButUndefined.\nEnd Value.\n"})}),"\n",(0,n.jsxs)(e.p,{children:["We represent enums and structs using the ",(0,n.jsx)(e.code,{children:"StructRecord"})," or ",(0,n.jsx)(e.code,{children:"StructTuple"})," constructors, depending on when the fields are named or ordered. The first string parameter is the absolute name of the type or the name of the type concatenated to the name of the constructor for enums. Note that in Rust there is always a unique absolute name for all type/value definitions."]}),"\n",(0,n.jsxs)(e.p,{children:["For example, if we have the type ",(0,n.jsx)(e.code,{children:"Foo"})," in Rust:"]}),"\n",(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:"language-rust",children:"struct Foo {\n    a: i32,\n    b: bool,\n}\n"})}),"\n",(0,n.jsx)(e.p,{children:"we would represent a value:"}),"\n",(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:"language-rust",children:"let foo = Foo { a: 42, b: true };\n"})}),"\n",(0,n.jsx)(e.p,{children:"as:"}),"\n",(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:"language-coq",children:'Value.StructRecord "Foo" [("a", Value.Integer IntegerKind.I32 42); ("b", Value.Bool true)]\n'})}),"\n",(0,n.jsx)(e.p,{children:"In our experience, the named fields always appear in the same order."}),"\n",(0,n.jsx)(e.h2,{id:"-typed-version",children:"\ud83d\uddff Typed version"}),"\n",(0,n.jsx)(e.p,{children:"We let the user define a typed version of the code according to its need. Most of the time, the definitions will be straightforward, following the definitions in Rust. It will still be the opportunity to order the definitions in their order of dependencies, and break some mutual dependencies with custom definitions."}),"\n",(0,n.jsxs)(e.p,{children:["To relate typed values of some type ",(0,n.jsx)(e.code,{children:"A"})," with their representation in ",(0,n.jsx)(e.code,{children:"Value.t"}),", we use a conversion function from ",(0,n.jsx)(e.code,{children:"A"})," to ",(0,n.jsx)(e.code,{children:"Value.t"})," that should ideally be an injection. To help in the proofs and debugging, there should be at most one type and value of this type for each value in ",(0,n.jsx)(e.code,{children:"Value.t"}),". We also add for each type ",(0,n.jsx)(e.code,{children:"A"})," a serialized version of this type in ",(0,n.jsx)(e.code,{children:"Ty.t"})," which may be used on the Rust side to know in a unique way which trait instance to use."]}),"\n",(0,n.jsx)(e.p,{children:"Here is the Rocq type-class we use to represent the conversion:"}),"\n",(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:"language-coq",children:"Class Link (A : Set) : Set := {\n  \u03a6 : Ty.t;\n  \u03c6 : A -> Value.t;\n}.\n"})}),"\n",(0,n.jsxs)(e.p,{children:["It gives, for a user-defined type ",(0,n.jsx)(e.code,{children:"A"})," in Rocq, a way to represent this type in ",(0,n.jsx)(e.code,{children:"Ty.t"})," on the Rust side, and a way to convert values of this type to ",(0,n.jsx)(e.code,{children:"Value.t"}),". We use the Greek letters ",(0,n.jsx)(e.code,{children:"\u03a6"})," and ",(0,n.jsx)(e.code,{children:"\u03c6"})," to shorten the definitions. Here is the definition of the ",(0,n.jsx)(e.code,{children:"Link"})," instance for the boolean type:"]}),"\n",(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:"language-coq",children:'Module Bool.\n  Global Instance IsLink : Link bool := {\n    \u03a6 := Ty.path "bool";\n    \u03c6 b := Value.Bool b;\n  }.\n'})}),"\n",(0,n.jsxs)(e.p,{children:["Most of the definitions follow the same pattern. Note that we avoid defining a ",(0,n.jsxs)(e.span,{className:"katex",children:[(0,n.jsx)(e.span,{className:"katex-mathml",children:(0,n.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,n.jsxs)(e.semantics,{children:[(0,n.jsx)(e.mrow,{children:(0,n.jsxs)(e.msup,{children:[(0,n.jsx)(e.mi,{children:"\u03c6"}),(0,n.jsxs)(e.mrow,{children:[(0,n.jsx)(e.mo,{children:"\u2212"}),(0,n.jsx)(e.mn,{children:"1"})]})]})}),(0,n.jsx)(e.annotation,{encoding:"application/x-tex",children:"\u03c6^{-1}"})]})})}),(0,n.jsx)(e.span,{className:"katex-html","aria-hidden":"true",children:(0,n.jsxs)(e.span,{className:"base",children:[(0,n.jsx)(e.span,{className:"strut",style:{height:"1.0085em",verticalAlign:"-0.1944em"}}),(0,n.jsxs)(e.span,{className:"mord",children:[(0,n.jsx)(e.span,{className:"mord mathnormal",children:"\u03c6"}),(0,n.jsx)(e.span,{className:"msupsub",children:(0,n.jsx)(e.span,{className:"vlist-t",children:(0,n.jsx)(e.span,{className:"vlist-r",children:(0,n.jsx)(e.span,{className:"vlist",style:{height:"0.8141em"},children:(0,n.jsxs)(e.span,{style:{top:"-3.063em",marginRight:"0.05em"},children:[(0,n.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,n.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,n.jsxs)(e.span,{className:"mord mtight",children:[(0,n.jsx)(e.span,{className:"mord mtight",children:"\u2212"}),(0,n.jsx)(e.span,{className:"mord mtight",children:"1"})]})})]})})})})})]})]})})]})," function that would be impossible or hard to define in general and not needed. In our proofs of equivalence between the untyped translated Rust code and the typed version, we will attempt to show the commutativity of the following diagram:"]}),"\n",(0,n.jsx)("figure",{children:(0,n.jsx)(e.p,{children:(0,n.jsx)(e.img,{alt:"Commutative diagram",src:a(92374).A+"",width:"453",height:"303"})})}),"\n",(0,n.jsx)(e.p,{children:"where:"}),"\n",(0,n.jsxs)(e.ul,{children:["\n",(0,n.jsxs)(e.li,{children:[(0,n.jsxs)(e.span,{className:"katex",children:[(0,n.jsx)(e.span,{className:"katex-mathml",children:(0,n.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,n.jsxs)(e.semantics,{children:[(0,n.jsx)(e.mrow,{children:(0,n.jsx)(e.mi,{children:"f"})}),(0,n.jsx)(e.annotation,{encoding:"application/x-tex",children:"f"})]})})}),(0,n.jsx)(e.span,{className:"katex-html","aria-hidden":"true",children:(0,n.jsxs)(e.span,{className:"base",children:[(0,n.jsx)(e.span,{className:"strut",style:{height:"0.8889em",verticalAlign:"-0.1944em"}}),(0,n.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.10764em"},children:"f"})]})})]})," is the function from the translated Rust code,"]}),"\n",(0,n.jsxs)(e.li,{children:[(0,n.jsxs)(e.span,{className:"katex",children:[(0,n.jsx)(e.span,{className:"katex-mathml",children:(0,n.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,n.jsxs)(e.semantics,{children:[(0,n.jsx)(e.mrow,{children:(0,n.jsxs)(e.mover,{accent:"true",children:[(0,n.jsx)(e.mi,{children:"f"}),(0,n.jsx)(e.mo,{children:"~"})]})}),(0,n.jsx)(e.annotation,{encoding:"application/x-tex",children:"\\tilde{f}"})]})})}),(0,n.jsx)(e.span,{className:"katex-html","aria-hidden":"true",children:(0,n.jsxs)(e.span,{className:"base",children:[(0,n.jsx)(e.span,{className:"strut",style:{height:"1.1257em",verticalAlign:"-0.1944em"}}),(0,n.jsx)(e.span,{className:"mord accent",children:(0,n.jsxs)(e.span,{className:"vlist-t vlist-t2",children:[(0,n.jsxs)(e.span,{className:"vlist-r",children:[(0,n.jsxs)(e.span,{className:"vlist",style:{height:"0.9313em"},children:[(0,n.jsxs)(e.span,{style:{top:"-3em"},children:[(0,n.jsx)(e.span,{className:"pstrut",style:{height:"3em"}}),(0,n.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.10764em"},children:"f"})]}),(0,n.jsxs)(e.span,{style:{top:"-3.6134em"},children:[(0,n.jsx)(e.span,{className:"pstrut",style:{height:"3em"}}),(0,n.jsx)(e.span,{className:"accent-body",style:{left:"-0.0833em"},children:(0,n.jsx)(e.span,{className:"mord",children:"~"})})]})]}),(0,n.jsx)(e.span,{className:"vlist-s",children:"\u200b"})]}),(0,n.jsx)(e.span,{className:"vlist-r",children:(0,n.jsx)(e.span,{className:"vlist",style:{height:"0.1944em"},children:(0,n.jsx)(e.span,{})})})]})})]})})]})," is its typed version that we define,"]}),"\n",(0,n.jsxs)(e.li,{children:[(0,n.jsxs)(e.span,{className:"katex",children:[(0,n.jsx)(e.span,{className:"katex-mathml",children:(0,n.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,n.jsxs)(e.semantics,{children:[(0,n.jsx)(e.mrow,{children:(0,n.jsxs)(e.msub,{children:[(0,n.jsx)(e.mi,{children:"\u03c6"}),(0,n.jsx)(e.mi,{children:"A"})]})}),(0,n.jsx)(e.annotation,{encoding:"application/x-tex",children:"\u03c6_A"})]})})}),(0,n.jsx)(e.span,{className:"katex-html","aria-hidden":"true",children:(0,n.jsxs)(e.span,{className:"base",children:[(0,n.jsx)(e.span,{className:"strut",style:{height:"0.625em",verticalAlign:"-0.1944em"}}),(0,n.jsxs)(e.span,{className:"mord",children:[(0,n.jsx)(e.span,{className:"mord mathnormal",children:"\u03c6"}),(0,n.jsx)(e.span,{className:"msupsub",children:(0,n.jsxs)(e.span,{className:"vlist-t vlist-t2",children:[(0,n.jsxs)(e.span,{className:"vlist-r",children:[(0,n.jsx)(e.span,{className:"vlist",style:{height:"0.3283em"},children:(0,n.jsxs)(e.span,{style:{top:"-2.55em",marginLeft:"0em",marginRight:"0.05em"},children:[(0,n.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,n.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,n.jsx)(e.span,{className:"mord mathnormal mtight",children:"A"})})]})}),(0,n.jsx)(e.span,{className:"vlist-s",children:"\u200b"})]}),(0,n.jsx)(e.span,{className:"vlist-r",children:(0,n.jsx)(e.span,{className:"vlist",style:{height:"0.15em"},children:(0,n.jsx)(e.span,{})})})]})})]})]})})]})," and ",(0,n.jsxs)(e.span,{className:"katex",children:[(0,n.jsx)(e.span,{className:"katex-mathml",children:(0,n.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,n.jsxs)(e.semantics,{children:[(0,n.jsx)(e.mrow,{children:(0,n.jsxs)(e.msub,{children:[(0,n.jsx)(e.mi,{children:"\u03c6"}),(0,n.jsx)(e.mi,{children:"B"})]})}),(0,n.jsx)(e.annotation,{encoding:"application/x-tex",children:"\u03c6_B"})]})})}),(0,n.jsx)(e.span,{className:"katex-html","aria-hidden":"true",children:(0,n.jsxs)(e.span,{className:"base",children:[(0,n.jsx)(e.span,{className:"strut",style:{height:"0.625em",verticalAlign:"-0.1944em"}}),(0,n.jsxs)(e.span,{className:"mord",children:[(0,n.jsx)(e.span,{className:"mord mathnormal",children:"\u03c6"}),(0,n.jsx)(e.span,{className:"msupsub",children:(0,n.jsxs)(e.span,{className:"vlist-t vlist-t2",children:[(0,n.jsxs)(e.span,{className:"vlist-r",children:[(0,n.jsx)(e.span,{className:"vlist",style:{height:"0.3283em"},children:(0,n.jsxs)(e.span,{style:{top:"-2.55em",marginLeft:"0em",marginRight:"0.05em"},children:[(0,n.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,n.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,n.jsx)(e.span,{className:"mord mathnormal mtight",style:{marginRight:"0.05017em"},children:"B"})})]})}),(0,n.jsx)(e.span,{className:"vlist-s",children:"\u200b"})]}),(0,n.jsx)(e.span,{className:"vlist-r",children:(0,n.jsx)(e.span,{className:"vlist",style:{height:"0.15em"},children:(0,n.jsx)(e.span,{})})})]})})]})]})})]})," are the conversion functions for the types ",(0,n.jsx)(e.code,{children:"A"})," and ",(0,n.jsx)(e.code,{children:"B"})," respectively."]}),"\n"]}),"\n",(0,n.jsx)(e.p,{children:"The commutativity of the diagram mean that all the paths are the same, that is to say that:"}),"\n",(0,n.jsx)(e.span,{className:"katex-display",children:(0,n.jsxs)(e.span,{className:"katex",children:[(0,n.jsx)(e.span,{className:"katex-mathml",children:(0,n.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",display:"block",children:(0,n.jsxs)(e.semantics,{children:[(0,n.jsxs)(e.mrow,{children:[(0,n.jsx)(e.mi,{mathvariant:"normal",children:"\u2200"}),(0,n.jsx)(e.mo,{stretchy:"false",children:"("}),(0,n.jsx)(e.mi,{children:"x"}),(0,n.jsx)(e.mo,{children:":"}),(0,n.jsx)(e.mi,{children:"A"}),(0,n.jsx)(e.mo,{stretchy:"false",children:")"}),(0,n.jsx)(e.mo,{separator:"true",children:","}),(0,n.jsx)(e.mspace,{width:"1em"}),(0,n.jsx)(e.mi,{children:"f"}),(0,n.jsx)(e.mo,{stretchy:"false",children:"("}),(0,n.jsxs)(e.msub,{children:[(0,n.jsx)(e.mi,{children:"\u03c6"}),(0,n.jsx)(e.mi,{children:"A"})]}),(0,n.jsx)(e.mi,{children:"x"}),(0,n.jsx)(e.mo,{stretchy:"false",children:")"}),(0,n.jsx)(e.mo,{children:"="}),(0,n.jsxs)(e.msub,{children:[(0,n.jsx)(e.mi,{children:"\u03c6"}),(0,n.jsx)(e.mi,{children:"B"})]}),(0,n.jsx)(e.mo,{stretchy:"false",children:"("}),(0,n.jsxs)(e.mover,{accent:"true",children:[(0,n.jsx)(e.mi,{children:"f"}),(0,n.jsx)(e.mo,{children:"~"})]}),(0,n.jsx)(e.mi,{children:"x"}),(0,n.jsx)(e.mo,{stretchy:"false",children:")"})]}),(0,n.jsx)(e.annotation,{encoding:"application/x-tex",children:"\\forall (x : A),\\quad f (\u03c6_A x) = \u03c6_B (\\tilde{f} x)"})]})})}),(0,n.jsxs)(e.span,{className:"katex-html","aria-hidden":"true",children:[(0,n.jsxs)(e.span,{className:"base",children:[(0,n.jsx)(e.span,{className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),(0,n.jsx)(e.span,{className:"mord",children:"\u2200"}),(0,n.jsx)(e.span,{className:"mopen",children:"("}),(0,n.jsx)(e.span,{className:"mord mathnormal",children:"x"}),(0,n.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}}),(0,n.jsx)(e.span,{className:"mrel",children:":"}),(0,n.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}})]}),(0,n.jsxs)(e.span,{className:"base",children:[(0,n.jsx)(e.span,{className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),(0,n.jsx)(e.span,{className:"mord mathnormal",children:"A"}),(0,n.jsx)(e.span,{className:"mclose",children:")"}),(0,n.jsx)(e.span,{className:"mpunct",children:","}),(0,n.jsx)(e.span,{className:"mspace",style:{marginRight:"1em"}}),(0,n.jsx)(e.span,{className:"mspace",style:{marginRight:"0.1667em"}}),(0,n.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.10764em"},children:"f"}),(0,n.jsx)(e.span,{className:"mopen",children:"("}),(0,n.jsxs)(e.span,{className:"mord",children:[(0,n.jsx)(e.span,{className:"mord mathnormal",children:"\u03c6"}),(0,n.jsx)(e.span,{className:"msupsub",children:(0,n.jsxs)(e.span,{className:"vlist-t vlist-t2",children:[(0,n.jsxs)(e.span,{className:"vlist-r",children:[(0,n.jsx)(e.span,{className:"vlist",style:{height:"0.3283em"},children:(0,n.jsxs)(e.span,{style:{top:"-2.55em",marginLeft:"0em",marginRight:"0.05em"},children:[(0,n.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,n.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,n.jsx)(e.span,{className:"mord mathnormal mtight",children:"A"})})]})}),(0,n.jsx)(e.span,{className:"vlist-s",children:"\u200b"})]}),(0,n.jsx)(e.span,{className:"vlist-r",children:(0,n.jsx)(e.span,{className:"vlist",style:{height:"0.15em"},children:(0,n.jsx)(e.span,{})})})]})})]}),(0,n.jsx)(e.span,{className:"mord mathnormal",children:"x"}),(0,n.jsx)(e.span,{className:"mclose",children:")"}),(0,n.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}}),(0,n.jsx)(e.span,{className:"mrel",children:"="}),(0,n.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}})]}),(0,n.jsxs)(e.span,{className:"base",children:[(0,n.jsx)(e.span,{className:"strut",style:{height:"1.1813em",verticalAlign:"-0.25em"}}),(0,n.jsxs)(e.span,{className:"mord",children:[(0,n.jsx)(e.span,{className:"mord mathnormal",children:"\u03c6"}),(0,n.jsx)(e.span,{className:"msupsub",children:(0,n.jsxs)(e.span,{className:"vlist-t vlist-t2",children:[(0,n.jsxs)(e.span,{className:"vlist-r",children:[(0,n.jsx)(e.span,{className:"vlist",style:{height:"0.3283em"},children:(0,n.jsxs)(e.span,{style:{top:"-2.55em",marginLeft:"0em",marginRight:"0.05em"},children:[(0,n.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,n.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,n.jsx)(e.span,{className:"mord mathnormal mtight",style:{marginRight:"0.05017em"},children:"B"})})]})}),(0,n.jsx)(e.span,{className:"vlist-s",children:"\u200b"})]}),(0,n.jsx)(e.span,{className:"vlist-r",children:(0,n.jsx)(e.span,{className:"vlist",style:{height:"0.15em"},children:(0,n.jsx)(e.span,{})})})]})})]}),(0,n.jsx)(e.span,{className:"mopen",children:"("}),(0,n.jsx)(e.span,{className:"mord accent",children:(0,n.jsxs)(e.span,{className:"vlist-t vlist-t2",children:[(0,n.jsxs)(e.span,{className:"vlist-r",children:[(0,n.jsxs)(e.span,{className:"vlist",style:{height:"0.9313em"},children:[(0,n.jsxs)(e.span,{style:{top:"-3em"},children:[(0,n.jsx)(e.span,{className:"pstrut",style:{height:"3em"}}),(0,n.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.10764em"},children:"f"})]}),(0,n.jsxs)(e.span,{style:{top:"-3.6134em"},children:[(0,n.jsx)(e.span,{className:"pstrut",style:{height:"3em"}}),(0,n.jsx)(e.span,{className:"accent-body",style:{left:"-0.0833em"},children:(0,n.jsx)(e.span,{className:"mord",children:"~"})})]})]}),(0,n.jsx)(e.span,{className:"vlist-s",children:"\u200b"})]}),(0,n.jsx)(e.span,{className:"vlist-r",children:(0,n.jsx)(e.span,{className:"vlist",style:{height:"0.1944em"},children:(0,n.jsx)(e.span,{})})})]})}),(0,n.jsx)(e.span,{className:"mord mathnormal",children:"x"}),(0,n.jsx)(e.span,{className:"mclose",children:")"})]})]})]})}),"\n",(0,n.jsx)(e.h2,{id:"-proof-of-execution",children:"\ud83d\udd2e Proof of execution"}),"\n",(0,n.jsxs)(e.p,{children:["To both define the typed ",(0,n.jsxs)(e.span,{className:"katex",children:[(0,n.jsx)(e.span,{className:"katex-mathml",children:(0,n.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,n.jsxs)(e.semantics,{children:[(0,n.jsx)(e.mrow,{children:(0,n.jsxs)(e.mover,{accent:"true",children:[(0,n.jsx)(e.mi,{children:"f"}),(0,n.jsx)(e.mo,{children:"~"})]})}),(0,n.jsx)(e.annotation,{encoding:"application/x-tex",children:"\\tilde{f}"})]})})}),(0,n.jsx)(e.span,{className:"katex-html","aria-hidden":"true",children:(0,n.jsxs)(e.span,{className:"base",children:[(0,n.jsx)(e.span,{className:"strut",style:{height:"1.1257em",verticalAlign:"-0.1944em"}}),(0,n.jsx)(e.span,{className:"mord accent",children:(0,n.jsxs)(e.span,{className:"vlist-t vlist-t2",children:[(0,n.jsxs)(e.span,{className:"vlist-r",children:[(0,n.jsxs)(e.span,{className:"vlist",style:{height:"0.9313em"},children:[(0,n.jsxs)(e.span,{style:{top:"-3em"},children:[(0,n.jsx)(e.span,{className:"pstrut",style:{height:"3em"}}),(0,n.jsx)(e.span,{className:"mord mathnormal",style:{marginRight:"0.10764em"},children:"f"})]}),(0,n.jsxs)(e.span,{style:{top:"-3.6134em"},children:[(0,n.jsx)(e.span,{className:"pstrut",style:{height:"3em"}}),(0,n.jsx)(e.span,{className:"accent-body",style:{left:"-0.0833em"},children:(0,n.jsx)(e.span,{className:"mord",children:"~"})})]})]}),(0,n.jsx)(e.span,{className:"vlist-s",children:"\u200b"})]}),(0,n.jsx)(e.span,{className:"vlist-r",children:(0,n.jsx)(e.span,{className:"vlist",style:{height:"0.1944em"},children:(0,n.jsx)(e.span,{})})})]})})]})})]})," version of the Rust code and to prove the commutativity of the diagram, we will define a tree that follows that the tree-like structure of the monad for the translated code."]}),"\n",(0,n.jsx)(e.p,{children:'Here are its basic combinators for the "return" and the "bind" of the monad:'}),"\n",(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:"language-coq",children:"Inductive t (Output : Set) `{Link Output} : M -> Set :=\n| Pure\n    (output : Output.t Output)\n    (output' : Value.t + Exception.t) :\n  output' = Output.to_value output ->\n  {{ LowM.Pure output' \ud83d\udd3d Output }}\n| Let {Output' : Set}\n    (ty : Ty.t) (to_value : Output' -> Value.t)\n    (e : M) (k : Value.t + Exception.t -> M) :\n  let _ := Build_Link _ ty to_value in\n  {{ e \ud83d\udd3d Output' }} ->\n  (forall (value_inter : Output.t Output'),\n    {{ k (Output.to_value value_inter) \ud83d\udd3d Output }}\n  ) ->\n  {{ LowM.Let e k \ud83d\udd3d Output }}\n"})}),"\n",(0,n.jsx)(e.p,{children:"It reads as follows:"}),"\n",(0,n.jsxs)(e.ul,{children:["\n",(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.strong,{children:"Pure"})," If we have some ",(0,n.jsx)(e.code,{children:"output'"})," value of type ",(0,n.jsx)(e.code,{children:"Value.t"})," some ",(0,n.jsx)(e.code,{children:"output"})," of type ",(0,n.jsx)(e.code,{children:"A"})," that are related through the ",(0,n.jsx)(e.code,{children:"Link"})," instance, then we can build a tree saying that the monadic untyped term ",(0,n.jsx)(e.code,{children:"LowM.pure output'"})," executes to some value of type ",(0,n.jsx)(e.code,{children:"Output"})," using the conversion from the ",(0,n.jsx)(e.code,{children:"Link"})," instance. We wrap the conversion in the ",(0,n.jsx)(e.code,{children:"Output.t"})," type to also represent exceptions, which are special error values that we propagate, for example, in case of ",(0,n.jsx)(e.code,{children:"panic!"})," or premature ",(0,n.jsx)(e.code,{children:"return"})," in a function."]}),"\n",(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.strong,{children:"Let"})," If an expression ",(0,n.jsx)(e.code,{children:"e"})," can be reduced to a value of type ",(0,n.jsx)(e.code,{children:"Output'"})," and if, for any value of type ",(0,n.jsx)(e.code,{children:"Output'"}),", using the same link instance, we can execute ",(0,n.jsx)(e.code,{children:"k"})," of this value to some value of type ",(0,n.jsx)(e.code,{children:"Output"}),", then we can execute the monadic term ",(0,n.jsx)(e.code,{children:"LowM.let e k"})," to some value of type ",(0,n.jsx)(e.code,{children:"Output"}),"."]}),"\n"]}),"\n",(0,n.jsxs)(e.p,{children:["Note that in most of the expressions above the ",(0,n.jsx)(e.code,{children:"Link"})," instance is implicit but still uniquely inferred by Rocq as there is only one for the types ",(0,n.jsx)(e.code,{children:"Output"})," and ",(0,n.jsx)(e.code,{children:"Output'"})," at a time."]}),"\n",(0,n.jsx)(e.h2,{id:"-pointers",children:"\ud83c\udfa3 Pointers"}),"\n",(0,n.jsxs)(e.p,{children:["One difficulty is maintaining the consistency of the ",(0,n.jsx)(e.code,{children:"\u03c6"})," function that we use, especially for pointer operations (allocate, read, and write). Indeed, if one allocates a pointer to a boolean with the function:"]}),"\n",(0,n.jsx)(e.span,{className:"katex-display",children:(0,n.jsxs)(e.span,{className:"katex",children:[(0,n.jsx)(e.span,{className:"katex-mathml",children:(0,n.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",display:"block",children:(0,n.jsxs)(e.semantics,{children:[(0,n.jsxs)(e.mrow,{children:[(0,n.jsxs)(e.msub,{children:[(0,n.jsx)(e.mi,{children:"\u03c6"}),(0,n.jsx)(e.mtext,{children:"bool"})]}),(0,n.jsx)(e.mo,{children:":"}),(0,n.jsx)(e.mtext,{children:"bool"}),(0,n.jsx)(e.mo,{children:"\u2192"}),(0,n.jsx)(e.mtext,{children:"Value.t"}),(0,n.jsx)(e.mspace,{linebreak:"newline"}),(0,n.jsxs)(e.msub,{children:[(0,n.jsx)(e.mi,{children:"\u03c6"}),(0,n.jsx)(e.mtext,{children:"bool"})]}),(0,n.jsx)(e.mo,{stretchy:"false",children:"("}),(0,n.jsx)(e.mi,{children:"b"}),(0,n.jsx)(e.mo,{stretchy:"false",children:")"}),(0,n.jsx)(e.mo,{children:"="}),(0,n.jsx)(e.mtext,{children:"Value.Bool"}),(0,n.jsx)(e.mo,{stretchy:"false",children:"("}),(0,n.jsx)(e.mi,{children:"b"}),(0,n.jsx)(e.mo,{stretchy:"false",children:")"})]}),(0,n.jsx)(e.annotation,{encoding:"application/x-tex",children:"\\varphi_{\\text{bool}} : \\text{bool} \\to \\text{Value.t}\\\\\n\\varphi_{\\text{bool}}(b) = \\text{Value.Bool}(b)"})]})})}),(0,n.jsxs)(e.span,{className:"katex-html","aria-hidden":"true",children:[(0,n.jsxs)(e.span,{className:"base",children:[(0,n.jsx)(e.span,{className:"strut",style:{height:"0.625em",verticalAlign:"-0.1944em"}}),(0,n.jsxs)(e.span,{className:"mord",children:[(0,n.jsx)(e.span,{className:"mord mathnormal",children:"\u03c6"}),(0,n.jsx)(e.span,{className:"msupsub",children:(0,n.jsxs)(e.span,{className:"vlist-t vlist-t2",children:[(0,n.jsxs)(e.span,{className:"vlist-r",children:[(0,n.jsx)(e.span,{className:"vlist",style:{height:"0.3361em"},children:(0,n.jsxs)(e.span,{style:{top:"-2.55em",marginLeft:"0em",marginRight:"0.05em"},children:[(0,n.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,n.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,n.jsx)(e.span,{className:"mord mtight",children:(0,n.jsx)(e.span,{className:"mord text mtight",children:(0,n.jsx)(e.span,{className:"mord mtight",children:"bool"})})})})]})}),(0,n.jsx)(e.span,{className:"vlist-s",children:"\u200b"})]}),(0,n.jsx)(e.span,{className:"vlist-r",children:(0,n.jsx)(e.span,{className:"vlist",style:{height:"0.15em"},children:(0,n.jsx)(e.span,{})})})]})})]}),(0,n.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}}),(0,n.jsx)(e.span,{className:"mrel",children:":"}),(0,n.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}})]}),(0,n.jsxs)(e.span,{className:"base",children:[(0,n.jsx)(e.span,{className:"strut",style:{height:"0.6944em"}}),(0,n.jsx)(e.span,{className:"mord text",children:(0,n.jsx)(e.span,{className:"mord",children:"bool"})}),(0,n.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}}),(0,n.jsx)(e.span,{className:"mrel",children:"\u2192"}),(0,n.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}})]}),(0,n.jsxs)(e.span,{className:"base",children:[(0,n.jsx)(e.span,{className:"strut",style:{height:"0.6944em"}}),(0,n.jsx)(e.span,{className:"mord text",children:(0,n.jsx)(e.span,{className:"mord",children:"Value.t"})})]}),(0,n.jsx)(e.span,{className:"mspace newline"}),(0,n.jsxs)(e.span,{className:"base",children:[(0,n.jsx)(e.span,{className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),(0,n.jsxs)(e.span,{className:"mord",children:[(0,n.jsx)(e.span,{className:"mord mathnormal",children:"\u03c6"}),(0,n.jsx)(e.span,{className:"msupsub",children:(0,n.jsxs)(e.span,{className:"vlist-t vlist-t2",children:[(0,n.jsxs)(e.span,{className:"vlist-r",children:[(0,n.jsx)(e.span,{className:"vlist",style:{height:"0.3361em"},children:(0,n.jsxs)(e.span,{style:{top:"-2.55em",marginLeft:"0em",marginRight:"0.05em"},children:[(0,n.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,n.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,n.jsx)(e.span,{className:"mord mtight",children:(0,n.jsx)(e.span,{className:"mord text mtight",children:(0,n.jsx)(e.span,{className:"mord mtight",children:"bool"})})})})]})}),(0,n.jsx)(e.span,{className:"vlist-s",children:"\u200b"})]}),(0,n.jsx)(e.span,{className:"vlist-r",children:(0,n.jsx)(e.span,{className:"vlist",style:{height:"0.15em"},children:(0,n.jsx)(e.span,{})})})]})})]}),(0,n.jsx)(e.span,{className:"mopen",children:"("}),(0,n.jsx)(e.span,{className:"mord mathnormal",children:"b"}),(0,n.jsx)(e.span,{className:"mclose",children:")"}),(0,n.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}}),(0,n.jsx)(e.span,{className:"mrel",children:"="}),(0,n.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}})]}),(0,n.jsxs)(e.span,{className:"base",children:[(0,n.jsx)(e.span,{className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),(0,n.jsx)(e.span,{className:"mord text",children:(0,n.jsx)(e.span,{className:"mord",children:"Value.Bool"})}),(0,n.jsx)(e.span,{className:"mopen",children:"("}),(0,n.jsx)(e.span,{className:"mord mathnormal",children:"b"}),(0,n.jsx)(e.span,{className:"mclose",children:")"})]})]})]})}),"\n",(0,n.jsx)(e.p,{children:"and reads it with the function:"}),"\n",(0,n.jsx)(e.span,{className:"katex-display",children:(0,n.jsxs)(e.span,{className:"katex",children:[(0,n.jsx)(e.span,{className:"katex-mathml",children:(0,n.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",display:"block",children:(0,n.jsxs)(e.semantics,{children:[(0,n.jsxs)(e.mrow,{children:[(0,n.jsxs)(e.msubsup,{children:[(0,n.jsx)(e.mi,{children:"\u03c6"}),(0,n.jsx)(e.mtext,{children:"bool"}),(0,n.jsx)(e.mo,{mathvariant:"normal",lspace:"0em",rspace:"0em",children:"\u2032"})]}),(0,n.jsx)(e.mo,{children:":"}),(0,n.jsx)(e.mtext,{children:"bool"}),(0,n.jsx)(e.mo,{children:"\u2192"}),(0,n.jsx)(e.mtext,{children:"Value.t"}),(0,n.jsx)(e.mspace,{linebreak:"newline"}),(0,n.jsxs)(e.msubsup,{children:[(0,n.jsx)(e.mi,{children:"\u03c6"}),(0,n.jsx)(e.mtext,{children:"bool"}),(0,n.jsx)(e.mo,{mathvariant:"normal",lspace:"0em",rspace:"0em",children:"\u2032"})]}),(0,n.jsx)(e.mo,{stretchy:"false",children:"("}),(0,n.jsx)(e.mi,{children:"b"}),(0,n.jsx)(e.mo,{stretchy:"false",children:")"}),(0,n.jsx)(e.mo,{children:"="}),(0,n.jsx)(e.mtext,{children:"Value.Bool"}),(0,n.jsx)(e.mo,{stretchy:"false",children:"("}),(0,n.jsx)(e.mtext,{children:"not"}),(0,n.jsx)(e.mo,{stretchy:"false",children:"("}),(0,n.jsx)(e.mtext,{children:"b"}),(0,n.jsx)(e.mo,{stretchy:"false",children:")"}),(0,n.jsx)(e.mo,{stretchy:"false",children:")"})]}),(0,n.jsx)(e.annotation,{encoding:"application/x-tex",children:"\\varphi'_{\\text{bool}} : \\text{bool} \\to \\text{Value.t}\\\\\n\\varphi'_{\\text{bool}}(b) = \\text{Value.Bool}(\\text{not}(\\text{b}))"})]})})}),(0,n.jsxs)(e.span,{className:"katex-html","aria-hidden":"true",children:[(0,n.jsxs)(e.span,{className:"base",children:[(0,n.jsx)(e.span,{className:"strut",style:{height:"1.0489em",verticalAlign:"-0.247em"}}),(0,n.jsxs)(e.span,{className:"mord",children:[(0,n.jsx)(e.span,{className:"mord mathnormal",children:"\u03c6"}),(0,n.jsx)(e.span,{className:"msupsub",children:(0,n.jsxs)(e.span,{className:"vlist-t vlist-t2",children:[(0,n.jsxs)(e.span,{className:"vlist-r",children:[(0,n.jsxs)(e.span,{className:"vlist",style:{height:"0.8019em"},children:[(0,n.jsxs)(e.span,{style:{top:"-2.453em",marginLeft:"0em",marginRight:"0.05em"},children:[(0,n.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,n.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,n.jsx)(e.span,{className:"mord mtight",children:(0,n.jsx)(e.span,{className:"mord text mtight",children:(0,n.jsx)(e.span,{className:"mord mtight",children:"bool"})})})})]}),(0,n.jsxs)(e.span,{style:{top:"-3.113em",marginRight:"0.05em"},children:[(0,n.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,n.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,n.jsx)(e.span,{className:"mord mtight",children:(0,n.jsx)(e.span,{className:"mord mtight",children:"\u2032"})})})]})]}),(0,n.jsx)(e.span,{className:"vlist-s",children:"\u200b"})]}),(0,n.jsx)(e.span,{className:"vlist-r",children:(0,n.jsx)(e.span,{className:"vlist",style:{height:"0.247em"},children:(0,n.jsx)(e.span,{})})})]})})]}),(0,n.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}}),(0,n.jsx)(e.span,{className:"mrel",children:":"}),(0,n.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}})]}),(0,n.jsxs)(e.span,{className:"base",children:[(0,n.jsx)(e.span,{className:"strut",style:{height:"0.6944em"}}),(0,n.jsx)(e.span,{className:"mord text",children:(0,n.jsx)(e.span,{className:"mord",children:"bool"})}),(0,n.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}}),(0,n.jsx)(e.span,{className:"mrel",children:"\u2192"}),(0,n.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}})]}),(0,n.jsxs)(e.span,{className:"base",children:[(0,n.jsx)(e.span,{className:"strut",style:{height:"0.6944em"}}),(0,n.jsx)(e.span,{className:"mord text",children:(0,n.jsx)(e.span,{className:"mord",children:"Value.t"})})]}),(0,n.jsx)(e.span,{className:"mspace newline"}),(0,n.jsxs)(e.span,{className:"base",children:[(0,n.jsx)(e.span,{className:"strut",style:{height:"1.0519em",verticalAlign:"-0.25em"}}),(0,n.jsxs)(e.span,{className:"mord",children:[(0,n.jsx)(e.span,{className:"mord mathnormal",children:"\u03c6"}),(0,n.jsx)(e.span,{className:"msupsub",children:(0,n.jsxs)(e.span,{className:"vlist-t vlist-t2",children:[(0,n.jsxs)(e.span,{className:"vlist-r",children:[(0,n.jsxs)(e.span,{className:"vlist",style:{height:"0.8019em"},children:[(0,n.jsxs)(e.span,{style:{top:"-2.453em",marginLeft:"0em",marginRight:"0.05em"},children:[(0,n.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,n.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,n.jsx)(e.span,{className:"mord mtight",children:(0,n.jsx)(e.span,{className:"mord text mtight",children:(0,n.jsx)(e.span,{className:"mord mtight",children:"bool"})})})})]}),(0,n.jsxs)(e.span,{style:{top:"-3.113em",marginRight:"0.05em"},children:[(0,n.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,n.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,n.jsx)(e.span,{className:"mord mtight",children:(0,n.jsx)(e.span,{className:"mord mtight",children:"\u2032"})})})]})]}),(0,n.jsx)(e.span,{className:"vlist-s",children:"\u200b"})]}),(0,n.jsx)(e.span,{className:"vlist-r",children:(0,n.jsx)(e.span,{className:"vlist",style:{height:"0.247em"},children:(0,n.jsx)(e.span,{})})})]})})]}),(0,n.jsx)(e.span,{className:"mopen",children:"("}),(0,n.jsx)(e.span,{className:"mord mathnormal",children:"b"}),(0,n.jsx)(e.span,{className:"mclose",children:")"}),(0,n.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}}),(0,n.jsx)(e.span,{className:"mrel",children:"="}),(0,n.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}})]}),(0,n.jsxs)(e.span,{className:"base",children:[(0,n.jsx)(e.span,{className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),(0,n.jsx)(e.span,{className:"mord text",children:(0,n.jsx)(e.span,{className:"mord",children:"Value.Bool"})}),(0,n.jsx)(e.span,{className:"mopen",children:"("}),(0,n.jsx)(e.span,{className:"mord text",children:(0,n.jsx)(e.span,{className:"mord",children:"not"})}),(0,n.jsx)(e.span,{className:"mopen",children:"("}),(0,n.jsx)(e.span,{className:"mord text",children:(0,n.jsx)(e.span,{className:"mord",children:"b"})}),(0,n.jsx)(e.span,{className:"mclose",children:"))"})]})]})]})}),"\n",(0,n.jsx)(e.p,{children:"the value that is read will be different from the value that was allocated."}),"\n",(0,n.jsxs)(e.p,{children:["In order to maintain the consistency of the pointer operations, we attach an extra function ",(0,n.jsxs)(e.span,{className:"katex",children:[(0,n.jsx)(e.span,{className:"katex-mathml",children:(0,n.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,n.jsxs)(e.semantics,{children:[(0,n.jsx)(e.mrow,{children:(0,n.jsxs)(e.msub,{children:[(0,n.jsx)(e.mi,{children:"\u03c6"}),(0,n.jsx)(e.mi,{children:"A"})]})}),(0,n.jsx)(e.annotation,{encoding:"application/x-tex",children:"\\varphi_A"})]})})}),(0,n.jsx)(e.span,{className:"katex-html","aria-hidden":"true",children:(0,n.jsxs)(e.span,{className:"base",children:[(0,n.jsx)(e.span,{className:"strut",style:{height:"0.625em",verticalAlign:"-0.1944em"}}),(0,n.jsxs)(e.span,{className:"mord",children:[(0,n.jsx)(e.span,{className:"mord mathnormal",children:"\u03c6"}),(0,n.jsx)(e.span,{className:"msupsub",children:(0,n.jsxs)(e.span,{className:"vlist-t vlist-t2",children:[(0,n.jsxs)(e.span,{className:"vlist-r",children:[(0,n.jsx)(e.span,{className:"vlist",style:{height:"0.3283em"},children:(0,n.jsxs)(e.span,{style:{top:"-2.55em",marginLeft:"0em",marginRight:"0.05em"},children:[(0,n.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,n.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,n.jsx)(e.span,{className:"mord mathnormal mtight",children:"A"})})]})}),(0,n.jsx)(e.span,{className:"vlist-s",children:"\u200b"})]}),(0,n.jsx)(e.span,{className:"vlist-r",children:(0,n.jsx)(e.span,{className:"vlist",style:{height:"0.15em"},children:(0,n.jsx)(e.span,{})})})]})})]})]})})]})," to pointers that we allocated in the untyped translation and make sure that this function, acting as a meta-data at the level of the untyped code, is properly forwarded to all subsequent use. That way, we make sure we always use the same ",(0,n.jsxs)(e.span,{className:"katex",children:[(0,n.jsx)(e.span,{className:"katex-mathml",children:(0,n.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,n.jsxs)(e.semantics,{children:[(0,n.jsx)(e.mrow,{children:(0,n.jsx)(e.mi,{children:"\u03c6"})}),(0,n.jsx)(e.annotation,{encoding:"application/x-tex",children:"\\varphi"})]})})}),(0,n.jsx)(e.span,{className:"katex-html","aria-hidden":"true",children:(0,n.jsxs)(e.span,{className:"base",children:[(0,n.jsx)(e.span,{className:"strut",style:{height:"0.625em",verticalAlign:"-0.1944em"}}),(0,n.jsx)(e.span,{className:"mord mathnormal",children:"\u03c6"})]})})]})," function when allocating, reading, or writing a pointer."]}),"\n",(0,n.jsx)(e.p,{children:"Here is the rule to define a proof of execution for the allocation of a pointer:"}),"\n",(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:"language-coq",children:"| CallPrimitiveStateAlloc\n    (value' : Value.t)\n    (k : Value.t -> M)\n    (of_value : OfValue.t value') :\n  (forall (ref : Ref.t Pointer.Kind.Raw (OfValue.get_Set of_value)),\n    {{ k (\u03c6 ref) \ud83d\udd3d Output }}\n  ) ->\n  {{ LowM.CallPrimitive (Primitive.StateAlloc value') k \ud83d\udd3d Output }}\n"})}),"\n",(0,n.jsxs)(e.p,{children:["We have the ",(0,n.jsx)(e.code,{children:"Ref.t"})," type on the side of the typed version to represent the Rust pointers. We reason for any possible references that could be allocated for the untyped value ",(0,n.jsx)(e.code,{children:"value'"}),". We use the ",(0,n.jsx)(e.code,{children:"OfValue.t"})," type to represent a combination of a type\xa0",(0,n.jsxs)(e.span,{className:"katex",children:[(0,n.jsx)(e.span,{className:"katex-mathml",children:(0,n.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,n.jsxs)(e.semantics,{children:[(0,n.jsx)(e.mrow,{children:(0,n.jsx)(e.mi,{children:"A"})}),(0,n.jsx)(e.annotation,{encoding:"application/x-tex",children:"A"})]})})}),(0,n.jsx)(e.span,{className:"katex-html","aria-hidden":"true",children:(0,n.jsxs)(e.span,{className:"base",children:[(0,n.jsx)(e.span,{className:"strut",style:{height:"0.6833em"}}),(0,n.jsx)(e.span,{className:"mord mathnormal",children:"A"})]})})]})," and a certain function\xa0",(0,n.jsxs)(e.span,{className:"katex",children:[(0,n.jsx)(e.span,{className:"katex-mathml",children:(0,n.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,n.jsxs)(e.semantics,{children:[(0,n.jsx)(e.mrow,{children:(0,n.jsxs)(e.msub,{children:[(0,n.jsx)(e.mi,{children:"\u03c6"}),(0,n.jsx)(e.mi,{children:"A"})]})}),(0,n.jsx)(e.annotation,{encoding:"application/x-tex",children:"\\varphi_A"})]})})}),(0,n.jsx)(e.span,{className:"katex-html","aria-hidden":"true",children:(0,n.jsxs)(e.span,{className:"base",children:[(0,n.jsx)(e.span,{className:"strut",style:{height:"0.625em",verticalAlign:"-0.1944em"}}),(0,n.jsxs)(e.span,{className:"mord",children:[(0,n.jsx)(e.span,{className:"mord mathnormal",children:"\u03c6"}),(0,n.jsx)(e.span,{className:"msupsub",children:(0,n.jsxs)(e.span,{className:"vlist-t vlist-t2",children:[(0,n.jsxs)(e.span,{className:"vlist-r",children:[(0,n.jsx)(e.span,{className:"vlist",style:{height:"0.3283em"},children:(0,n.jsxs)(e.span,{style:{top:"-2.55em",marginLeft:"0em",marginRight:"0.05em"},children:[(0,n.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,n.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,n.jsx)(e.span,{className:"mord mathnormal mtight",children:"A"})})]})}),(0,n.jsx)(e.span,{className:"vlist-s",children:"\u200b"})]}),(0,n.jsx)(e.span,{className:"vlist-r",children:(0,n.jsx)(e.span,{className:"vlist",style:{height:"0.15em"},children:(0,n.jsx)(e.span,{})})})]})})]})]})})]})," with the property that:"]}),"\n",(0,n.jsx)(e.span,{className:"katex-display",children:(0,n.jsxs)(e.span,{className:"katex",children:[(0,n.jsx)(e.span,{className:"katex-mathml",children:(0,n.jsx)(e.math,{xmlns:"http://www.w3.org/1998/Math/MathML",display:"block",children:(0,n.jsxs)(e.semantics,{children:[(0,n.jsxs)(e.mrow,{children:[(0,n.jsx)(e.mi,{mathvariant:"normal",children:"\u2203"}),(0,n.jsx)(e.mo,{stretchy:"false",children:"("}),(0,n.jsx)(e.mi,{children:"x"}),(0,n.jsx)(e.mo,{children:":"}),(0,n.jsx)(e.mi,{children:"A"}),(0,n.jsx)(e.mo,{stretchy:"false",children:")"}),(0,n.jsx)(e.mo,{separator:"true",children:","}),(0,n.jsx)(e.mspace,{width:"1em"}),(0,n.jsxs)(e.msub,{children:[(0,n.jsx)(e.mi,{children:"\u03c6"}),(0,n.jsx)(e.mi,{children:"A"})]}),(0,n.jsx)(e.mo,{stretchy:"false",children:"("}),(0,n.jsx)(e.mi,{children:"x"}),(0,n.jsx)(e.mo,{stretchy:"false",children:")"}),(0,n.jsx)(e.mo,{children:"="}),(0,n.jsx)(e.mtext,{children:"value\u2019"})]}),(0,n.jsx)(e.annotation,{encoding:"application/x-tex",children:"\\exists (x : A),\\quad \\varphi_A(x) = \\text{value'}"})]})})}),(0,n.jsxs)(e.span,{className:"katex-html","aria-hidden":"true",children:[(0,n.jsxs)(e.span,{className:"base",children:[(0,n.jsx)(e.span,{className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),(0,n.jsx)(e.span,{className:"mord",children:"\u2203"}),(0,n.jsx)(e.span,{className:"mopen",children:"("}),(0,n.jsx)(e.span,{className:"mord mathnormal",children:"x"}),(0,n.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}}),(0,n.jsx)(e.span,{className:"mrel",children:":"}),(0,n.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}})]}),(0,n.jsxs)(e.span,{className:"base",children:[(0,n.jsx)(e.span,{className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),(0,n.jsx)(e.span,{className:"mord mathnormal",children:"A"}),(0,n.jsx)(e.span,{className:"mclose",children:")"}),(0,n.jsx)(e.span,{className:"mpunct",children:","}),(0,n.jsx)(e.span,{className:"mspace",style:{marginRight:"1em"}}),(0,n.jsx)(e.span,{className:"mspace",style:{marginRight:"0.1667em"}}),(0,n.jsxs)(e.span,{className:"mord",children:[(0,n.jsx)(e.span,{className:"mord mathnormal",children:"\u03c6"}),(0,n.jsx)(e.span,{className:"msupsub",children:(0,n.jsxs)(e.span,{className:"vlist-t vlist-t2",children:[(0,n.jsxs)(e.span,{className:"vlist-r",children:[(0,n.jsx)(e.span,{className:"vlist",style:{height:"0.3283em"},children:(0,n.jsxs)(e.span,{style:{top:"-2.55em",marginLeft:"0em",marginRight:"0.05em"},children:[(0,n.jsx)(e.span,{className:"pstrut",style:{height:"2.7em"}}),(0,n.jsx)(e.span,{className:"sizing reset-size6 size3 mtight",children:(0,n.jsx)(e.span,{className:"mord mathnormal mtight",children:"A"})})]})}),(0,n.jsx)(e.span,{className:"vlist-s",children:"\u200b"})]}),(0,n.jsx)(e.span,{className:"vlist-r",children:(0,n.jsx)(e.span,{className:"vlist",style:{height:"0.15em"},children:(0,n.jsx)(e.span,{})})})]})})]}),(0,n.jsx)(e.span,{className:"mopen",children:"("}),(0,n.jsx)(e.span,{className:"mord mathnormal",children:"x"}),(0,n.jsx)(e.span,{className:"mclose",children:")"}),(0,n.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}}),(0,n.jsx)(e.span,{className:"mrel",children:"="}),(0,n.jsx)(e.span,{className:"mspace",style:{marginRight:"0.2778em"}})]}),(0,n.jsxs)(e.span,{className:"base",children:[(0,n.jsx)(e.span,{className:"strut",style:{height:"0.6944em"}}),(0,n.jsx)(e.span,{className:"mord text",children:(0,n.jsx)(e.span,{className:"mord",children:"value\u2019"})})]})]})]})}),"\n",(0,n.jsxs)(e.p,{children:["For more details, you can look at the file ",(0,n.jsx)(e.a,{href:"https://github.com/formal-land/coq-of-rust/blob/main/CoqOfRust/links/M.v",children:"CoqOfRust/links/M.v"}),"."]}),"\n",(0,n.jsx)(e.h2,{id:"-extracting-an-execution",children:"\ud83d\udca7 Extracting an execution"}),"\n",(0,n.jsx)(e.p,{children:"The Rocq relation above:"}),"\n",(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:"language-coq",children:"{{ e \ud83d\udd3d Output }}\n"})}),"\n",(0,n.jsxs)(e.p,{children:["is defined in ",(0,n.jsx)(e.code,{children:"Set"})," instead of ",(0,n.jsx)(e.code,{children:"Prop"}),". This means that it contains data in addition to stating the property that there exists an execution of with a certain type. We can then define a Rocq function ",(0,n.jsx)(e.code,{children:"evaluate"})," that is total and builds this execution. Here is its signature:"]}),"\n",(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:"language-coq",children:"Fixpoint evaluate {Output : Set} `{Link Output} {e : M}\n    (run : {{ e \ud83d\udd3d Output }}) :\n  LowM.t (Output.t Output).\n"})}),"\n",(0,n.jsxs)(e.p,{children:["Here ",(0,n.jsx)(e.code,{children:"LowM.t"})," is the type version of the untyped ",(0,n.jsx)(e.code,{children:"LowM.t"})," monad from above. We define this function by induction on the proof of execution ",(0,n.jsx)(e.code,{children:"run"}),". We write this definition using the proof mode of Rocq as it is more convenient for this definition. Here is, for example, the definition for the allocation case (better read using the interactive mode of Rocq):"]}),"\n",(0,n.jsx)(e.pre,{children:(0,n.jsx)(e.code,{className:"language-coq",children:"{ (* Alloc *)\n  apply (LowM.CallPrimitive (Primitive.StateAlloc (OfValue.get_value of_value))).\n  intros ref_core.\n  eapply evaluate. (* here is the recursive call *)\n  match goal with\n  | H : forall _, _ |- _ => apply (H {| Ref.core := ref_core |})\n  end.\n}\n"})}),"\n",(0,n.jsx)(e.p,{children:"Having access to the typed execution will be useful for the next phase, in which we will define the memory allocation strategies."}),"\n",(0,n.jsx)(e.p,{children:"With the method we use, we do not need to define the execution explicitly: we derive it automatically from its equivalence proof with the untyped code, thus saving us time. In addition, as proofs can be generated semi-automatically in Rocq, we also hope to automate a lot of our definitions and have more robust scripts for when the source code changes."}),"\n",(0,n.jsx)(e.h2,{id:"\ufe0f-conclusion",children:"\u2712\ufe0f Conclusion"}),"\n",(0,n.jsxs)(e.p,{children:["We have seen how to define a proof of execution using equivalent typed values for the untyped translated code from ",(0,n.jsx)(e.code,{children:"coq-of-rust"}),", and extract a runnable typed code from it. In the next article we will see how to do the same for the resolution of names: to find the trait instances and the order of the function definitions."]}),"\n",(0,n.jsx)(e.admonition,{title:"For more",type:"success",children:(0,n.jsx)(e.p,{children:(0,n.jsxs)(e.em,{children:["Follow us on ",(0,n.jsx)(e.a,{href:"https://x.com/FormalLand",children:"X"})," or ",(0,n.jsx)(e.a,{href:"https://fr.linkedin.com/company/formal-land",children:"LinkedIn"})," for more, or comment on this post below! Feel free to DM us for any questions or requests!"]})})})]})}function o(s={}){const{wrapper:e}={...(0,t.R)(),...s.components};return e?(0,n.jsx)(e,{...s,children:(0,n.jsx)(m,{...s})}):m(s)}},92374:(s,e,a)=>{a.d(e,{A:()=>n});const n=a.p+"assets/images/commutative-diagram-bbb4c911ed7560df3ed98090561652e4.png"},36544:(s,e,a)=>{a.d(e,{A:()=>n});const n=a.p+"assets/images/green-forest-a051f559898a800a1ed19191d4c1372f.webp"},28453:(s,e,a)=>{a.d(e,{R:()=>i,x:()=>r});var n=a(96540);const t={},l=n.createContext(t);function i(s){const e=n.useContext(l);return n.useMemo((function(){return"function"==typeof s?s(e):{...e,...s}}),[e,s])}function r(s){let e;return e=s.disableParentContext?"function"==typeof s.components?s.components(t):s.components||t:i(s.components),n.createElement(l.Provider,{value:e},s.children)}}}]);