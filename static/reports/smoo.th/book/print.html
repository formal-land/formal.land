<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Formal Verification of Smoo.th</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Formal Verification of Smoo.th</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="report"><a class="header" href="#report">Report</a></h1>
<h2 id="-library"><a class="header" href="#-library">📚 Library</a></h2>
<p>The <a href="https://smoo.th/">Smoo.th library</a> is an optimized implementation in <a href="https://soliditylang.org/">Solidity</a> of the <a href="https://en.wikipedia.org/wiki/Elliptic_curve">elliptic curve</a> operations of addition and scalar multiplication, which are at the basis of most of the authentication algorithms in the blockchain or the Web2 space. The code is carefully optimized by hand using:</p>
<ul>
<li>the assembly of Solidity, the <a href="https://docs.soliditylang.org/en/latest/yul.html">Yul</a> language,</li>
<li>an algorithm based on the bit decomposition of the scalars.</li>
</ul>
<p>The <a href="https://github.com/get-smooth/crypto-lib/blob/main/doc/Audits/CRX_smooth_report_2024_07_11_v1.2.pdf">audit report from CryptoExperts</a> gives a nice overview of the library and how its algorithms work.</p>
<p>When looking exclusively at <a href="https://github.com/get-smooth/crypto-lib/blob/main/src/elliptic/SCL_mulmuladdX_fullgen_b4.sol">SCL_mulmuladdX_fullgen_b4.sol</a> (there is also <a href="https://github.com/get-smooth/crypto-lib/blob/main/src/elliptic/SCL_mulmuladdX_fullgenW.sol">SCL_mulmuladdX_fullgenW.sol</a> giving a similar implementation), the library is composed of one main function composed of more than 200 lines of Yul code. We want to show that all this code is equivalent to the basic but unoptimized implementation of the elliptic curve operations (addition and scalar multiplication).</p>
<h2 id="-formal-verification"><a class="header" href="#-formal-verification">✅ Formal verification</a></h2>
<p>Our verification is not complete as of today. You can find the current state of our work in the folder <a href="https://github.com/formal-land/coq-of-solidity/tree/develop/coq/CoqOfSolidity/contracts/scl/mulmuladdX_fullgen_b4">https://github.com/formal-land/coq-of-solidity/tree/develop/coq/CoqOfSolidity/contracts/scl/mulmuladdX_fullgen_b4</a>.</p>
<p>We have verified the following:</p>
<ul>
<li>The addition operation <code>ecAddn2</code> is implemented as in the specification.</li>
<li>The doubling and negation operation <code>ecDblNeg</code> is implemented as in the specification, in an inlined manner.</li>
<li>The pre-computations of the sums of the possible combinations of points is correct.</li>
<li>The retrieval of the pre-computed sums from the current bits of the scalars is correct.</li>
</ul>
<p>We are currently blocked by the complexity of our representation for the library in Coq. We are verifying the Yul code after the optimization pass of the Solidity compiler. This pass adds complexity as many variable names disappear and are replaced by arbitrary locations in the memory. Keeping all the names would simplify keeping the verification effort aligned to the source code and expressing the invariants about data in the loops. So, verifying the code before the optimization passes is the a first improvement that we see. There are probably further improvements we could make, for example, on the reasoning principles of field arithmetic. There are a few dedicated Coq libraries for this problem that we need to investigate.</p>
<h2 id="-how"><a class="header" href="#-how">🧭 How</a></h2>
<p>We do our verification by:</p>
<ol>
<li>Translating the code to Coq using <code>coq-of-solidity</code>. More precisely, we use our script <a href="/coq/scripts/shallow_embed.py">coq/scripts/shallow_embed.py</a> to generate a translation as a shallow embedding in Coq. In contrast to a deep embedding, a shallow embedding has a form that is simpler to reason about, as it more directly uses the features of the target language. From this step, we obtain the file <a href="/coq/contracts/scl/mulmuladdX_fullgen_b4/shallow.v">coq/contracts/scl/mulmuladdX_fullgen_b4/shallow.v</a>.</li>
<li>Executing the contract step by step in a symbolic manner, to show it equivalent to a simpler and idiomatic Coq definition. This is done in the file <a href="/coq/contracts/scl/mulmuladdX_fullgen_b4/run.v">coq/contracts/scl/mulmuladdX_fullgen_b4/run.v</a>. Note that this is still a work in progress.</li>
<li>Showing that the idiomatic Coq version is equivalent to the canonical definition of the elliptic curve operations. This is a work that remains to be done, which will involve reasoning about the two loops implemented in the code, to find the most significant bits of the scalars and to perform the additions and doubling of the points bit by bit.</li>
</ol>
<h2 id="-reproduce"><a class="header" href="#-reproduce">🔄 Reproduce</a></h2>
<p>Assuming you have a working installation of the Coq proof system, you can re-generate and check all of our files by running the following commands. We first assume that you have compiled <code>coq-of-solidity</code>, what you can do by applying the instructions to build the solidity compiler from sources given on https://docs.soliditylang.org/en/v0.8.28/installing-solidity.html#building-from-source</p>
<p>Then run in the folder <code>coq/</code>:</p>
<pre><code class="language-sh">scripts/contracts_generate.sh
cd CoqOfSolidity/
make # Compile all the proofs. This may take a few minutes.
</code></pre>
<h2 id="-blog-posts"><a class="header" href="#-blog-posts">📰 Blog posts</a></h2>
<p>For more information, you can read our associated blog posts:</p>
<ul>
<li><a href="https://formal.land/blog/2024/10/16/coq-of-solidity-enhanced-version-1">🪁 Enhancements to coq-of-solidity – 1</a></li>
<li><a href="https://formal.land/blog/2024/10/21/verification-smooth-library-1">⚈ Verification of the Smoo.th library – 1</a></li>
<li><a href="https://formal.land/blog/2024/10/28/verification-smooth-library-2">⚈ Verification of the Smoo.th library – 2</a></li>
</ul>
<h2 id="-contact"><a class="header" href="#-contact">💌 Contact</a></h2>
<p>If you have any additional questions, do not hesitate to reach us at <a href="mailto:contact@formal.land">contact@formal.land</a>!</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
