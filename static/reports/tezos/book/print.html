<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Formal Verification of Parts of the L1 of Tezos</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Formal Verification of Parts of the L1 of Tezos</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="presentation"><a class="header" href="#presentation">Presentation</a></h1>
<p>We worked for the formal verification of parts of the L1 of the <a href="https://tezos.com/">Tezos blockchain</a> for two grants with the <a href="https://tezos.foundation/">Tezos Foundation</a> of four months each.</p>
<p>The end result is on this website: <a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/">https://formal-land.gitlab.io/coq-tezos-of-ocaml/</a> It includes a blog associated with the project describing the technical progress and the challenges we faced, as well as a link to the source code of the project. Everything is open-source under <a href="https://opensource.org/license/mit">MIT license</a>.</p>
<div style="text-align: center; margin-top: 100px;">
  <img src="./tezos-xtz-logo.svg" alt="Tezos" width="200" />
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="milestone-1"><a class="header" href="#milestone-1">Milestone 1</a></h1>
<p>Here we quickly describe what we have completed for the first milestone of this grant.</p>
<ul>
<li>Verification: significantly increase the coverage of the proofs in the protocol code:
<ul>
<li>Verify the <code>*_hash.ml</code> files: short files with very few properties to verify.</li>
<li>Verify the <code>*_repr.ml</code> files: check the definitions of data-encodings.</li>
<li>Verify the <code>*_services.ml</code> files: check the encodings in the RPCs.</li>
</ul>
</li>
<li>Translation: add annotations on the Ocaml sources or improve the way <code>coq-of-ocaml</code> translates the code in order for some of the files to translate to Coq. Due to various changes in the protocol, some of the files are currently not translating to Coq. The main difficulty in these files is that they include a lot of pattern-matching on GADTs.
<ul>
<li>Translate the Michelson interpreter <code>script_interpreter.ml</code> (around 2,000 OCaml lines).</li>
<li>Translate the Michelson translator <code>script_ir_translator.ml</code> (around 6,000 OCaml lines).</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="milestone-2"><a class="header" href="#milestone-2">Milestone 2</a></h1>
<p>We take the milestone description from the "milestone review" and complete it with our results for this milestone report. In all this document, we will use the pills:</p>
<ul>
<li>ðŸŸ¢ for "done",</li>
<li>ðŸŸ  for "partially done",</li>
<li>ðŸ”´ for "not done".</li>
</ul>
<p>Our results are for the <code>proto_alpha</code> version of the protocol in the branch <code>master</code>. Given the date of this document, this protocol version is close to the version <code>J</code> of the protocol.</p>
<h2 id="verification"><a class="header" href="#verification">Verification</a></h2>
<h3 id="storage-system"><a class="header" href="#storage-system">Storage system</a></h3>
<blockquote>
<p>Verify the storage system: show a simulation with a simpler data structure made of records, sets, and maps.</p>
</blockquote>
<p>We wrote a specification of the <a href="https://gitlab.com/tezos/tezos/-/blob/master/src/proto_alpha/lib_protocol/storage.ml">storage.ml</a> file in https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/proofs/storage/ . This specification is composed of two parts:</p>
<ul>
<li>The definition of a simulation <em>state</em> and <em>change</em> types ðŸŸ¢;</li>
<li>An axiomatization that this simulation is equivalent to the various sub-stores defined in OCaml. This is axiomatized for now but should have been proven ðŸ”´.</li>
</ul>
<p>To prove that the store simulations are correct, we need to verify the storage functors defined in <a href="https://gitlab.com/tezos/tezos/-/blob/master/src/proto_alpha/lib_protocol/storage_functors.ml">storage_functors.ml</a>. We wrote these proofs in https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/proofs/storage_functors/ The functors are the followings:</p>
<ul>
<li><code>Make_subcontext</code> ðŸŸ¢</li>
<li><code>Make_single_data_storage</code> ðŸŸ </li>
<li><code>Pair</code> ðŸŸ¢</li>
<li><code>Make_data_set_storage</code> ðŸŸ </li>
<li><code>Make_carbonated_data_set_storage</code> ðŸ”´</li>
<li><code>Make_indexed_data_storage</code> ðŸŸ¢</li>
<li><code>Make_indexed_carbonated_data_storage</code> ðŸŸ </li>
<li><code>Make_indexed_data_snapshotable_storage</code> ðŸ”´</li>
<li><code>Make_indexed_subcontext.Raw_context</code> ðŸŸ¢</li>
<li><code>Make_indexed_subcontext.Make_set</code> ðŸŸ </li>
<li><code>Make_indexed_subcontext.Make_map</code> ðŸŸ </li>
<li><code>Make_indexed_subcontext.Make_carbonated_map</code> ðŸ”´</li>
<li><code>Wrap_indexed_data_storage</code> ðŸ”´</li>
</ul>
<p>We also need to check that the sub-storages do not interfere with each other (so that we store the data at different sub-trees in the context). This is not done ðŸ”´.</p>
<h3 id="_storageml-files"><a class="header" href="#_storageml-files"><code>*_storage.ml</code> files</a></h3>
<blockquote>
<p>Verify the [*_storage.ml files:] verify the high-level behavior of these functions and specify the invariants on the storage which these files expect.</p>
</blockquote>
<p>For most of the files named <code>*_storage.ml</code> in the protocol, we wrote a specification of some of the functions together with corresponding proofs. In addition to validating parts of the code, we believe this also validates our approach to verify the storage interactions using a simulation. The proofs are in the following files:</p>
<ul>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/proofs/bootstrap_storage/">bootstrap_storage</a></li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/proofs/commitment_storage/">commitment_storage</a></li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/proofs/constants_storage/">constants_storage</a></li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/proofs/contract_manager_storage/">contract_manager_storage</a></li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/proofs/contract_storage/">contract_storage</a></li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/proofs/delegate_activation_storage/">delegate_activation_storage</a></li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/proofs/delegate_storage/">delegate_storage</a></li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/proofs/fees_storage/">fees_storage</a></li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/proofs/frozen_deposits_storage/">frozen_deposits_storage</a></li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/proofs/global_constants_storage/">global_constants_storage</a></li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/proofs/level_storage/">level_storage</a></li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/proofs/nonce_storage/">nonce_storage</a></li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/proofs/sapling_storage/">sapling_storage</a></li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/proofs/sc_rollup_storage/">sc_rollup_storage</a></li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/proofs/seed_storage/">seed_storage</a></li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/proofs/stake_storage/">stake_storage</a></li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/proofs/ticket_storage/">ticket_storage</a></li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/proofs/vote_storage/">vote_storage</a></li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/proofs/voting_period_storage/">voting_period_storage</a></li>
</ul>
<p>There are still some properties that are axioms or using axioms because the storage system is not entirely specified. Thus we consider this verification effort to be between ðŸŸ  and ðŸŸ¢.</p>
<h3 id="michelson-interpreter"><a class="header" href="#michelson-interpreter">Michelson interpreter</a></h3>
<blockquote>
<p>Verify the Michelson interpreter, according to the semantics given in Mi-Cho-Coq.</p>
</blockquote>
<p>We have done the following steps to verify the Michelson interpreter:</p>
<ul>
<li>The definition of a dependently-typed abstract syntax tree for Michelson in https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/simulations/script_typed_ir ðŸŸ¢</li>
<li>The definition of a dependent-typed interpreter following the definition of the OCaml interpreter in https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/simulations/script_interpreter ðŸŸ </li>
<li>A proof of equivalence between the dependent interpreter and the OCaml version (translated to Coq) in https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/proofs/script_interpreter ðŸŸ </li>
<li>A proof of inclusion of the semantics on Mi-Cho-Coq into the dependently-typed interpreter in https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/simulations/micho_to_dep ðŸŸ  The proof is mainly for the individual instructions. What is missing are the control structures or some more complex instructions, primarily related to contract calls or set and map data structures.</li>
<li>We found a few changes to make in Mi-Cho-Coq to keep the semantics similar to the one in OCaml, like the change in the order of parameters for one of the instructions (this instruction was not used in the verification of existing smart contracts).</li>
</ul>
<h3 id="michelson-type-checker"><a class="header" href="#michelson-type-checker">Michelson type-checker</a></h3>
<blockquote>
<p>Verify the script translator, in particular for the compatibility of the parsing and unparsing operators.</p>
</blockquote>
<p>To verify the Michelson type-checker in <a href="https://gitlab.com/tezos/tezos/-/blob/master/src/proto_alpha/lib_protocol/script_ir_translator.ml">script_ir_translator.ml</a>, we have done the following steps:</p>
<ul>
<li>The definition of a dependently-typed version of the various <code>parse</code> and <code>unparse</code> functions in https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/simulations/script_ir_translator/ ðŸŸ </li>
<li>A proof of equality between the dependently-typed functions and translated OCaml ones in https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/proofs/script_ir_translator/ ðŸŸ </li>
<li>We have not done a proof that each kind of <code>parse</code> and <code>unparse</code> functions are inverses ðŸ”´, although we had partial proofs for previous versions of the protocol that we need to update.</li>
</ul>
<p>Among the difficulies we had with the type-checker are that:</p>
<ul>
<li>There were a lot of changes in the OCaml code requiring us to change our proofs, like the removal of the annotations. We did not anticipate this difficulty enough.</li>
<li>The function definitions are large and slow to evaluate in Coq.</li>
</ul>
<p>We hope to complete these proofs at some point, especially in the hope of having a proof for the pair's case of the parsing functions.</p>
<h3 id="gas-system"><a class="header" href="#gas-system">Gas system</a></h3>
<blockquote>
<p>Verify the gas system: check that the saturated arithmetic implementation is valid, and check that the expected computational complexity is coherent with the gas cost for important functions.</p>
</blockquote>
<ul>
<li>We checked that the saturation arithmetic functions defined in <a href="https://gitlab.com/tezos/tezos/-/blob/master/src/proto_alpha/lib_protocol/saturation_repr.ml">saturation_repr.ml</a> are correct in https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/proofs/saturation_repr For each primitive, we check that is it coherent to the equivalent version in <code>Z</code> when we stay in the bounds, and that the output is always in bounds ðŸŸ¢.</li>
<li>We also verified the existing property-based tests for the saturation arithmetic defined in <a href="https://gitlab.com/tezos/tezos/-/blob/master/src/proto_alpha/lib_protocol/test/pbt/saturation_fuzzing.ml">saturation_fuzzing.ml</a> with corresponding lemmas in https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/tests/pbt/saturation_repr These lemmas verify that the tests succeed for any possible inputs ðŸŸ¢.</li>
<li>We did not verify the complexity cost of functions using the gas ðŸ”´.</li>
</ul>
<h2 id="link-with-the-tests"><a class="header" href="#link-with-the-tests">Link with the Tests</a></h2>
<p>For the tests, we are working with four students of the Rug Nl University for a part-time internship to:</p>
<ul>
<li>translate the tests to Coq;</li>
<li>verify that they are correct in the general case.</li>
</ul>
<p>This is ongoing work that will last two more months with the students. The students are not being paid, and this is part of a class, so there is no need for funding.</p>
<blockquote>
<p>Better communicate with the OCaml developers and share code, therefore it is important to link the verification and testing effort.</p>
</blockquote>
<ul>
<li>We made two small presentations are the tests meeting to present:
<ul>
<li>The test of side-effects with free-monads. That can make the integration tests more amenable to formal verification, in addition of being a clean solution to fake the inputs-outputs of a tested code.</li>
<li>The translation of property-based tests in Coq.</li>
</ul>
</li>
<li>We recently started a changelog file, accessible on https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/changelog/ to give better visibility to what we are doing. This was suggested by one of the developers (Mehdi Bouaziz) and has already helped us to have some good remarks.</li>
<li>We wrote the following blog articles to advertise our work and published them on our <a href="https://twitter.com/LandFoobar">Twitter account</a>:
<ol>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/blog/2022/02/08/integer-verification/">Integer arithmetic verification</a></li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/blog/2022/02/10/using-tactics/">Formalization of code in Coq - tactics</a></li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/blog/2022/02/26/simulations-dependently-typed-version/">Simulations - dependently-typed version</a></li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/blog/2022/03/28/profiling-refactoring-optimization/">Some refactoring, some profiling and some optimization</a></li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/blog/2022/04/04/verifying-the-compare-functions/">Verifying the compare functions of OCaml</a></li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/blog/2022/04/04/fuel/">Fuel - quiet escape from the halting problem</a></li>
</ol>
</li>
</ul>
<p>We think we need to do more presentations, especially at the proto-call ðŸŸ .</p>
<blockquote>
<p>Translate the code in the test folder to Coq.
Verify the generalized version of the OCaml tests. We want to make sure that there are no bugs related to properties that are already tested.</p>
</blockquote>
<ul>
<li>We have translated and verified two test files by hand:
<ul>
<li>Saturation arithmetic: https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/tests/pbt/saturation_repr</li>
<li>Tez arithmetic: https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/tests/pbt/tez_repr</li>
</ul>
</li>
<li>We began to automate the translation with <code>coq-of-ocaml</code> of two test files in Coq:
<ul>
<li>Saturation arithmetic: https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/tests/pbt_generated/saturation_fuzzing</li>
<li>Sc rollup ticks: https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/tests/pbt_generated/test_sc_rollup_tick_repr</li>
</ul>
</li>
</ul>
<p>With our technique, we can only cover the tests in the <code>pbt/</code> folder of the <a href="https://gitlab.com/tezos/tezos/-/tree/master/src/proto_alpha/lib_protocol/test"><code>test/</code> folder</a> of the protocol, and we verified only a few files. So we consider that we are between ðŸ”´ and ðŸŸ  for this task.</p>
<h2 id="broader-support-of-the-tezos-code"><a class="header" href="#broader-support-of-the-tezos-code">Broader support of the Tezos code</a></h2>
<blockquote>
<p>Make coq-of-ocaml usable as a library rather than as a configurable executable. This way, the recipient is able to customize the behavior of coq-of-ocaml depending on the kind of code.</p>
</blockquote>
<p>We have not done this task ðŸ”´.</p>
<blockquote>
<p>Translate and verify the data-encoding library. A challenge in verifying this library in Coq is that it contains optimized code using side-effects such as global references, exceptions, or mutable bytes buffers.</p>
</blockquote>
<p>We have not done this task ðŸ”´.</p>
<blockquote>
<p>Optimizing the execution of <code>coq-of-ocaml</code>. The translation of the protocol currently takes around one minute on a typical machine, this should be reduced ten fold in order to iterate more rapidly on the code.</p>
</blockquote>
<p>We have made some optimizations decreasing the time to translate the protocol by two to three times ðŸŸ .</p>
<h2 id="deliverables"><a class="header" href="#deliverables">Deliverables</a></h2>
<blockquote>
<p>A) Formally verify more critical parts of the code and reach a significant volume of verified code.</p>
</blockquote>
<p>Since the last milestone (end of January 2022), we wrote around 20,000 lines of Coq proofs on the protocol. In addition to verifying properties for this milestone, we also verified utility functions (encoding, comparisons, ...). An example of such verification effort is the file <a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/proofs/indexable">Indexable.v</a>, where we verify the encodings, the comparisons, and the <code>Make</code> functor of the <a href="https://gitlab.com/tezos/tezos/-/blob/master/src/proto_alpha/lib_protocol/indexable.ml">indexable.ml</a> file of the protocol.</p>
<blockquote>
<p>B) Improve coq-of-ocaml , reducing the use of unsafe axioms and supporting more OCaml code. In addition to the protocol, we want to support the Tezos libraries and the shell.</p>
</blockquote>
<p>We have made incremental changes to <code>coq-of-ocaml</code> to support the recently added code in the protocol. We continue to use unsafe axioms, for example to support the GADTs. We still support most of the protocol code. We do not yet support code in the shell or libraries. We are beginning to support the tests of the protocol. So this is between ðŸŸ  and ðŸ”´.</p>
<blockquote>
<p>C) Maintain the existing infrastructure, that is to say the translation pipeline from OCaml to Coq and the existing proofs on the protocol.</p>
</blockquote>
<p>We have continued to maintain the translation of the protocol code to Coq, and the existing proofs. The code size increased by more than 50% since the beginning of the grant (four months ago), mainly due to the rollup projects, but we still translate most of the protocol code to Coq ðŸŸ¢.</p>
<h2 id="additional-remarks"><a class="header" href="#additional-remarks">Additional remarks</a></h2>
<p>We have not found bugs in the OCaml code of the protocol.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="milestone-1-1"><a class="header" href="#milestone-1-1">Milestone 1</a></h1>
<p>Here we present what we have completed for the first milestone of this grant.</p>
<h2 id="skip-lists"><a class="header" href="#skip-lists">Skip-lists</a></h2>
<p>We have already specified what the skip-lists data structure should do in <a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/proofs/skip_list_repr">Skip_list_repr.v</a>. Without condidering the properties that were trivial, we verified:</p>
<ul>
<li><input disabled="" type="checkbox" checked=""/>
<code>S.Valid.equal</code> the fact that the equality check of two skip-lists is valid;</li>
<li><input disabled="" type="checkbox" checked=""/>
<code>S.Valid.encoding</code> the fact that the data-encoding function on skip-lists is valid</li>
</ul>
<p>We missed the verification of the following two properties (the most important ones):</p>
<ul>
<li><input disabled="" type="checkbox"/>
<code>S.Valid.back_path_is_valid</code> the fact that the check of a path generated by <code>back_path</code> always returns <code>true</code>;</li>
<li><input disabled="" type="checkbox"/>
<code>S.Valid.back_path_is_uniq</code> the fact that the path generated by <code>back_path</code> is indeed minimal.</li>
</ul>
<p>We plan to complete the proofs of the skip-lists for the second milestone of the grant, but this was not completed for this first milestone.</p>
<h2 id="carbonated-maps"><a class="header" href="#carbonated-maps">Carbonated maps</a></h2>
<p>We have already specified what the carbonated maps should do. We verified all of these specifications in <a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/proofs/carbonated_map">Carbonated_map.v</a>. We verify that:</p>
<ul>
<li>the carbonated maps behave as normal maps, up to the gas cost calculation;</li>
<li>the size of the maps is correctly pre-calculated.</li>
</ul>
<h2 id="classification-of-errors"><a class="header" href="#classification-of-errors">Classification of errors</a></h2>
<p>We have classified all the errors appearing in the protocol in the following three reports:</p>
<ul>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/reports/asserts/">Asserts</a></li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/reports/errors/">Errors</a></li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/reports/exceptions/">Exceptions</a></li>
</ul>
<p>In the file <a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/proofs/error">Error.v</a> we give a predicate to specify what are the internal errors for the extensible <code>error</code> type. Our plan to verify the exceptions and asserts is to write proven equal definitions without using exceptions or assertions. We already have many of such simulations for the interpreter and translator of Michelson in the files:</p>
<ul>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/simulations/script_interpreter">Simulations/Script_interpreter.v</a></li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/simulations/script_ir_translator">Simulations/Script_ir_translator.v</a></li>
</ul>
<h2 id="translation-of-the-protocol-j"><a class="header" href="#translation-of-the-protocol-j">Translation of the protocol J</a></h2>
<p>We have a full translation of the protocol J available in https://gitlab.com/nomadic-labs/coq-tezos-of-ocaml/-/tree/master/src/Proto_alpha and browsable online starting from <a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/alpha_context">Alpha_context.v</a>.</p>
<p>We have done this translation running <code>coq-of-ocaml</code> on our fork https://gitlab.com/clarus1/tezos/-/commits/guillaume-claret@proto_alpha-coq-of-ocaml-proto-j that include some changes added in our fork, mainly to make it compile once translated to Coq. The only functions for which we use the <a href="https://formal.land/docs/coq-of-ocaml/attributes#coq_axiom_with_reason"><code>@coq_axiom_with_reason</code></a> attribute of <code>coq-of-ocaml</code> (disabling the translation and replacing the corresponding definition by an axiom) are the followings:</p>
<ul>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/script_interpreter#log"><code>Script_interpreter.log</code></a> because we ignore the logging feature of Michelson in our formalization of the interpreter. Indeed, this feature is only used in debug mode and would accidentally complexify a lot our dependent type definitions for Michelson.</li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/script_interpreter#klog"><code>Script_interpreter.klog</code></a> Disabled for the same reasons as <code>log</code>.</li>
<li>The top-level initialization calls in <a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/storage_functors/">Storage_functors.v</a> with code such as <code>let () = ...</code> The reasons are that:
<ul>
<li>These code elements are only doing side-effects so cannot study them in Coq as it is;</li>
<li>These code examples are creating a stack-overflow error in Coq for an unknown reason.</li>
</ul>
</li>
</ul>
<p>In addition to the translation of the Tezos code using <code>coq-of-ocaml</code>, we spent a lot of time writing simulations for the Michelson interpreter. These are proven-equivalent definitions using dependent types instead of GADTs. The issue with definitions with GADTs in our Coq translation is that they use dynamic cast axioms in the <code>match</code>, what makes the proofs on them more complex in our experience. Our main files with simulations are the followings:</p>
<ul>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/simulations/script_typed_ir">Script_typed_ir.v</a> with a dependently-typed definition of the abstract syntax tree of Michelson;</li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/simulations/script_interpreter">Script_interpreter.v</a> with a dependently-typed definition of the interpreter (the case for the instruction <code>IView</code> is missing);</li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/simulations/script_ir_translator">Script_ir_translator.v</a> with simulations for some of the functions of the <a href="https://gitlab.com/tezos/tezos/-/blob/master/src/proto_alpha/lib_protocol/script_ir_translator.ml">translator.ml</a> file of the protocol of Tezos.</li>
</ul>
<h2 id="additional-proofs"><a class="header" href="#additional-proofs">Additional proofs</a></h2>
<p>We have continued to maintain our existing proofs and verified most of the compare functions as presented on this page: <a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/status/compare/">Status compare</a>. We have also continued our verification effort on the property-based tests. We have a Coq translation and at least a part of the proofs for the following test files:</p>
<ul>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/tests/pbt/saturation_fuzzing">Saturation_fuzzing.v</a></li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/tests/pbt/test_bitset">Test_bitset.v</a></li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/tests/pbt/test_carbonated_map">Test_carbonated_map.v</a></li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/tests/pbt/test_sc_rollup_tick_repr">Test_sc_rollup_tick_repr.v</a></li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/docs/tests/pbt/test_tez_repr">Test_tez_repr.v</a></li>
</ul>
<h2 id="communication"><a class="header" href="#communication">Communication</a></h2>
<p>Our communication was mainly in the form of blog posts. We published the following posts:</p>
<ul>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/blog/2022/05/21/fold-left/">Handling fold_left in proofs</a></li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/blog/2022/06/02/plan-backward-compatibility/">Plan for backward compatibility verification</a></li>
<li><a href="https://nomadic-labs.gitlab.io/coq-tezos-of-ocaml/blog/2022/06/07/formal-verification-of-property-based-tests/">Formal verification of property based tests</a></li>
<li><a href="https://formal.land/blog/2022/06/15/status%20update-tezos">Status update on the verification of Tezos</a></li>
<li><a href="https://formal.land/blog/2022/06/23/upgrade-coq-of-ocaml-4.14">Upgrade coq-of-ocaml to OCaml 4.14</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="milestone-2-1"><a class="header" href="#milestone-2-1">Milestone 2</a></h1>
<p>In this report, we summarize the work we have done in July and August 2022. Thanks for the reading of the report, and the opportunity given to us to work on the verification of Tezos.</p>
<p>Here are some general remarks on our code:</p>
<ul>
<li>We have all our developments in the Git repository <a href="https://gitlab.com/formal-land/coq-tezos-of-ocaml">https://gitlab.com/formal-land/coq-tezos-of-ocaml</a> with its associated website <a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/">https://formal-land.gitlab.io/coq-tezos-of-ocaml/</a>, as well as some proofs in <a href="https://gitlab.com/formal-land/json-data-encoding">https://gitlab.com/formal-land/json-data-encoding</a> for the <code>json-data-encoding</code> library.</li>
<li>The website presents a better view of the proofs, with hyperlinks to access the definitions. It also includes a blog and a <a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/docs/guides/translation-of-the-protocol">Guides</a> section with a higher-level presentation of the repository.</li>
<li>What we name <code>Proto_alpha</code> is actually the protocol version J. We kept this name to preserve the links, but are planning to change it once we have a proper translation of the development version alpha of the protocol.</li>
<li>Instead of making a comparison for the backward compatibility between the protocol version J and alpha (as claimed in the grant proposal), we are making a comparison of versions J and K. This is because the version K was released by the time of the end of this grant.</li>
<li>The branch from which we translate the folders of the protocols version J and K of Tezos is in <a href="https://gitlab.com/formal-land/tezos/-/merge_requests/7">this merge request</a>. It includes some changes so that the translated code compiles in Coq.</li>
</ul>
<h2 id="skip-list-data-structure"><a class="header" href="#skip-list-data-structure">Skip-list data structure</a></h2>
<p>We verified the validity of the skip-list data structure in <a href="https://gitlab.com/formal-land/coq-tezos-of-ocaml/-/blob/master/src/Proto_K/Proofs/Skip_list_repr.v">https://gitlab.com/formal-land/coq-tezos-of-ocaml/-/blob/master/src/Proto_K/Proofs/Skip_list_repr.v</a> Our final proof is in the lemma <code>back_path_is_valid</code>. We verify that when the <code>back_path</code> primitive returns some value <code>path</code> then this path is considered as correct for the function <code>valid_back_path</code>.</p>
<p>For our proof of the validity of the <code>back_path</code> function, we added a few hypotheses regarding the way we handle the pointers on the client side of the algorithm. For example, we assume that the cells are all created by a <code>genesis</code> or <code>next</code> operation. To verify the usage of the back-path data structure, we will need to check these hypotheses where the back-path functions are used. We believe these hypotheses to be reasonable and necessary. The whole validity statement is the following:</p>
<pre><code class="language-coq">Lemma back_path_is_valid `{FArgs} {content_type ptr_type : Set}
    (equal_ptr : ptr_type â†’ ptr_type â†’ bool)
    (cell_ptr target_ptr : ptr_type)
    (target_cell : cell content_type ptr_type) (path : list ptr_type)
    (deref : ptr_type â†’ option (cell content_type ptr_type)) (fuel : nat)
    (cell_index_spec : Helper_valid.Cell_Index.Valid.t deref)
    (path_valid : âˆ€ p x,
                    In p path â†’ deref p = Some x â†’ Cell.Valid.t x)
    (array_len_valid :
       âˆ€ cptr cval,
         In cptr path â†’
         deref cptr = Some cval â†’
           Z.of_nat (Datatypes.length cval.(cell.back_pointers).(t.items))
           &lt; Pervasives.max_int) :
    Compare.Equal.Valid.t (fun _ â‡’ True) equal_ptr â†’
    deref target_ptr = Some target_cell â†’
    let target_index := index_value target_cell in
    back_path deref cell_ptr target_index = Some path â†’
    valid_back_path equal_ptr deref cell_ptr target_ptr path = true.
</code></pre>
<p>We do not verify the <code>back_path_is_uniq</code> property that states that the path validated by the boolean function <code>valid_back_path</code> is unique. This property was also claimed in the grant proposal.</p>
<h2 id="backward-compatibility"><a class="header" href="#backward-compatibility">Backward compatibility</a></h2>
<p>We verify the backward compatibility over the Michelson interpreter between the versions J and K of the protocol. We put all these developments into the folder <a href="https://gitlab.com/formal-land/coq-tezos-of-ocaml/-/tree/master/src/Proto_K_alpha"><code>src/Proto_K_alpha</code></a>, following our naming where we use <code>alpha</code> for the protocol J.</p>
<p>We organize our development into several files. In the <code>src/Proto_K_alpha</code> and <code>src/Proto_K_alpha/Simulations</code> folders we put the migrations of the datatypes defined in the corresponding files in <code>src/Proto_alpha</code>. A migration is a function from a datatype defined in the old protocol to the new one. For example, for the mutez values:</p>
<pre><code class="language-coq">Module Old := TezosOfOCaml.Proto_alpha.Tez_repr.
Module New := TezosOfOCaml.Proto_K.Tez_repr.

(** Migrate [Tez_repr.t]. *)
Definition migrate (x : Old.t) : New.t :=
  match x with
  | Old.Tez_tag n =&gt; New.Tez_tag n
  end.
</code></pre>
<p>we map the old constructor <code>Tez_tag</code> to the new one. We also have such a migration function for the abstract syntax tree of Michelson.</p>
<p>In the folder <code>src/Proto_K_alpha/Proofs</code> we add the proofs of backward compatibility of various functions of the protocol. The main file is <a href="https://gitlab.com/formal-land/coq-tezos-of-ocaml/-/blob/master/src/Proto_K_alpha/Proofs/Script_interpreter.v"><code>src/Proto_K_alpha/Proofs/Script_interpreter.v</code></a> where we state the backward compatibility of the interpreter:</p>
<pre><code class="language-coq">Error.migrate_monad (Old.dep_step fuel (ctxt, sc) gas i_value ks accu_stack)
  (fun '(output, ctxt, gas) =&gt; (
    Script_typed_ir.With_family.migrate_stack_value output,
    Local_gas_counter.migrate_outdated_context ctxt,
    Local_gas_counter.migrate_local_gas_counter gas
  )) =
New.dep_step
  fuel
  (
    Local_gas_counter.migrate_outdated_context ctxt,
    Script_typed_ir.migrate_step_constants sc
  )
  (Local_gas_counter.migrate_local_gas_counter gas)
  (Script_typed_ir.With_family.migrate_kinstr i_value)
  (Script_typed_ir.With_family.migrate_continuation ks)
  (Script_typed_ir.With_family.migrate_stack_value accu_stack)
</code></pre>
<p>We say that the two following computations give the same result:</p>
<ul>
<li>taking the <code>dep_step</code> function from the protocol J, running it on an instruction <code>i_value</code> and a stack <code>accu_value</code>, and applying the migration function on the results;</li>
<li>taking the <code>dep_step</code> function from the protocol K, and running it on the migrations of an instruction <code>i_value</code> and a stack <code>accu_stack</code>.</li>
</ul>
<p>At the time of writing, we have verified the backward compatibility of the interpreter on 80% of the instructions. We did not verify the backward compatibility of the parser and type-checker of Michelson. In order to simplify the proofs, we axiomatize that the gas cost is the same for the two protocols. We check that both the success and the error cases of the interpreter are the same for the protocols J and K.</p>
<p>We write our proofs on a dependently typed implementation of the interpreter that we name <code>dep_step</code> in the file <a href="https://gitlab.com/formal-land/coq-tezos-of-ocaml/-/blob/master/src/Proto_K/Simulations/Script_interpreter.v">src/Proto_K/Simulations/Script_interpreter.v</a> instead of the usual <code>step</code> function from <a href="https://gitlab.com/formal-land/coq-tezos-of-ocaml/-/blob/master/src/Proto_K/Script_interpreter.v">src/Proto_K/Script_interpreter.v</a>. We do so to simplify the reasoning on the code that is originally written using GADTs in OCaml.</p>
<p>For the two protocols J and K, we have a complete definition of a dependent abstract syntax tree, an almost complete definition of the interpreter, and the definition for most of the <code>script_ir_translator.ml</code> file. To these dependent definitions, we attach proofs of equivalence between the dependent implementation and the original translated code. The translated code from OCaml contains <code>cast</code> axioms to implement the <code>match</code> on GADT values. We mostly verified the equivalence for the interpreter and some parts of the <code>script_ir_translator.ml</code> file.</p>
<p>Most of our time was allocated to writing or verifying these dependent implementations for both protocols J and K. A good optimization in our work would be to automatically generate these dependent implementations from the OCaml code.</p>
<h2 id="absence-of-internal-errors"><a class="header" href="#absence-of-internal-errors">Absence of internal errors</a></h2>
<p>We did not have time to do more than our <a href="https://gitlab.com/formal-land/coq-tezos-of-ocaml/-/tree/master/src/Reports">initial reports</a> classifying the errors in the Tezos protocol (submitted for the previous half of the grant). With the dependent implementation that we write for Michelson, we verify the absence of <code>assert false</code>, exceptions and non-termination effect for all the parts of the code for which we have a dependent version. For the absence of <code>assert false</code> or exceptions, at a meta-level, our proof relies on the fact that:</p>
<ul>
<li>we axiomatize the <code>assert</code> or exception operators;</li>
<li>unless we ignore these values, if they appear in a reachable branch of the translated OCaml code then it would not be able to prove our dependent purely functional implementation equal to the translated code.</li>
</ul>
<p>We are aware that we did not achieve to do what we planned for the verification of the absence of internal errors.</p>
<h2 id="json-data-encoding"><a class="header" href="#json-data-encoding">JSON data encoding</a></h2>
<p>Additionally, we worked on the verification of the <a href="https://gitlab.com/nomadic-labs/json-data-encoding">JSON data-encoding</a> library used in the protocol for serialization. We verified the implementation of the optimized version of <code>List.map</code> given in <a href="https://gitlab.com/nomadic-labs/json-data-encoding/-/blob/master/src/list_map.ml">src/list_map.ml</a> in the file <a href="https://gitlab.com/formal-land/json-data-encoding/-/blob/master/coq-src/proofs/List_map.v">coq-src/proofs/List_map.v</a> of our fork of the project.</p>
<p>We also began the translation to Coq of the other files of this project. However, we faced some difficulties including:</p>
<ul>
<li>The use of polymorphic variants; for that we refactored the code to avoid using polymorphic variants.</li>
<li>A missing definition of the standard library of OCaml in Coq. We have started to complete these definitions in <a href="https://github.com/formal-land/coq-of-ocaml/pull/221">this pull request</a>.</li>
</ul>
<h2 id="communication-1"><a class="header" href="#communication-1">Communication</a></h2>
<p>We published two blog posts:</p>
<ul>
<li><a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/blog/2022/07/19/fixing-proofs">Fixing reused proofs</a> to explain how we typically proceed to port and fix proofs for a version of the protocol to another. In particular, we had to do this work from the protocol version J to K, and complete the proofs for the verification of new data-encodings for example.</li>
<li><a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/blog/2022/08/15/verify-json-data-encoding/">Verifying json-data-encoding</a> to explain the work we did on the <a href="https://gitlab.com/nomadic-labs/json-data-encoding">JSON data-encoding</a> library, in particular to translate parts of the code to Coq and verify the optimized <a href="https://gitlab.com/nomadic-labs/json-data-encoding/-/blob/master/src/list_map.ml">List.map</a> implementation.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="milestone-3"><a class="header" href="#milestone-3">Milestone 3</a></h1>
<p>To see the work we have done in this additional milestone, please refer to this PDF document: <a href="./grant_2_3.pdf">Additional Milestone - Verification of the Internal Errors</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
